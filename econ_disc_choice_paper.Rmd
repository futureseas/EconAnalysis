---
title: "Climate effects on species-location choices"
author:
  - name: Felipe Quezada
    email: felipe.quezada@noaa.gov
    institute: [ucsc, noaa]
    correspondence: true
  - name: Desiree Tommasi
    institute: [ucsc, noaa]
  - name: Stephen Stohs
    institute: noaa
institute:
  - ucsc: Institute of Marine Sciences, University of California Santa Cruz
  - noaa: NOAA Southwest Fisheries Science Center
date: "`r format(Sys.time(), '%B %e, %Y')`"
header-includes:
  \usepackage{mathtools}
  \usepackage{tcolorbox}
  \usepackage{float}
  \floatplacement{figure}{H}
  \usepackage{times}
  \usepackage{setspace}
  \setstretch{1.5}
output:
  pdf_document:
    number_sections: yes
    citation_package: natbib
    pandoc_args:
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
bibliography: references.bib
urlcolor: blue
---

```{r setup, include=FALSE}
gc()
knitr::opts_chunk$set(echo = TRUE)
library(bookdown)
library(doBy)
library(dplyr)
library(fastDummies)
library(ggplot2)
library(here)
library(hrbrthemes)
library(lmtest)
library(lubridate)
library(magrittr)
library(plm)
library(reshape)
library(reshape2)
library(rstan)
library(scales)
library(sjlabelled)
library(summarytools)
library(texreg)
library(tidyr)
library(tidyverse)
library(tinytex)
library(viridis)
library(xtable)
library(zoo)
```



```{r read_data, include=FALSE} 
disc.choice.dat <- read.csv(file = here("Data", "discrete_choice_data.csv"))
logbooks.dat <- read.csv(file = here("Data", "logbooks_merged.csv"))

```

```{r functions, include=FALSE}
cntrd <- function(x) {
  data.frame(geosphere::centroid(as.matrix(x[,c("set_long", "set_lat")])))
}

deg2rad <- function(deg) {
  m <- deg * (pi/180)
  return(m)
}

getDistanceFromLatLonInKm <- function(lat1,lon1,lat2,lon2) {
  R <- 6371
  dLat <- deg2rad(lat2-lat1)
  dLon <- deg2rad(lon2-lon1)
  a <- sin(dLat/2) * sin(dLat/2) +  cos(deg2rad(lat1)) * cos(deg2rad(lat2)) * sin(dLon/2) * sin(dLon/2)
  c <- 2 * atan2(sqrt(a), sqrt(1-a))
  d <- R * c
  return(d)
}

```

# Introduction

<!-- JON in CPS's Workshop: -->
<!-- " This part of the discussion was devoted to some of the decision making that goes on to determine -->
<!-- fishing locations and target species of the CPS fleet, and some of the key discussion points were: -->
<!-- ● The decisions of where and when to fish and what to target can depend on whether the -->
<!-- vessel is ‘owner-operated’ or ‘company-owned’. The owner-operator vessels have more -->
<!-- agency to decide what and when. CPS vessels (sardine and anchovy, and to a lesser -->
<!-- extent squid), are largely limited to staying out for 1 day. Regardless of vessel ownership, -->
<!-- much of the CPS fishing is driven by market order. The boats will have a port and -->
<!-- processor lined up before they go fishing. The relationship between the markets and -->
<!-- fishers is important. Coastal tunas are important to the catch and income for CPS boats. -->
<!-- For the NW fleet, most vessels leave from Astoria, but can land elsewhere. They can hire -->
<!-- a pilot to look for fish, and the WA and OR fleet will use this information to decide where -->
<!-- to fish, before returning to their arranged port. Spotter planes are frequently used. -->
<!-- ● Key ports for CPS landings are: San Pedro, Ventura, Morro Bay, Monterey, Half Moon -->
<!-- Bay, and San Francisco. Important to know if some smaller ports, such as Astoria, can -->
<!-- remain viable. Most plants in OR are permanent, but temporary landings can be set up, -->
<!-- particularly for squid, with trucks taking landings to regular plants. -->
<!-- ● A seine boat needs options, so OR boats often have CA permits, or they could switch -->
<!-- gears. They try to be very flexible. Historically, NW fishing can stop due to weather, and -->
<!-- in the SW more likely due to allocation and quota. -->
<!-- ● Price and market order drive what is targeted. Prices can also very by port, for example -->
<!-- anchovy is worth more at Monterey. What are the key forces driving price? There are -->
<!-- different markets for different species, so it’s complex. International markets and their -->
<!-- supply and demand are important for price. Building the domestic market is hard, lots -->
<!-- still exported. Tariffs are having a bit of an impact" -->



High variability on forage fisheries could encourage fisher to have complex fishers portfolio, using diversification as a tool for reducing risk [@kasperski2013]. This diversification can allow for species-specific environmental shocks affect other non-related fisheries through "harvest" arbitrage [@richerson2017]. Hetoregeneity must be considerate as fleet that differ by specific characteristics may have different responses to changes in policy and environmental conditions [@zhang2011]. We capture vessel heterogeneity estimating a Mixed Logit model. 

Because we have access to vessel characteristics, we can estimate a sorting model with observable heterogeneity following @zhang2011.


Previous studies on fishers behavior focus moslty on a single-species framework. TO our knowledge, only [@richerson2017] address the complexity of fleet dynamics on multispecies fishery in the U.S. West Coast, where the desicion which species to harvest is interdependent between species. They study how a closure of the salmon fishery on fisher behavior. Our study expand on their work studying the interrelation and the effect of closures and weather events on the desion to participate in fishery for the Coastal Pelagic Species fishery in the California current.  

Moreover, fisher decision to participate in a particular fishery could vary depending on the season. Some vessels change within a year their target species to follow species distribution over the year. Regulations (e.g. whether or not the fishery have limited entry, and the vessel holds a permit) and profitability can also condition the decision to participate in a fishery during a year [@richerson2017]. Complementary v/s substitute fisheries [@richerson2017]

Additional, we study fishers response to weather events (e.g. storms) and to a fishery closure, such as the Pacific sardine closure in 2015.


+ Research question:
  + **Big question:** What is the effect of climate change on fishers dexision. 
  + **Narrow question:** How does changes in the presence of CPS affect species and location choices by vessels registered in the US west coast?
  + Check if state limits affect the behavior of fish decisions.

+ Contribution:
  + SDM projections to forecast fisher behavior
  + Better understanding of fishers species portfolio
  + Policy analysis

+ Method
  + Mixed logir model:
    + Mixed logit? (A mixed logit (or random-coefficient logit) avoids assuming IIA allowing for marginal utility varies between individuals)
    + Relax the independence of irrelevant alternative assumption: Coeficient vary randomnly across vessels, and "Variance in the unobserved vessel-specific parameters induces correlation over alternatives in the stochastic portion
of utility." @revelt1998
    + Account for correlation in unobserved utility between repeated choices @revelt1998. The estimations is efficient. 

"Technological, economic, and management factors can limit both
the willingness and capacity for fishers to respond to shifting the
availability of target species, thus affecting the coupling between
landings and availability." Selden 2020


"Rogers in Nature: fishers are often limited in where they can fish based on local ecological
knowledge, vessel size or gear type, geographic distance,
spatial management or conservation measures and, in some cases,
customary territories9. Peer groups of vessels from the same port
and using the same gear type"

+ Characterize the fishery
  + Heterogeneity in location, do a map and calculate variation on latitude and longitude.
  + How far from ports
  + How far from the coast. 
  + Average distance traveled. 
  + Fishing effort


# Species/location choice model for the CPS fishery

+ Choices:
  + Set of location/specie
  + Number of choices can vary between vessels, as well as the number of periods or choice situtations @revelt1998.
  + What is the outside option, non-CPS fishery or non-fishing? [@zhang2011]
  + Use @hicks2020 methodology to select the choice set:
    + Crucial for the model the selection of the choice set. If is erroneous, our estimates would be biased.
    + We don't observe fishers complete set of alternatives. "A limitation of all of the models discussed thus far is the assumption that the choice set is finite and tractable. In the caseof spatial choice models in a number of environmental settings, including fisheries, the choice set is virtually infinite as spacecan be continually divided to form different “alternatives.”"
    + They propose a method to construct alternative choices when alternative are effectively infinite *we just observe a point where vessel fish over a very large open ocean area).
    + What is wrong with aggregating fishing areas? -> "areas may encompass highly heterogeneous fishing locations in terms of species composition and density or feasibility of fishing (e.g.unfishable rocky areas)". THIS COULD BIAS OUR RESULTS.
    + How this work: "Sample points from a fine scale grid of specific locations." It is a point-based approach for choosing the choice set. 
    + Should improve modeling in setting with fine-scale spatial heteogeneity.
    + The method is called: **Grid point-based sampling models.**
      + The region study is restricted, but within the region there are infinite points.
      + The choice set considerate **depth on water**. Does this is an important variable for CPS fisheries?
    
    
    
+ Explanatory variables:
  + Species value? This assumes fisher that has rational preferences and maximizes utility. It might be that they harvest a species as they have been doing it for a long time. 
Landings;
  + Vessel characteristics (Note: Not all vessels go to the exact location, so that decisions might depend on their characteristics).
  + Expected catch / species abundance?
  + Catch per unit of effort" (use monthly data to calculate this, maybe correlated with SDM outputs [@zhang2011]) Maybe is endogenus (comment from Dale Squires)... better to use SDM to get expected biomass at this area. 
  + DIstance? 
  
  + Girardin may have a way to compute congestion in location


+ Data 
  + CDWF logbooks and landings (Caitlin)
  + PacFIN landings by vessel & logbooks (try to connect to Global Fishing Watch). 
  + SDM's from Barb

+ Consideration:
  + Choice set important (locations and species).
  + Outside option?


# Method

+ Dale comments
  + Results are sensible when your have high resolution data (stochastic within day)
  + We have to find the optimal degree of disagregation (multicollinearity between explanatory variables)
  + Check for endogeneity, heterokedasticity and serial correlation (in panel data).
    + Distance might be endogeneous (location or distance is chosen? do a Hausman test)
  + Try including splines in the regressors 

It is of high relevance to define rigorously the choice set. For instance, @stafford2018 show that aggregating relevant alternative in the generic outside option lead to biased results and distorted substitution patterns. Thus, we should carefully assess the set of alternative in this case. In our case, this require to carefully select the set of species a fisher has as alternatives, as well as the location included in the choice set.
<!-- Model: Nested logit model -> Stages: Participation, species, and location. / How closure predictions were made? -->

We develop to different discrete choice model:
  + species participation model
  + Location and species decision model
  + species and gear decision model
  
Our second model is a location and species decision model. We can estimate a conditional logit for species-location choice set using charactristics of the choice and incorporating heterogeneity through interaction variables. 


A locations/species model could be implemented to see how fine scale behavior emerge to the aggregate one that we observe. Another think to consider is whether is better to use mixed logir or conditional logit with interactive terms (see Phaneuf and Requate (2016): "A Course in Environmental Economics: Theory, Policy, and Practice". 




## Graphs

```{r std_coordinates, include=FALSE}
# Calculate centroids 
centroids.fleet <- logbooks.dat %>% group_by(fleet_name, species) %>% do(cntrd(.)) %>% 
  dplyr::rename(long_fleet = lon) %>% dplyr::rename(lat_fleet = lat) 
  logbooks.dat <- logbooks.dat %>% 
    merge(centroids.fleet, by=c('fleet_name', 'species'),all.x = TRUE) %>% 
    mutate(drvid = ifelse(drvid == 0, BoatName, ifelse(is.na(drvid), BoatName, drvid)))
  
centroids.drvid <- logbooks.dat %>% group_by(drvid) %>% mutate(count = n()) %>% dplyr::filter(count>2) %>%
  group_by(drvid) %>% do(cntrd(.)) %>% 
  dplyr::rename(long_drvid = lon) %>% dplyr::rename(lat_drvid = lat)
  logbooks.dat <- merge(logbooks.dat, centroids.drvid, by=c('drvid'),all.x = TRUE) 
  
# Caclulate standard errors
  std_coordinates <- logbooks.dat %>% 
    mutate(std_lat = (set_lat - lat_drvid)^2) %>% 
    mutate(std_lon = (set_long - long_drvid)^2)  %>% group_by(drvid) %>% 
    mutate(sum_std_lat=sum(std_lat), n=n(), sum_std_lon=sum(std_lon))  %>%
    mutate(std_lat = sqrt(sum_std_lat / (n-1))) %>% mutate(std_lon = sqrt(sum_std_lon / (n-1))) %>%
    tidyr::unite('fleet', fleet_name:species, remove = FALSE) %>% 
    dplyr::select("std_lon", "std_lat", "drvid", "fleet") %>% unique()

```

```{r hist_all, echo=FALSE, fig.cap="Histogram for standard deviation from centroid", message=FALSE, warning=FALSE}
### How many standard error deviate from the average (by mmsi and fleet) ###
LonCol <- rgb(1,0,0,0.2)
LatCol <- rgb(0,0,1,0.2)
hist_data <- gather(std_coordinates, condition, measurement, std_lon, std_lat, factor_key=TRUE)
ggplot(hist_data, aes(measurement, fill = condition)) +  geom_density(alpha = 0.2) +
  labs(fill = "Variable", x = "Standard deviation (in degrees) from centroids", y = "Density") +
  scale_fill_manual(labels = c("Longitude (SD)", "Latitute (SD)"), values = c(LonCol, LatCol))

```

```{r hist_fleet, echo=FALSE, fig.cap="Histogram for standard deviation from centroid by fleet", message=FALSE, warning=FALSE}
### How many standard error deviate from the average (by mmsi and fleet) ###
hist_data <- gather(std_coordinates, condition, measurement, std_lon, std_lat, factor_key=TRUE)
ggplot(hist_data, aes(measurement, fill = condition)) +  geom_density(alpha = 0.2) +
  labs(fill = "Variable", x = "Standard deviation (in degrees) from centroids", y = "Density") +
  scale_fill_manual(labels = c("Longitude (SD)", "Latitute (SD)"), values = c(LonCol, LatCol)) + 
  facet_wrap(~fleet, scales = "free")
```


## Convex hull estimation

```{r convex_hull, echo=FALSE, fig.cap="Histogram for standard deviation of latitude", message=FALSE, warning=FALSE}
### Minimum convex polygon (or convex hull) It is the smallest polygon in which no internal angle exceeds 180 degrees and which contains all sites. 

logbooks.dat.sp <- logbooks.dat %>% tidyr::unite('fleet', fleet_name:species, remove = FALSE) %>% 
  group_by(drvid) %>% mutate(count = n()) %>% dplyr::filter(count>=5) 
logbooks.sp <- logbooks.dat.sp[, c("drvid", "set_long", "set_lat")] 


# Create a SpatialPointsDataFrame by defining the coordinates
library(sp)
coordinates(logbooks.sp) <- c("set_long", "set_lat")
# proj4string(logbooks.sp) <- CRS( "+proj=utm +zone=11 +datum=WGS84 +units=m +no_defs" )

# Calculate MCPs for each turtle
library(adehabitatHR) # Load library to estimate "home range estimation" (used in ecology I guess)
logbooks.mcp <- mcp(logbooks.sp, percent = 100, unin = c("km"), unout = c("ha"))
logbooks.convex.hull <- as.data.frame(logbooks.mcp)
# # Plot
library(scales) # Helps make polygons partly transparent using the alpha argument below
plot(logbooks.sp, col = as.factor(logbooks.sp@data$drvid), pch = 16)
plot(logbooks.mcp, col = alpha(1:5, 0.5), add = TRUE)
# 

# Plot histrogram for convex hull by fleet
convex.hull <- logbooks.dat %>% tidyr::unite('fleet', fleet_name:species, remove = FALSE) %>% 
  dplyr::select("drvid", "fleet") %>% unique() %>% dplyr::rename(id = drvid) 
  convex.hull <- merge(convex.hull, logbooks.convex.hull, by=c('id'), all.x = TRUE)
  ggplot(convex.hull, aes(area)) +  geom_density() + facet_wrap(~fleet, scales = "free") +
    labs(x = "Convex hull area (hectares)", y = "Density")


```

