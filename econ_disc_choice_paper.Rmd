---
title: "Climate effects on species-location choices"
author:
  - name: Felipe Quezada
    email: felipe.quezada@noaa.gov
    institute: [ucsc, noaa]
    correspondence: true
  - name: Desiree Tommasi
    institute: [ucsc, noaa]
  - name: Stephen Stohs
    institute: noaa
institute:
  - ucsc: Institute of Marine Sciences, University of California Santa Cruz
  - noaa: NOAA Southwest Fisheries Science Center
date: "`r format(Sys.time(), '%B %e, %Y')`"
header-includes:
  \usepackage{mathtools}
  \usepackage{tcolorbox}
  \usepackage{float}
  \floatplacement{figure}{H}
  \usepackage{times}
  \usepackage{setspace}
  \setstretch{1.5}
output:
  pdf_document:
    number_sections: yes
    citation_package: natbib
    pandoc_args:
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
bibliography: references.bib
urlcolor: blue
---

```{r setup, include=FALSE}
gc()
knitr::opts_chunk$set(echo = TRUE)
library(bookdown)
library(doBy)
library(dplyr)
library(fastDummies)
library(ggplot2)
library(here)
library(hrbrthemes)
library(lmtest)
library(lubridate)
library(magrittr)
library(plm)
library(reshape)
library(reshape2)
library(rstan)
library(scales)
library(sjlabelled)
library(summarytools)
library(texreg)
library(tidyr)
library(tidyverse)
library(tinytex)
library(viridis)
library(xtable)
library(zoo)
```



```{r read_data, include=FALSE} 
disc.choice.dat <- read.csv(file = here("Data", "discrete_choice_data.csv"))

```

```{r functions, include=FALSE}
cntrd <- function(x) {
  data.frame(geosphere::centroid(as.matrix(x[,c("set_long", "set_lat")])))
}

deg2rad <- function(deg) {
  m <- deg * (pi/180)
  return(m)
}

getDistanceFromLatLonInKm <- function(lat1,lon1,lat2,lon2) {
  R <- 6371
  dLat <- deg2rad(lat2-lat1)
  dLon <- deg2rad(lon2-lon1)
  a <- sin(dLat/2) * sin(dLat/2) +  cos(deg2rad(lat1)) * cos(deg2rad(lat2)) * sin(dLon/2) * sin(dLon/2)
  c <- 2 * atan2(sqrt(a), sqrt(1-a))
  d <- R * c
  return(d)
}

```

# Introduction

+ Research question:
  + **Big question:** What is the effect of climate change on fish patterns. 
  + **Narrow question:** How does changes in the presence of CPS affect species and location choices by vessels registered in the US west coast?
  + Check if state limits affect the behavior of fish decisions.

+ Contribution:
  + SDM projections to forecast fisher behavior
  + Better understanding of fishers species portfolio
  + Policy analysis

+ Method
  + Mixed logir model:
    + Mixed logit? (A mixed logit (or random-coefficient logit) avoids assuming IIA allowing for marginal utility varies between individuals)
    + Relax the independence of irrelevant alternative assumption: Coeficient vary randomnly across vessels, and "Variance in the unobserved vessel-specific parameters induces correlation over alternatives in the stochastic portion
of utility." @revelt1998
    + Account for correlation in unobserved utility between repeated choices @revelt1998. The estimations is efficient. 



+ Characterize the fishery
  + Heterogeneity in location, do a map and calculate variation on latitude and longitude.
  + How far from ports
  + How far from the coast. 
  + Average distance traveled. 
  + Fishing effort


# Species/location choice model for the CPS fishery

+ Choices:
  + Set of location/specie
  + Number of choices can vary between vessels, as well as the number of periods or choice situtations @revelt1998.
  + Use @hicks2020 methodology to select the choice set:
    + Crucial for the model the selection of the choice set. If is erroneous, our estimates would be biased.
    + We don't observe fishers complete set of alternatives. "A limitation of all of the models discussed thus far is the assumption that the choice set is finite and tractable. In the caseof spatial choice models in a number of environmental settings, including fisheries, the choice set is virtually infinite as spacecan be continually divided to form different “alternatives.”"
    + They propose a method to construct alternative choices when alternative are effectively infinite *we just observe a point where vessel fish over a very large open ocean area).
    + What is wrong with aggregating fishing areas? -> "areas may encompass highly heterogeneous fishing locations in terms of species composition and density or feasibility of fishing (e.g.unfishable rocky areas)". THIS COULD BIAS OUR RESULTS.
    + How this work: "Sample points from a fine scale grid of specific locations." It is a point-based approach for choosing the choice set. 
    + Should improve modeling in setting with fine-scale spatial heteogeneity.
    + The method is called: **Grid point-based sampling models.**
      + The region study is restricted, but within the region there are infinite points.
      + The choice set considerate **depth on water**. Does this is an important variable for CPS fisheries?
    
    
    
+ Explanatory variables:
  + Species value? This assumes fisher that has rational preferences and maximizes utility. It might be that they harvest a species as they have been doing it for a long time. 
Landings;
  + Vessel characteristics (Note: Not all vessels go to the exact location, so that decisions might depend on their characteristics).
  + Expected catch / species abundance?


+ Data 
  + CDWF logbooks and landings (Caitlin)
  + PacFIN landings by vessel & logbooks (try to connect to Global Fishing Watch). 
  + SDM's from Barb

+ Consideration:
  + Choice set important (locations and species).
  + Outside option?




<!-- Stafford (2018):  -->
<!-- When alternatives are combined, they are treated as identical alternatives. Regardless of similarity between them or with an alternative in the model. → Misleading estimates and distort substitution patterns.  -->
<!-- “The empirical results and Monte Carlo analysis suggest that researchers and practitioners should explicitly model choices closely related to the decisions of interest whenever possible and, when not possible, carefully consider the potential biases introduced by pooling such choices with other outside options.” -->
<!-- Model: Nested logit model -->
<!-- Stages: Participation, species, and location. -->
<!-- Variables: They include alternative-specific observations (for species and location) as well as alternative-invariant variables.  -->
<!-- Q: What about individual characteristics in the model to show heterogeneity in fleets? -->
<!-- How closure predictions were made? -->



# Graphs

```{r dist_from_centroid, include=FALSE}
## Calculate centroids and distances
centroids.mmsi <- disc.choice.dat %>% group_by(mmsi) %>% do(cntrd(.)) %>% 
  dplyr::rename(long_mmsi = lon) %>% dplyr::rename(lat_mmsi = lat)
  disc.choice.dat <- merge(disc.choice.dat, centroids.mmsi, by=c('mmsi'),all.x = TRUE) 

centroids.fleet <- disc.choice.dat %>% group_by(fleet_name, species) %>% do(cntrd(.)) %>% 
  dplyr::rename(long_fleet = lon) %>% dplyr::rename(lat_fleet = lat)
  disc.choice.dat <- merge(disc.choice.dat, centroids.fleet, by=c('fleet_name', 'species'),all.x = TRUE) 

## Calculate distances to centroids   
disc.choice.dat$dist_cntrd_mmsi <- getDistanceFromLatLonInKm(disc.choice.dat$set_lat,  
                                                             disc.choice.dat$set_long,
                                                             disc.choice.dat$lat_mmsi,
                                                             disc.choice.dat$long_mmsi)
disc.choice.dat$dist_cntrd_fleet <- getDistanceFromLatLonInKm(disc.choice.dat$set_lat,  
                                                              disc.choice.dat$set_long,
                                                              disc.choice.dat$lat_fleet,
                                                              disc.choice.dat$long_fleet)
```


```{r mmsi_dist, echo=FALSE, fig.cap="Histogram for distance from centroid", message=FALSE, warning=FALSE}
### How many standard error deviate from the average (by mmsi and fleet) ###
hist(disc.choice.dat$dist_cntrd_mmsi, breaks=60, main="", 
     xlab="Distance from centroid (km)")
```


```{r mmsi_dist_by_mmsi, echo=FALSE, fig.cap="Histogram for distance from centroid by vessels", message=FALSE, warning=FALSE}
ggplot(disc.choice.dat, aes(x = dist_cntrd_mmsi)) +
  geom_histogram()+facet_wrap(~mmsi)+
  xlim(0, 200) + labs(x = "Distance from centroid (km)", y = "Frequency")

```

```{r statistics_deviation, echo=FALSE, , fig.cap="Histogram for distance from centroid by fleet", message=FALSE, warning=FALSE}
### How many standard error deviate from the average (by mmsi and fleet) ###
disc.choice.dat <- disc.choice.dat %>% tidyr::unite('fleet', fleet_name:species, remove = FALSE)
ggplot(disc.choice.dat, aes(x = dist_cntrd_fleet)) +
  geom_histogram()+facet_wrap(~fleet)+
  xlim(0, 200) + labs(x = "Distance from centroid (km)", y = "Frequency")

```


