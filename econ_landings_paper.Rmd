---
title: "Multivariate landing model for the CPS fishery"
author: "Felipe J. Quezada"
date: "`r format(Sys.time(), '%B %e, %Y')`"
header-includes:
  \usepackage{mathtools}
  \usepackage{tcolorbox}
  \usepackage{float}
  \floatplacement{figure}{H}
output:
  pdf_document: 
    number_sections: yes
    citation_package: natbib
bibliography: references.bib
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
rm(list = ls(all.names = TRUE)) 
load("stan_fit.RData")
# gc()
library(bookdown)
library(brms)
library(cmdstanr)
library(doBy)
library(dplyr)
library(fastDummies)
library(ggplot2)
library(here)
library(hrbrthemes)
library(kableExtra)
library(lmtest)
library(lubridate)
library(magrittr)
library(patchwork)
library(plm)
library(papaja)
library(reshape)
library(reshape2)
library(rstan)
library(scales)
library(sjlabelled)
library(summarytools)
library(texreg)
library(tidyr)
library(tidyverse)
library(tinytex)
library(viridis)
library(xtable)
library(zoo)
```

```{r read_data, include=FALSE} 
PacFIN_dat <- read.csv(file = here("Data", "PacFin.csv"))
sapply(PacFIN_dat, class) 
```

```{r functions, include=FALSE}

meanfun <- function(x, ...){
  c(mean=mean(x, na.rm=TRUE, ...)) #, v=var(x, na.rm=TRUE, ...), l=length(x))
}

sumfun <- function(x, ...){
  c(sum=sum(x, na.rm=TRUE, ...)) #, v=var(x, na.rm=TRUE, ...), l=length(x))
}

sum_mean_fun <- function(x, ...){
  c(mean=mean(x, na.rm=TRUE, ...), sum=sum(x, na.rm=TRUE, ...)) #, l=length(x))
}

port_by_state <- function(state_name) {
  if (state_name == "ALL") {
    collapse <- PacFIN_dat %>%
    filter(Port == "BDA" | Port == "CBA" | Port == "CCA" | Port == "CLO" | Port == "ERA" | Port == "LAA" | Port == "MNA" | Port == "MRA" | Port == "NPA" | Port == "NPS" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
      filter(Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING") %>%
      mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "MRA", "SFA", "BDA", "ERA", "CCA", "CBA", "NPA", "CLO", "NPS"))
  }
  else {
    collapse <- PacFIN_dat %>%
    filter(Port == "BDA" | Port == "CBA" | Port == "CCA" | Port == "CLO" | Port == "ERA" | Port == "LAA" | Port == "MNA" | Port == "MRA" | Port == "NPA" | Port == "NPS" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
    filter(State == state_name & (Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING")) %>%
    mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "MRA", "SFA", "BDA", "ERA", "CCA", "CBA", "NPA", "CLO", "NPS"))
  }
  
  ggplot(collapse, aes(y=Landings, x=Landing_year, color=Species_code, group=Species_code)) +
  geom_line(size=1) + 
  facet_wrap(~ Port) +
  theme(legend.position="bottom") + 
  theme(axis.text.x = element_text(angle=90))
}

```

# Introduction

+ Research question:
  + **Big question:** What is the effect of climate change on fish landings? 
  + **Narrow question:** How does changes in the presence of sardine/anchovy/market squid/herring affect landings at ports located in the US west coast?

+ Contribution:
  + Interaction between species.
  + Better understanding of fishers species portfolio

# Coastal Pelagic Species fishery

Mean revenues by species are shown in Figure \ref{fig:plot_revenue}, while mean landings by species are shown in Figure \ref{fig:plot_landings}.

Figure \ref{fig:ts_landings} shows landing over time by species, while Figure \ref{fig:ts_prices} shows landing and prices over time for selected CPS species. 

```{r ts_landings, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Total annual landing by CPS species.\\label{fig:ts_landings}"}

collapse <- PacFIN_dat %>%
  filter(Management_group == "CPEL") %>%
  filter(Species_code != "PBNT" & Species_code != "CMCK" & Species_code != "JMCK" & Species_code != "RHRG" & Species_code != "UMCK")

collapse <- summaryBy(Landings + Price ~ Species_name  + Landing_year, FUN=sumfun, data=collapse) %>%
  dplyr::select(Landing_year, Price.sum, Landings.sum, Species_name) 

ggplot(collapse, aes(x = Landing_year, y = Landings.sum, group= Species_name, colour =  Species_name)) + 
  geom_line(size=1.5) +
  scale_y_continuous(name = "Landings (M Tons)")
```

```{r ts_landings_vessels, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Total annual landing by CPS species.\\label{fig:ts_landings}"}

collapse <- PacFIN_dat %>%
  filter(Management_group == "CPEL") %>%
  filter(Species_code != "PBNT" & Species_code != "RHRG" & Species_code != "UMCK")

collapse <- summaryBy(Landings + Price + N_vessels ~ Species_name  + Landing_year, FUN=sum_mean_fun, data=collapse) %>%
  dplyr::select(Landing_year, Landings.sum, N_vessels.mean, Species_name) 
coeff <- 1000
collapse$N_vessels.mean <- collapse$N_vessels.mean * coeff 
df <- gather(collapse, key = Variable, value = value,
             c("Landings.sum", "N_vessels.mean"))

# Plot
ggplot(df, aes(x=Landing_year, y = value, group = Variable, colour = Variable)) + 
geom_line(size=1) +
scale_y_continuous(name = "Landings (M Tons)", 
                   sec.axis = sec_axis(~./coeff, name = "Number of Vessels")) +
  facet_wrap(~Species_name)
```


```{r by_port,  fig.cap = "Landing by Port.", echo=FALSE, message=FALSE, warning=FALSE}
collapse <- summaryBy(Landings ~ Species_name + Species_code + Port + State, FUN=meanfun, data=PacFIN_dat) %>%
  filter(Port == "BDA" | Port == "CBA" | Port == "CCA" | Port == "CLO" | Port == "ERA" | Port == "LAA" | Port == "MNA" | Port == "MRA" | Port == "NPA" | Port == "NPS" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
  filter(Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING") %>%
  mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "MRA", "SFA", "BDA", "ERA", "CCA", "CBA", "NPA", "CLO", "NPS"))



ggplot(collapse, aes(fill=Species_code, y=Landings.mean, x=Port)) +
  geom_bar(position="dodge", stat="identity") + 
  facet_grid(~ State, scale="free", space="free_x") +
  theme(legend.position="bottom") + 
  scale_fill_viridis(discrete = T) + 
  theme(axis.text.x = element_text(angle=90))

```



```{r ts_by_port,  fig.cap = "Annual average landing by area port. \\textit{Notes:} BDA = Bodega Bay; BRA = Brookings; CBA = Coos Bay; CCA = Crescent City; CLO = Columbia River (OR); ERA = Eureka; LAA = Los Angeles; MNA = Monterey; MRA = Morro Bay; NPA = Newport; NPS = North Puget Sound; SBA = Santa Barbara; SDA = San Diego; SFA = San Francisco.", echo=FALSE, message=FALSE, warning=FALSE}

port_by_state("ALL")

```

```{r SDM_by_port,  fig.cap = "SDM mean for Pacific Sardine by area port. \\textit{Notes:} BDA = Bodega Bay; BRA = Brookings; CBA = Coos Bay; CCA = Crescent City; CLO = Columbia River (OR); ERA = Eureka; LAA = Los Angeles; MNA = Monterey; MRA = Morro Bay; NPA = Newport; NPS = North Puget Sound; SBA = Santa Barbara; SDA = San Diego; SFA = San Francisco.", echo=FALSE, message=FALSE, warning=FALSE}

collapse <- PacFIN_dat %>%
  filter(Species_code == "PSDN") %>%
  select(Landing_year, Port, PSDN_SDM, Landings) %>% 
  filter(Port == "CBA" | Port == "CLO" | Port == "LAA" | Port == "MNA" | Port == "NPA" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
      mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "SFA", "CBA", "NPA", "CLO"))

coeff <- 75000
collapse$PSDN_SDM <- collapse$PSDN_SDM * coeff 
df <- gather(collapse, key = Variable, value = value,
             c("Landings", "PSDN_SDM"))

# Plot
ggplot(df, aes(x=Landing_year, y = value, group = Variable, colour = Variable)) + 
geom_line(size=1) +
scale_y_continuous(name = "Landings (M Tons)", 
                   sec.axis = sec_axis(~./coeff, name = "SDM (Probability)")) +
  facet_wrap(~ Port) +
  theme(legend.position="bottom") + 
  theme(axis.text.x = element_text(angle=90)) + 
  theme(axis.text.x = element_text(size = 5)) +
  theme(axis.text.y = element_text(size = 5)) 

```

```{r SDM_by_port_msqd, echo=FALSE}
collapse <- PacFIN_dat %>%
  filter(Species_code == "MSQD") %>%
  select(Landing_year, Port, MSQD_SDM_90, Landings) %>% 
  filter(Port == "CBA" | Port == "CLO" | Port == "LAA" | Port == "MNA" | Port == "NPA" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
  filter(Landing_year > 1997) %>%
      mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "SFA", "CBA", "NPA", "CLO"))

coeff <- 75000
collapse$MSQD_SDM_90 <- collapse$MSQD_SDM_90 * coeff 
df <- gather(collapse, key = Variable, value = value,
             c("Landings", "MSQD_SDM_90"))

# Plot
ggplot(df, aes(x=Landing_year, y = value, group = Variable, colour = Variable)) + 
geom_line(size=1) +
scale_y_continuous(name = "Landings (M Tons)", 
                   sec.axis = sec_axis(~./coeff, name = "SDM (Probability)")) +
  facet_wrap(~ Port) +
  theme(legend.position="bottom") + 
  theme(axis.text.x = element_text(angle=90)) + 
  theme(axis.text.x = element_text(size = 5)) +
  theme(axis.text.y = element_text(size = 5)) 

```

```{r SDM_by_port_msqd_v2}
collapse <- PacFIN_dat %>%
  filter(Species_code == "MSQD") %>%
  select(Landing_year, Port, MSQD_SDM_90, Landings) %>% 
  filter(Port == "CBA" | Port == "CLO" | Port == "LAA" | Port == "MNA" | Port == "NPA" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
  filter(Landing_year > 1997) %>%
      mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "SFA", "CBA", "NPA", "CLO"))

df <- gather(collapse, key = Variable, value = value,
             c("MSQD_SDM_90"))

# Plot
ggplot(df, aes(x=Landing_year, y = value, group = Variable, colour = Variable)) + 
geom_line(size=1) +
scale_y_continuous(name = "SDM (Probability)") +
  facet_wrap(~ Port) +
  theme(legend.position="bottom") + 
  theme(axis.text.x = element_text(angle=90)) + 
  theme(axis.text.x = element_text(size = 5)) +
  theme(axis.text.y = element_text(size = 5)) 

```


# Empirical model

## Data 
We use as outcome variable landing data public available from [PacFIN](http://pacfin.psmfc.org/). It is a yearly panel data for the period 1980 - 2020 that contains landings of commercial species by ports located in the west coast of the United States (i.e. Washington, Oregon and California). 
 
Our main treatment variables are species presence. This variables were obtained from Species Distributiuon Models (SDM). Future forecast on this variable allows us to simulate a fishery in the future. 

Additional explanatory variables are the annual catch limit (ACL) for the species in consideration and  

Summary statistics for the whole data set is shown in Table 1.
```{r desc_table, echo=FALSE, results='asis'}
# Clean dataset
PacFIN_dat = PacFIN_dat[,!grepl("*_LE_",names(PacFIN_dat))]

est_data <- PacFIN_dat %>%
  filter(Species_name == "PACIFIC SARDINE"  |
           Species_name == "MARKET SQUID") %>% 
  melt(id.vars=c("Species_name", "State", "Species_code", "Landing_year", "Port", "Complex", "Management_group")) %>% 
  dcast(Landing_year + Port ~ Species_code + variable) %>%
  mutate(port_num = as.numeric(as.factor(Port))) %>%
  dplyr::rename(PSDN_SDM = PSDN_PSDN_SDM) %>%
  dplyr::rename(MSQD_SDM = MSQD_MSQD_SDM_60) %>%
  dplyr::rename(ACL_PSDN = PSDN_ACL_PSDN.sum) %>%
  dplyr::rename(ACL_MSQD = MSQD_ACL_MSQD.mean)

  # Change chr to numeric #
  est_data$PSDN_SDM      <- as.numeric(est_data$PSDN_SDM)
  est_data$MSQD_SDM      <- as.numeric(est_data$MSQD_SDM)
  est_data$PSDN_Landings <- as.numeric(est_data$PSDN_Landings)
  est_data$MSQD_Landings <- as.numeric(est_data$MSQD_Landings)
  est_data$ACL_PSDN <- as.numeric(est_data$ACL_PSDN)
  est_data$ACL_MSQD <- as.numeric(est_data$ACL_MSQD)
  
  
print(xtable(descr(PacFIN_dat, stats = c("mean", "sd", "min", "max"), transpose = TRUE, headings = TRUE), caption = 'Descriptive statistics.'), comment = FALSE, caption.placement = 'top')
```


## Model

In general, landings are conditional to biological stocks (affected by climate change), harvest cost, prices and regulations. 
 
* Outcome variable:
  + Pacific sardine landings by vessel, port and year. In this case we would predict landing by vessel $i$ that land in port $j$
  
* Treatment variable:
  + Change spatial distribution of species due to climate.  
    + @smith2021potential relate port-level landings to the probaility of presence from a sardine species distribution model (SDM), and then makes projection to quantify future changes in landings. 
    + Specifically, @smith2021potential use mean monthly probability of presence of sardine within 60 km of port. 

* Explanatory variables
  + Harvest costs (e.g., distances and fuel cost)
  + Own price and substitutes
  + Effort
    + Fishing effort from matching PacFIN data to Global Fishing Watch
    + "VESSEL_NUM" in PacFIN data: "It can be a USCG VID (ex: 1234567 or AK1234nn) or MISSING or UNKNOWN if vessel ID not provided or invalid. It is also “Null” if no vessel was used."
  + Regulations. 
    + Incorporate ACL in the model (@smith2021potential obtained this information from [CPS Fisheries Management Plan](pcouncil.org), and [Federal Register](federalregister.gov)), maybe with a function that have a ceiling limit, or as **censored data** ([Stan code](https://mc-stan.org/docs/2_18/stan-users-guide/censored-data.html)). 
    + Port capacity.
    + Closures.

* Random-coefficients?
  + By port: Different intercept / coefficient by vessel port.
  
* Some considerations:
  + Vessels likely to have contract with ports. Less flexibility where they land.
  + Harvest happen near-shore, less probability of longer trips if species move further. 
  + Multivariate framework allows us to consider interrelation between species and CPS fleet. 
      + Sardine harvest affect squid harvest?
      + If Sardine opens… Sardine more preferred? Sequentially or simultaneous harvest?
  
<!-- # print summary -->
<!-- texreg(list(f2, f3, r2, r3), caption = 'Panel data models for Pacific Sardine landings.\\label{table:sardine_est}', caption.above = TRUE, float.pos = "h", custom.model.names = c("FE: Model 1", "FE: Model 2", "RE: Model 1", "RE: Model 2")) -->
<!-- ``` -->

### Empirical strategy

  + Statistical model:
    + Bayesian hierarchical model
      + Hierarchical effects by port. 
      + Uncertainty from modeling the process (as well as from the imperfect observation of the process).
      + Model the zeros in data 
        + Included in the estimation. 
        + N/A landings were converted to zero.
        + Closures.
        + Port restrictions (i.e. no infrastructure)
    + @smith2021potential estimate with GAM framework (allows for non-linear relationships)
  
    + Some details:
      + Spatial autocorrelation between ports through species abundance? Between areas where vessel harvest? 
        + @morris2019bayesian include spatial errors in a bayesian framework.
        + How to deal with non-linearities
        + How far vessel travel for each species? (See animation [here](https://drive.google.com/file/d/1-PE_lcZNcXNcyILA_6xhkHyEhV3mV2TA/view?usp=sharing))
 
 
### Bayesian model  

<!-- + Would be great! - Multivariate probit model + Multivariate truncated model, with correlation between models.  -->
<!--   + No idea how to implemented it yet... -->

<!-- + Separate equation models: -->
<!--   + Multivariate probit model + Multivariate censored model (estimate then marginal effects together. What about standard errors?) -->
<!--   + Multivariate probit model (see stan model) + Univariate lognormal if just one species observed, multivariate lognormal if both observed (crash!!! trying to estimate efficient version presented in Stan manual for missing data.). -->
<!--   + Multivariate probit model + Univariate lognormal or truncated model -->

We estimate a Hierarchial Bayesian Hurdel model for each species. The model have the following structure:
\begin{align*}
[\alpha_i,\beta_i, \sigma^2_{\alpha}, \sigma^2_{\beta}, \Sigma | q_{i,t}] &  \varpropto \text{multivariate normal}(q_{i,t} | \alpha_i + \beta_i SDM_{i,t},\Sigma) \times \text{normal}(\alpha_i | \mu_{\alpha},\sigma^2_{\alpha})  \\ 
&   \times \text{normal}(\beta_i | \mu_{\beta},\sigma^2_{\beta}) \times [\mu_{\alpha}][\mu_{\beta}][\sigma^2_{\alpha}][\sigma^2_{\beta}][\Sigma],
\end{align*} 
where $q_{i,t}$ is the observed landings in port $i \in (1,\ldots,L)$ at year $t$, $L$ is the total number of ports, $SDM_{i,t}$ is the SDM output for sardine observed at port $i$ during the landing year $t$, $\alpha_i$ is the coefficient estimate by port,   $\beta_i$ is the effect of SDM on landing by port, and $\Sigma$ is a matrix covariances. 


+ Changes on estimations:
  + SDM outputs of Market Squid included (using first 60km within coast)
  + Separate equation depending on species
  + Time fixed effects included. 
  + Separate correlation matrix (0.37 positive correlation between sardine and squid)

# Results

## Pacific Sardine model

```{r psdn_data, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

###############################
## Pacific Sardine Equation ###
###############################

  # hist_psdn <- est_data %>%
  #   filter(MSQD_Landings>0) %>%
  #   mutate(log_land_psdn = MSQD_Landings)
  # 
  # hist(hist_psdn$log_land_psdn)
  
# Select data for estimation, replace N/A landings to zero #
est_data_psnd <- est_data %>%
  dplyr::select(port_num, Port, PSDN_SDM, MSQD_SDM, PSDN_Landings, Landing_year, ACL_PSDN) %>%
  dplyr::mutate(PSDN_Landings = coalesce(PSDN_Landings, 0)) %>% 
  filter(Landing_year >= 2000 & Landing_year < 2015)


# Select ports that at least they have landing PSDN once, and drop N/A #
Tot.landings.ports <- as.data.frame(cbind(rowsum(est_data_psnd$PSDN_Landings, est_data_psnd$Port, na.rm = TRUE)))

Tot.landings.ports <- Tot.landings.ports %>%
  mutate(dTotalPSDN = ifelse(V1>0, 1, 0)) %>%
  mutate(Port = rownames(Tot.landings.ports)) %>%
  dplyr::select(Port, dTotalPSDN)


### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###
est_data_psnd <- est_data_psnd %>%
  merge(Tot.landings.ports, by.x = "Port", by.y = "Port", all.x = TRUE, all.y = FALSE) %>%
  filter(dTotalPSDN==1) %>%
  # mutate(dSDA = ifelse(Port == "SDA", 1, 0)) %>%
  # filter(dSDA == 0) %>%
  drop_na()
  

# Create matrices and vectors to run STAN model #
year_id <- as.vector(cbind(as.numeric(factor(est_data_psnd$Landing_year))));
est_data_psnd$port_ID <- udpipe::unique_identifier(est_data_psnd, fields = "port_num", start_from = 1) 

portID_names <- est_data_psnd %>%
  dplyr::select(Port, port_ID) %>%
  unique()
```


```{r psdn_est, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
### Estimate using BRMS package ###

# Notes: BRMS cannot handle splines in group-level terms.

# fit_qPSDN_lognormal <- brm(
#   bf(PSDN_Landings ~ s(PSDN_SDM, MSQD_SDM, by = port_ID) + s(ACL_PSDN) + (1 | port_ID),
#                 hu ~ s(PSDN_SDM, MSQD_SDM, by = port_ID) + s(ACL_PSDN) + (1 | port_ID)),
#                           data = est_data_psnd,
#                           family = hurdle_lognormal(), 
#                           control = list(adapt_delta = 0.999, max_treedepth = 20),
#                           chains = 4, cores = 4)

est_data_psnd$port_ID <- as.numeric(est_data_psnd$port_ID)
class(est_data_psnd$port_ID)

fit_qPSDN_gamma <- brm(
  bf(PSDN_Landings ~ s(PSDN_SDM, MSQD_SDM, by = port_ID) + s(ACL_PSDN) + (1 | port_ID),
                hu ~ s(PSDN_SDM, MSQD_SDM, by = port_ID) + s(ACL_PSDN) + (1 | port_ID)),
                          data = est_data_psnd,
                          family = hurdle_gamma(), 
                          control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)

save.image (file = "stan_fit.RData")

# ##  Extract Grouo-Level estimates ##
# ranef(fit_qPSDN_gamma)
# 
# ## Check divergence and other model check ##
# launch_shinystan(fit_qPSDN_gamma) 
```

```{r y_rep_gamma, message=FALSE, warning=FALSE, fig.cap = "Graphical posterior predictive checks. (Gamma distribution)"}
pp_check(fit_qPSDN_gamma) + ggtitle('Gamma distribution') + theme(legend.position = "bottom")
```

### Effect of SDM's on Sardine landings

```{r int_effect_smooth, eval=FALSE, include=FALSE}
pseq_gamma <- plot(conditional_smooths(fit_qPSDN_gamma), plot = FALSE, ask = FALSE)
pseq_gamma[[1]] + pseq_gamma[[2]] + plot_layout(nrow = 2)

```

```{r PSDN_effect_total, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}

# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qPSDN_gamma, "PSDN_SDM", surface=TRUE), ask = FALSE)
```  

```{r MSQD_effect_total, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}

# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qPSDN_gamma, "MSQD_SDM", surface=TRUE), ask = FALSE)
```  

```{r ACL_effect, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qPSDN_gamma, "ACL_PSDN", surface=TRUE), ask = FALSE)
```  


### Results by port

```{r by_port_sdm_psdn}
conditions <- data.frame(port_ID = unique(est_data_psnd$port_ID))
rownames(conditions) <- unique(est_data_psnd$Port)
plot(conditional_effects(
  fit_qPSDN_gamma, "PSDN_SDM", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```


```{r by_port_msqd_sdm}
plot(conditional_effects(
  fit_qPSDN_gamma, "MSQD_SDM", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)

```

```{r by_port_acl_psdn}
plot(conditional_effects(
  fit_qPSDN_gamma, "ACL_PSDN", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)

```


### Interactive effects between Pacific Sardine and Market Squid SDMs

```{r int_effect_total, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}

# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qPSDN_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE), ask = FALSE)

# Investigate chain and posterior distributions. 
# https://cran.r-project.org/web/packages/bayesplot/vignettes/graphical-ppcs.html
# plot(fit_qPSDN_t2nc, pars = c("PSDN_SDM"))

# ### Predictions ###
# pred_data <- data.frame(PSDN_SDM = c(0.5, 0.25), MSQD_SDM = c(0.5), Port_ID = 1)
# predict(fit_qPSDN, newdata = pred_data, re_formula = NA)

# ## Compare models ##
# loo(fit1, fit2)

## Check https://www.pcouncil.org/stock-assessments-and-fishery-evaluation-safe-documents/ for ACL and closures.
```   

```{r by_port_both_sdm, echo=FALSE, message=FALSE, warning=FALSE}
plot(conditional_effects(
  fit_qPSDN_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```


## Market Squid model

```{r msqd_data_all, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

# Select data for estimation, replace N/A landings to zero #
est_data_msqd_all <- est_data %>%
  dplyr::select(port_num, Port, PSDN_SDM, MSQD_SDM, MSQD_Landings, Landing_year, ACL_MSQD) %>%
  dplyr::mutate(MSQD_Landings = coalesce(MSQD_Landings, 0)) %>% 
  filter(Landing_year >= 2000) %>%
  dplyr::mutate(dACL_MSQD= ifelse(Landing_year>=2004, 1, 0))


# Select ports that at least they have landing PSDN once, and drop N/A #
Tot.landings.ports <- as.data.frame(cbind(rowsum(est_data_msqd_all$MSQD_Landings, est_data_msqd_all$Port, na.rm = TRUE)))

Tot.landings.ports <- Tot.landings.ports %>%
  mutate(dTotalMSQD = ifelse(V1>0, 1, 0)) %>%
  mutate(Port = rownames(Tot.landings.ports)) %>%
  dplyr::select(Port, dTotalMSQD)


### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###
est_data_msqd_all <- est_data_msqd_all %>%
  merge(Tot.landings.ports, by.x = "Port", by.y = "Port", all.x = TRUE, all.y = FALSE) %>%
  filter(dTotalMSQD==1) %>%
  drop_na() %>%
  mutate(dClose = ifelse(Landing_year >= 2015,1,0))
  
# Create matrices and vectors to run STAN model #
year_id <- as.vector(cbind(as.numeric(factor(est_data_msqd_all$Landing_year))));
est_data_msqd_all$port_ID <- udpipe::unique_identifier(est_data_msqd_all, fields = "port_num", start_from = 1) 

portID_names_all <- est_data_msqd_all %>%
  dplyr::select(Port, port_ID) %>%
  unique()
```

```{r msqd_est, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
### Estimate using BRMS package ###
est_data_msqd_all$dACL_MSQD <- factor(est_data_msqd_all$dACL_MSQD)
est_data_msqd_all$dClose    <- factor(est_data_msqd_all$dClose)
est_data_msqd_all$port_ID   <- as.numeric(est_data_msqd_all$port_ID)
class(est_data_msqd_all$dACL_MSQD)
class(est_data_msqd_all$dClose)
class(est_data_msqd_all$port_ID)

fit_qMSQD_gamma_dClose <- brm(
  bf(MSQD_Landings ~ s(PSDN_SDM, MSQD_SDM, by = port_ID) + dClose + (dClose +  1 | port_ID),
                hu ~ s(PSDN_SDM, MSQD_SDM, by = port_ID) + dClose + (dClose +  1 | port_ID)),
                       data = est_data_msqd_all,
                       family = hurdle_gamma(),
                       control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)

fit_qMSQD_gamma <- brm(
  bf(MSQD_Landings ~ s(PSDN_SDM, MSQD_SDM, by = port_ID) + (1 | port_ID),
                hu ~ s(PSDN_SDM, MSQD_SDM, by = port_ID) + (1 | port_ID)),
                       data = est_data_msqd_all,
                       family = hurdle_gamma(), 
                       control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)

save.image (file = "stan_fit.RData")

LOO(fit_qMSQD_gamma, fit_qMSQD_gamma_dClose)

# ##  Extract Grouo-Level estimates ##
# ranef(fit_qPSDN_gamma)
# 
# ## Check divergence and other model check ##
# launch_shinystan(fit_qPSDN_gamma) 
```


```{r model-comp-msqd, message=FALSE, warning=FALSE, results='asis'}
fit_qMSQD_gamma <- add_criterion(fit_qMSQD_gamma, "loo")
fit_qMSQD_gamma_dClose <- add_criterion(fit_qMSQD_gamma_dClose, "loo")

comp <- loo_compare(loo(fit_qMSQD_gamma), loo(fit_qMSQD_gamma_dClose)) %>%
  as.data.frame() %>%
  select(elpd_loo, elpd_diff, se_diff, p_loo, looic) %>%
  dplyr::rename(
    "ELPD-Diff" = elpd_diff, "SE-Diff" = se_diff, 
    "ELPD-LOO" = elpd_loo, "P-LOO" = p_loo, "LOOIC" = looic
  )

mw1 <- model_weights(fit_qMSQD_gamma, fit_qMSQD_gamma_dClose, weights = "loo")[rownames(comp)]

comp %>%
  cbind("Akaike-Weight" = mw1) %>%
  apa_table(
    format = "latex", booktabs = TRUE, digits = 2,
    caption = "Comparison of models fit1 to fit3 based on approximate leave-one-out cross-validation. Market squid landigns model.",
    note =  "ELPD-LOO = expected log posterior predictive density (higher is better); ELPD-DIFF = difference in ELPD values compared to the best model. SE-DIFF = standard error of the ELPD difference. P-LOO = effective number of model parameters (lower is better); LOOIC: leave-one-out information criterion (lower is better); Akaike-Weight = Model weight based on the LOOIC values (higher is better).",
    align = c("l", rep("r", 6))
  )
```


### Compare models 
```{r y_rep_logn_msqd, message=FALSE, warning=FALSE, fig.cap = "Graphical posterior predictive checks for Market Squid landings model. (Gamma distribution)"}
pp_check(fit_qMSQD_gamma_dClose) + ggtitle('Gamma distribution + dClose') + theme(legend.position = "bottom")
```

### Compare models 
```{r y_rep_gamma_msqd, message=FALSE, warning=FALSE, fig.cap = "Graphical posterior predictive checks for Market Squid landings model. (Gamma distribution)"}
pp_check(fit_qMSQD_gamma) + ggtitle('Gamma distribution') + theme(legend.position = "bottom")
```


### Effect of SDM's on Market SquidSardine landings

```{r PSDN_effect_total_msqd, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Conditional effect of SDMs on Pacific Sardine landings."}

# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qMSQD_gamma_dClose, "PSDN_SDM", surface=TRUE), ask = FALSE)
```  

```{r MSQD_effect_total_msqd, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Conditional effect of SDMs on Pacific Sardine landings."}

# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qMSQD_gamma_dClose, "MSQD_SDM", surface=TRUE), ask = FALSE)
```  

```{r ACL_effect_msqd, echo=FALSE, fig.cap="Effect ACL on MSQD", message=TRUE, warning=TRUE}
# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qMSQD_gamma_dClose, "dClose"), ask = FALSE)
```  


### Results by port

```{r by_port_sdm_msdq}
conditions <- data.frame(port_ID = unique(est_data_msqd$port_ID))
rownames(conditions) <- unique(est_data_msqd$Port)
plot(conditional_effects(
  fit_qMSQD_gamma_dClose, "PSDN_SDM", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```



```{r by_port_msqd_sdm_msqd}
plot(conditional_effects(
  fit_qMSQD_gamma_dClose, "MSQD_SDM", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)

```

```{r by_port_msqd_sdm_msqd}
plot(conditional_effects(
  fit_qMSQD_gamma_dClose, "dClose", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)

```


### Interactive effects between Pacific Sardine and Market Squid SDMs

```{r int_effect_total_msqd, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Conditional effect of SDMs on Pacific Sardine landings."}

# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qMSQD_gamma_dClose, "PSDN_SDM:MSQD_SDM", surface=TRUE), ask = FALSE)

# Investigate chain and posterior distributions. 
# https://cran.r-project.org/web/packages/bayesplot/vignettes/graphical-ppcs.html
# plot(fit_qPSDN_t2nc, pars = c("PSDN_SDM"))

# ### Predictions ###
# pred_data <- data.frame(PSDN_SDM = c(0.5, 0.25), MSQD_SDM = c(0.5), Port_ID = 1)
# predict(fit_qPSDN, newdata = pred_data, re_formula = NA)

# ## Compare models ##
# loo(fit1, fit2)

## Check https://www.pcouncil.org/stock-assessments-and-fishery-evaluation-safe-documents/ for ACL and closures.
```   

```{r by_port_both_sdm_msqd, echo=FALSE, message=FALSE, warning=FALSE}
plot(conditional_effects(
  fit_qMSQD_gamma_dClose, "PSDN_SDM:MSQD_SDM", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```


# Conclusions


# Appendix 

```{r int_effect_sep, eval=FALSE, fig.cap=, include=FALSE}

hu <- plot(conditional_effects(fit_qPSDN_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="hu"),
           plot = FALSE, ask = FALSE)
mu <- plot(conditional_effects(fit_qPSDN_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="mu"),
           plot = FALSE, ask = FALSE)

mu[[1]] + hu[[1]] + plot_layout(nrow = 2)

```

```{r int_effect_sep_msqd, eval=FALSE, fig.cap=, include=FALSE}

hu <- plot(conditional_effects(fit_qMSQD_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="hu"),
           plot = FALSE, ask = FALSE)
mu <- plot(conditional_effects(fit_qMSQD_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="mu"),
           plot = FALSE, ask = FALSE)

mu[[1]] + hu[[1]] + plot_layout(nrow = 2)

```




