---
title: "Catch Subtitution between Coastal Pelagic Species under Climate Change Scenarios"
author:
  - name: Felipe Quezada
    email: felipe.quezada@noaa.gov
    institute: [ucsc, noaa]
    correspondence: true
  # - name: Desiree Tommasi
  #   institute: [ucsc, noaa]
  # - name: Stephen Stohs
  #   institute: noaa
institute:
  - ucsc: Institute of Marine Sciences, University of California Santa Cruz
  - noaa: NOAA Southwest Fisheries Science Center
date: "`r format(Sys.time(), '%B %e, %Y')`"
abstract: "Fisher do not only catch one species. They have a set of possible choices, called 'fishing portfolio'. Some species are easier to shift as gear and method used are similar between them. Therefore, the cost of shifting between species is low and fishers could adapt quickly to a shift in fish species spatial distributions in response to climate change. Nevertheless, it is not clear whether actually this substitution happen as other constraint may be in play. Port constraints, as well as market characteristics could reduce substitution between species. In this study we analyze how changing in spatial distribution affects landing subtitution between three coastal pelagic species: Pacific sardine, market squid and Northern anchovy. We primary focus on the substitution that ocur between these species, and we project change on catch composition due to future climate change."
header-includes:
  \usepackage{mathtools}
  \usepackage{tcolorbox}
  \usepackage{float}
  \floatplacement{figure}{H}
  \usepackage{times}
  \usepackage{setspace}
  \setstretch{1.5}
output:
  pdf_document:
    number_sections: yes
    citation_package: natbib
    pandoc_args:
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
bibliography: references.bib
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
rm(list = ls(all.names = TRUE)) 
gc()
load("stan_fit.RData")

library(bookdown)
library(brms)
library(cmdstanr)
library(doBy)
library(dplyr)
library(fastDummies)
library(ggplot2)
library(here)
library(hrbrthemes)
library(kableExtra)
library(lmtest)
library(lubridate)
library(magrittr)
library(Rcpp)
library(patchwork)
library(plm)
library(papaja)
library(reshape)
library(reshape2)
library(rstan)
library(scales)
library(sjlabelled)
library(texreg)
library(tidyr)
library(tidyverse)
library(tinytex)
library(viridis)
library(xtable)
library(zoo)
```

```{r read_data, include=FALSE} 
PacFIN_dat <- read.csv(file = here::here("Data", "PacFin.csv"))
sapply(PacFIN_dat, class) 
```

```{r functions, include=FALSE}

meanfun <- function(x, ...){
  c(mean=mean(x, na.rm=TRUE, ...)) #, v=var(x, na.rm=TRUE, ...), l=length(x))
}

sumfun <- function(x, ...){
  c(sum=sum(x, na.rm=TRUE, ...)) #, v=var(x, na.rm=TRUE, ...), l=length(x))
}

sum_mean_fun <- function(x, ...){
  c(mean=mean(x, na.rm=TRUE, ...), sum=sum(x, na.rm=TRUE, ...)) #, l=length(x))
}

port_by_state <- function(state_name) {
  if (state_name == "SOME") {
    collapse <- PacFIN_dat %>%
    filter(Port == "CLO" | Port == "LAA" | Port == "MNA" | Port == "SBA" | Port == "SFA") %>%
    filter(Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING") %>%
    mutate(Port = fct_relevel(Port, "LAA", "SBA", "MNA", "SFA", "CLO"))
  }
  if (state_name == "ALL") {
    collapse <- PacFIN_dat %>%
    filter(Port == "BDA" | Port == "CBA" | Port == "CCA" | Port == "CLO" | Port == "ERA" | Port == "LAA" | Port == "MNA" | Port == "MRA" | Port == "NPA" | Port == "NPS" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
    filter(Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING") %>%
    mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "MRA", "SFA", "BDA", "ERA", "CCA", "CBA", "NPA", "CLO", "NPS"))
  }
  else {
    collapse <- PacFIN_dat %>%
    filter(Port == "BDA" | Port == "CBA" | Port == "CCA" | Port == "CLO" | Port == "ERA" | Port == "LAA" | Port == "MNA" | Port == "MRA" | Port == "NPA" | Port == "NPS" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
    filter(State == state_name & (Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING")) %>%
    mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "MRA", "SFA", "BDA", "ERA", "CCA", "CBA", "NPA", "CLO", "NPS"))
  }
  
  ggplot(collapse, aes(y=Landings, x=Landing_year, color=Species_code, group=Species_code)) +
  geom_line(size=1) + 
  facet_wrap(~ Port) +
  theme(legend.position="bottom") + 
  theme(axis.text.x = element_text(angle=90))
}

```

# Introduction
Fishing portfolios are an important mechanism to safeguard fishers livelihood. Diversification strategy have been principally associated to reducing income variability. For instance, when a species abundance is reduced due to environmental conditions, fisher can change the targeted species. However, there is no always room for diversification. Switching between species can be costly if gears are quite different between species, or a new permit is required for legal fishing. Moreover, even though fisher may have flexibility switching between species, port infrastructure and markets may impose some restrictions on this flexibility. Therefore, it is not clear how change in species distribution would be reflected in landings.

In this study we analyze how changing in spatial distribution affects landing substitutions between three coastal pelagic species (CPS): Pacific sardine (PSDN), market squid (MSQD) and Northern anchovy (NANC). Moreover, using climate projections we can predict how catch composition is affected under climate change. Our analysis is focused on the US west coast CPS fishery. 

Our papers builds on the model developed by @smith2021potential for sardine landings.  We expand their research Fisheries historically have been analyzed as single species. We expand their model including a landing equation for all of the three species analyzed. Moreover, we use the probability of presence obtained from Species Distribution Models (SDM) as explanatory variable instead of landing by species. This allows us to project landing over time using SDM predictions for different climate scenarios. Additionally, we analyze how species distribution interact between each others. We expect that this additions allows us to characterize better how fishers portfolio is composed, and also to understand better species interactions on catch rates. 

The remainder of the paper is organized as follows: Section \ref{coastal-pelagic-species-fishery} provides background on the CPS fishery in the US west coast. In Section \ref{methods} we discusses our data set and empirical strategy. Section \ref{results} presents the results of the estimations, and we conclude in Section \ref{conclusions}.


# Coastal Pelagic Species fishery 

Before Pacific sardine closure in 2015, the CPS fishery have been mainly dominated by Pacific sardine and market squid in landings (see Figure \ref{fig:avg_lan_rev}). In terms of revenue, due to the low prices received for sardine, the revenues in the CPS fishery are the highest for market squid. 

```{r avg_landings, echo=FALSE, fig.cap="Average annual landing and revenues for the CPS fishery by species.\\label{fig:avg_lan_rev}", message=FALSE, warning=FALSE}
landings <- summaryBy(Landings ~ Species_code + Landing_year + Management_group, FUN=sumfun, data=PacFIN_dat) %>%
  filter(Management_group == "CPEL") %>%
  filter(Species_code != "PBNT" & Species_code != "CMCK" & 
           Species_code != "JMCK" & Species_code != "RHRG" & Species_code != "UMCK")

landings <- summaryBy(Landings.sum ~ Species_code, FUN=meanfun, data=landings)

g1 <- ggplot(landings, aes(Species_code, Landings.sum.mean)) +
  geom_col(width=0.4) + ggtitle("(a) Landings") + 
  theme(plot.title = element_text(size=9, face="bold.italic")) +
  xlab("Port areas") + ylab("Landings (tons)")


revenue <- summaryBy(Revenue ~ Species_code + Landing_year + Management_group, FUN=sumfun, data=PacFIN_dat) %>%
  filter(Management_group == "CPEL") %>%
  filter(Species_code != "PBNT" & Species_code != "CMCK" & 
           Species_code != "JMCK" & Species_code != "RHRG" & Species_code != "UMCK")

revenue <- summaryBy(Revenue.sum ~ Species_code, FUN=meanfun, data=revenue)


g2 <- ggplot(revenue, aes(Species_code, Revenue.sum.mean)) +
  geom_col(width=0.4) + ggtitle("(b) Revenue") + 
  theme(plot.title = element_text(size=9, face="bold.italic")) +
  xlab("Port areas") + ylab("Revenues (USD)")


g1 + g2
```
```{r ts_landings, eval=FALSE, fig.cap="Total annual landing by CPS species.\\label{fig:ts_landings}", message=FALSE, warning=FALSE, include=FALSE}
collapse <- PacFIN_dat %>%
  filter(Management_group == "CPEL") %>%
  filter(Species_code != "PBNT" & Species_code != "CMCK" & Species_code != "JMCK" & Species_code != "RHRG" & Species_code != "UMCK")

collapse <- summaryBy(Landings + Price ~ Species_name  + Landing_year, FUN=sumfun, data=collapse) %>%
  dplyr::select(Landing_year, Price.sum, Landings.sum, Species_name) 

ggplot(collapse, aes(x = Landing_year, y = Landings.sum, group= Species_name, colour =  Species_name)) + 
  geom_line(size=1.5) +
  scale_y_continuous(name = "Landings (M Tons)")
```

```{r ts_landings_vessels, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
collapse <- PacFIN_dat %>%
  filter(Management_group == "CPEL") %>%
  filter(Species_code != "PBNT" & Species_code != "RHRG" & Species_code != "UMCK")

collapse <- summaryBy(Landings + Price + N_vessels ~ Species_name  + Landing_year, FUN=sum_mean_fun, data=collapse) %>%
  dplyr::select(Landing_year, Landings.sum, N_vessels.mean, Species_name) 
coeff <- 1000
collapse$N_vessels.mean <- collapse$N_vessels.mean * coeff 
df <- gather(collapse, key = Variable, value = value,
             c("Landings.sum", "N_vessels.mean"))

# Plot
ggplot(df, aes(x=Landing_year, y = value, group = Variable, colour = Variable)) + 
geom_line(size=1) +
scale_y_continuous(name = "Landings (M Tons)", 
                   sec.axis = sec_axis(~./coeff, name = "Number of Vessels")) +
  facet_wrap(~Species_name)
```

Landings composition varies geographically. We show in Figure \ref{fig:avg_landings_by_ports} average annual landings by ports areas. We can observe that market squid is mostly landed in the southern ports located in Los Angeles, Santa Barbara and Monterrey areas, while Pacific sardine is mainly landed in Los Angeles and Monterrey areas in California, and also in the Columbia river area in Oregon. Substitution between species seems to be more likely in Los Angeles, Monterrey and Santa Barbara area ports (and in some lower scale at San Francisco area) as positive values for market squid, Pacific sardine and Northern anchovy landings are observed. 

```{r avg_landings_by_port, echo=FALSE, fig.cap="Annual average landings by port area.\\label{fig:avg_landings_by_ports}", message=FALSE, warning=FALSE}
collapse <- summaryBy(Landings ~ Species_name + Species_code + Port + State, FUN=meanfun, data=PacFIN_dat) %>%
  filter(Port == "BDA" | Port == "CBA" | Port == "CCA" | Port == "CLO" | Port == "ERA" | Port == "LAA" | Port == "MNA" | Port == "MRA" | Port == "NPA" | Port == "NPS" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
  filter(Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING") %>%
  mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "MRA", "SFA", "BDA", "ERA", "CCA", "CBA", "NPA", "CLO", "NPS"))

ggplot(collapse, aes(fill=Species_code, y=Landings.mean, x=Port)) +
  geom_bar(position="dodge", stat="identity") + 
  facet_grid(~ State, scale="free", space="free_x") +
  theme(legend.position="bottom") + 
  scale_fill_viridis(discrete = T) + 
  theme(axis.text.x = element_text(angle=90)) + 
  xlab("Port areas") + ylab("Landings (tons)") +
  guides(fill=guide_legend(title="Species: ")) +
  scale_color_brewer(palette="Set2")
```

To analyze substitution more in detail, we compute total annual landing by port during 1980-2020 period (Figure \ref{fig:ts_landings_by_ports}). There is a general conception that vessel that harvest Pacific sardine switch to market squid when the conditions are favorable. However, we can notice from Figure \ref{fig:ts_landings_by_ports} that landings of market squid have been decreasing in the last five years. We would expect that the closure of the Pacific sardine fishery would have switch targeted species, but the graphs show some complementary instead of substitution. Under this scenario is useful to ask to ask whether after the closure, vessel that harvest Market squid left the fishery or stayed. We show the number of vessels by species in Figure \ref{fig:ts_n_vessels}. 


```{r ts_by_port,  fig.cap = "Total annual landing by port area. 2000 - 2020. \\textit{Notes:} CLO = Columbia River (OR); LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara; SFA = San Francisco.\\label{fig:ts_landings_by_ports}" , echo=FALSE, message=FALSE, warning=FALSE}

collapse <- PacFIN_dat %>%
    filter(Port == "CLO" | Port == "LAA" | Port == "MNA" | Port == "SBA" | Port == "SFA") %>%
    filter(Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | 
             Species_name == "MARKET SQUID") %>%
    mutate(Port = fct_relevel(Port, "LAA", "SBA", "MNA", "SFA", "CLO")) %>%
  filter(Landing_year >= 2000 & Landing_year <= 2020)

ggplot(collapse, aes(y=Landings, x=Landing_year, color=Species_code, group=Species_code)) +
  geom_line(size=1) + xlab("Port areas") + ylab("Landings (tons)") + 
  facet_wrap(~ Port) +
  theme(legend.position="bottom") + 
  theme(axis.text.x = element_text(angle=90)) +
  guides(color=guide_legend(title="Species: ")) +
  scale_color_brewer(palette="Set2")
```

```{r ts_n_vessels, fig.cap = "Total number of vessel by species. 2000 - 2020.\\label{fig:ts_n_vessels}", echo=FALSE, message=FALSE, warning=FALSE}
collapse <- PacFIN_dat %>%
  filter(Management_group == "CPEL") %>%
  filter(Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | 
           Species_name == "MARKET SQUID") %>%
  filter(Landing_year >= 2000 & Landing_year <= 2020)

collapse <- summaryBy(N_vessels ~ Species_name  + Landing_year, FUN=meanfun, data=collapse) 

# Plot
ggplot(collapse, aes(x=Landing_year, y = N_vessels.mean,  colour = Species_name)) + 
  geom_line(size=1) +
  scale_y_continuous(name = "Number of vessels") +
  facet_wrap(~Species_name) + theme(legend.position="bottom") +
  guides(colour=guide_legend(title="Species: ")) +
  scale_color_brewer(palette="Set2") + 
  theme(legend.position="none") + xlab("Year") 
```

# Methods

## Data 
Our data set contain a number of variables measured at the port and *vessel levels* for CPS the fishery located in the U.S. West Coast. Our outcome variables are landings by port areas in a year and landing by vessel in a month. These two different outcome variables would allows us to study the degree of flexibility that vessel have in comparison to ports in regard to species substitution and catch composition. If vessels have strong contracts with processor associated with a port, then we should observe that substitution of vessels and port is similar. Yearly panel data data on landing by port areas during the the period 1980 - 2020 is publicly available from [PacFIN](http://pacfin.psmfc.org/). **Vessel level data was obtained upon request from...** We only include ports areas where substitution could happen. In practical terms, we drop port that have never landed either Pacific sardine, market squid or Northern anchovy during our period of analysis.^[N/A were converted to zero.] We assume that this criteria would allows to identify ports that have the infrastructure to land all of the species in consideration.

Our main treatment variables are species probability of presence. This variables were obtained from Species Distribution Models (SDM), and future forecast of these variables allows us to simulate the CPS fishery in the future. Prior landings models have shown that the probability of presence have a large contribution on explaining landings. For instance, @smith2021potential use mean monthly probability of presence of sardine within 60 km of the port as explanatory variable. They found a positive effect of probability of presence on Pacific sardine landings. Moreover, landings where mostly explained by this variable. We follow their same procedure to associate SDM's outputs with ports. For Pacific sardine, we compute the average probability of presence within the same radius of 60 kilometers around the port. This radious also coincide with the average distance with two standard deviation traveled by vessels based on logbook availables for this fisheries. For market squid and Northern anchovy, we set this radius to 90 km. We also use logbook in the case or market squid, while for the Northern anchovy, the optimal distance for Northern anchovy was chosen empirically.^[To see an animation of how far vessel travel please visit [this link](https://drive.google.com/file/d/1-PE_lcZNcXNcyILA_6xhkHyEhV3mV2TA/view?usp=sharing).]   

Figure \ref{fig:sdm_land_by_port} show the relationship between the probability of presence and landings by species in three main port areas: Los Angeles, Monterrey and Santa Barbara areas. The graph suggest that Pacific sardine landings are positive correlated with the probability of presence of this species, similar to @smith2021potential. This is also true in Monterrey area for the Northern anchovy, In the case of market squid, we cannot distinguish correlation between landings and probability of presence. Note, however, that the evidence shown in this figure may not capturing the actual effect of the probability of presence as other effect may be in play. Our empirical strategy is designed to isolate the effect of the probability on landing in a multivariate model framework.

```{r SDM_land_by_port, echo=FALSE, fig.cap="Landings v/s probability of presence by port area. \\textit{Notes:} LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara.\\label{fig:sdm_land_by_port}", message=FALSE, warning=FALSE}

collapse <- PacFIN_dat %>%
  filter(Species_code == "PSDN" | Species_code == "MSQD"  | Species_code == "NANC") %>%
  dplyr::select(Landing_year, Port, PSDN_SDM_60, MSQD_SDM_90, NANC_SDM_20, Landings, Species_code) %>% 
  filter(Port == "LAA" | Port == "MNA" | Port == "SBA") %>%
      mutate(Port = fct_relevel(Port, "LAA", "SBA", "MNA")) %>% 
  spread(Species_code, Landings) %>% 
  dplyr::rename(Landings_PSDN = PSDN) %>% dplyr::rename(Landings_MSQD = MSQD) %>% dplyr::rename(Landings_NANC = NANC) %>%
  filter(Landing_year >= 2000 & Landing_year <= 2018)
  
# Plot
coeff <- 50000
g1 <- ggplot(collapse) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_PSDN),
            size = 0.5, color = "grey") +
  geom_line(mapping = aes(x = Landing_year, y = PSDN_SDM_60*coeff), 
            size = 0.5, color = "blue", linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = element_blank(), labels = NULL) +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff, name = "")) +
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(a) Pacific sardine")

g2 <- ggplot(collapse) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_MSQD),
            size = 0.5, color = "grey") +
  geom_line(mapping = aes(x = Landing_year, y = MSQD_SDM_90*coeff), 
            size = 0.5, color = "blue", linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = element_blank(), labels = NULL) +
  scale_y_continuous(name = "Landings", sec.axis = sec_axis(~./coeff, name = "P(presence)")) +
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(b) Market squid")

g3 <- ggplot(collapse) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_NANC, color = "Landings"),
            size = 0.5) +
  geom_line(mapping = aes(x = Landing_year, y = NANC_SDM_20*coeff, color = "Probability of presence"), 
            size = 0.5, linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = "Year", labels = NULL) +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff, name = element_blank())) +
  theme(legend.position="bottom", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(c) Northern anchovy") +  scale_color_manual(name = "Variable: ", 
                     values = c("Landings" = "grey", "Probability of presence" = "blue"))

g1 / g2 / g3

```

```{r SDM_land_by_port_NANC, eval=FALSE, fig.cap="Landings v/s probability of presence by port area. \\textit{Notes:} LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara.\\label{fig:sdm_land_by_port}", message=FALSE, warning=FALSE, include=FALSE}

collapse <- PacFIN_dat %>%
  filter(Species_code == "NANC") %>%
  dplyr::select(Landing_year, Port, NANC_SDM_20_sep_dec, Landings, Species_code) %>% 
  filter(Port == "MNA") %>% mutate(Port = fct_relevel(Port, "MNA")) %>% 
  spread(Species_code, Landings) %>% dplyr::rename(Landings_NANC = NANC) %>%
  filter(Landing_year >= 2000 & Landing_year <= 2018)
  
# Plot
coeff <- 50000
g3 <- ggplot(collapse) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_NANC, color = "Landings"),
            size = 0.5) +
  geom_line(mapping = aes(x = Landing_year, y = NANC_SDM_20_sep_dec*coeff, color = "Probability of presence"), 
            size = 0.5, linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = "Year") +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff, name = element_blank())) +
  theme(legend.position="bottom", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("Northern anchovy") +  scale_color_manual(name = "Variable: ", 
                     values = c("Landings" = "grey", "Probability of presence" = "blue"))

g3


collapse2 <- as.data.frame(diff(collapse$NANC_SDM_20_sep_dec))
  names(collapse2)[1] <- 'NANC_SDM_20_sep_dec'
  collapse2 <- collapse2 %>% mutate(Landings_NANC = diff(collapse$Landings_NANC)) %>% mutate(Port = "MNA") %>%
    mutate(Landing_year = seq(2001,2018))

dg3 <- ggplot(collapse2) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_NANC, color = "diff(Landings)"),
            size = 0.5) +
  geom_line(mapping = aes(x = Landing_year, y = NANC_SDM_20_sep_dec*coeff, color = "diff(Probability of presence)"), 
            size = 0.5, linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = "Year") +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff, name = element_blank())) +
  theme(legend.position="bottom", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("Northern anchovy (first differences)") +  scale_color_manual(name = "Variable: ", 
                     values = c("diff(Landings)" = "grey", "diff(Probability of presence)" = "blue"))

dg3


library("writexl")
write_xlsx(collapse,"Data\\monterrey_NANC_sdm_landings.xlsx")

```

Beside the biological stock, landings are affected by socio-economics conditions. Some of them are harvest cost, prices received by species and their substitutes, and regulations imposed by the authorities. In our data we include as a proxy of harvest cost average distances traveled by vessel from the port of origin *(TO BE INCLUDED USING GLOBAL FISHING WATCH...)* and fuel cost *(TO BE INCLUDED...)*. Own price was included and it was obtained from PacFIN landings dataset. When price was missing, we replace this value for the average price of the species in all ports for the corresponding year. We include the Annual Catch Limit (ACL) for the Pacific sardine model. The ACL for Pacific sardine were obtained from the [CPS Fisheries Management Plan](pcouncil.org)???. 
A summary statistics of our data set is shown in Table \ref{tab:sum_stats}.

```{r desc_table, echo=FALSE, results='asis'}
# Clean dataset
PacFIN_dat = PacFIN_dat[,!grepl("*_LE_",names(PacFIN_dat))]
PacFIN_dat <- PacFIN_dat %>%
  filter(Species_code == "PSDN" | Species_code == "MSQD"  | Species_code == "NANC") %>%
  dplyr::select(Landing_year, Port, PSDN_SDM_60, MSQD_SDM_90, NANC_SDM_20, ACL_PSDN.sum,
         Landings, Price, Revenue, Species_code) %>% 
  melt(id.vars=c("Species_code", "Landing_year", "Port")) %>% 
  dcast(Landing_year + Port ~ Species_code + variable) %>%
  mutate(port_num = as.numeric(as.factor(Port))) %>%
  dplyr::rename(PSDN_SDM_60 = PSDN_PSDN_SDM_60) %>%
  dplyr::rename(MSQD_SDM_90 = MSQD_MSQD_SDM_90) %>%
  dplyr::rename(NANC_SDM_20 = NANC_NANC_SDM_20) %>%
  dplyr::rename(ACL_PSDN = PSDN_ACL_PSDN.sum) %>%
  filter(Landing_year >= 2000 & Landing_year <= 2018)
  
est_data = subset(PacFIN_dat, select = -c(MSQD_PSDN_SDM_60, MSQD_NANC_SDM_20, MSQD_ACL_PSDN.sum, 
                                          NANC_PSDN_SDM_60, NANC_MSQD_SDM_90, NANC_ACL_PSDN.sum,
                                          PSDN_MSQD_SDM_90, PSDN_NANC_SDM_20))

# Calculate year price for N/A's
price.year.PSDN <- aggregate(x= est_data$PSDN_Price, by = list(est_data$Landing_year), FUN = mean, na.rm=T)
  price.year.PSDN <- price.year.PSDN %>%
    dplyr::rename(Landing_year = Group.1) %>%
    dplyr::rename(PSDN_Price.year = x)
  
price.year.MSQD <- aggregate(x= est_data$MSQD_Price, by = list(est_data$Landing_year), FUN = mean, na.rm=T)
  price.year.MSQD <- price.year.MSQD %>%
    dplyr::rename(Landing_year = Group.1) %>%
    dplyr::rename(MSQD_Price.year = x)

price.year.NANC <- aggregate(x= est_data$NANC_Price, by = list(est_data$Landing_year), FUN = mean, na.rm=T)
  price.year.NANC <- price.year.NANC %>%
    dplyr::rename(Landing_year = Group.1) %>%
    dplyr::rename(NANC_Price.year = x)
    
est_data <- est_data %>%
  left_join(price.year.PSDN, by = "Landing_year") %>%
    left_join(price.year.MSQD, by = "Landing_year") %>%
    left_join(price.year.NANC, by = "Landing_year") %>%
  mutate(PSDN_Price_full = ifelse(is.na(PSDN_Price), PSDN_Price.year, PSDN_Price)) %>%
    mutate(MSQD_Price_full = ifelse(is.na(MSQD_Price), MSQD_Price.year, MSQD_Price)) %>%
    mutate(NANC_Price_full = ifelse(is.na(NANC_Price), NANC_Price.year, NANC_Price)) %>%
  subset(select = -c(PSDN_Price, MSQD_Price, NANC_Price, PSDN_Price.year, MSQD_Price.year, NANC_Price.year)) %>%
    dplyr::rename(PSDN_Price = PSDN_Price_full) %>% 
    dplyr::rename(MSQD_Price = MSQD_Price_full) %>%
    dplyr::rename(NANC_Price = NANC_Price_full)


# Change chr to numeric #
est_data$PSDN_SDM_60   <- as.numeric(est_data$PSDN_SDM_60)
est_data$MSQD_SDM_90   <- as.numeric(est_data$MSQD_SDM_90)
est_data$NANC_SDM_20   <- as.numeric(est_data$NANC_SDM_20)
est_data$PSDN_Landings <- as.numeric(est_data$PSDN_Landings)
est_data$MSQD_Landings <- as.numeric(est_data$MSQD_Landings)
est_data$NANC_Landings <- as.numeric(est_data$NANC_Landings)
est_data$ACL_PSDN <- as.numeric(est_data$ACL_PSDN)
  
sjlabelled::set_label(est_data$MSQD_SDM_90)   <- "Prob(presence): MSQD"
sjlabelled::set_label(est_data$PSDN_SDM_60)   <- "Prob(presence): PSDN"
sjlabelled::set_label(est_data$NANC_SDM_20)   <- "Prob(presence): NANC"
sjlabelled::set_label(est_data$Landing_year)  <- "Year"
sjlabelled::set_label(est_data$Port)          <- "Port area"
sjlabelled::set_label(est_data$MSQD_Landings) <- "Landings: MSQD"
sjlabelled::set_label(est_data$MSQD_Price)    <- "Price: MSQD"
sjlabelled::set_label(est_data$MSQD_Revenue)  <- "Revenue: MSQD"
sjlabelled::set_label(est_data$NANC_Landings) <- "Landings: NANC"
sjlabelled::set_label(est_data$NANC_Price)    <- "Price: NANC"
sjlabelled::set_label(est_data$NANC_Revenue)  <- "Revenue: NANC"
sjlabelled::set_label(est_data$ACL_PSDN)      <- "Annual Catch Limit: PSDN"
sjlabelled::set_label(est_data$PSDN_Landings) <- "Landings: PSDN"
sjlabelled::set_label(est_data$PSDN_Price)    <- "Price: PSDN"
sjlabelled::set_label(est_data$PSDN_Revenue)  <- "Revenue: PSDN"
sjlabelled::set_label(est_data$port_num)      <- "Port ID"

est_data_set <- est_data %>%
  subset(select = -c(port_num, Landing_year))

sjlabelled::set_label(est_data_set$MSQD_SDM_90)   <- "Prob(presence): MSQD"
sjlabelled::set_label(est_data_set$PSDN_SDM_60)   <- "Prob(presence): PSDN"
sjlabelled::set_label(est_data_set$NANC_SDM_20)   <- "Prob(presence): NANC"
sjlabelled::set_label(est_data_set$Landing_year)  <- "Year"
sjlabelled::set_label(est_data_set$Port)          <- "Port area"
sjlabelled::set_label(est_data_set$MSQD_Landings) <- "Landings: MSQD"
sjlabelled::set_label(est_data_set$MSQD_Price)    <- "Price: MSQD"
sjlabelled::set_label(est_data_set$MSQD_Revenue)  <- "Revenue: MSQD"
sjlabelled::set_label(est_data_set$NANC_Landings) <- "Landings: NANC"
sjlabelled::set_label(est_data_set$NANC_Price)    <- "Price: NANC"
sjlabelled::set_label(est_data_set$NANC_Revenue)  <- "Revenue: NANC"
sjlabelled::set_label(est_data_set$ACL_PSDN)      <- "Annual Catch Limit: PSDN"
sjlabelled::set_label(est_data_set$PSDN_Landings) <- "Landings: PSDN"
sjlabelled::set_label(est_data_set$PSDN_Price)    <- "Price: PSDN"
sjlabelled::set_label(est_data_set$PSDN_Revenue)  <- "Revenue: PSDN"
sjlabelled::set_label(est_data_set$port_num)      <- "Port ID"

est_data_set <- est_data_set[c("Port", "PSDN_Landings", "MSQD_Landings", "NANC_Landings", 
                                "PSDN_SDM_60", "MSQD_SDM_90", "NANC_SDM_20", "PSDN_Price", "MSQD_Price" , "NANC_Price",
                                "PSDN_Revenue", "MSQD_Revenue", "NANC_Revenue", "ACL_PSDN")]
                                 
vtable::st(est_data_set, labels = TRUE, title='Summary Statistics \\label{tab:sum_stats}', out='latex')
```

## Empirical model
We use a Hierarchical Bayesian Hurdle model to estimate the effect of species distribution on fish landings. We estimate a separate model for the three species in consideration. We use a Bayesian framework for several reasons. First, it allows us to consider uncertainty from modeling the process as well as from the imperfect observation of the process, assuming that all parameters are random variables. Second, it allows us to incorporate multilevel effects (i.e. hierarchical effects). Finally, it allow us to incorporate previous knowledge as a prior. For instance, we can include a prior the results obtained in @smith2021potential for the Pacific sardine landing equation. 

Specifically, we fit a hierarchical Bayesian hurdle model to model the zeros included in our landing data. We observe a zero when no landings occur in a specific time period (landings observations with "NA" were transformed to zero). This zero could mean that there was no incentives for the fleet/vessel to harvest the species in consideration.  In general, our Bayesian models have the following structure:
\begin{align*}
[\theta_i | q_{i,t}] &  \varpropto f\left(q_{i,t} | \theta_i\right) \times [\theta_i] 
\end{align*} 
where $q_{i,t}$ is the observed landings of the corresponding species in port $i \in (1,\ldots,L)$ at year $t$, $L$ is the total number of port, and $\theta_i$ are the parameters (i.e. random-coefficients) to be estimated at the port level. The latter give the name of hierarchical to our model.^[For more details about Hierarchichal models, see \cite{hobbs2015}.] 
The distribution $f\left(q_{i,t} | \theta_j\right)$ can be rewritten as:
\begin{equation}
f\left(q_{i,t} | \theta_j \right) = \begin{cases}
p_i & \text{if} \quad q_{it} = 0  \\ 
\left[1-p_i\right] \text{gamma} \left(q_{i,t} | \frac{\mu^2}{\sigma^2}, \frac{\mu}{\sigma^2} \right) & \text{if} \quad q_{it} > 0. 
\end{cases}
\end{equation}
where $\text{logit}(p_{i,j}) = \bf{X}\gamma$ and $\mu = \bf{X}\beta$. Specifically $\mu$ is defined as the following: 
\begin{equation}
\mu_{i,j} = \beta_{0,i} + \beta_{1,j} P(Precense)_{PSDN} + \beta_{2,j} + P(Precense)_{MSQD} + \beta_{3,j} P(Precense)_{NANC}.
\end{equation}
where $j$ indicate the species in consideration. $\text{logit}(p_{i,j})$ follows the same structure, but coefficient are replaced by $\gamma$. 

For the Pacific sardine, we also include annual catch limits as an additional explanatory variable in both $\mu_i$ and $\text{logit}(p_i)$ equations. We restrict our data set for this species to the period when the fishery was open (2000-2015). We only consider ports where landing have occur at least once in our sample period. Thus, we avoid to deal with ports where infrastructure to land Pacific sardine is inexistent.  



```{r psdn_data, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
# Select data for estimation, replace N/A landings to zero #
est_data_psdn <- est_data %>%
  dplyr::select(port_num, Port, PSDN_SDM_60, PSDN_Landings, PSDN_Price, ACL_PSDN,
                MSQD_SDM_90, NANC_SDM_20, Landing_year) %>%
  dplyr::mutate(PSDN_Landings = coalesce(PSDN_Landings, 0)) %>% 
  filter(Landing_year >= 2000 & Landing_year < 2015)

# Select ports that at least they have landing PSDN once, and drop N/A #
Tot.landings.ports <- as.data.frame(cbind(rowsum(est_data_psdn$PSDN_Landings, est_data_psdn$Port, na.rm = TRUE)))

Tot.landings.ports <- Tot.landings.ports %>%
  mutate(dTotalPSDN = ifelse(V1>0, 1, 0)) %>%
  mutate(Port = rownames(Tot.landings.ports)) %>%
  dplyr::select(Port, dTotalPSDN)

### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###
est_data_psdn <- est_data_psdn %>%
  merge(Tot.landings.ports, by.x = "Port", by.y = "Port", all.x = TRUE, all.y = FALSE) %>%
  filter(dTotalPSDN==1) %>%
  drop_na()
  # mutate(dSDA = ifelse(Port == "SDA", 1, 0)) %>%
  # filter(dSDA == 0) %>%  

# Create matrices and vectors to run STAN model #
year_id <- as.vector(cbind(as.numeric(factor(est_data_psdn$Landing_year))));
est_data_psdn$port_ID <- udpipe::unique_identifier(est_data_psdn, fields = "port_num", start_from = 1) 

portID_names_PSDN <- est_data_psdn %>%
  dplyr::select(Port, port_ID) %>%
  unique()

est_data_psdn$port_ID <- as.factor(est_data_psdn$port_ID)
class(est_data_psdn$port_ID)
```

```{r psdn_est, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qPSDN <- brm(
  bf(PSDN_Landings ~ PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 + s(ACL_PSDN) 
                      + (1 + PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 | port_ID),
                hu ~ PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 + s(ACL_PSDN) 
                      + (1 + PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 | port_ID)),
                          data = est_data_psdn,
                          family = hurdle_gamma(), 
                          control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)
save.image (file = "stan_fit.RData")

```


```{r psdn_est_price, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qPSDN_price <- brm(
  bf(PSDN_Landings ~ PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 + PSDN_Price + s(ACL_PSDN) 
                      + (1 + PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 + PSDN_Price | port_ID),
                hu ~ PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 + PSDN_Price + s(ACL_PSDN) 
                      + (1 + PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 + PSDN_Price | port_ID)),
                          data = est_data_psdn,
                          family = hurdle_gamma(), 
                          control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)

save.image (file = "stan_fit.RData")

```

In the case of market squid, our database comprise the time period between 2000 and 2018. We do not include ACL as an explanatory variable as there is no variation between years. To capture any change on fishers behavior when Pacific sardine fishery closed, we include a binary variable called **dClose** that takes the value "1" when the Pacific sardine fishery is close, and the value "0" when its close. Pacific sardine probability takes the value of zero when the fishery is closed. Thus, the effect of this variable is only relevant when it PAcific sardine fishery is open in order to capture potential substitution between targets. 

```{r msqd_data, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
# Select data for estimation, replace N/A landings to zero #
est_data_msqd <- est_data %>%
  dplyr::select(port_num, Port, MSQD_SDM_90, MSQD_Landings, MSQD_Price, 
                  PSDN_SDM_60, NANC_SDM_20, Landing_year) %>%
  dplyr::mutate(MSQD_Landings = coalesce(MSQD_Landings, 0)) %>% 
  dplyr::mutate(dClose = ifelse(Landing_year >= 2015,1,0)) %>%
  dplyr::mutate(dOpen = ifelse(Landing_year < 2015,1,0)) %>%
  dplyr::mutate(PSDN_SDM_60_dOpen = PSDN_SDM_60 * dOpen) %>%
  filter(Landing_year >= 2000)

# Select ports that at least they have landing PSDN once, and drop N/A #
Tot.landings.ports <- as.data.frame(cbind(rowsum(est_data_msqd$MSQD_Landings, est_data_msqd$Port, na.rm = TRUE)))

Tot.landings.ports <- Tot.landings.ports %>%
  mutate(dTotalMSQD = ifelse(V1>0, 1, 0)) %>%
  mutate(Port = rownames(Tot.landings.ports)) %>%
  dplyr::select(Port, dTotalMSQD)

### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###
est_data_msqd <- est_data_msqd %>%
  merge(Tot.landings.ports, by.x = "Port", by.y = "Port", all.x = TRUE, all.y = FALSE) %>%
  filter(dTotalMSQD==1) %>%
  drop_na() 
  
# Create matrices and vectors to run STAN model #
year_id <- as.vector(cbind(as.numeric(factor(est_data_msqd$Landing_year))));
est_data_msqd$port_ID <- udpipe::unique_identifier(est_data_msqd, fields = "port_num", start_from = 1) 
portID_names_MSQD <- est_data_msqd %>%
  dplyr::select(Port, port_ID) %>%
  unique()

### Estimate using BRMS package ###
est_data_msqd$dClose    <- factor(est_data_msqd$dClose)
est_data_msqd$port_ID   <- factor(est_data_msqd$port_ID)
class(est_data_msqd$dClose)
class(est_data_msqd$port_ID)
class(est_data_msqd$dOpen)
```

```{r msqd_est, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qMSQD <- brm(bf(MSQD_Landings ~ MSQD_SDM_90 + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose 
                      + (1 + MSQD_SDM_90 + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose | port_ID),
                               hu ~ MSQD_SDM_90 + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose 
                      + (1 + MSQD_SDM_90 + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose | port_ID)),
                       data = est_data_msqd,
                       family = hurdle_gamma(),
                       control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)
save.image (file = "stan_fit.RData")
```

```{r msqd_est_price, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qMSQD_price <- brm(bf(MSQD_Landings ~ MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose 
                      + (1 + MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose | port_ID),
                               hu ~ MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose 
                      + (1 + MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose | port_ID)),
                       data = est_data_msqd,
                       family = hurdle_gamma(),
                       control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)
save.image (file = "stan_fit.RData")
```

Finally, a similar structure than Market squid models is followed for our estimation of Northern anchovy landing by ports.

```{r nanc_data, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
# Select data for estimation, replace N/A landings to zero #
est_data_nanc <- est_data %>%
  dplyr::select(port_num, Port, NANC_SDM_20, NANC_Landings, NANC_Price, 
                  PSDN_SDM_60, MSQD_SDM_90, Landing_year) %>%
  dplyr::mutate(NANC_Landings = coalesce(NANC_Landings, 0)) %>% 
  dplyr::mutate(dClose = ifelse(Landing_year >= 2015,1,0)) %>%
  dplyr::mutate(dOpen = ifelse(Landing_year < 2015,1,0)) %>%
  dplyr::mutate(PSDN_SDM_60_dOpen = PSDN_SDM_60 * dOpen) %>%
  filter(Landing_year >= 2000)

# Select ports that at least they have landing PSDN once, and drop N/A #
Tot.landings.ports <- as.data.frame(cbind(rowsum(est_data_nanc$NANC_Landings, est_data_nanc$Port, na.rm = TRUE)))

Tot.landings.ports <- Tot.landings.ports %>%
  mutate(dTotalNANC = ifelse(V1>0, 1, 0)) %>%
  mutate(Port = rownames(Tot.landings.ports)) %>%
  dplyr::select(Port, dTotalNANC)

### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###
est_data_nanc <- est_data_nanc %>%
  merge(Tot.landings.ports, by.x = "Port", by.y = "Port", all.x = TRUE, all.y = FALSE) %>%
  filter(dTotalNANC==1) %>%
  drop_na() 
  
# Create matrices and vectors to run STAN model #
year_id <- as.vector(cbind(as.numeric(factor(est_data_nanc$Landing_year))));
est_data_nanc$port_ID <- udpipe::unique_identifier(est_data_nanc, fields = "port_num", start_from = 1) 
portID_names_NANC <- est_data_nanc %>%
  dplyr::select(Port, port_ID) %>%
  unique()

### Estimate using BRMS package ###
est_data_nanc$dClose    <- factor(est_data_nanc$dClose)
est_data_nanc$port_ID   <- factor(est_data_nanc$port_ID)
class(est_data_nanc$dClose)
class(est_data_nanc$port_ID)
class(est_data_nanc$dOpen)
```

```{r nanc_est_price, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qNANC_price <- brm(bf(NANC_Landings ~ NANC_SDM_20 + NANC_Price + PSDN_SDM_60_dOpen + MSQD_SDM_90 + dClose 
                      + (1 +  NANC_SDM_20 + NANC_Price + PSDN_SDM_60_dOpen + MSQD_SDM_90 + dClose | port_ID),
                                     hu ~ NANC_SDM_20 + NANC_Price + PSDN_SDM_60_dOpen + MSQD_SDM_90 + dClose + dClose 
                      + (1 + NANC_SDM_20 + NANC_Price + PSDN_SDM_60_dOpen + MSQD_SDM_90 + dClose | port_ID)),
                       data = est_data_nanc,
                       family = hurdle_gamma(),
                       control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)
save.image (file = "stan_fit.RData")
```

##  Multispecies participation model

<< WORK ON THIS >>
For the multispecies participation model, we follow a similar methodology than @richerson201. We estimate a discrete choice model for probability that a vessel participate in a particular fishery. First, we identify vessels that participate in at least two fishery. Then, we...

Variables that can explain fishery participation on a particular fishery are **HHI and LI?** (Think about this) (Peña et al have some ideas how to use expected catch and cost. It could be the month average...)


# Results

## Landing model

<!-- # print summary -->
<!-- texreg(list(f2, f3, r2, r3), caption = 'Panel data models for Pacific Sardine landings.\\label{table:sardine_est}', caption.above = TRUE, float.pos = "h", custom.model.names = c("FE: Model 1", "FE: Model 2", "RE: Model 1", "RE: Model 2")) -->


<!-- # ##  Extract Grouo-Level estimates ## -->
<!-- # ranef(fit_qPSDN_gamma) -->
<!-- #  -->
<!-- # ## Check divergence and other model check ## -->
<!-- # shinystan::launch_shinystan(fit_qPSDN_gamma) -->

<!-- # Investigate chain and posterior distributions.  -->
<!-- # https://cran.r-project.org/web/packages/bayesplot/vignettes/graphical-ppcs.html -->
<!-- # plot(fit_qPSDN_t2nc, pars = c("PSDN_SDM")) -->

<!-- # ### Predictions ### -->
<!-- # pred_data <- data.frame(PSDN_SDM = c(0.5, 0.25), MSQD_SDM = c(0.5), Port_ID = 1) -->
<!-- # predict(fit_qPSDN, newdata = pred_data, re_formula = NA) -->

<!-- # ## Compare models ## -->
<!-- # loo(fit1, fit2) -->

<!-- ## Check https://www.pcouncil.org/stock-assessments-and-fishery-evaluation-safe-documents/ for ACL and closures. -->

### Graphical posterior predictive
Before presenting the results for the three species in consideration, we check graphically whether the posterior distribution is able to predict the actual distribution. We exclude zero in our graph to avoid plotting different data generation processes. In Figure \ref{fig:posteriors} we show a posterior sample compare with the true sample distribution for the three species in analysis. Some deviation from the true sample distribution is observed in the three models, but still the posterior sample follow a similar shape than the actual curve. Moreover, our pacific sardine sample do well in predicting probabilities at lower landing levels. 

```{r y_rep, message=FALSE, warning=FALSE, fig.cap = "Graphical posterior predictive checks\\label{fig:posteriors}"}
g1 <- pp_check(fit_qPSDN_price) + ggtitle('(a) Pacific sardine') + 
  theme(legend.position = "none", plot.title = element_text(size=9, face="bold.italic")) +  xlim(0.1, 15000) 
g2 <- pp_check(fit_qMSQD_price) + ggtitle('(b) Market Squid') + 
  theme(legend.position = "none", plot.title = element_text(size=9, face="bold.italic"))  +  xlim(0.1, 15000) 
g3 <- pp_check(fit_qNANC_price) + ggtitle('(c) Northern Anchovy') +
  theme(legend.position = "right", plot.title = element_text(size=9, face="bold.italic"))  +  xlim(0.1, 15000) 


g1 + g2 + g3
```

In addition to a posterior predictive check, we also check divergence and treedepth.^[Explain what are these concepts...] In all three models, we did not have any divergent step in our estimation. The maximum treedepth was 11 for the Pacific sardine model, while in the others it was 10.   

```{r shinystan, eval=FALSE, include=FALSE}
shinystan::launch_shinystan(fit_qPSDN_price) 
shinystan::launch_shinystan(fit_qMSQD_price) 
shinystan::launch_shinystan(fit_qNANC_price) 
```

```{r y_rep_zero, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
g1 <- pp_check(fit_qPSDN_price) + ggtitle('(a) Pacific sardine') + theme(legend.position = "none") +  xlim(0, 0.1) 
g2 <- pp_check(fit_qMSQD_price) + ggtitle('(b) Market Squid') + theme(legend.position = "none")  +  xlim(0, 0.1) 
g3 <- pp_check(fit_qNANC_price) + 
  ggtitle('(c) Northern anchovy') + 
  theme(legend.position = "right", plot.title = element_text(size=9, face="bold.italic"))  +  xlim(0, 0.1)


g1 + g2 + g3
```


```{r model-comparision, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
fit_qMSQD <- add_criterion(fit_qMSQD, "loo")
fit_qMSQD_90 <- add_criterion(fit_qMSQD_90, "loo")

comp <- loo_compare(loo(fit_qMSQD), loo(fit_qMSQD_90)) %>%
  as.data.frame() %>%
  select(elpd_loo, elpd_diff, se_diff, p_loo, looic) %>%
  dplyr::rename(
    "ELPD-Diff" = elpd_diff, "SE-Diff" = se_diff, 
    "ELPD-LOO" = elpd_loo, "P-LOO" = p_loo, "LOOIC" = looic
  )

mw1 <- model_weights(fit_qMSQD, fit_qMSQD_90, weights = "loo")[rownames(comp)]

comp %>%
  cbind("Akaike-Weight" = mw1) %>%
  apa_table(
    format = "latex", booktabs = TRUE, digits = 2,
    caption = "Comparison of models fit1 to fit3 based on approximate leave-one-out cross-validation. Market squid landigns model.",
    note =  "ELPD-LOO = expected log posterior predictive density (higher is better); ELPD-DIFF = difference in ELPD values compared to the best model. SE-DIFF = standard error of the ELPD difference. P-LOO = effective number of model parameters (lower is better); LOOIC: leave-one-out information criterion (lower is better); Akaike-Weight = Model weight based on the LOOIC values (higher is better).",
    align = c("l", rep("r", 6))
  )
```


### Own species distribution effect

The inclusion of hierarchical effects by port allows us to analyze the effects of the probability of presence on landings disaggregated by ports. We only focus our analysis in owns probability of presence effects, as other probability are analyzed as interaction (see next subsection). We can observe in Figure \ref{fig:sdmeffects} that the effects of the own probability of presence on landings are not strong (maybe I should use logs...). However, it is clear that it have a positive effect on landings, specially on port areas such as Columbia River at Oregon for Pacific sardine, and Monterrey for Northern anchovy, while a more moderate effect is observed at Santa Barbara Area for Northern anchovy.


```{r by_port_sdm, echo=FALSE, fig.cap = "Effect of probability of presence on landings by species and port\\label{fig:sdmeffects}"}
# PSDN plots
conditions <- data.frame(port_ID = unique(est_data_psdn$port_ID))
  rownames(conditions) <- unique(est_data_psdn$Port)
conditions_psdn <- conditions %>% 
  rownames_to_column('port_name') %>%
  filter(port_ID == 1 | port_ID == 2 | port_ID == 3) %>%
  column_to_rownames('port_name')

c_eff_psdn <- (conditional_effects
               (fit_qPSDN_price, "PSDN_SDM_60", surface=TRUE, conditions = conditions_psdn, re_formula = NULL))
               #, transform = log, method = "posterior_predict"))
g1 <- plot(c_eff_psdn, plot = FALSE, nrow = 3, ncol = 1)[[1]] + ggtitle('(a) Pacific sardine')+ 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_continuous(name = element_blank()) +
  scale_y_continuous(name = "Landings (tons)")

# MSQD plots
conditions2 <- data.frame(port_ID = unique(est_data_msqd$port_ID))
  rownames(conditions2) <- unique(est_data_msqd$Port)
conditions_msqd <- conditions2 %>% 
  rownames_to_column('port_name') %>%
  filter(port_ID == 4  | port_ID == 5  | port_ID == 8) %>%
  column_to_rownames('port_name')
c_eff_msqd <- (conditional_effects
               (fit_qMSQD_price, "MSQD_SDM_90", surface=TRUE, conditions = conditions_msqd, re_formula = NULL))
               #, transform = log, method = "posterior_predict"))
g2 <- plot(c_eff_msqd, plot = FALSE, nrow = 3, ncol = 1)[[1]] + ggtitle('(b) Market squid') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_continuous(name = "Prob(Presence)") +
  scale_y_continuous(name = element_blank()) 

# NANC plots
conditions3 <- data.frame(port_ID = unique(est_data_nanc$port_ID))
  rownames(conditions3) <- unique(est_data_nanc$Port)
conditions_nanc <- conditions3 %>% 
  rownames_to_column('port_name') %>%
  filter(port_ID == 3  | port_ID == 4  | port_ID == 5) %>%
  column_to_rownames('port_name')
c_eff_nanc <- (conditional_effects
               (fit_qNANC_price, "NANC_SDM_20", surface=TRUE, conditions = conditions_nanc, re_formula = NULL))
               #, transform = log, method = "posterior_predict"))
g3 <- plot(c_eff_nanc, plot = FALSE, nrow = 3, ncol = 1)[[1]] + ggtitle('(c) Northern anchovy') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_continuous(name = element_blank()) +
  scale_y_continuous(name = element_blank()) 

# Merge plots
g1 + g2 + g3

```

<!-- @smith2021potential estimate with GAM framework (allows for non-linear relationships) -->


### Interaction effects

To study the effect of other species distribution on landings, we compute the conditional effects of the interaction between probabilities of presence. Let denote species A the species which we are analysing its landings, and species B and C the other species included in the model for species A landings. For each species, we compute the effect on landing of the interaction between the probability of presences of: 
  + Species A and species B, 
  + Species A versus species C,
  + Species B versus species C.
For example, for the Pacific sardine equation, we compute these results for the probability of presence effect between Pacific sardine and market squid, Pacific sardine and Northern anchovy, and market squid and Northern anchovy. 

```{r int_effect_PSDN_by_port, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
c_eff_int_psdn_msqd <- (conditional_effects(fit_qPSDN_price, "PSDN_SDM_60:MSQD_SDM_90", surface=TRUE, 
                                            conditions = conditions_psdn, re_formula = NULL))
c_eff_int_psdn_nanc <- (conditional_effects(fit_qPSDN_price, "PSDN_SDM_60:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_psdn, re_formula = NULL))
c_eff_int_msqd_nanc <- (conditional_effects(fit_qPSDN_price, "MSQD_SDM_90:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_psdn, re_formula = NULL))

g1_PSDN <-  plot(c_eff_int_psdn_msqd, plot = FALSE)[[1]] + ggtitle('(a) Pacific sardine x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) +
  scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): MSQD") 

g2_PSDN <-  plot(c_eff_int_psdn_nanc, plot = FALSE)[[1]] + ggtitle('(b) Pacific sardine x Northern anchovy') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): NANC") 

g3_PSDN <-  plot(c_eff_int_msqd_nanc, plot = FALSE)[[1]] + ggtitle('(c) Northern anchovy x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): MSQD") + scale_y_continuous(name = "P(Pres): NANC") 
save.image (file = "stan_fit.RData")
```

Let first analyze the interaction effect of the probability of presences on Pacific sardine landings, presented in Figure \ref{fig:sdm_int_psdn}. We only shows results for the main three port where Pacific sardine is landed (Columbia River at Oregon, Los Angeles Area  and Monterrey Area). As we already commented in Figure \ref{fig:sdmeffects}, the effects the Pacific sardine's own probability of presence is positive, changing color from left to right in panels (a) and (b). Market squid seems to be an stronger substitute for Pacific sardine than Northern anchovy. This is suggested by the different slopes between panel (a) and panel (b). For instane, in Columbia River, an increase in the probability of presence for anchovy does decrease Pacific sardine landings as much as an increase in the probability of presece of market squid. 

```{r int_effect_PSDN_by_port_PLOT, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Interaction effects between species distribution on Pacific sardine landings by port\\label{fig:sdm_int_psdn}"}
g1_PSDN / g2_PSDN
```

```{r int_effect_MSQD_by_port, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
c_eff_int_msqd_psdn <- (conditional_effects(fit_qMSQD_price, "MSQD_SDM_90:PSDN_SDM_60_dOpen", surface=TRUE, 
                                            conditions = conditions_msqd, re_formula = NULL))
c_eff_int_msqd_nanc <- (conditional_effects(fit_qMSQD_price, "MSQD_SDM_90:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_msqd, re_formula = NULL))
c_eff_int_psdn_nanc <- (conditional_effects(fit_qMSQD_price, "PSDN_SDM_60_dOpen:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_msqd, re_formula = NULL))

g1_MSQD <-  plot(c_eff_int_msqd_psdn, plot = FALSE)[[1]] + ggtitle('(a) Market squid x Pacific sardine') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: MSQD")) +
  scale_x_continuous(name = "P(Pres): MSQD") + scale_y_continuous(name = "P(Pres): PSDN") 

g2_MSQD <-  plot(c_eff_int_msqd_nanc, plot = FALSE)[[1]] + ggtitle('(b) Market squid x Northern anchovy') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: MSQD")) + 
        scale_x_continuous(name = "P(Pres): MSQD") + scale_y_continuous(name = "P(Pres): NANC") 

g3_MSQD <-  plot(c_eff_int_psdn_nanc, plot = FALSE)[[1]] + ggtitle('(c) Pacific sardine x Northern anchovy') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: MSQD")) + 
        scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): NANC") 
save.image (file = "stan_fit.RData")
```

We found some similar findings for market squid in Figure \ref{fig:sdm_int_msqd}. Pacific sardine it is a strong substitute of market squid. In regard to Norther anchovy, there is some complementarity with market squid. We observe that when Northern anchovy presence increase, there is also an increase in market squid landings. 

```{r int_effect_MSQD_by_port_PLOT, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Interaction effects between species distribution on market squid landings by port\\label{fig:sdm_int_msqd}"}
g1_MSQD / g2_MSQD 
```


```{r int_effect_NANC_by_port, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
conditions_nanc <- conditions_nanc %>% filter(port_ID == 3  | port_ID == 5)

c_eff_int_nanc_psdn <- (conditional_effects(fit_qNANC_price, "NANC_SDM_20:PSDN_SDM_60_dOpen", surface=TRUE, 
                                            conditions = conditions_nanc, re_formula = NULL))
c_eff_int_nanc_msqd <- (conditional_effects(fit_qNANC_price, "NANC_SDM_20:MSQD_SDM_90", surface=TRUE, 
                                            conditions = conditions_nanc, re_formula = NULL))
c_eff_int_psdn_msqd <- (conditional_effects(fit_qNANC_price, "PSDN_SDM_60_dOpen:MSQD_SDM_90", surface=TRUE, 
                                            conditions = conditions_nanc, re_formula = NULL))

g1_NANC <-  plot(c_eff_int_nanc_psdn, plot = FALSE)[[1]] + ggtitle('(a) Northern anchovy x Pacific sardine') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) +
  scale_x_continuous(name = "P(Pres): NANC") + scale_y_continuous(name = "P(Pres): PSDN") 

g2_NANC <-  plot(c_eff_int_nanc_msqd, plot = FALSE)[[1]] + ggtitle('(b) Northern anchovy x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): NANC") + scale_y_continuous(name = "P(Pres): MSQD") 

g3_NANC <-  plot(c_eff_int_psdn_msqd, plot = FALSE)[[1]] + ggtitle('(c) Pacific sardine x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): MSQD") 
save.image (file = "stan_fit.RData")
```


However, this complementary is not observed for Northern anchovy landings. When market squid presence increase, we observe a decrease in Northern anchovy landings. An interesting case is observed for Pacific sardine and Northern anchovy, in particular at Monterrey area. For small levels of Pacific sardine presence, Pacific sardine is a complement with Northern anchovy. However, after certain threshold, Pacific sardine is no longer complement and Pacific sardine become a substitute, reducing Northern anchovy landings when the probability of presence for Pacific sardine increase.

```{r int_effect_NANC_by_port_PLOT, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Interaction effects between species distribution on Northern anchovy landings by port\\label{fig:sdm_int_nanc}"}
g1_NANC / g2_NANC 
```


### Pacific sardine closure
Finally, lets analyze the effect of the Pacific sardine closure on market squind and Northern anchovy landings.  

```{r by_port_msqd_dclose, echo=FALSE, fig.cap = "Effect of Pacific sardine fishery closure on markt squid landings by species and  port\\label{fig:sdmeffects}"}
# conditions_dClose <- data.frame(port_ID = unique(est_data_msqd$dClose))
# rownames(conditions_dClose) <- unique(est_data_msqd$dClose)
c_eff_close_msqd <- (conditional_effects(fit_qMSQD_price, "dClose", conditions = conditions_msqd, re_formula = NULL))
g1 <-  plot(c_eff_close_msqd, plot = FALSE)[[1]] + ggtitle('(a) Market squid') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "Landings (tons)") 

c_eff_close_nanc <- (conditional_effects(fit_qNANC_price, "dClose", conditions = conditions_nanc, re_formula = NULL))
g2 <- plot(c_eff_close_nanc, plot = FALSE)[[1]] + ggtitle('(b) Northern anchovy') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  scale_x_discrete(name = "Closure? (1 = True; 0 = False)") +
  scale_y_continuous(name = "Landings (tons)") 

g1 / g2
```

## Multispecies participation model



# Predictions
...

# Conclusions
A possible extension of our research is to consider spatial autocorrelations between ports.^[See \cite{morris2019bayesian} for an application of a spatial model in a Bayesian framework.] Ports landing maybe correlated as vessel have the incentives to choose the port of landing, conditional on whether the port have the infrastructure for this. It is likely that they just land wherever is closer to the area they are fishing. Nevertheless, differential in prices could encourage them to travel a little further for higher prices. 




<!-- ```{r int_effect_sep, eval=FALSE, include=FALSE} -->

<!-- hu <- plot(conditional_effects(fit_qPSDN, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="hu"), -->
<!--            plot = FALSE, ask = FALSE) -->
<!-- mu <- plot(conditional_effects(fit_qPSDN, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="mu"), -->
<!--            plot = FALSE, ask = FALSE) -->

<!-- mu[[1]] + hu[[1]] + plot_layout(nrow = 2) -->

<!-- ``` -->

<!-- ```{r int_effect_sep_msqd, eval=FALSE, fig.cap=, include=FALSE} -->

<!-- hu <- plot(conditional_effects(fit_qMSQD_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="hu"), -->
<!--            plot = FALSE, ask = FALSE) -->
<!-- mu <- plot(conditional_effects(fit_qMSQD_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="mu"), -->
<!--            plot = FALSE, ask = FALSE) -->

<!-- mu[[1]] + hu[[1]] + plot_layout(nrow = 2) -->

<!-- ``` -->




