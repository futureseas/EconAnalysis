---
title: "Portfolio Substitution between Coastal Pelagic Species under Shifting Target Species Distributions and Policy Constraints"
author:
  - name: Felipe Quezada
    email: felipe.quezada@noaa.gov
    institute: [ucsc, noaa1]
    correspondence: true
  - name: Desiree Tommasi
    institute: [ucsc, noaa1]
  - name: Stephen Stohs
    institute: noaa1
  - name: Isaac Kaplan
    institute: noaa2
  - name: Jonathan Sweeney 
    institute: noaa3
  - name: Barbara Muhling
    institute: [ucsc, noaa1]  

institute:
  - ucsc: Institute of Marine Sciences, University of California Santa Cruz
  - noaa1: NOAA Southwest Fisheries Science Center
  - noaa2: NOAA Northwest Fisheries Science Center
  - noaa3: NOAA Pacific Island Fisheries Science Center
  
date: "`r format(Sys.time(), '%B %e, %Y')`"
abstract: "Fishers for forage species typically face a set of possible choices, called fishing portfolios, that allow them to diversify target species and reduce income risk. Switching among species is more feasible for vessels that share similar gear and methods for fishing. More diverse portfolios may increase fisher resilience to climate-driven changes in target species’ spatial distributions and availability. However, regulations and other constraints (e.g., port constraints on where landings of a particular species may occur, or permit requirements) may reduce the degree of substitution we observe. In this study, we analyze how historical changes in forage species distribution and the closure of the  Pacific sardine fishery affected landing substitution between three coastal pelagic species: Pacific sardine, market squid, and Northern anchovy. Using a discrete choice modeling approach, we also study how spatial distribution and closure affected the coastal pelagic species fisheries' participation decisions over the 2000-2019 period. Our preliminary results show strong substitution between market squid and Pacific sardine when both were available, while the Pacific sardine closure in 2015 was associated with reduced market squid landings suggesting lower fishers’ participation in this fishery. We plan to use species distribution model projections to study how landings and participation change under different future climate change scenarios."
header-includes:
  \usepackage{mathtools}
  \usepackage{tcolorbox}
  \usepackage{float}
  \floatplacement{figure}{H}
  \usepackage{times}
  \usepackage{setspace}
  \setstretch{1.5}
output:
  pdf_document:
    number_sections: yes
    citation_package: natbib
    pandoc_args:
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
bibliography: references.bib
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# rm(list = ls(all.names = TRUE)) 
gc()
# load("PacFIN.RData")

library(bookdown)
library(brms)
library(cmdstanr)
library(doBy)
library(dplyr)
library(fastDummies)
library(ggplot2)
library(here)
library(hrbrthemes)
library(kableExtra)
library(lmtest)
library(lubridate)
library(magrittr)
library(Rcpp)
library(patchwork)
library(plm)
library(papaja)
library(reshape)
library(reshape2)
library(rstan)
library(scales)
library(sjlabelled)
library(texreg)
library(tidyr)
library(tidyverse)
library(tinytex)
library(viridis)
library(xtable)
library(zoo)
```

```{r read_data, include=FALSE}
port_area <- read.csv(file = here::here("Data", "Ports", "ports_area_codes.csv"))
  PacFIN.month <- read.csv(file ="C:\\Data\\PacFIN data\\PacFIN_month.csv")
  PacFIN.month <- PacFIN.month %>% merge(port_area, by = c("PACFIN_PORT_CODE"), all.x = TRUE)
  PacFIN.month.CPS <- PacFIN.month %>% dplyr::filter(PACFIN_SPECIES_CODE %in% c("PSDN", "MSQD", "NANC", "PHRG"))
rm(port_area)
  
```

```{r functions, include=FALSE}
meanfun <- function(x, ...){
  c(mean=mean(x, na.rm=TRUE, ...)) #, v=var(x, na.rm=TRUE, ...), l=length(x))
}
sumfun <- function(x, ...){
  c(sum=sum(x, na.rm=TRUE, ...)) #, v=var(x, na.rm=TRUE, ...), l=length(x))
}
sum_mean_fun <- function(x, ...){
  c(mean=mean(x, na.rm=TRUE, ...), sum=sum(x, na.rm=TRUE, ...)) #, l=length(x))
}

```

# Introduction
Fishing portfolios are an important mechanism to safeguard fishers livelihood. Diversification strategy have been principally associated to reducing income variability [@kasperski2013]. For instance, when a species abundance is reduced due to environmental conditions, fisher can change the targeted species to one that requires similar gears. However, there is no always room for diversification. Switching between species can be costly if gears are quite different between species, or a new permit is required for legal fishing. Moreover, even though fisher may have flexibility switching between species, port infrastructure and markets may impose some restrictions on this flexibility, as well as regulations that limits access to fisheries to avoid collapse of fish stocks from overfishing [@kasperski2013]. Therefore, it is not clear how change in species distribution and regulation would be reflected in landings compositions and participation.

In this study we analyze how changing in spatial distribution as well as the implementation of a fishery's closure affects landing and fisher participation of three coastal pelagic species (CPS) harvested in U.S. West Coast: Pacific sardine (PSDN), market squid (MSQD) and Northern anchovy (NANC). Fisheries closures are a interesting policy instrument in a multispecies framework as give us the opportunity to study a quasi-experiment. However, fewer studies have study the effect of one fishery closure in other fishery outcomes. Some examples are @vermard2008 study the effect of an anchovy closure in trip choices conducted by the Bay of Biscai pelagic fleet, and <!-- They use their estimate pre-closure to simulate the anchovy closure and compare with actual data. --> @richerson2017 who study the effect of salmon closures in vessel participation on salmon fishery, but also in other fisheries. In this paper, we study the effect of the 2015 Pacific sardine closure implemented  after the overxplotation of the fishery. The answer to this questions is not straightforward as different response can be observed to the same conditions as fishers and vessel are heterogeneous [@zhang2011]. Moreover, we have to consider that species are interconnected, at least economically if not ecologically, so a multispecies framework that considering interrelation between them is necessary. Our research give a step further and analyze the CPS as a multispecies fishery. This is in line with recent literature that start to consider multiple species in their analysis [@richerson2017]. Our goal is to understand how changing in species distribution and closure of Pacific sardine affect vessel responses in landing amount and participation, the substitution between species, and to what extent future projected climate will affect landings, catch composition and participation of fishers.

Our papers builds on the model developed by @smith2021potential for sardine landings.  We expand their model including a landing equation for the three species analyzed in this study and estimating a multilevel Bayesian model in order to incorporate heterogeneity between fleets and ports areas. Moreover, we use the probability of presence obtained from Species Distribution Models (SDM) as explanatory variable instead of landing by species. This allows us to project landing over time using SDM predictions for different climate scenarios. We analyze how species distribution interact between each others. We expect that this additions allows us to characterize better how fishers portfolio is composed, and also to understand better species interactions on catch rates. Additionally, we also estimate a multiple species participation model based on @richerson2017 who study the effect of salmon closure on annual fishers participation, expanding their analysis to the CPS fishery in monthly basis, allowing to understand seasonality within fishing season. For this, we develop a Random Utility Model (RUM) to model monthly vessel participation in targeting a specific species in the CPS fishery as a function of... **fisher characteristics including revenue level, diversification, dependence on the species and spatial variables of area and range..** 

The remainder of the paper is organized as follows: Section \ref{coastal-pelagic-species-fishery} provides background on the CPS fishery in the US west coast. In Section \ref{methods} we discusses our data set and empirical strategy. Section \ref{results} presents the results of the estimations, and we conclude in Section \ref{conclusions}.


# Coastal Pelagic Species fishery 
***<<< Note: I got this information from an Excel file that desiree sent me about Annual Catch Limits and Limted entry for sardine and squid, and I will start to complement with the CPS FMP document and random notes that I have >>>***

Before 2000, the only fishery under a Fisheries Management Plan (FMP) was the Northern anchovy. In March, 1995 the Pacific Fishery Management Council (PFMC) decided to expand the FMP to include the entire CPS species (Pacific sardine, northern anchovy, Pacific (chub) mackerel, jack mackerel, and market squid) along the U.S. west coast. through the Amendment 8. The FMP for the CPS fishery was finally implemented in January, 2000. 

The Pacific sardine fishery in California was close in 1967 due to the collapse of the fishery. It reopened in 1986 with a precautionary quota of 906 metric tons. Since 2000, the Pacific sardine is managed under a permit and quota management system, with a Harvest Guideline (HG) controlling commercial catch of sardine biomass ***<<< DOES FISHER HAVE TO BUY OR SELL QUOTA LIKE IN AN ITQ SYSTEM? IS THERE A FINE FOR EXCEDING THE QUOTA, IT IS INDIVIDUAL QUOTA >>>*** In the states of Oregon and Washington, the development of the fishery did not happen until the years 2000s. In 1999, a fishery for Pacific sardine started to operate in both states targeting larger sardine to be sold as bait to longliners. In Oregon, it was a developmental fishery until 2005. In 2006, the first Limited Entry (LE) permits were issued at 26, and its expand to human consumption during this year. In Washignton,  the PAcific sardine fishery was a trial fishery from 2000-2002 with a state HG of 15,000 metric tons. From 2003 to 2009, the fishery was an experimental fishery  with permits capped at 25. Finally, in 2009, the Washington's Pacific sardine fishery it was designated as a commercial fishery in with a Limited Entry (LE) program that allocated 16 permanent permits and 10 temporary ones. Fishing for sardine is prohibited from January 1st to March 31st, and it have been closed since 2015 as the biomass was below the cutoff point of 150,000 metric tons. 

Regarding market squid, the fishery was unregulated under open access until permits became required in 1998. However, there were no limits to the number of permits issued by the authorities. In 2001 was the first time a Harvest Guideline (HG) was implemented for this fishery to 125,000 U.S. tons. Later, in 2005, the California Fishery and Wildlife Division's Market Squid Fisheries Management Plan (CFWD MSFMP) reduced the fleet to a maximum of 55 vessels and 18 brail vessels, and limits the number of light boats to 34. Also, it reduce the HG to 118,000 U.S. tons. Oregon's market squid fishery just started in 2014, while in Washington there is no directed landings of market squid. In 2019 two permits were isssued but with the intention to allow the possibility to deliver Oregon's market squid catch to Washington ports. The market squid fishery has a weekend closure.

The fishing season for Pacific sardine in California have a peak in landings during the early summer to fall in the area of Monterrey, specifically in Moss Landing, and in Southern California, specifically in San Pedro and Terminal Port occurs during the winter. Fishing season are for Pacific sardine are shown in Panel (a) of Figure \ref{{fig:fish_season}}. In Oregon and Washington state, at Astoria and Ilwako/Chinook ports, respectively, the fishing season mostly happen in summer and early fall. Panel (b) shows that market squid fishing season in Southern California, specifically in San Pedro, Terminal Port and Ventura, goes from fall to winter, while in Northern California, specifically in Moss Landing and Monterrey, the season goes from late spring to summer. 
 
<!-- ```{r psdn_month} -->
<!-- q.psdn.by.month <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>% -->
<!--   filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>%   -->
<!--   group_by(LANDING_YEAR, LANDING_MONTH, PORT_NAME, AGENCY_CODE) %>%  -->
<!--   summarise(Landings_PSDN = sum(LANDED_WEIGHT_MTONS.sum))  -->
<!-- ggplot(data=q.psdn.by.month, aes(x=LANDING_MONTH, y=Landings_PSDN)) + -->
<!--     geom_bar(stat="identity", fill=rgb(0.1,0.4,0.5,0.7), width=0.4) +  -->
<!--   scale_x_continuous(name = "Month", breaks=1:12) + -->
<!--   scale_y_continuous(name = "Landing of sardine" ) +  -->
<!--   facet_grid(~ AGENCY_CODE) -->
<!-- rm(q.psdn.by.month) -->
<!-- ```   -->

```{r psdn__msqd_month, echo=FALSE, fig.cap="Fishing season for Pacific sardine and Market squid (average monthly total harvest for the period 2000-2014).", message=FALSE, warning=FALSE}

port_names <- as_labeller(c("SP" = "San Pedro", "HNM" = "Hueneme", "MNT" = "Monterrey", "MOS" = "Moss Landing", 
                               "LWC" = "Ilwaco / Chinook", "AST" = "Astoria", 
                               "PRN" = "Princeton/ Half Moon\nBay", "SF" = "San Francisco", 
                               "SLT" = "Sausalito", "TRM" = "Terminal Island",
                               "VEN" = "Ventura"))

q.psdn.by.month <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%
  filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>%  
  group_by(LANDING_YEAR, LANDING_MONTH, PACFIN_PORT_CODE) %>% 
  summarise(Landings_PSDN = sum(LANDED_WEIGHT_MTONS.sum)) %>%  
  group_by(LANDING_MONTH, PACFIN_PORT_CODE) %>% 
  summarise(Landings_PSDN = mean(Landings_PSDN)) %>%
    filter(PACFIN_PORT_CODE == "AST" | PACFIN_PORT_CODE == "SP" |
             PACFIN_PORT_CODE == "TRM" | PACFIN_PORT_CODE == "MOS" | 
             PACFIN_PORT_CODE == "LWC") %>%
    mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, "SP", "TRM", "MOS", "AST", "LWC"))
  
g1 <- ggplot(data=q.psdn.by.month, aes(x=LANDING_MONTH, y=Landings_PSDN)) +
    geom_bar(stat="identity", fill=rgb(0.1,0.4,0.5,0.7), width=0.4) + 
  scale_x_continuous(name = "Month", breaks=1:12) +
  scale_y_continuous(name = "Landings (M tons)" ) + 
  facet_grid(~ PACFIN_PORT_CODE, labeller = port_names) + ggtitle("(a) Pacific sardine") + 
  theme(plot.title = element_text(size=9, face="bold.italic"))

q.msqd.by.month <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%
  filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>%  
  group_by(LANDING_YEAR, LANDING_MONTH, PACFIN_PORT_CODE) %>% 
  summarise(Landings_PSDN = sum(LANDED_WEIGHT_MTONS.sum)) %>%  
  group_by(LANDING_MONTH, PACFIN_PORT_CODE) %>% 
  summarise(Landings_PSDN = mean(Landings_PSDN)) %>%
    filter( PACFIN_PORT_CODE == "SP" | PACFIN_PORT_CODE == "VEN" | PACFIN_PORT_CODE == "TRM" | 
              PACFIN_PORT_CODE == "MOS" | PACFIN_PORT_CODE == "MNT") %>%
    mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, "SP", "TRM", "VEN", "MNT", "MOS"))

# PACFIN_PORT_CODE == "HNM"

g2 <- ggplot(data=q.msqd.by.month, aes(x=LANDING_MONTH, y=Landings_PSDN)) +
    geom_bar(stat="identity", fill=rgb(0.1,0.4,0.5,0.7), width=0.4) + 
  scale_x_continuous(name = "Month", breaks=1:12) +
  scale_y_continuous(name = "Landings (M tons)" ) + 
  facet_grid(~ PACFIN_PORT_CODE, labeller = port_names) + ggtitle("(b) Market squid") + 
  theme(plot.title = element_text(size=9, face="bold.italic"))

g1 / g2

rm(g1, g2, q.psdn.by.month, q.msqd.by.month)
```


```{r msqd_month_2015, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

port_names <- as_labeller(c("SP" = "San Pedro", "HNM" = "Hueneme", "MNT" = "Monterrey", "MOS" = "Moss Landing", 
                               "LWC" = "Ilwaco / Chinook", "AST" = "Astoria", 
                               "PRN" = "Princeton/ Half Moon\nBay", "SF" = "San Francisco", 
                               "SLT" = "Sausalito", "TRM" = "Terminal Island",
                               "VEN" = "Ventura"))

q.msqd.by.month <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2015) %>%
  filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>%  
  group_by(LANDING_YEAR, LANDING_MONTH, PACFIN_PORT_CODE) %>% 
  summarise(Landings_PSDN = sum(LANDED_WEIGHT_MTONS.sum)) %>%  
  group_by(LANDING_MONTH, PACFIN_PORT_CODE) %>% 
  summarise(Landings_PSDN = mean(Landings_PSDN)) %>%
    filter( PACFIN_PORT_CODE == "SP" | PACFIN_PORT_CODE == "VEN" | PACFIN_PORT_CODE == "TRM" | 
              PACFIN_PORT_CODE == "MOS" | PACFIN_PORT_CODE == "MNT") %>%
    mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, "SP", "TRM", "VEN", "MNT", "MOS"))

ggplot(data=q.msqd.by.month, aes(x=LANDING_MONTH, y=Landings_PSDN)) +
    geom_bar(stat="identity", fill=rgb(0.1,0.4,0.5,0.7), width=0.4) + 
  scale_x_continuous(name = "Month", breaks=1:12) +
  scale_y_continuous(name = "Landings (M tons)" ) + 
  facet_grid(~ PACFIN_PORT_CODE, labeller = port_names) + ggtitle("(b) Market squid") + 
  theme(plot.title = element_text(size=9, face="bold.italic"))

rm(q.msqd.by.month)

```

<!-- <<<ISAAC: Need some more details on anchovy and herring fisheries, these I believe are constrained by management and geography, so may not be real "choices" for the substitution. >>>  -->

Landings in the CPS fishery have been mainly dominated by Pacific sardine and market squid during the period 1981-2014 as is shown in Panel (a) in Figure \ref{fig:avg_lan_rev}. Average anual prices arw shown in Panel (b). As prices are similar between species, except for market squid, low average annual landings observed for Pacific herring and Northern anchovy could be related with geography and regulatory constraint that restrict vessels to exploit them. In terms of revenue, we can observe in Panel (c) that market squid have the largest revenue, while Pacific sardine is not as relevant under this comparison due to the low prices received by fishers.


```{r avg_landings, echo=FALSE, fig.cap="Average annual landings, message=FALSE, warning=FALSE, prices and revenues by species (1981-2020).\\label{fig:avg_lan_rev}"}

## Landings chart
landings.year <- summaryBy(LANDED_WEIGHT_MTONS.sum ~ PACFIN_SPECIES_CODE + LANDING_YEAR, FUN=sumfun, data=PacFIN.month.CPS)
  landings.year <- landings.year %>% filter(LANDING_YEAR <2015)
  landings.avg.year <- summaryBy(LANDED_WEIGHT_MTONS.sum.sum ~ PACFIN_SPECIES_CODE, FUN=meanfun, da=landings.year)

g1 <- ggplot(landings.avg.year, aes(PACFIN_SPECIES_CODE, LANDED_WEIGHT_MTONS.sum.sum.mean)) +
  geom_col(width=0.4) + ggtitle("(a) Landings") + 
  theme(plot.title = element_text(size=9, face="bold.italic")) +
  xlab("Species") + ylab("Landings (tons)") + 
  scale_x_discrete(labels=c("MSQD" = "Market\nSquid", "NANC" = "Northern\nAnchovy", 
                            "PHRG" = "Pacific\nHerring", "PSDN" = "Pacific\nSardine"))

## Landings chart
price.year <- summaryBy(AFI_PRICE_PER_KG.mean ~ PACFIN_SPECIES_CODE + LANDING_YEAR, FUN=meanfun, data=PacFIN.month.CPS)
  price.year <- price.year %>% filter(LANDING_YEAR <2015)
  price.avg.year <- summaryBy(AFI_PRICE_PER_KG.mean.mean ~ PACFIN_SPECIES_CODE, FUN=meanfun, da=price.year)

g2 <- ggplot(price.avg.year, aes(PACFIN_SPECIES_CODE, AFI_PRICE_PER_KG.mean.mean.mean)) +
  geom_col(width=0.4) + ggtitle("(b) Price") + 
  theme(plot.title = element_text(size=9, face="bold.italic")) +
  xlab("Species") + ylab("Price (kg)") + 
  scale_x_discrete(labels=c("MSQD" = "Market\nSquid", "NANC" = "Northern\nAnchovy", 
                            "PHRG" = "Pacific\nHerring", "PSDN" = "Pacific\nSardine"))

## Revenue chart

revenue.year <- summaryBy(AFI_EXVESSEL_REVENUE.sum ~ PACFIN_SPECIES_CODE + LANDING_YEAR, FUN=sumfun, data=PacFIN.month.CPS)
  revenue.year <- revenue.year %>% filter(LANDING_YEAR <2015)
  revenue.avg.year <- summaryBy(AFI_EXVESSEL_REVENUE.sum.sum ~ PACFIN_SPECIES_CODE, FUN=meanfun, data=revenue.year)

g3 <- ggplot(revenue.avg.year, aes(PACFIN_SPECIES_CODE, AFI_EXVESSEL_REVENUE.sum.sum.mean)) +
  geom_col(width=0.4) + ggtitle("(c) Revenue") + 
  theme(plot.title = element_text(size=9, face="bold.italic")) +
  xlab("Species") + ylab("Revenues (Millions of USD)") +  scale_y_continuous(labels = label_number(scale = 1e-6)) +
  scale_x_discrete(labels=c("MSQD" = "Market\nSquid", "NANC" = "Northern\nAnchovy", 
                            "PHRG" = "Pacific\nHerring", "PSDN" = "Pacific\nSardine"))

(g1 + g2) / g3

rm(g1, g2, g3, landings.year, landings.avg.year, revenue.year, revenue.avg.year, price.year, price.avg.year)

```

```{r datasets_year, include=FALSE}
# PacFIN.month.CPS.noPHRG <- PacFIN.month %>% filter(PACFIN_SPECIES_CODE %in% c("PSDN", "MSQD", "NANC"))
# PacFIN.month.CPS.noPHRG$Date <- zoo::as.yearmon(paste(PacFIN.month.CPS$LANDING_YEAR, PacFIN.month.CPS$LANDING_MONTH), "%Y %m")


# Calculate number of vessels by species per month # 
nvessel.year <- PacFIN.month.CPS %>% 
  dplyr::select(PACFIN_SPECIES_CODE, LANDING_YEAR, VESSEL_NUM) %>% unique() %>% 
  mutate(n_vessel = 1) %>% group_by(PACFIN_SPECIES_CODE, LANDING_YEAR) %>%
  summarise(n_vessel = sum(n_vessel))

# Calculate average price and total landings by species per month #
landing.price.year <- summaryBy(LANDED_WEIGHT_MTONS.sum + AFI_PRICE_PER_KG.mean ~ 
                                  PACFIN_SPECIES_CODE + LANDING_YEAR, 
                      FUN=sum_mean_fun, data=PacFIN.month.CPS) 

```


```{r ts_Q_P_V, eval=FALSE, fig.cap="Yearly total landing, warning=FALSE, average price and total number of vessel by CPS species (1981 - 2020).\\label{fig:ts_landings}", message=FALSE, include=FALSE}

g1 <- ggplot(landing.price.year, 
             aes(x = LANDING_YEAR, y = LANDED_WEIGHT_MTONS.sum.sum, group = PACFIN_SPECIES_CODE, colour = PACFIN_SPECIES_CODE)) + 
  geom_line(size=1) + scale_x_continuous(name = "Year") +
  scale_y_continuous(name = "Landings (MTons)") + 
  theme(legend.position = "right", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(a) Landings") +   guides(colour=guide_legend(title="Species: ")) + 
  scale_color_brewer(palette="Set2", labels=c("MSQD" = "Market Squid", 
                                              "NANC" = "Northern Anchovy",
                                              "PSDN" = "Pacific Herring",
                                              "PSDN" = "Pacific Sardine"))
  
g2 <- ggplot(landing.price.year,
             aes(x = LANDING_YEAR, y = AFI_PRICE_PER_KG.mean.mean, group = PACFIN_SPECIES_CODE, colour = PACFIN_SPECIES_CODE)) + 
  geom_line(size=1) + scale_x_continuous(name = "Year") +
  scale_y_continuous(name = "Price ($/Kg)")  + 
   scale_color_brewer(palette="Set2") +  theme(legend.position = "none", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(b) Prices")


g3 <- ggplot(nvessel.year, aes(x = LANDING_YEAR, y = n_vessel, group = PACFIN_SPECIES_CODE, colour = PACFIN_SPECIES_CODE)) + 
  geom_line(size=1) + scale_x_continuous(name = "Year") +
  scale_y_continuous(name = "# of vessels") +   theme(legend.position="none")  + 
   scale_color_brewer(palette="Set2") +  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(c) Number of vessels")

(g2 + g1) / g3

rm(g1, g2, g3)

```

Figure \ref{fig:ts_landings_price} shows the evolution of landings and prices and vessel participation by species during the period 1981-2020. We can observe in panel (a) that real prices for market squid have been increasing during the last two decades. 
Incentives should be high for landing market squid. However, we observe a sharp decline on market squid landings in the last decade.^[Prices fro forage species are likely to be determined in the world market, as the California current landings for forage species correspond to a small share of the total landings in the world]. Regarding the other species, we observe a decline in both prices and landings during the last decade. 

```{r ts_landing_price, echo=FALSE, fig.cap="Yearly total landing v/s, warning=FALSE, average price by CPS species (1981 - 2020).\\label{fig:ts_landings_price}", message=FALSE}
landing.price.year.sel <- landing.price.year %>% 
  select("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean", "PACFIN_SPECIES_CODE", "LANDING_YEAR")

# Graph landing v/s number of  vessels
coeff <- 100000
  df <- landing.price.year.sel %>% filter(PACFIN_SPECIES_CODE == "MSQD")
  df$AFI_PRICE_PER_KG.mean.mean <- df$AFI_PRICE_PER_KG.mean.mean * coeff 
  df <- gather(df, key = Variable, value = value,
               c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"))
  g1 <- ggplot(df, aes(x=LANDING_YEAR, y = value, colour = Variable)) + geom_line(size=1) +
    scale_y_continuous(name = "Landings (M Tons)", sec.axis = sec_axis(~./coeff, name = "")) +
    theme(legend.position="none") + scale_x_continuous(name = element_blank()) + 
    theme(plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
      ggtitle("(a) Market Squid")  +  
    scale_color_brewer(palette="Set2",
                       limits = c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"))

coeff <- 100000
  df <- landing.price.year.sel %>% filter(PACFIN_SPECIES_CODE == "PSDN")
  df$AFI_PRICE_PER_KG.mean.mean <- df$AFI_PRICE_PER_KG.mean.mean * coeff 
  df <- gather(df, key = Variable, value = value,
               c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"))
  g2 <- ggplot(df, aes(x=LANDING_YEAR, y = value, colour = Variable)) + geom_line(size=1) +
    scale_y_continuous(name = "", sec.axis = sec_axis(~./coeff, name = "Price per kilogram")) + 
    theme(legend.position="none") + scale_x_continuous(name = "") +
    theme(plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
      ggtitle("(b) Pacific Sardine")  +  
    scale_color_brewer(palette="Set2",
                       limits = c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"))

coeff <- 1500
  df <- landing.price.year.sel %>% filter(PACFIN_SPECIES_CODE == "PHRG")
  df$AFI_PRICE_PER_KG.mean.mean <- df$AFI_PRICE_PER_KG.mean.mean * coeff 
  df <- gather(df, key = Variable, value = value,
               c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"))
  g3 <- ggplot(df, aes(x=LANDING_YEAR, y = value, colour = Variable)) + geom_line(size=1) +
  scale_y_continuous(name = "Landings (M Tons)", sec.axis = sec_axis(~./coeff, name = "")) +
  theme(legend.position="none") + scale_x_continuous(name = "Year") +
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
    ggtitle("(c) Pacific Herring")  +  scale_color_brewer(palette="Set2",
                       limits = c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"))

coeff <- 30000
  df <- landing.price.year.sel %>% filter(PACFIN_SPECIES_CODE == "NANC")
  df$AFI_PRICE_PER_KG.mean.mean <- df$AFI_PRICE_PER_KG.mean.mean * coeff 
  df <- gather(df, key = Variable, value = value,
               c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"))
  g4 <- ggplot(df, aes(x=LANDING_YEAR, y = value, colour = Variable)) + geom_line(size=1) +
    scale_y_continuous(name = "", sec.axis = sec_axis(~./coeff, name = "Price per kilogram")) +
    theme(legend.position="bottom") + scale_x_continuous(name = "Year") + 
    theme(plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
    ggtitle("(d) Northern Anchovy") + guides(colour=guide_legend(title="Variables: ")) + 
  scale_color_brewer(palette="Set2",
                     limits = c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"),
                     labels=c("AFI_PRICE_PER_KG.mean.mean" = "Price", "LANDED_WEIGHT_MTONS.sum.sum" = "Landings"))
  
(g1 + g2) / (g3 + g4)
  rm(df, g1, g2, g3, g4, landing.price.year.sel)
  
  
```

A potential hypothesis for the observed decline in market squid landings could be that the lower abundance and the consequently closure of the Pacific sardine fishery also affect vessels' decision to participate in the market squid fishery. Maybe fishers stop fishing at all as the exclusion of Pacific sardine from tehir portfolio reduce the ability of fisher for reduce income risk through diversification of their fisher portfolios [@kasperski2013]. We have some suggestive evidence from this in Figure \ref{fig:ts_landings}, which shows the evolution of landings and vessel participation by species during the period 1981-2020. 
We observe a slighly increase on number of vessel participating in the market squid fishery after the Pacific sardine closure in 2015, from 72 vessels in 2015 to 109 in 2020, but way below the levels observed in 2012 with 139 vessels participation in 2012.  This trends does not coincide with the perception that stalkholders have about switching behavior. They claim that after the Pacific sardine closure, in California many vessels switch to market squid.^[This was stated by a participant from a workshop that reunite U.S. West Coast fishery stalkholders.] Another hypothesis that could explain the lower landings levels observed  for market squid in the last decade could be changing in species availability and substitution to another species more profitable than market squid. According to the stalkholders, substitution between Pacific sardine may happen also with mackerel, tuna, or anchovy. ***<<NOTE: WE HAVE TO THINK IN OTHER SPECIES THAT MARKET SQUID VESSEL CAN SWITH: Should we include tuna and mackerel in the analysis?? Maybe take out herring? Going to check first gears to see any chances of substitution>>*** Our empirical strategy is designed to address various concerns about omitted variables to obtain clean causal effect of a set of explanatory variables.


```{r ts_landings_vessels, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
landing.nvessels.year.sel <- landing.price.year %>% 
  inner_join(nvessel.year, by = c("PACFIN_SPECIES_CODE", "LANDING_YEAR")) %>%
  select("LANDED_WEIGHT_MTONS.sum.sum", "n_vessel", "PACFIN_SPECIES_CODE", "LANDING_YEAR")

# Graph landing v/s number of  vessels
coeff <- 1000
  df <- landing.nvessels.year.sel %>% filter(PACFIN_SPECIES_CODE == "MSQD" | PACFIN_SPECIES_CODE == "PSDN") %>%
    mutate(n_vessel = ifelse(PACFIN_SPECIES_CODE == "MSQD", n_vessel, 0)) %>%
    mutate(LANDED_WEIGHT_MTONS.sum.sum = ifelse(PACFIN_SPECIES_CODE == "PSDN", LANDED_WEIGHT_MTONS.sum.sum, 0)) %>%
    group_by(LANDING_YEAR) %>% 
    summarise(n_vessel = sum(n_vessel), LANDED_WEIGHT_MTONS.sum.sum = sum(LANDED_WEIGHT_MTONS.sum.sum))
  
  df$n_vessel <- df$n_vessel * coeff 
  df <- gather(df, key = Variable, value = value,
               c("n_vessel", "LANDED_WEIGHT_MTONS.sum.sum"))
  ggplot(df, aes(x=LANDING_YEAR, y = value, colour = Variable)) + geom_line(size=1) +
    scale_y_continuous(name = "Landings of Pacific sardine (M Tons)", sec.axis = sec_axis(~./coeff, name = "# of vessels harvesting Market squid")) +
    theme(legend.position="bottom") + scale_x_continuous(name = element_blank()) + 
    theme(plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +  
    scale_color_brewer(palette="Set2", limits = c("LANDED_WEIGHT_MTONS.sum.sum", "n_vessel"))

rm(g1, g2, g3, g4, df, landing.nvessels.year.sel, landing.price.year, nvessel.year, coeff)
  
```


## Switching behavior

Before continuing our analysis, we have to verify whether there is actually exist switching behavior between CPS species. First, we observe how many vessel participate in both the Pacific sardine and market squid fishery. To do this, we first have to define what we understand as participation. Following @richerson2017, we consider a vessel participate in a specific fishery if they met the following criteria:

1. Harvest the species during the period 2000-2014 (before the Pacific sardine closure) 
2. Total annual revenue from the species averaged at least 1000 USD per year over 2000–2014. This calculation exclude years where the vessel did not fish.
3. Revenue from the species at least 5% of total vessel revenue per year over 2000–2014.
4. The vessel fished at least 3 of 15 years in 2000–2014.


```{r only_psdn, include=FALSE}
### Vessel that participate in Pacific sardine.
total.revenue <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>% 
  group_by(VESSEL_NUM, LANDING_YEAR) %>% summarise(year_revenue = sum(AFI_EXVESSEL_REVENUE.sum)) 

psdn.fleet <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>% 
  group_by(VESSEL_NUM, LANDING_YEAR) %>% summarise(revenue_psdn = sum(AFI_EXVESSEL_REVENUE.sum)) %>%
    merge(total.revenue, by = c("VESSEL_NUM", "LANDING_YEAR"), all.x = TRUE) %>% 
  filter(revenue_psdn > 0) %>% group_by(VESSEL_NUM) %>% 
  summarise(anual_revenue_psdn = mean(revenue_psdn), anual_revenue_all = mean(year_revenue), n_year_fishing = n()) %>%  
  mutate(perc_psdn_rev = anual_revenue_psdn/anual_revenue_all) %>% 
  filter(anual_revenue_psdn >= 1000) %>% 
  filter(perc_psdn_rev >= 0.05) %>% 
  filter(n_year_fishing >= 3) %>%
  select(VESSEL_NUM) %>% unique() %>% mutate(d_PSDN_fleet = 1)

msqd.fleet <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>% 
  group_by(VESSEL_NUM, LANDING_YEAR) %>% summarise(revenue_specie = sum(AFI_EXVESSEL_REVENUE.sum)) %>%
    merge(total.revenue, by = c("VESSEL_NUM", "LANDING_YEAR"), all.x = TRUE) %>% 
  filter(revenue_specie > 0) %>% group_by(VESSEL_NUM) %>% 
  summarise(anual_revenue_specie = mean(revenue_specie), anual_revenue_all = mean(year_revenue), n_year_fishing = n()) %>%  
  mutate(perc_specie_rev = anual_revenue_specie/anual_revenue_all) %>% 
  filter(anual_revenue_specie >= 1000) %>% 
  filter(perc_specie_rev >= 0.05) %>% 
  filter(n_year_fishing >= 3) %>%
  select(VESSEL_NUM) %>% unique() %>% mutate(d_MSQD_fleet = 1)


# Which are the vessel that harvest both PSDN and MSQD?
squid.and.psdn <- merge(psdn.fleet, msqd.fleet, by = c("VESSEL_NUM"), all.y = FALSE, all.x = FALSE) %>%
  select(VESSEL_NUM) %>% unique() %>%  mutate(d_PSDN_and_MSQD = 1)

# Which are the vessel that harvest only MSQD?
only.msqd <- msqd.fleet %>% merge(squid.and.psdn, by = c("VESSEL_NUM"), all.x = TRUE) %>% 
  filter(is.na(d_PSDN_and_MSQD)) %>% select(VESSEL_NUM) %>% unique() %>% mutate(d_onlyMSQD = 1)

# Which are the vessel that harvest only PSDN?
only.psdn <- psdn.fleet %>% merge(squid.and.psdn, by = c("VESSEL_NUM"), all.x = TRUE) %>% 
  filter(is.na(d_PSDN_and_MSQD)) %>% select(VESSEL_NUM) %>% unique() %>% mutate(d_onlyPSDN = 1)

rm(total.revenue)

```

From 2000 to 2014, there are 74 vessels that participate in both Pacific sardine and market squid fisheries, while 26 vessel participate in the Pacific sardine but not in the market squid fishery, and  82 vessels participate in the market squid fishery but not in the Pacific sardine fishery. From this calculation, we can infer that it is more likely that a vessel that harvest Pacific sardine will also harvest market squid, instead of the opposite. This is also reflected in Figure \ref{fig:switching}, which shows the number of vessel that harvest squid in a year conditional they also harvest sardine, and the number of vessel that harvest sardine in a year conditional that they also harvest squid. 


<!-- ```{r dataframe_with_dummies, include=FALSE} -->

<!-- ## Characterize vessel that harvest both PSDN and MSQD.  -->

<!-- df <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%  -->
<!--   merge(squid.and.psdn, by = c("VESSEL_NUM"), all.x = TRUE) %>%  -->
<!--   merge(only.msqd, by = c("VESSEL_NUM"), all.x = TRUE) %>%  -->
<!--   merge(only.psdn, by = c("VESSEL_NUM"), all.x = TRUE) %>%  -->
<!--   filter(d_PSDN_and_MSQD == 1 | d_onlyPSDN == 1 | d_onlyMSQD == 1) %>% -->
<!--   mutate(d_PSDN_and_MSQD = if_else(is.na(d_PSDN_and_MSQD), 0, d_PSDN_and_MSQD)) %>% -->
<!--   mutate(d_onlyPSDN = if_else(is.na(d_onlyPSDN), 0, d_onlyPSDN)) %>% -->
<!--   mutate(d_onlyMSQD = if_else(is.na(d_onlyMSQD), 0, d_onlyMSQD)) -->

<!-- # rm(df) -->

<!-- ``` -->



<!--"SPECIFICS: But there is a limit to how far its profitable to truck -->
<!-- fish. Between Coos Bay and San Francisco there is very little opportunity for large -->
<!-- volume (squid) landings. If the squid biomass shifted north 200-300 miles, a lack of -->
<!-- infrastructure could mean that squid goes unharvested." (CPS Workshop) "Spoilage of CPS is rapid, so vessels remain as close to a port as possible and usually return within one day; there could be large impacts if CPS move into areas where there is no nearby infrastructure to land catches" (CPS Workshop) -->
<!-- "NW and SW communities differents" (Workshop) -->

<!-- Projecting the effect on climate change on the CPS fishery is not straightforward. Some fishers communities are more vulnerable to others to changes in species abuandance. Port constraints and fleet heterogeneity reduce the set of species that fishers are able to choose for harvest (**FROM CPS WORKSHOP**), while fixed contracts with processor also reduce switching capacity between species in the short-run. Our paper... ***HOW WE SOLVE THIS?***  -->



```{r switching, include=FALSE}
psdn.by.year <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR) %>% filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>% 
  unique() %>% mutate(harv.psdn = 1)
msqd.by.year <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR) %>% filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>% 
  unique() %>% mutate(harv.msqd = 1)

# If a vessel harvest Pacific sardine in a year, how many also harvest squid.
squid.cond.psdn <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR) %>% merge(psdn.by.year, 
                        by = c("VESSEL_NUM", "LANDING_YEAR"), all.y = TRUE) %>% 
  filter(harv.psdn == 1) %>% filter(PACFIN_SPECIES_CODE.x == "MSQD") %>% unique()

# Calculate number of vessels harvesting sardine and squid and percentage per year
n_vessel_psdn <- psdn.by.year %>% group_by(LANDING_YEAR) %>% summarize(n_vessel_psdn = sum(harv.psdn))
n_vessel_msqd_c_psdn <- squid.cond.psdn %>% group_by(LANDING_YEAR) %>% summarize(n_vessel_msqd = sum(harv.psdn))
  df <- n_vessel_msqd_c_psdn %>% mutate(perc = n_vessel_psdn$n_vessel_psdn) %>%
    mutate(n_vessel_only_psdn = perc) %>%  # - n_vessel_msqd
    mutate(perc = (n_vessel_msqd / perc)) 
  
coeff = 115
g1 <- ggplot(df) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = n_vessel_only_psdn,
                          color = "# of vessels landing sardine"), size = 1) +
  geom_line(mapping = aes(x = LANDING_YEAR, y = n_vessel_msqd,
                          color = "# of vessels landing squid (c/ landing sardine)"), size = 1) +
  geom_line(mapping = aes(x = LANDING_YEAR, y = perc*coeff, 
                          color = "% of vessels landing squid (c/ landings sardine)"),
            size = 1, linetype = "dashed") + scale_x_continuous(name = "Year") +
  scale_y_continuous(name = "Number of vessels", 
                     sec.axis = sec_axis(~./coeff, name = "% vessels harvesting squid" )) +
  theme(axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +  scale_color_manual(name = "Variables: ", 
                     values = c("# of vessels landing sardine" = "green", 
                                "# of vessels landing squid (c/ landing sardine)" = "blue",
                               "% of vessels landing squid (c/ landings sardine)" = "grey")) + 
  theme(legend.position="right")


rm(psdn.by.year, squid.cond.psdn, n_vessel_psdn, n_vessel_msqd_c_psdn, df, coeff)
```

```{r switching_graph, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Switching between Pacific sardine and market squid.\\label{fig:switching}"}
msqd.by.year <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2020) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR) %>% filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>% 
  unique() %>% mutate(harv.msqd = 1)

# If a vessel harvest Pacific sardine in a year, how many also harvest squid.
psdn.cond.msqd <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2020) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR) %>% merge(msqd.by.year, 
                        by = c("VESSEL_NUM", "LANDING_YEAR"), all.y = TRUE) %>% 
  filter(harv.msqd == 1) %>% filter(PACFIN_SPECIES_CODE.x == "PSDN") %>% unique()

# Calculate number of vessels harvesting sardine and squid and percentage per year
n_vessel_msqd <- msqd.by.year %>% group_by(LANDING_YEAR) %>% summarize(n_vessel_msqd = sum(harv.msqd))
n_vessel_psdn_c_msqd <- psdn.cond.msqd %>% group_by(LANDING_YEAR) %>% summarize(n_vessel_psdn = sum(harv.msqd))
  df <- n_vessel_psdn_c_msqd %>%  mutate(n_vessel_msqd = n_vessel_msqd$n_vessel_msqd) %>%
    mutate(perc = n_vessel_psdn / n_vessel_msqd) 
  
coeff = 200
g2 <- ggplot(df) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = n_vessel_msqd,
                          color = "# of vessels landing squid"), size = 1) +
  geom_line(mapping = aes(x = LANDING_YEAR, y = n_vessel_psdn,
                          color = "# of vessels landing sardine (c/ landing squid)"), size = 1) +
  geom_line(mapping = aes(x = LANDING_YEAR, y = perc*coeff, 
                          color = "% of vessels landing sardine (c/ landings squid)"),
            size = 1, linetype = "dashed") + scale_x_continuous(name = "Year") +
  scale_y_continuous(name = "Number of vessels", 
                     sec.axis = sec_axis(~./coeff, name = "% vessels harvesting squid" )) +
  theme(axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +  scale_color_manual(name = "Variables: ", 
                     values = c("# of vessels landing squid" = "green", 
                                "# of vessels landing sardine (c/ landing squid)" = "blue",
                               "% of vessels landing sardine (c/ landings squid)" = "grey")) + 
  theme(legend.position="right")

g1 / g2

rm(msqd.by.year, psdn.cond.msqd, n_vessel_msqd, n_vessel_psdn_c_msqd, df, coeff, g1, g2)

```

<!-- ```{r switching_quarter, eval=FALSE, include=FALSE} -->
<!-- psdn.by.quarter <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%  -->
<!--   mutate(quarter = quarter(zoo::as.yearmon(paste(LANDING_YEAR, LANDING_MONTH, sep='-')), with_year = TRUE)) %>%  -->
<!--   select(VESSEL_NUM, PACFIN_SPECIES_CODE, quarter) %>% filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>%  -->
<!--   unique() %>% mutate(harv.psdn = 1)  -->

<!-- # If a vessel harvest Pacific sardine in a year, how many also harvest squid. -->
<!-- squid.cond.psdn <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%  -->
<!--   mutate(quarter = quarter(zoo::as.yearmon(paste(LANDING_YEAR, LANDING_MONTH, sep='-')), with_year = TRUE)) %>%  -->
<!--   select(VESSEL_NUM, PACFIN_SPECIES_CODE, quarter) %>% merge(psdn.by.quarter,  -->
<!--                         by = c("VESSEL_NUM", "quarter"), all.y = TRUE) %>%  -->
<!--   filter(harv.psdn == 1) %>% filter(PACFIN_SPECIES_CODE.x == "MSQD") %>% unique() -->

<!-- # Calculate number of vessels harvesting sardine and squid and percentage per year -->
<!-- n_vessel_psdn <- psdn.by.quarter %>% group_by(quarter) %>%  -->
<!--   summarize(n_vessel_psdn = sum(harv.psdn, na.rm = TRUE)) -->

<!-- n_vessel_msqd_c_psdn <- squid.cond.psdn %>% group_by(quarter) %>%  -->
<!--   summarize(n_vessel_msqd = sum(harv.psdn, na.rm = TRUE)) -->

<!-- df <- merge(n_vessel_psdn, n_vessel_msqd_c_psdn, by=c("quarter"), all.x = TRUE) %>% -->
<!--     mutate(n_vessel_msqd = if_else(is.na(n_vessel_msqd), 0, n_vessel_msqd)) %>% -->
<!--     mutate(perc = (n_vessel_msqd / n_vessel_psdn)) -->

<!-- # coeff = 79 -->
<!-- ggplot(df) +  -->
<!--   geom_line(mapping = aes(x = quarter, y = perc), color = "blue", size = 1) +  -->
<!--   scale_x_continuous(name = "Quarter") + -->
<!--   scale_y_continuous(name = "% of vessel harvesting squid" ) +  -->
<!--   theme(axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + -->
<!--   theme(legend.position="bottom") -->

<!-- rm(psdn.by.quarter, squid.cond.psdn, n_vessel_psdn, n_vessel_msqd_c_psdn, df) -->

<!-- ``` -->

```{r switching_month}
psdn.by.month <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR, LANDING_MONTH) %>% filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>% 
  unique() %>% mutate(harv.psdn = 1) 

# If a vessel harvest Pacific sardine in a year, how many also harvest squid.
squid.cond.psdn <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR, LANDING_MONTH) %>% merge(psdn.by.month, 
                        by = c("VESSEL_NUM", "LANDING_YEAR", "LANDING_MONTH"), all.y = TRUE) %>% 
  filter(harv.psdn == 1) %>% filter(PACFIN_SPECIES_CODE.x == "MSQD") %>% unique()

# Calculate number of vessels harvesting sardine and squid and percentage per year
n_vessel_psdn <- psdn.by.month %>% group_by(LANDING_YEAR, LANDING_MONTH) %>% 
  summarize(n_vessel_psdn = sum(harv.psdn, na.rm = TRUE)) 

n_vessel_msqd_c_psdn <- squid.cond.psdn %>% group_by(LANDING_YEAR, LANDING_MONTH) %>% 
  summarize(n_vessel_msqd = sum(harv.psdn, na.rm = TRUE))
  
df <- merge(n_vessel_psdn, n_vessel_msqd_c_psdn, by=c("LANDING_YEAR", "LANDING_MONTH"), all.x = TRUE) %>%
    mutate(n_vessel_msqd = if_else(is.na(n_vessel_msqd), 0, n_vessel_msqd)) %>% group_by(LANDING_MONTH) %>% 
    summarize(n_vessel_msqd = sum(n_vessel_msqd, na.rm = TRUE), n_vessel_psdn = sum(n_vessel_psdn, na.rm = TRUE)) %>%
    mutate(perc = (n_vessel_msqd / n_vessel_psdn)) %>% select(LANDING_MONTH, perc)

ggplot(data=df, aes(x=LANDING_MONTH, y=perc)) +
    geom_bar(stat="identity", fill=rgb(0.1,0.4,0.5,0.7), width=0.4) + 
  scale_x_continuous(name = "Month", breaks=1:12) +
  scale_y_percent(name = "Percentage of vessels harvesting squid" )

rm(psdn.by.month, squid.cond.psdn, n_vessel_psdn, n_vessel_msqd_c_psdn, df)


```

```{r switching_day, echo=FALSE}
# PacFIN_2010_2020 <- read.csv(file = "C:/Data/PacFIN data/FutureSeasIII_2010_2020.csv")
#   PacFIN_2000_2009 <- read.csv(file = "C:/Data/PacFIN data/FutureSeasIII_2000_2009.csv")
# 
#   # Merge different decades of data #
# PacFIN <- rbind.data.frame(PacFIN_2000_2009, PacFIN_2010_2020)
#   rm(PacFIN_2000_2009, PacFIN_2010_2020)
#   gc()
# 
# psdn.by.day <- PacFIN %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>% 
#   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR, LANDING_MONTH, LANDING_DAY) %>% 
#   filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>% 
#   unique() %>% mutate(harv.psdn = 1) 
# 
# # If a vessel harvest Pacific sardine in a year, how many also harvest squid.
# squid.cond.psdn <- PacFIN %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>% 
#   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR, LANDING_MONTH, LANDING_DAY) %>% 
#   merge(psdn.by.day, by = c("VESSEL_NUM", "LANDING_YEAR", "LANDING_MONTH", "LANDING_DAY"), all.x = TRUE) %>% 
#   filter(harv.psdn == 1) %>% filter(PACFIN_SPECIES_CODE.x == "MSQD") %>% unique()
# 
# # Calculate number of vessels harvesting sardine and squid and percentage per year
# n_vessel_psdn <- psdn.by.day %>% group_by(LANDING_YEAR, LANDING_MONTH, LANDING_DAY) %>% 
#   summarize(n_vessel_psdn = sum(harv.psdn, na.rm = TRUE)) 
# # %>% group_by(LANDING_MONTH, LANDING_DAY) %>% 
# #   summarize(n_vessel_psdn = mean(n_vessel_psdn, na.rm = TRUE))
# 
# n_vessel_msqd_c_psdn <- squid.cond.psdn %>% group_by(LANDING_YEAR, LANDING_MONTH, LANDING_DAY) %>% 
#   summarize(n_vessel_msqd = sum(harv.psdn, na.rm = TRUE)) 
# # %>% group_by(LANDING_MONTH, LANDING_DAY) %>% 
# #   summarize(n_vessel_msqd = mean(n_vessel_msqd, na.rm = TRUE))
#   
# df <- merge(n_vessel_psdn, n_vessel_msqd_c_psdn, by=c("LANDING_YEAR", "LANDING_MONTH", "LANDING_DAY"), all.x = TRUE) %>%
#     mutate(n_vessel_msqd = if_else(is.na(n_vessel_msqd), 0, n_vessel_msqd)) %>% group_by(LANDING_MONTH, LANDING_DAY) %>% 
#     summarize(n_vessel_msqd = sum(n_vessel_msqd, na.rm = TRUE), n_vessel_psdn = sum(n_vessel_psdn, na.rm = TRUE)) %>%
#     mutate(perc = (n_vessel_msqd / n_vessel_psdn)) %>% select(LANDING_MONTH, LANDING_DAY, perc)
# 
# df$MonthDay <- paste( month.abb[df$LANDING_MONTH], df$LANDING_DAY, sep="-" )
# 
# write.csv(df,"C:\\Data\\day_switch.csv", row.names = FALSE)
df <- read.csv(file = "C:\\Data\\day_switch.csv")

ggplot(data=df, aes(x=MonthDay, y=perc)) +
    geom_bar(stat="identity", fill=rgb(0.1,0.4,0.5,0.7), width=0.4) + 
  scale_x_discrete(name = "Day", breaks=1:366) +
  scale_y_percent(name = "Percentage of vessels harvesting squid" )

rm(df)


```

## Gear

Substitution between species is likely to be related with the gear that a vessel or fisher have already invest for their fishing activities. However, a vessel is not restricted to an specific gear. They can switch between different alternatives. In average a vessel use 1.4 gears for their fishing activities in out sample data, with an standard deviation of 0.72. If we only focus in CPS species, a vessel switch between 1.42 gears in average to harvest market squid, 1.16 gears in average to harvest Northern anchovy, 1.16 gears in average to harvest Pacific herring and 1.28 in average to harvest Pacific sardine. In terms of gears, midwater trawl and seine allow for the highest level of substitution between CPS species. In average, a vessel using midwater trawl harvest 2.36 CPS species, while a vessel using seine harvest in average 1.91 CPS species (see Table \ref{n_CPS_gear})

<!-- "Peer groups of vessels from the same port and using the same gear type are often subject to a common set of spatial constraints (for example, shared local ecological knowledge, vessel mobility) and, as a result, typically exhibit distinct and relatively enduring spatial patterns of ocean use. The ‘communities-at-sea’ concept11 recognizes that shared patterns of ocean" Rogers -->

```{r n_gears_used_vessels, eval=FALSE, include=FALSE}
# How many gears a vessel use in the dataset
PacFIN.CPS.unique.gear <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_GEAR_CODE) %>% unique()


PacFIN.CPS.n_gears <- PacFIN.CPS.unique.gear %>% mutate(n_gears = 1) %>% group_by(VESSEL_NUM) %>% 
  summarise(n_gears= sum(n_gears)) 
  summary(PacFIN.CPS.n_gears$n_gears)
  sd(PacFIN.CPS.n_gears$n_gears)

# ### If I have used SEINE, how many other gear I use?
# PacFIN.Base <- PacFIN_month %>% filter( LANDING_YEAR >= 2010) %>%  select(VESSEL_NUM, PACFIN_GEAR_CODE) %>% unique()
#   PacFIN.only.seine <- PacFIN_month %>% filter( LANDING_YEAR >= 2010) %>% select(VESSEL_NUM, PACFIN_GEAR_CODE) %>%
#     filter(PACFIN_GEAR_CODE == "SEN") %>% mutate(D_Seine = 1) %>% select(VESSEL_NUM, D_Seine) %>% unique() 
#   PacFIN.CPS.n_gear <- PacFIN.Base %>% inner_join(PacFIN.only.seine, by = c("VESSEL_NUM")) %>% filter(D_Seine == 1) %>% 
#     unique() %>% group_by(VESSEL_NUM) %>% summarise(N_gear= sum(D_Seine)) 
#   summary(PacFIN.CPS.n_gear$N_gear)
#   sd(PacFIN.CPS.n_gear$N_gear)
  
rm(PacFIN.CPS.unique.gear, PacFIN.CPS.n_gears)

```

```{r n_gear_CPS, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
PacFIN.Gear.PSDN <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% unique() %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>% mutate(n_gears = 1) %>%  
  group_by(VESSEL_NUM) %>% summarise(n_gears = sum(n_gears)) %>% mutate(Species = "PSDN")

PacFIN.Gear.MSQD <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% unique() %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>% mutate(n_gears = 1) %>%  
  group_by(VESSEL_NUM) %>% summarise(n_gears = sum(n_gears)) %>% mutate(Species = "MSQD")

PacFIN.Gear.NANC <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% unique() %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("NANC")) %>% mutate(n_gears = 1) %>%  
  group_by(VESSEL_NUM) %>% summarise(n_gears = sum(n_gears)) %>% mutate(Species = "NANC")

PacFIN.Gear.PHRG <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% unique() %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("PHRG")) %>% mutate(n_gears = 1) %>%  
  group_by(VESSEL_NUM) %>% summarise(n_gears = sum(n_gears)) %>% mutate(Species = "PHRG")

PacFIN.Gear <- rbind.data.frame(PacFIN.Gear.PSDN, PacFIN.Gear.NANC, PacFIN.Gear.MSQD, PacFIN.Gear.PHRG)

table <- xtabs(n_gears ~ Species, aggregate(n_gears ~ Species, PacFIN.Gear, mean))
#table
rownames(table) = c("Market squid", "Northern Anchovy", "Pacific Herring", "Pacific sardine") 
print(xtable(table, caption = 'Average number of gear used to catch a CPS species.', type = "latex"), comment=FALSE,  caption.placement = "top")

rm(PacFIN.Gear, PacFIN.Gear.PSDN, PacFIN.Gear.NANC, PacFIN.Gear.MSQD, PacFIN.Gear.PHRG)

```

```{r n_species_CPS_by_gear, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

# Create dummy of whether a vessel harvest MSQD, NANC OR PSDN 
PacFIN.CPS <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("PSDN", "MSQD", "NANC", "PHRG")) %>%  
  filter(PACFIN_GEAR_CODE %in% c("DPN", "ONT", "SEN", "GLN", "MDT", "POL")) %>% mutate(CPS_species = 1) %>%
  group_by(VESSEL_NUM, PACFIN_GEAR_CODE) %>% 
  summarise(n_CPS_landed = sum(CPS_species)) 

table <- xtabs(n_CPS_landed ~ PACFIN_GEAR_CODE, aggregate(n_CPS_landed ~ PACFIN_GEAR_CODE, PacFIN.CPS, mean))
#table
rownames(table) = c("Dip Net", "Gill Net", "Midwater Trawl", "Other Net Gear", "Pole", "Seine") 

print(xtable(table, caption = 'Average number of CPS species landed by a vessel by gear used.\\label{Table:n_CPS_gear}', type = "latex"), comment=FALSE,  caption.placement = "top")

rm(PacFIN.CPS, table)

```

Seine is the most used gear to harvest Pacific sardine, Northern anchovy and Market squid. From Table \ref{Table:n_vess_gear} we can observe that 41\% of vessels have used seine to harvest Market squid since the year 2000, 57\% to harvest Pacific sardine and 51\% to harvest Northern anchovy. In the case of Pacific herring, half of the vessel observed during the period 2000-2020 use gill net for their harvest instead of seine, where only 7\% of vessels have used this gear. Similar patter is observed when we compute the total landed weight for these four species during the period 2000-2020, presented in Table \ref{table:landing_by_gears}.

```{r n_vessels_using_gear, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
PacFIN.Gear.PSDN <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>% 
  mutate(n_vessels = 1) %>% group_by(PACFIN_GEAR_CODE) %>% 
  summarise(n_vessels = sum(n_vessels)) %>% mutate(Species = "PSDN") %>% 
  filter(PACFIN_GEAR_CODE %in% c("DPN", "GLN", "MDT", "ONT", "POL", "SEN"))

PacFIN.Gear.MSQD <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>% 
  mutate(n_vessels = 1) %>% group_by(PACFIN_GEAR_CODE) %>% 
  summarise(n_vessels = sum(n_vessels)) %>% mutate(Species = "MSQD") %>% 
  filter(PACFIN_GEAR_CODE %in% c("DPN", "GLN", "MDT", "ONT", "POL", "SEN"))

PacFIN.Gear.PHRG <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("PHRG")) %>% 
  mutate(n_vessels = 1) %>% group_by(PACFIN_GEAR_CODE) %>% 
  summarise(n_vessels = sum(n_vessels)) %>% mutate(Species = "PHRG") %>% 
  filter(PACFIN_GEAR_CODE %in% c("DPN", "GLN", "MDT", "ONT", "POL", "SEN"))

PacFIN.Gear.NANC <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE %in% c("NANC")) %>% 
  mutate(n_vessels = 1) %>% group_by(PACFIN_GEAR_CODE) %>% 
  summarise(n_vessels = sum(n_vessels)) %>% mutate(Species = "NANC") %>% 
  filter(PACFIN_GEAR_CODE %in% c("DPN", "GLN", "MDT", "ONT", "POL", "SEN"))

# sum(PacFIN.Gear.PSDN$N_vessels) // 258 vessels
# sum(PacFIN.Gear.MSQD$N_vessels) // 411 vessels
PacFIN.Gear.PSDN$n_vessels <- PacFIN.Gear.PSDN$n_vessels/sum(PacFIN.Gear.PSDN$n_vessels)
PacFIN.Gear.MSQD$n_vessels <- PacFIN.Gear.MSQD$n_vessels/sum(PacFIN.Gear.MSQD$n_vessels)
PacFIN.Gear.NANC$n_vessels <- PacFIN.Gear.NANC$n_vessels/sum(PacFIN.Gear.NANC$n_vessels)
PacFIN.Gear.PHRG$n_vessels <- PacFIN.Gear.PHRG$n_vessels/sum(PacFIN.Gear.PHRG$n_vessels)
  PacFIN.Gear <- rbind.data.frame(PacFIN.Gear.PSDN, PacFIN.Gear.NANC, PacFIN.Gear.MSQD, PacFIN.Gear.PHRG)
  table <- xtabs(n_vessels ~ PACFIN_GEAR_CODE + Species, PacFIN.Gear)

#table
colnames(table) = c("Market squid", "Northern anchovy", "Pacific Herring", "Pacific sardine") 
  rownames(table) = c("Dip Net", "Gill Net","Midwater Trawl", "Other Net Gear", "Pole", "Seine") 

print(xtable(table, 
             caption = 'Percentage of vessels using a gear to harvest CPS species.\\label{Table:n_vess_gear}', 
             type = "latex"), comment=FALSE,  caption.placement = "top")

rm(PacFIN.Gear, PacFIN.Gear.PSDN, PacFIN.Gear.NANC, PacFIN.Gear.MSQD, PacFIN.Gear.PHRG, table)


```

```{r landing_by_gear, echo=FALSE, results='asis'}
PacFIN.CPS <- PacFIN.month %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("MSQD", "PSDN", "NANC", "PHRG")) %>% 
  filter(PACFIN_GEAR_CODE  %in% c("DPN", "ONT", "SEN", "GLN", "MDT", "POL")) %>%
  filter(LANDING_YEAR >= 2010)

table <- round(xtabs(LANDED_WEIGHT_MTONS.sum ~ PACFIN_GEAR_CODE + PACFIN_SPECIES_CODE, 
                     data = PacFIN.CPS ), 0 )

colnames(table) = c("Market squid", "Northern Anchovy", "Pacific Herring", "Pacific Sardine") 
rownames(table) = c("Dip Net", "Gill Net", "Midwater Trawl", "Other Net Gear", "Pole", "Seine") 
  print(xtable(table, caption = 'Landings of CPS species by gear used. \\label{table:landing_by_gears}', 
             type = "latex"), comment=FALSE,  caption.placement = "top")
  
rm(PacFIN.CPS, table)

```



## Port landings

In average, a vessel land in 4.8 ports, with an standard deviation of 3.94. 

```{r n_ports_vessels, eval=FALSE, include=FALSE}
# How many gears a vessel use in the dataset
PacFIN.CPS.unique.port <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_PORT_CODE) %>% unique() 
  PacFIN.CPS.n_ports <- PacFIN.CPS.unique.port %>% mutate(n_ports = 1) %>% group_by(VESSEL_NUM) %>% summarise(n_ports= sum(n_ports)) 
  summary(PacFIN.CPS.n_ports$n_ports)
  sd(PacFIN.CPS.n_ports$n_ports)

# ### If I have used SEINE, how many other gear I use?
# PacFIN.Base <- PacFIN.month %>% filter( LANDING_YEAR >= 2010) %>%  select(VESSEL_NUM, PACFIN_GEAR_CODE) %>% unique()
#   PacFIN.only.seine <- PacFIN.month %>% filter( LANDING_YEAR >= 2010) %>% select(VESSEL_NUM, PACFIN_GEAR_CODE) %>%
#     filter(PACFIN_GEAR_CODE == "SEN") %>% mutate(D_Seine = 1) %>% select(VESSEL_NUM, D_Seine) %>% unique() 
#   PacFIN.CPS.n_gear <- PacFIN.Base %>% inner_join(PacFIN.only.seine, by = c("VESSEL_NUM")) %>% filter(D_Seine == 1) %>% 
#     unique() %>% group_by(VESSEL_NUM) %>% summarise(N_gear= sum(D_Seine)) 
#   summary(PacFIN.CPS.n_gear$N_gear)
#   sd(PacFIN.CPS.n_gear$N_gear)
  
rm(PacFIN.CPS.unique.port, PacFIN.CPS.n_ports)

```

```{r n_ports_CPS, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
PacFIN.Gear.PSDN <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>% 
  mutate(N_port = 1) %>% group_by(VESSEL_NUM) %>% 
  summarise(N_port = sum(N_port)) %>% mutate(Species = "PSDN")

PacFIN.Gear.MSQD <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>% 
  mutate(N_port = 1) %>% group_by(VESSEL_NUM) %>% 
  summarise(N_port = sum(N_port)) %>% mutate(Species = "MSQD")

PacFIN.Gear.NANC <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("NANC")) %>% 
  mutate(N_port = 1) %>% group_by(VESSEL_NUM) %>% 
  summarise(N_port = sum(N_port)) %>% mutate(Species = "NANC")

PacFIN.Gear.PHRG <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("PHRG")) %>% 
  mutate(N_port = 1) %>%  group_by(VESSEL_NUM) %>% 
  summarise(N_port = sum(N_port)) %>% mutate(Species = "PHRG")

PacFIN.Port <- rbind.data.frame(PacFIN.Gear.PSDN, PacFIN.Gear.NANC, PacFIN.Gear.MSQD, PacFIN.Gear.PHRG)

table <- xtabs(N_port ~ Species, aggregate(N_port ~ Species, PacFIN.Port, mean))
#table
rownames(table) = c("Market squid", "Northern Anchovy", "Pacific Herring", "Pacific sardine") 
print(xtable(table, caption = 'Average number of ports where a vessel landed their CPS species catch.', type = "latex"), comment=FALSE,  caption.placement = "top")

rm(PacFIN.Gear.PSDN, PacFIN.Gear.MSQD, PacFIN.Gear.PHRG, PacFIN.Gear.NANC, PacFIN.Port)

```


Composition varies geographically. We show in Figure \ref{fig:avg_landings_by_ports} average annual landings by ports areas. We can observe that market squid is mostly landed in the southern ports located in Los Angeles, Santa Barbara and Monterrey areas, while Pacific sardine is mainly landed in Los Angeles and Monterrey areas in California, and also in the Columbia river area in Oregon. Substitution between species seems to be more likely in Los Angeles, Monterrey and Santa Barbara area ports (and in some lower scale at San Francisco area) as positive values for market squid, Pacific sardine and Northern anchovy landings are observed. 

```{r avg_landings_by_port, echo=FALSE, fig.cap="Annual average landings by port area.\\label{fig:avg_landings_by_ports}", message=FALSE, warning=FALSE}
landings.by.port.year <- summaryBy(LANDED_WEIGHT_MTONS.sum ~ 
  PACFIN_SPECIES_CODE + PACFIN_PORT_CODE + LANDING_YEAR + AGENCY_CODE, FUN=sumfun, data=PacFIN.month.CPS)
  landings.by.port.avg.year <- summaryBy(LANDED_WEIGHT_MTONS.sum.sum ~ PACFIN_SPECIES_CODE + PACFIN_PORT_CODE 
    + AGENCY_CODE, FUN=meanfun, data=landings.by.port.year) %>%
    filter(PACFIN_PORT_CODE == "AST" | PACFIN_PORT_CODE == "HNM" | PACFIN_PORT_CODE == "SP" |
             PACFIN_PORT_CODE == "VEN" | PACFIN_PORT_CODE == "TRM" | PACFIN_PORT_CODE == "MOS" | 
             PACFIN_PORT_CODE == "WTP" | PACFIN_PORT_CODE == "MNT" | PACFIN_PORT_CODE == "LWC" | 
             PACFIN_PORT_CODE == "SF"  | PACFIN_PORT_CODE == "PRN" | PACFIN_PORT_CODE == "SLT") %>%
    mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, "SP", "TRM", "HNM", "VEN", "MNT", "MOS", "PRN", "SF", "SLT", "AST", "LWC"))

states_names <- as_labeller(c(`C` = "California", `O` = "Oregon",`W` = "Washington"))
  ggplot(landings.by.port.avg.year, aes(fill=PACFIN_SPECIES_CODE, 
                                      y=LANDED_WEIGHT_MTONS.sum.sum.mean, x=PACFIN_PORT_CODE)) +
  geom_bar(position="dodge", stat="identity") + 
  facet_grid(~ AGENCY_CODE, scale="free", space="free_x", labeller = states_names) + 
  theme(strip.text.x = element_text(size = 7)) +
  theme(legend.position="bottom") + 
  scale_fill_viridis(discrete = T, labels=c("MSQD" = "Market Squid", "NANC" = "Northern Anchovy", 
                               "PHRG" = "Pacific Herring", "PSDN" = "Pacific Sardine")) +
  theme(axis.text.x = element_text(angle=90, hjust=0.95, vjust=0.45)) + xlab("Ports") + 
  ylab("Landings (tons)") + guides(fill=guide_legend(title="Species: "))  + 
    scale_x_discrete(labels=c("SP" = "San\nPedro", "HNM" = "Hueneme", "MNT" = "Monterrey", "MOS" = "Moss\nLanding", 
                              "LWC" = "Ilwaco /\nChinook", "AST" = "Astoria", 
                              "PRN" = "Princeton/\nHalf Moon\nBay", "SF" = "San\nFrancisco", 
                              "SLT" = "Sausalito", "TRM" = "Terminal\nIsland",
                              "VEN" = "Ventura")) +
    scale_color_brewer(palette="Set2")

  
  
rm(states_names, landings.by.port.avg.year)
```

To analyze substitution more in detail, we compute total annual landing by port during 1980-2020 period (Figure \ref{fig:ts_landings_by_ports}). There is a general conception that vessel that harvest Pacific sardine switch to market squid when the conditions are favorable. However, we can notice from Figure \ref{fig:ts_landings_by_ports} that landings of market squid have been decreasing in the last five years. We would expect that the closure of the Pacific sardine fishery would have switch targeted species, but the graphs show some complementary instead of substitution. Under this scenario is useful to ask to ask whether after the closure, vessel that harvest Market squid left the fishery or stayed, which we can answer from our multispecies participation model. We show the number of vessels by species in Figure \ref{fig:ts_n_vessels}. This would be suggesting an unintended consequence from a policy that aims to only affect Pacific sardine, but its effect affects indirectly other fisheries [@richerson2017]. 


```{r ts_by_port,  fig.cap = "Total annual landing by port area. 2000 - 2020. \\textit{Notes:} CLO = Columbia River (OR); LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara; SFA = San Francisco.\\label{fig:ts_landings_by_ports}" , echo=FALSE, message=FALSE, warning=FALSE}

landings.by.sel.ports <- landings.by.port.year %>% filter(PACFIN_PORT_CODE == "SP" | PACFIN_PORT_CODE == "TRM" | PACFIN_PORT_CODE == "MOS" | PACFIN_PORT_CODE == "MNT") %>% 
  mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, "SP", "TRM", "HNM", "MNT", "MOS"))

port_names <- as_labeller(c(`SP` = "San Pedro", `TRM` = "Terminal Island", 
                            `MOS` = "Moss Landing", `MNT` = "Monterrey"))
     

ggplot(landings.by.sel.ports, aes(y=LANDED_WEIGHT_MTONS.sum.sum, 
                                  x=LANDING_YEAR, color=PACFIN_SPECIES_CODE, group=PACFIN_SPECIES_CODE)) +
  geom_line(size=1) + xlab("Year") + ylab("Landings (tons)") + 
  facet_wrap(~ PACFIN_PORT_CODE, labeller = port_names) +
  theme(legend.position="bottom") + 
  theme(axis.text.x = element_text(angle=90)) +
  guides(color=guide_legend(title="Species: ")) +
  scale_color_brewer(palette="Set2", labels=c("MSQD" = "Market Squid", "NANC" = "Northern Anchovy", 
             "PHRG" = "Pacific Herring", "PSDN" = "Pacific Sardine"))

rm(port_names, landings.by.sel.ports, landings.by.port.year)
```

**<< SHOULD WE STUDY HOW FISHING GROUNDS CHANGE FROM PORTS (THUS DISTANCE TO FISHING GROUNDS AND WEATHER VARIABLES AFFECTED), LIKE SELDEN (2020) AND PAPAIOANNOU (2021)??? IN BOTH MODELS? >>**


## Vessel Heterogeneity
<!-- 1) What are the characteristics of a vessel depending on gear, and also on Species -->
There is heterogeneity on vessel characteristics depending on the gear and target species. In general, vessel harvesting Pacific herring tends to be smaller in length (see Table \ref{Table:length}), except for vessels using pole. Vessels using seine and harvesting Market squid, Pacific sardine and Northern anchovy have similar length, suggesting easier substitution between these species. About fishing days...

```{r lenght_by_species_gear, echo=FALSE, results='asis'}

PacFIN.CPS <- PacFIN.month %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("MSQD", "PSDN", "NANC", "PHRG"))  %>% 
  filter(PACFIN_GEAR_CODE  %in% c("DPN", "ONT", "SEN", "GLN", "MDT", "POL")) %>%
  filter(LANDING_YEAR >= 2010 )

table <- xtabs(VESSEL_LENGTH.mean ~ PACFIN_GEAR_CODE + PACFIN_SPECIES_CODE,
               aggregate(VESSEL_LENGTH.mean ~ PACFIN_GEAR_CODE + PACFIN_SPECIES_CODE, PacFIN.CPS, mean))
# table
colnames(table) = c("Market squid", "Northern Anchovy", "Pacific Herring", "Pacific Sardine") 
rownames(table) = c("Dip Net", "Gill Net", "Midwater Trawl", "Other Net Gear", "Pole", "Seine") 
print(xtable(table, caption = 'Vessel lenght used in the CPS fishery by gear used.\\label{Table:lenght}', type = "latex"), comment=FALSE,  caption.placement = "top")

rm(table, PacFIN.CPS)

```


## Fishing days

```{r fishing_days, echo=FALSE, results='asis'}

PacFIN.CPS <- PacFIN.month %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("MSQD", "PSDN", "NANC", "PHRG"))  %>% 
  filter(PACFIN_GEAR_CODE  %in% c("DPN", "ONT", "SEN", "GLN", "MDT", "POL")) %>%
  filter(LANDING_YEAR >= 2000 )

table <- xtabs(NUM_OF_DAYS_FISHED.mean ~ PACFIN_GEAR_CODE + PACFIN_SPECIES_CODE,
               aggregate(NUM_OF_DAYS_FISHED.mean ~ PACFIN_GEAR_CODE + PACFIN_SPECIES_CODE, PacFIN.CPS, mean))
 # table
colnames(table) = c("Northern Anchovy", "Pacific Herring", "Pacific Sardine") 
rownames(table) = c("Dip Net", "Midwater Trawl", "Other Net Gear", "Seine")
print(xtable(table, caption = 'Number of days fishing by species and gear used', type = "latex"), comment=FALSE,  caption.placement = "top")

rm(table, PacFIN.CPS)

```



## Other determinants of behavior

<!-- JON in CPS's Workshop: -->
<!-- " This part of the discussion was devoted to some of the decision making that goes on to determine -->
<!-- fishing locations and target species of the CPS fleet, and some of the key discussion points were: -->
<!-- ● The decisions of where and when to fish and what to target can depend on whether the -->
<!-- vessel is ‘owner-operated’ or ‘company-owned’. The owner-operator vessels have more -->
<!-- agency to decide what and when. CPS vessels (sardine and anchovy, and to a lesser -->
<!-- extent squid), are largely limited to staying out for 1 day. Regardless of vessel ownership, -->
<!-- much of the CPS fishing is driven by market order. The boats will have a port and -->
<!-- processor lined up before they go fishing. The relationship between the markets and -->
<!-- fishers is important. Coastal tunas are important to the catch and income for CPS boats. -->
<!-- For the NW fleet, most vessels leave from Astoria, but can land elsewhere. They can hire -->
<!-- a pilot to look for fish, and the WA and OR fleet will use this information to decide where -->
<!-- to fish, before returning to their arranged port. Spotter planes are frequently used. -->
<!-- ● Key ports for CPS landings are: San Pedro, Ventura, Morro Bay, Monterey, Half Moon -->
<!-- Bay, and San Francisco. Important to know if some smaller ports, such as Astoria, can -->
<!-- remain viable. Most plants in OR are permanent, but temporary landings can be set up, -->
<!-- particularly for squid, with trucks taking landings to regular plants. -->
<!-- ● A seine boat needs options, so OR boats often have CA permits, or they could switch -->
<!-- gears. They try to be very flexible. Historically, NW fishing can stop due to weather, and -->
<!-- in the SW more likely due to allocation and quota. -->
<!-- ● Price and market order drive what is targeted. Prices can also very by port, for example -->
<!-- anchovy is worth more at Monterey. What are the key forces driving price? There are -->
<!-- different markets for different species, so it’s complex. International markets and their -->
<!-- supply and demand are important for price. Building the domestic market is hard, lots -->
<!-- still exported. Tariffs are having a bit of an impact" -->



# Methods

## Multispecies Landing Model

Our data set contain a number of variables measured at the port and *vessel levels* for CPS the fishery located in the U.S. West Coast. In regard to landings, our outcome variables are landings by port areas in a year, landing by vessel in a month. These two different outcome variables would allows us to study the degree of flexibility that vessel have in comparison to ports in regard to species substitution and catch composition. If vessels have strong contracts with processor associated with a port, then we should observe that substitution of vessels and port is similar. Yearly panel data data on landing by port areas during the the period 1980 - 2020 is publicly available from [PacFIN](http://pacfin.psmfc.org/). **Vessel level data was obtained upon request from...** We only include ports areas where substitution could happen. In practical terms, we drop port that have never landed either Pacific sardine, market squid or Northern anchovy during our period of analysis.^[N/A were converted to zero.] We assume that this criteria would allows to identify ports that have the infrastructure to land all of the species in consideration.

Our main treatment variables are species probability of presence and Pacific sardine closure. Probability of presence were obtained from Species Distribution Models (SDM), and future forecast of these variables allows us to simulate the CPS fishery in the future. Distribution of species have change relative to ports in the last decades [@selden2020]. Thus, it have been used to explain variability in fish landings [@selden2020, @smith2021potential]. For instance, @smith2021potential use mean monthly probability of presence of sardine within 60 km of the port as explanatory variable. They found a positive effect of probability of presence on Pacific sardine landings. Moreover, landings where mostly explained by this variable. We follow their same procedure to associate SDM's outputs with ports. For Pacific sardine, we compute the average probability of presence within the same radius of 60 kilometers around the port. This radius also coincide with the average distance with two standard deviation traveled by vessels based on logbooks available for these fisheries.^[@selden2020 use the 75th quantile of the travel distances made by vessels to define the availability of an species associated to a port for multiple species, and weight this distances by the catch of those species.] For market squid and Northern anchovy, we set this radius to 90 and 20 kilometers, respectively, also based in the average distance to fishing ground obtained from logbooks.^[To see an animation of how far vessel travel please visit [this link](https://drive.google.com/file/d/1-PE_lcZNcXNcyILA_6xhkHyEhV3mV2TA/view?usp=sharing).]   

Figure \ref{fig:sdm_land_by_port} show the relationship between the probability of presence and landings by species in three main port areas: Los Angeles, Monterrey and Santa Barbara areas. The graph suggest that Pacific sardine landings are positive correlated with the probability of presence of this species, similar to @smith2021potential. This is also true in Monterrey area for the Northern anchovy, In the case of market squid, we cannot distinguish correlation between landings and probability of presence. Note, however, that the evidence shown in this figure may not capturing the actual effect of the probability of presence as other effect may be in play. Our empirical strategy is designed to isolate the effect of the probability on landing in a multivariate model framework.

```{r SDM_land, echo=FALSE, fig.cap="Landings v/s probability of presence by port area. \\textit{Notes:} LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara.\\label{fig:sdm_land_by_port}", message=FALSE, warning=FALSE}

sdm.by.species <- PacFIN.month.CPS %>%
  dplyr::select(LANDING_YEAR, PSDN_SDM_60, MSQD_SDM_90, NANC_SDM_20, LANDED_WEIGHT_MTONS.sum, PACFIN_SPECIES_CODE) %>% 
  filter(LANDING_YEAR >= 1998 & LANDING_YEAR <= 2019) %>%
  group_by(LANDING_YEAR, PACFIN_SPECIES_CODE) %>% 
  summarize(PSDN_SDM_60 = mean(PSDN_SDM_60, na.rm = TRUE), 
            NANC_SDM_20 = mean(NANC_SDM_20, na.rm = TRUE), 
            MSQD_SDM_90 = mean(MSQD_SDM_90, na.rm = TRUE),
            LANDED_WEIGHT_MTONS = sum(LANDED_WEIGHT_MTONS.sum, na.rm = TRUE)) %>%
  spread(PACFIN_SPECIES_CODE, LANDED_WEIGHT_MTONS) %>% 
  dplyr::rename(Landings_PSDN = PSDN) %>% dplyr::rename(Landings_MSQD = MSQD) %>% 
  dplyr::rename(Landings_NANC = NANC) %>% dplyr::rename(Landings_PHRG = PHRG) %>%
  group_by(LANDING_YEAR) %>% 
  summarize(PSDN_SDM_60 = mean(PSDN_SDM_60, na.rm = TRUE), 
            NANC_SDM_20 = mean(NANC_SDM_20, na.rm = TRUE), 
            MSQD_SDM_90 = mean(MSQD_SDM_90, na.rm = TRUE),
            Landings_PSDN = sum(Landings_PSDN, na.rm = TRUE), Landings_MSQD = sum(Landings_MSQD, na.rm = TRUE),
            Landings_NANC = sum(Landings_NANC, na.rm = TRUE), Landings_PHRG = sum(Landings_PHRG, na.rm = TRUE)) 
  # sdm.by.species$Date <- zoo::as.yearmon(paste(sdm.by.species$LANDING_YEAR, sdm.by.species$LANDING_MONTH, sep='-'))

# Plot
coeff <- 200000
g1 <-  ggplot(sdm.by.species) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = Landings_PSDN, color = "Landings"), size = 0.5) +
  geom_line(mapping = aes(x = LANDING_YEAR, y = PSDN_SDM_60*coeff, color = "Probability of presence"), 
            size = 0.5, linetype = "dashed") + 
  scale_x_continuous(name = element_blank(), labels = NULL) +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff, name = "")) +
  theme(legend.position="right", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(a) Pacific sardine") +  scale_color_manual(name = "Variable: ", 
                     values = c("Landings" = "grey", "Probability of presence" = "blue"))

coeff2 <- 300000
g2 <- ggplot(sdm.by.species) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = Landings_MSQD), size = 0.5, color = "grey") +
  geom_line(mapping = aes(x = LANDING_YEAR, y = MSQD_SDM_90*coeff2), 
            size = 0.5, color = "blue", linetype = "dashed") + 
  scale_x_continuous(name = element_blank(), labels = NULL) +
  scale_y_continuous(name = "Landings", sec.axis = sec_axis(~./coeff2, name = "P(presence)")) +
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(b) Market squid")

coeff3 <- 30000
g3 <- ggplot(sdm.by.species) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = Landings_NANC), size = 0.5, color = "grey") +
  geom_line(mapping = aes(x = LANDING_YEAR, y = NANC_SDM_20*coeff3),
            size = 0.5, color = "blue", linetype = "dashed") + 
  scale_x_continuous(name = "Year") +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff3, name = element_blank())) +
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(c) Northern anchovy") 

g1 / g2 / g3

rm(g1, g2, g3, sdm.by.species, coeff, coeff2, coeff3)

```


```{r SDM_land_by_port, echo=FALSE, fig.cap="Landings v/s probability of presence by port area. \\textit{Notes:} LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara.\\label{fig:sdm_land_by_port}", message=FALSE, warning=FALSE}

sdm.by.species <- PacFIN.month.CPS %>%
  dplyr::select(LANDING_YEAR, PORT_NAME, PSDN_SDM_60, MSQD_SDM_90, NANC_SDM_20, 
                LANDED_WEIGHT_MTONS.sum, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE) %>% 
  filter(LANDING_YEAR >= 1998 & LANDING_YEAR <= 2019) %>%
  group_by(LANDING_YEAR, PORT_NAME, PACFIN_PORT_CODE, PACFIN_SPECIES_CODE) %>% 
  summarize(PSDN_SDM_60 = mean(PSDN_SDM_60, na.rm = TRUE), 
            NANC_SDM_20 = mean(NANC_SDM_20, na.rm = TRUE), 
            MSQD_SDM_90 = mean(MSQD_SDM_90, na.rm = TRUE),
            LANDED_WEIGHT_MTONS = sum(LANDED_WEIGHT_MTONS.sum, na.rm = TRUE)) %>%
  spread(PACFIN_SPECIES_CODE, LANDED_WEIGHT_MTONS) %>% 
  dplyr::rename(Landings_PSDN = PSDN) %>% dplyr::rename(Landings_MSQD = MSQD) %>% 
  dplyr::rename(Landings_NANC = NANC) %>% dplyr::rename(Landings_PHRG = PHRG) %>%
  filter(PACFIN_PORT_CODE == "SP" | PACFIN_PORT_CODE == "TRM" | PACFIN_PORT_CODE == "MOS") %>% 
  mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, "SP", "TRM", "MOS")) %>%
  group_by(LANDING_YEAR, PORT_NAME, PACFIN_PORT_CODE) %>% 
  summarize(PSDN_SDM_60 = mean(PSDN_SDM_60, na.rm = TRUE), 
            NANC_SDM_20 = mean(NANC_SDM_20, na.rm = TRUE), 
            MSQD_SDM_90 = mean(MSQD_SDM_90, na.rm = TRUE),
            Landings_PSDN = sum(Landings_PSDN, na.rm = TRUE), Landings_MSQD = sum(Landings_MSQD, na.rm = TRUE),
            Landings_NANC = sum(Landings_NANC, na.rm = TRUE), Landings_PHRG = sum(Landings_PHRG, na.rm = TRUE)) 
  # sdm.by.species$Date <- zoo::as.yearmon(paste(sdm.by.species$LANDING_YEAR, sdm.by.species$LANDING_MONTH, sep='-'))

# Plot
coeff <- 60000
g1 <-  ggplot(sdm.by.species) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = Landings_PSDN), size = 0.5, color = "grey") +
  geom_line(mapping = aes(x = LANDING_YEAR, y = PSDN_SDM_60*coeff), 
            size = 0.5, color = "blue", linetype = "dashed") + 
  facet_wrap(~ PORT_NAME) + 
  scale_x_continuous(name = element_blank(), labels = NULL) +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff, name = "")) +
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(a) Pacific sardine")

coeff2 <- 90000
g2 <- ggplot(sdm.by.species) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = Landings_MSQD), size = 0.5, color = "grey") +
  geom_line(mapping = aes(x = LANDING_YEAR, y = MSQD_SDM_90*coeff2), 
            size = 0.5, color = "blue", linetype = "dashed") + 
  facet_wrap(~ PORT_NAME) + 
  scale_x_continuous(name = element_blank(), labels = NULL) +
  scale_y_continuous(name = "Landings", sec.axis = sec_axis(~./coeff2, name = "P(presence)")) +
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(b) Market squid")

coeff3 <- 10000
g3 <- ggplot(sdm.by.species) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = Landings_NANC, color = "Landings"), size = 0.5) +
  geom_line(mapping = aes(x = LANDING_YEAR, y = NANC_SDM_20*coeff3, color = "Probability of presence"),
            size = 0.5, linetype = "dashed") + 
  facet_wrap(~ PORT_NAME) + 
  scale_x_continuous(name = "Year") +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff3, name = element_blank())) +
  theme(legend.position="bottom", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(c) Northern anchovy") +  scale_color_manual(name = "Variable: ", 
                     values = c("Landings" = "grey", "Probability of presence" = "blue"))

g1 / g2 / g3


rm(g1, g2, g3, sdm.by.species, coeff, coeff2, coeff3)
```

```{r SDM_land_by_port_NANC, eval=FALSE, fig.cap="Landings v/s probability of presence by port area. \\textit{Notes:} LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara.\\label{fig:sdm_land_by_port}", message=FALSE, warning=FALSE, include=FALSE}

collapse <- PacFIN_yearly %>%
  filter(Species_code == "NANC") %>%
  dplyr::select(Landing_year, Port, NANC_SDM_20_sep_dec, Landings, Species_code) %>% 
  filter(Port == "MNA") %>% mutate(Port = fct_relevel(Port, "MNA")) %>% 
  spread(Species_code, Landings) %>% dplyr::rename(Landings_NANC = NANC) %>%
  filter(Landing_year >= 2000 & Landing_year <= 2018)
  
# Plot
coeff <- 50000
g3 <- ggplot(collapse) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_NANC, color = "Landings"),
            size = 0.5) +
  geom_line(mapping = aes(x = Landing_year, y = NANC_SDM_20_sep_dec*coeff, color = "Probability of presence"), 
            size = 0.5, linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = "Year") +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff, name = element_blank())) +
  theme(legend.position="bottom", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("Northern anchovy") +  scale_color_manual(name = "Variable: ", 
                     values = c("Landings" = "grey", "Probability of presence" = "blue"))

g3


collapse2 <- as.data.frame(diff(collapse$NANC_SDM_20_sep_dec))
  names(collapse2)[1] <- 'NANC_SDM_20_sep_dec'
  collapse2 <- collapse2 %>% mutate(Landings_NANC = diff(collapse$Landings_NANC)) %>% mutate(Port = "MNA") %>%
    mutate(Landing_year = seq(2001,2018))

dg3 <- ggplot(collapse2) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_NANC, color = "diff(Landings)"),
            size = 0.5) +
  geom_line(mapping = aes(x = Landing_year, y = NANC_SDM_20_sep_dec*coeff, color = "diff(Probability of presence)"), 
            size = 0.5, linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = "Year") +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff, name = element_blank())) +
  theme(legend.position="bottom", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("Northern anchovy (first differences)") +  scale_color_manual(name = "Variable: ", 
                     values = c("diff(Landings)" = "grey", "diff(Probability of presence)" = "blue"))

dg3


library("writexl")
write_xlsx(collapse,"Data\\monterrey_NANC_sdm_landings.xlsx")

```


We use a Hierarchical Bayesian Hurdle model to estimate the effect of species distribution on fish landings. We estimate a separate model for the three species in consideration. We use a Bayesian framework for several reasons. First, it allows us to consider uncertainty from modeling the process as well as from the imperfect observation of the process, assuming that all parameters are random variables. Second, it allows us to incorporate multilevel effects (i.e. hierarchical effects). Finally, it allow us to incorporate previous knowledge as a prior. For instance, we can include a prior the results obtained in @smith2021potential for the Pacific sardine landing equation. 

Specifically, we fit a hierarchical Bayesian hurdle model to model the zeros included in our landing data. We observe a zero when no landings occur in a specific time period (landings observations with "NA" were transformed to zero). This zero could mean that there was no incentives for the fleet/vessel to harvest the species in consideration.  In general, our Bayesian models have the following structure:
$$
[\theta_i | q_{it}] \varpropto f\left(q_{it} | \theta_i\right) \times [\theta_i]
$$
where $q_{it}$ is the observed landings of the corresponding species in port $i \in (1,\ldots,L)$ at year $t$, $L$ is the total number of port, and $\theta_i$ are the parameters (i.e. random-coefficients) to be estimated at the port level. The latter give the name of hierarchical to our model.^[For more details about Hierarchichal models, see \cite{hobbs2015}.] 
The distribution $f\left(q_{it} | \theta_i\right)$ can be rewritten as:
$$ f\left(q_{it} | \theta_i \right) = 
\begin{cases} p_{it} & \text{if} \quad q_{it} = 0  \\
\left[1-p_{it}\right] \text{gamma} \left(q_{it} | \frac{\mu_{it}^2}{\sigma^2}, \frac{\mu_{it}}{\sigma^2} \right) & \text{if} \quad q_{it} > 0. \end{cases} $$
where $\text{logit}(p_{it}) = \bf{X}\gamma_i$ and $\mu_{it} = \bf{X}\beta_i$. Specifically $\mu_{it}$ is defined as the following: 
\begin{equation}
\mu_{it} = \beta_{0,i} + \beta_{1,i} P(Precense.PSDN)_{it} + \beta_{2,i} + P(Precense.MSQD)_{it} + \beta_{3,i} P(Precense.NANC)_{it}.
\end{equation}
$\text{logit}(p_{it})$ follows the same structure, but coefficient $\beta_i$ are replaced by $\gamma_i$. 


Beside the biological stock, landings are affected by socio-economics conditions. Some of them are harvest cost, prices received by species and their substitutes, and regulations imposed by the authorities. In our data we include as a proxy of harvest cost average distances traveled by vessel from the port of origin *(TO BE INCLUDED USING GLOBAL FISHING WATCH...)* and fuel cost *(TO BE INCLUDED...)*. Own price was included and it was obtained from PacFIN landings dataset. When price was missing, we replace this value for the average price of the species in all ports for the corresponding year.

WEATHER ALSO. BAD WEATHER REDUCE FISHING DECISION, Become risky, but also this is compare to revenue and how risk averse is a fishermenr (see Lisa's work)

<!-- ISAAC's comments: Is this the ACL, or the remaining part of the ACL (accounting for previous catch). R: In the annual case doesn't matter, but in a monthly model I should consider this. -->

We include the Annual Catch Limit (ACL) for the Pacific sardine model as an additional explanatory variable in both $\mu_i$ and $\text{logit}(p_i)$ equations. ACL variable is the total quota allocated each year for this fishery and was obtained from the [CPS Fisheries Management Plan](pcouncil.org)???.  For this species, we restrict our data set to the period when the fishery was open (2000-2015). We only consider ports where landing have occur at least once in our sample period. Thus, we avoid to deal with ports where infrastructure to land Pacific sardine is nonexistent. 


* NOTE: We have to think about some arbitrary decision with the database:
  + If we don't observe price, how we fill the NA. I calculate the year/month mean by port, then by port code, then by port area, then by state. 
  + Same for SDMs. I first I get an average month/year by port code and then by port area.

```{r dataset_and_desc, echo=FALSE, results='asis'}
# Clean dataset
PacFIN.month.dataset = PacFIN.month[,!grepl("*_LE_",names(PacFIN.month))]
PacFIN.month.dataset <- PacFIN.month.dataset %>%   filter(LANDING_YEAR >= 2000 & LANDING_YEAR <= 2018) %>%
  filter(PACFIN_SPECIES_CODE == "PSDN" | PACFIN_SPECIES_CODE == "MSQD"  | PACFIN_SPECIES_CODE == "NANC") %>%
  dplyr::select(LANDING_YEAR, LANDING_MONTH, PORT_NAME, VESSEL_NUM, PSDN_SDM_60, MSQD_SDM_90, NANC_SDM_20, ACL_PSDN,
         LANDED_WEIGHT_MTONS.sum, AFI_PRICE_PER_KG.mean, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE, AGENCY_CODE) %>% 
  mutate(AFI_PRICE_PER_KG.mean = na_if(AFI_PRICE_PER_KG.mean, 0)) %>% 
  melt(id.vars=c("LANDING_YEAR", "LANDING_MONTH", "VESSEL_NUM",  "PORT_NAME", 
                 "PACFIN_PORT_CODE", "PACFIN_SPECIES_CODE", "AGENCY_CODE")) %>% 
  dcast(LANDING_YEAR + LANDING_MONTH + VESSEL_NUM + PORT_NAME + PACFIN_PORT_CODE + AGENCY_CODE ~ PACFIN_SPECIES_CODE + variable, fun.aggregate=mean) 
  PacFIN.month.dataset[PacFIN.month.dataset == "NaN"] <- NA
  PacFIN.month.dataset <- PacFIN.month.dataset %>%
  mutate(PORT_ID = as.numeric(as.factor(PORT_NAME))) %>%
  mutate(PSDN_SDM_60 = rowMeans(cbind(PSDN_PSDN_SDM_60, MSQD_PSDN_SDM_60, NANC_PSDN_SDM_60), na.rm = T)) %>%
  mutate(MSQD_SDM_90 = rowMeans(cbind(PSDN_MSQD_SDM_90, MSQD_MSQD_SDM_90, NANC_MSQD_SDM_90), na.rm = T)) %>%
  mutate(NANC_SDM_20 = rowMeans(cbind(PSDN_NANC_SDM_20, MSQD_NANC_SDM_20, NANC_NANC_SDM_20), na.rm = T)) %>%
  mutate(ACL_PSDN = rowMeans(cbind(PSDN_ACL_PSDN, MSQD_ACL_PSDN, NANC_ACL_PSDN), na.rm = T))
    PacFIN.month.dataset[PacFIN.month.dataset == "NaN"] <- NA

# Create dataset for estimations
dataset = subset(PacFIN.month.dataset, select = -c(PSDN_PSDN_SDM_60, MSQD_PSDN_SDM_60, NANC_PSDN_SDM_60,
                  PSDN_MSQD_SDM_90, MSQD_MSQD_SDM_90, NANC_MSQD_SDM_90, PSDN_NANC_SDM_20, MSQD_NANC_SDM_20, 
                  NANC_NANC_SDM_20, PSDN_ACL_PSDN, MSQD_ACL_PSDN, NANC_ACL_PSDN))

# Include port area codes
port_area <- read.csv(file = here::here("Data", "Ports", "ports_area_codes.csv"))
  dataset <- dataset %>% merge(port_area, by = c("PACFIN_PORT_CODE"), all.x = TRUE)
  rm(PacFIN.month.dataset, port_area)
 
#--------
  
# Calculate year price for N/A's using PacFIN port code, port area code, state and year/month.

## Pacific sardine
  
### (a) Using port name
price.port.name.PSDN <- aggregate(x=dataset$PSDN_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_NAME), FUN = mean, na.rm=T)
  price.port.name.PSDN <- price.port.name.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_NAME = Group.3) %>%
    dplyr::rename(PSDN.price.port.name = x)
    price.port.name.PSDN[price.port.name.PSDN == "NaN"] <- NA
    dataset <- dataset %>% 
      merge(price.port.name.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_NAME"), all.x = TRUE) %>%
      mutate(PSDN_AFI_PRICE_PER_KG.mean = ifelse(is.na(PSDN_AFI_PRICE_PER_KG.mean), 
        PSDN.price.port.name, PSDN_AFI_PRICE_PER_KG.mean))
        rm(price.port.name.PSDN)
    
### (b) Using PacFIN port code
price.port.code.PSDN <- aggregate(x=dataset$PSDN_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PACFIN_PORT_CODE), FUN = mean, na.rm=T)
  price.port.code.PSDN <- price.port.code.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PACFIN_PORT_CODE = Group.3) %>%
    dplyr::rename(PSDN.price.port.code = x)
    price.port.code.PSDN[price.port.code.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.port.code.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "PACFIN_PORT_CODE"), all.x = TRUE) %>% 
      mutate(PSDN_AFI_PRICE_PER_KG.mean = ifelse(is.na(PSDN_AFI_PRICE_PER_KG.mean), 
        PSDN.price.port.code, PSDN_AFI_PRICE_PER_KG.mean))
        rm(price.port.code.PSDN)
    
### (c) Using port area code
price.port.area.PSDN <- aggregate(x=dataset$PSDN_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_AREA_CODE), FUN = mean, na.rm=T)
  price.port.area.PSDN <- price.port.area.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_AREA_CODE = Group.3) %>%
    dplyr::rename(PSDN.price.port.area = x)
    price.port.area.PSDN[price.port.area.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.port.area.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_AREA_CODE"), all.x = TRUE) %>% 
      mutate(PSDN_AFI_PRICE_PER_KG.mean = ifelse(is.na(PSDN_AFI_PRICE_PER_KG.mean), 
        PSDN.price.port.area, PSDN_AFI_PRICE_PER_KG.mean))
        rm(price.port.area.PSDN)
        
### (d) Using state
price.state.PSDN <- aggregate(x=dataset$PSDN_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$AGENCY_CODE), FUN = mean, na.rm=T)
  price.state.PSDN <- price.state.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(AGENCY_CODE = Group.3) %>%
    dplyr::rename(PSDN.price.state = x)
    price.state.PSDN[price.state.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.state.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "AGENCY_CODE"), all.x = TRUE) %>% 
      mutate(PSDN_AFI_PRICE_PER_KG.mean = ifelse(is.na(PSDN_AFI_PRICE_PER_KG.mean), 
        PSDN.price.state, PSDN_AFI_PRICE_PER_KG.mean))
        rm(price.state.PSDN)
        
### (e) Using year/month
price.year.PSDN <- aggregate(x=dataset$PSDN_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH), FUN = mean, na.rm=T)
  price.year.PSDN <- price.year.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PSDN.price.year.month = x)
    price.year.PSDN[price.year.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.year.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH"), all.x = TRUE) %>% 
      mutate(PSDN_AFI_PRICE_PER_KG.mean = ifelse(is.na(PSDN_AFI_PRICE_PER_KG.mean), 
        PSDN.price.year.month, PSDN_AFI_PRICE_PER_KG.mean))
        rm(price.year.PSDN)
    
dataset = subset(dataset, select = 
                   -c(PSDN.price.port.name, PSDN.price.port.code, 
                      PSDN.price.port.area, PSDN.price.state, PSDN.price.year.month))


## Market squid
  
### (a) Using port name
price.port.name.MSQD <- aggregate(x=dataset$MSQD_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_NAME), FUN = mean, na.rm=T)
  price.port.name.MSQD <- price.port.name.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_NAME = Group.3) %>%
    dplyr::rename(MSQD.price.port.name = x)
    price.port.name.MSQD[price.port.name.MSQD == "NaN"] <- NA
    dataset <- dataset %>% 
      merge(price.port.name.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_NAME"), all.x = TRUE) %>%
      mutate(MSQD_AFI_PRICE_PER_KG.mean = ifelse(is.na(MSQD_AFI_PRICE_PER_KG.mean), 
        MSQD.price.port.name, MSQD_AFI_PRICE_PER_KG.mean))
        rm(price.port.name.MSQD)
    
### (b) Using PacFIN port code
price.port.code.MSQD <- aggregate(x=dataset$MSQD_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PACFIN_PORT_CODE), FUN = mean, na.rm=T)
  price.port.code.MSQD <- price.port.code.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PACFIN_PORT_CODE = Group.3) %>%
    dplyr::rename(MSQD.price.port.code = x)
    price.port.code.MSQD[price.port.code.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.port.code.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "PACFIN_PORT_CODE"), all.x = TRUE) %>% 
      mutate(MSQD_AFI_PRICE_PER_KG.mean = ifelse(is.na(MSQD_AFI_PRICE_PER_KG.mean), 
        MSQD.price.port.code, MSQD_AFI_PRICE_PER_KG.mean))
        rm(price.port.code.MSQD)
    
### (c) Using port area code
price.port.area.MSQD <- aggregate(x=dataset$MSQD_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_AREA_CODE), FUN = mean, na.rm=T)
  price.port.area.MSQD <- price.port.area.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_AREA_CODE = Group.3) %>%
    dplyr::rename(MSQD.price.port.area = x)
    price.port.area.MSQD[price.port.area.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.port.area.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_AREA_CODE"), all.x = TRUE) %>% 
      mutate(MSQD_AFI_PRICE_PER_KG.mean = ifelse(is.na(MSQD_AFI_PRICE_PER_KG.mean), 
        MSQD.price.port.area, MSQD_AFI_PRICE_PER_KG.mean))
        rm(price.port.area.MSQD)
        
### (d) Using state
price.state.MSQD <- aggregate(x=dataset$MSQD_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$AGENCY_CODE), FUN = mean, na.rm=T)
  price.state.MSQD <- price.state.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(AGENCY_CODE = Group.3) %>%
    dplyr::rename(MSQD.price.state = x)
    price.state.MSQD[price.state.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.state.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "AGENCY_CODE"), all.x = TRUE) %>% 
      mutate(MSQD_AFI_PRICE_PER_KG.mean = ifelse(is.na(MSQD_AFI_PRICE_PER_KG.mean), 
        MSQD.price.state, MSQD_AFI_PRICE_PER_KG.mean))
        rm(price.state.MSQD)
        
### (e) Using year/month
price.year.MSQD <- aggregate(x=dataset$MSQD_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH), FUN = mean, na.rm=T)
  price.year.MSQD <- price.year.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(MSQD.price.year.month = x)
    price.year.MSQD[price.year.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.year.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH"), all.x = TRUE) %>% 
      mutate(MSQD_AFI_PRICE_PER_KG.mean = ifelse(is.na(MSQD_AFI_PRICE_PER_KG.mean), 
        MSQD.price.year.month, MSQD_AFI_PRICE_PER_KG.mean))
        rm(price.year.MSQD)
    
dataset = subset(dataset, select = 
                   -c(MSQD.price.port.name, MSQD.price.port.code, 
                      MSQD.price.port.area, MSQD.price.state, MSQD.price.year.month))


## Northern Anchovy
  
### (a) Using port name
price.port.name.NANC <- aggregate(x=dataset$NANC_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_NAME), FUN = mean, na.rm=T)
  price.port.name.NANC <- price.port.name.NANC %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_NAME = Group.3) %>%
    dplyr::rename(NANC.price.port.name = x)
    price.port.name.NANC[price.port.name.NANC == "NaN"] <- NA
    dataset <- dataset %>% 
      merge(price.port.name.NANC, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_NAME"), all.x = TRUE) %>%
      mutate(NANC_AFI_PRICE_PER_KG.mean = ifelse(is.na(NANC_AFI_PRICE_PER_KG.mean), 
        NANC.price.port.name, NANC_AFI_PRICE_PER_KG.mean))
        rm(price.port.name.NANC)
    
### (b) Using PacFIN port code
price.port.code.NANC <- aggregate(x=dataset$NANC_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PACFIN_PORT_CODE), FUN = mean, na.rm=T)
  price.port.code.NANC <- price.port.code.NANC %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PACFIN_PORT_CODE = Group.3) %>%
    dplyr::rename(NANC.price.port.code = x)
    price.port.code.NANC[price.port.code.NANC == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.port.code.NANC, by = c("LANDING_YEAR", "LANDING_MONTH", "PACFIN_PORT_CODE"), all.x = TRUE) %>% 
      mutate(NANC_AFI_PRICE_PER_KG.mean = ifelse(is.na(NANC_AFI_PRICE_PER_KG.mean), 
        NANC.price.port.code, NANC_AFI_PRICE_PER_KG.mean))
        rm(price.port.code.NANC)
    
### (c) Using port area code
price.port.area.NANC <- aggregate(x=dataset$NANC_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_AREA_CODE), FUN = mean, na.rm=T)
  price.port.area.NANC <- price.port.area.NANC %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_AREA_CODE = Group.3) %>%
    dplyr::rename(NANC.price.port.area = x)
    price.port.area.NANC[price.port.area.NANC == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.port.area.NANC, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_AREA_CODE"), all.x = TRUE) %>% 
      mutate(NANC_AFI_PRICE_PER_KG.mean = ifelse(is.na(NANC_AFI_PRICE_PER_KG.mean), 
        NANC.price.port.area, NANC_AFI_PRICE_PER_KG.mean))
        rm(price.port.area.NANC)
        
### (d) Using state
price.state.NANC <- aggregate(x=dataset$NANC_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$AGENCY_CODE), FUN = mean, na.rm=T)
  price.state.NANC <- price.state.NANC %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(AGENCY_CODE = Group.3) %>%
    dplyr::rename(NANC.price.state = x)
    price.state.NANC[price.state.NANC == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.state.NANC, by = c("LANDING_YEAR", "LANDING_MONTH", "AGENCY_CODE"), all.x = TRUE) %>% 
      mutate(NANC_AFI_PRICE_PER_KG.mean = ifelse(is.na(NANC_AFI_PRICE_PER_KG.mean), 
        NANC.price.state, NANC_AFI_PRICE_PER_KG.mean))
        rm(price.state.NANC)
        
### (e) Using year/month
price.year.NANC <- aggregate(x=dataset$NANC_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH), FUN = mean, na.rm=T)
  price.year.NANC <- price.year.NANC %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(NANC.price.year.month = x)
    price.year.NANC[price.year.NANC == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.year.NANC, by = c("LANDING_YEAR", "LANDING_MONTH"), all.x = TRUE) %>% 
      mutate(NANC_AFI_PRICE_PER_KG.mean = ifelse(is.na(NANC_AFI_PRICE_PER_KG.mean), 
        NANC.price.year.month, NANC_AFI_PRICE_PER_KG.mean))
        rm(price.year.NANC)
    
dataset = subset(dataset, select = 
                   -c(NANC.price.port.name, NANC.price.port.code, 
                      NANC.price.port.area, NANC.price.state, NANC.price.year.month))


#------

# Calculate year SDM for N/A's using PacFIN port code and port area code.

## Pacific sardine

### (a) Using PacFIN port code
SDM.port.code.PSDN <- aggregate(x=dataset$PSDN_SDM_60, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PACFIN_PORT_CODE), FUN = mean, na.rm=T)
  SDM.port.code.PSDN <- SDM.port.code.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PACFIN_PORT_CODE = Group.3) %>%
    dplyr::rename(PSDN.SDM.port.code = x)
    SDM.port.code.PSDN[SDM.port.code.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(SDM.port.code.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "PACFIN_PORT_CODE"), all.x = TRUE) %>% 
      mutate(PSDN_SDM_60 = ifelse(is.na(PSDN_SDM_60), PSDN.SDM.port.code, PSDN_SDM_60))
        rm(SDM.port.code.PSDN)
    
### (b) Using port area code
SDM.port.area.PSDN <- aggregate(x=dataset$PSDN_SDM_60, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_AREA_CODE), FUN = mean, na.rm=T)
  SDM.port.area.PSDN <- SDM.port.area.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_AREA_CODE = Group.3) %>%
    dplyr::rename(PSDN.SDM.port.area = x)
    SDM.port.area.PSDN[SDM.port.area.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(SDM.port.area.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_AREA_CODE"), all.x = TRUE) %>% 
      mutate(PSDN_SDM_60 = ifelse(is.na(PSDN_SDM_60), PSDN.SDM.port.area, PSDN_SDM_60))
        rm(SDM.port.area.PSDN)

dataset = subset(dataset, select = -c(PSDN.SDM.port.code, PSDN.SDM.port.area))

## Market squid 

### (a) Using PacFIN port code
SDM.port.code.MSQD <- aggregate(x=dataset$MSQD_SDM_90, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PACFIN_PORT_CODE), FUN = mean, na.rm=T)
  SDM.port.code.MSQD <- SDM.port.code.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PACFIN_PORT_CODE = Group.3) %>%
    dplyr::rename(MSQD.SDM.port.code = x)
    SDM.port.code.MSQD[SDM.port.code.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(SDM.port.code.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "PACFIN_PORT_CODE"), all.x = TRUE) %>% 
      mutate(MSQD_SDM_90 = ifelse(is.na(MSQD_SDM_90), MSQD.SDM.port.code, MSQD_SDM_90))
        rm(SDM.port.code.MSQD)
    
### (b) Using port area code
SDM.port.area.MSQD <- aggregate(x=dataset$MSQD_SDM_90, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_AREA_CODE), FUN = mean, na.rm=T)
  SDM.port.area.MSQD <- SDM.port.area.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_AREA_CODE = Group.3) %>%
    dplyr::rename(MSQD.SDM.port.area = x)
    SDM.port.area.MSQD[SDM.port.area.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(SDM.port.area.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_AREA_CODE"), all.x = TRUE) %>% 
      mutate(MSQD_SDM_90 = ifelse(is.na(MSQD_SDM_90), MSQD.SDM.port.area, MSQD_SDM_90))
        rm(SDM.port.area.MSQD)

dataset = subset(dataset, select = -c(MSQD.SDM.port.code, MSQD.SDM.port.area))
     
## Northern Anchovy 

### (a) Using PacFIN port code
SDM.port.code.NANC <- aggregate(x=dataset$NANC_SDM_20, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PACFIN_PORT_CODE), FUN = mean, na.rm=T)
  SDM.port.code.NANC <- SDM.port.code.NANC %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PACFIN_PORT_CODE = Group.3) %>%
    dplyr::rename(NANC.SDM.port.code = x)
    SDM.port.code.NANC[SDM.port.code.NANC == "NaN"] <- NA
    dataset <- dataset %>%
      merge(SDM.port.code.NANC, by = c("LANDING_YEAR", "LANDING_MONTH", "PACFIN_PORT_CODE"), all.x = TRUE) %>% 
      mutate(NANC_SDM_20 = ifelse(is.na(NANC_SDM_20), NANC.SDM.port.code, NANC_SDM_20))
        rm(SDM.port.code.NANC)
    
### (b) Using port area code
SDM.port.area.NANC <- aggregate(x=dataset$NANC_SDM_20, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_AREA_CODE), FUN = mean, na.rm=T)
  SDM.port.area.NANC <- SDM.port.area.NANC %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_AREA_CODE = Group.3) %>%
    dplyr::rename(NANC.SDM.port.area = x)
    SDM.port.area.NANC[SDM.port.area.NANC == "NaN"] <- NA
    dataset <- dataset %>%
      merge(SDM.port.area.NANC, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_AREA_CODE"), all.x = TRUE) %>% 
      mutate(NANC_SDM_20 = ifelse(is.na(NANC_SDM_20), NANC.SDM.port.area, NANC_SDM_20))
        rm(SDM.port.area.NANC)

dataset = subset(dataset, select = -c(NANC.SDM.port.code, NANC.SDM.port.area))
        
#------------

# Rename Price and landing variables #
dataset <- dataset %>% 
  dplyr::rename(PSDN_Price = PSDN_AFI_PRICE_PER_KG.mean) %>%
  dplyr::rename(MSQD_Price = MSQD_AFI_PRICE_PER_KG.mean) %>%
  dplyr::rename(NANC_Price = NANC_AFI_PRICE_PER_KG.mean) %>%
  dplyr::rename(PSDN_Landings = PSDN_LANDED_WEIGHT_MTONS.sum) %>%
  dplyr::rename(MSQD_Landings = MSQD_LANDED_WEIGHT_MTONS.sum) %>%
  dplyr::rename(NANC_Landings = NANC_LANDED_WEIGHT_MTONS.sum)

        
#------------

# Label dataset
sjlabelled::set_label(dataset$MSQD_SDM_90)   <- "Prob(presence): MSQD"
sjlabelled::set_label(dataset$PSDN_SDM_60)   <- "Prob(presence): PSDN"
sjlabelled::set_label(dataset$NANC_SDM_20)   <- "Prob(presence): NANC"
sjlabelled::set_label(dataset$LANDING_YEAR)  <- "Year"
sjlabelled::set_label(dataset$LANDING_MONTH)    <- "Month"
sjlabelled::set_label(dataset$PACFIN_PORT_CODE) <- "Port code"
sjlabelled::set_label(dataset$PORT_AREA_CODE)   <- "Port area code"
sjlabelled::set_label(dataset$PORT_NAME)        <- "Port name"
sjlabelled::set_label(dataset$AGENCY_CODE)      <- "State"
sjlabelled::set_label(dataset$VESSEL_NUM)       <- "Vessel ID"
sjlabelled::set_label(dataset$MSQD_Landings) <- "Landings: MSQD"
sjlabelled::set_label(dataset$MSQD_Price)    <- "Price: MSQD"
sjlabelled::set_label(dataset$NANC_Landings) <- "Landings: NANC"
sjlabelled::set_label(dataset$NANC_Price)    <- "Price: NANC"
sjlabelled::set_label(dataset$PSDN_Landings) <- "Landings: PSDN"
sjlabelled::set_label(dataset$PSDN_Price)    <- "Price: PSDN"
sjlabelled::set_label(dataset$ACL_PSDN)      <- "Annual Catch Limit: PSDN"
sjlabelled::set_label(dataset$PORT_ID)       <- "Port ID"

desc_data <- dataset %>%
  subset(select = -c(PORT_ID, LANDING_YEAR, LANDING_MONTH, VESSEL_NUM, 
                     AGENCY_CODE, PACFIN_PORT_CODE, PORT_AREA_CODE, PORT_NAME))


sjlabelled::set_label(desc_data$MSQD_SDM_90)   <- "Prob(presence): MSQD"
sjlabelled::set_label(desc_data$PSDN_SDM_60)   <- "Prob(presence): PSDN"
sjlabelled::set_label(desc_data$NANC_SDM_20)   <- "Prob(presence): NANC"
sjlabelled::set_label(desc_data$MSQD_Landings) <- "Landings: MSQD"
sjlabelled::set_label(desc_data$MSQD_Price)    <- "Price: MSQD"
sjlabelled::set_label(desc_data$NANC_Landings) <- "Landings: NANC"
sjlabelled::set_label(desc_data$NANC_Price)    <- "Price: NANC"
sjlabelled::set_label(desc_data$PSDN_Landings) <- "Landings: PSDN"
sjlabelled::set_label(desc_data$PSDN_Price)    <- "Price: PSDN"
sjlabelled::set_label(desc_data$ACL_PSDN)      <- "Annual Catch Limit: PSDN"


desc_data <- desc_data[c("PSDN_SDM_60", "MSQD_SDM_90", "NANC_SDM_20",
  "PSDN_Landings", "MSQD_Landings", "NANC_Landings",
  "PSDN_Price", "MSQD_Price", "NANC_Price", "ACL_PSDN")]
                                 
vtable::st(desc_data, labels = TRUE, title='Summary Statistics \\label{tab:sum_stats}', out='latex')
rm(desc_data)

```

<!-- CREATE DATASET FOR PACIFIC SARDINE LANDINGS -->

Note: We have to think about:
  + Which port to exclude/include. I'm including port where substitution may happen (there is landing of sardine and squid)
  + At which level should I conduct the analysis? Port code or port area? I start with port area. 


```{r dataset_psdn, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

Tot.landings.ports.PSDN <- as.data.frame(cbind(rowsum(dataset$PSDN_Landings, dataset$PORT_AREA_CODE, na.rm = TRUE)))
  Tot.landings.ports.PSDN <- Tot.landings.ports.PSDN %>% mutate(dTotalPSDN = ifelse(V1>0, 1, 0)) %>% 
    mutate(PORT_AREA_CODE = rownames(Tot.landings.ports.PSDN)) %>%  dplyr::select(PORT_AREA_CODE, dTotalPSDN)

Tot.landings.ports.MSQD <- as.data.frame(cbind(rowsum(dataset$MSQD_Landings, dataset$PORT_AREA_CODE, na.rm = TRUE)))
  Tot.landings.ports.MSQD <- Tot.landings.ports.MSQD %>% mutate(dTotalMSQD = ifelse(V1>0, 1, 0)) %>% 
    mutate(PORT_AREA_CODE = rownames(Tot.landings.ports.MSQD)) %>%  dplyr::select(PORT_AREA_CODE, dTotalMSQD)

Tot.landings.ports.NANC <- as.data.frame(cbind(rowsum(dataset$NANC_Landings, dataset$PORT_AREA_CODE, na.rm = TRUE)))
  Tot.landings.ports.NANC <- Tot.landings.ports.NANC %>% mutate(dTotalNANC = ifelse(V1>0, 1, 0)) %>% 
    mutate(PORT_AREA_CODE = rownames(Tot.landings.ports.NANC)) %>%  dplyr::select(PORT_AREA_CODE, dTotalNANC)
  
Tot.landings.ports <- Tot.landings.ports.PSDN %>% 
  merge(Tot.landings.ports.MSQD, by = c("PORT_AREA_CODE")) %>% 
  merge(Tot.landings.ports.NANC, by = c("PORT_AREA_CODE")) %>% 
  mutate(nSpecies = dTotalPSDN + dTotalMSQD + dTotalNANC)

rm(Tot.landings.ports.PSDN, Tot.landings.ports.MSQD, Tot.landings.ports.NANC)
  

# Select ports that at least they have landing PSDN once, and drop N/A #
## Select data for estimation, replace N/A landings to zero #
### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###

dataset_psdn <- dataset %>% 
  dplyr::select(PSDN_SDM_60, PSDN_Landings, PSDN_Price, ACL_PSDN,
                MSQD_SDM_90, NANC_SDM_20, PORT_ID, PACFIN_PORT_CODE, PORT_AREA_CODE, LANDING_YEAR, LANDING_MONTH) %>% 
  filter(LANDING_YEAR >= 2000 & LANDING_YEAR < 2015) %>% dplyr::mutate(PSDN_Landings = coalesce(PSDN_Landings, 0)) %>%
  merge(Tot.landings.ports, by = "PORT_AREA_CODE", all.x = TRUE, all.y = FALSE) %>% 
  filter(dTotalPSDN==1) %>% filter(dTotalMSQD==1) %>% filter(dTotalNANC==1) %>% drop_na()

# Create matrices and vectors to run STAN model #
year_id <- as.vector(cbind(as.numeric(factor(dataset_psdn$LANDING_YEAR))))
dataset_psdn$port_ID <- as.factor(udpipe::unique_identifier(dataset_psdn, fields = "PORT_AREA_CODE", start_from = 1))
dataset_psdn_port_names <- dataset_psdn %>% dplyr::select(PORT_AREA_CODE, port_ID) %>% unique()
rm(year_id, dataset_psdn_port_names)
```

```{r psdn_estimation, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qPSDN <- brm(
  bf(PSDN_Landings ~ PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 + PSDN_Price + s(ACL_PSDN) 
                      + (1 + PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 + PSDN_Price | port_ID),
                hu ~ PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 + PSDN_Price + s(ACL_PSDN) 
                      + (1 + PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_20 + PSDN_Price | port_ID)),
                          data = dataset_psdn,
                          family = hurdle_gamma(), 
                          control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)

save.image (file = "stan_fit.RData")

```

In the case of market squid, our database comprise the time period between 2000 and 2018. We do not include ACL as an explanatory variable as there is no variation between years. To capture any change on fishers behavior when Pacific sardine fishery closed, we include a binary variable called **dClose** that takes the value "1" when the Pacific sardine fishery is close, and the value "0" when its close. Pacific sardine probability takes the value of zero when the fishery is closed. Thus, the effect of this variable is only relevant when it Pacific sardine fishery is open in order to capture potential substitution between targets. Finally, a similar structure than Market squid models is followed for our estimation of Northern anchovy landing by ports. A summary statistics of our data set is shown in Table \ref{tab:sum_stats}.

```{r msqd_data, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
# Select data for estimation, replace N/A landings to zero #
est_data_msqd <- est_data %>%
  dplyr::select(port_num, Port, MSQD_SDM_90, MSQD_Landings, MSQD_Price, 
                  PSDN_SDM_60, NANC_SDM_20, Landing_year) %>%
  dplyr::mutate(MSQD_Landings = coalesce(MSQD_Landings, 0)) %>% 
  dplyr::mutate(dClose = ifelse(Landing_year >= 2015,1,0)) %>%
  dplyr::mutate(dOpen = ifelse(Landing_year < 2015,1,0)) %>%
  dplyr::mutate(PSDN_SDM_60_dOpen = PSDN_SDM_60 * dOpen) %>%
  filter(Landing_year >= 2000)

# Select ports that at least they have landing PSDN once, and drop N/A #
Tot.landings.ports <- as.data.frame(cbind(rowsum(est_data_msqd$MSQD_Landings, est_data_msqd$Port, na.rm = TRUE)))

Tot.landings.ports <- Tot.landings.ports %>%
  mutate(dTotalMSQD = ifelse(V1>0, 1, 0)) %>%
  mutate(Port = rownames(Tot.landings.ports)) %>%
  dplyr::select(Port, dTotalMSQD)

### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###
est_data_msqd <- est_data_msqd %>%
  merge(Tot.landings.ports, by.x = "Port", by.y = "Port", all.x = TRUE, all.y = FALSE) %>%
  filter(dTotalMSQD==1) %>%
  drop_na() 
  
# Create matrices and vectors to run STAN model #
year_id <- as.vector(cbind(as.numeric(factor(est_data_msqd$Landing_year))));
est_data_msqd$port_ID <- udpipe::unique_identifier(est_data_msqd, fields = "port_num", start_from = 1) 
portID_names_MSQD <- est_data_msqd %>%
  dplyr::select(Port, port_ID) %>%
  unique()

### Estimate using BRMS package ###
est_data_msqd$dClose    <- factor(est_data_msqd$dClose)
est_data_msqd$port_ID   <- factor(est_data_msqd$port_ID)
class(est_data_msqd$dClose)
class(est_data_msqd$port_ID)
class(est_data_msqd$dOpen)
```


```{r msqd_est_price, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qMSQD_price <- brm(bf(MSQD_Landings ~ MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose 
                      + (1 + MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose | port_ID),
                               hu ~ MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose 
                      + (1 + MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose | port_ID)),
                       data = est_data_msqd,
                       family = hurdle_gamma(),
                       control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)
save.image (file = "stan_fit.RData")
```



```{r nanc_data, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
# Select data for estimation, replace N/A landings to zero #
est_data_nanc <- est_data %>%
  dplyr::select(port_num, Port, NANC_SDM_20, NANC_Landings, NANC_Price, 
                  PSDN_SDM_60, MSQD_SDM_90, Landing_year) %>%
  dplyr::mutate(NANC_Landings = coalesce(NANC_Landings, 0)) %>% 
  dplyr::mutate(dClose = ifelse(Landing_year >= 2015,1,0)) %>%
  dplyr::mutate(dOpen = ifelse(Landing_year < 2015,1,0)) %>%
  dplyr::mutate(PSDN_SDM_60_dOpen = PSDN_SDM_60 * dOpen) %>%
  filter(Landing_year >= 2000)

# Select ports that at least they have landing PSDN once, and drop N/A #
Tot.landings.ports <- as.data.frame(cbind(rowsum(est_data_nanc$NANC_Landings, est_data_nanc$Port, na.rm = TRUE)))

Tot.landings.ports <- Tot.landings.ports %>%
  mutate(dTotalNANC = ifelse(V1>0, 1, 0)) %>%
  mutate(Port = rownames(Tot.landings.ports)) %>%
  dplyr::select(Port, dTotalNANC)

### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###
est_data_nanc <- est_data_nanc %>%
  merge(Tot.landings.ports, by.x = "Port", by.y = "Port", all.x = TRUE, all.y = FALSE) %>%
  filter(dTotalNANC==1) %>%
  drop_na() 
  
# Create matrices and vectors to run STAN model #
year_id <- as.vector(cbind(as.numeric(factor(est_data_nanc$Landing_year))));
est_data_nanc$port_ID <- udpipe::unique_identifier(est_data_nanc, fields = "port_num", start_from = 1) 
portID_names_NANC <- est_data_nanc %>%
  dplyr::select(Port, port_ID) %>%
  unique()

### Estimate using BRMS package ###
est_data_nanc$dClose    <- factor(est_data_nanc$dClose)
est_data_nanc$port_ID   <- factor(est_data_nanc$port_ID)
class(est_data_nanc$dClose)
class(est_data_nanc$port_ID)
class(est_data_nanc$dOpen)
```

```{r nanc_est_price, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qNANC_price <- brm(bf(NANC_Landings ~ NANC_SDM_20 + NANC_Price + PSDN_SDM_60_dOpen + MSQD_SDM_90 + dClose 
                      + (1 +  NANC_SDM_20 + NANC_Price + PSDN_SDM_60_dOpen + MSQD_SDM_90 + dClose | port_ID),
                                     hu ~ NANC_SDM_20 + NANC_Price + PSDN_SDM_60_dOpen + MSQD_SDM_90 + dClose + dClose 
                      + (1 + NANC_SDM_20 + NANC_Price + PSDN_SDM_60_dOpen + MSQD_SDM_90 + dClose | port_ID)),
                       data = est_data_nanc,
                       family = hurdle_gamma(),
                       control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)
save.image (file = "stan_fit.RData")
```


##  Multispecies participation model
For the multispecies participation model, we follow a similar methodology than @richerson2017. We estimate a discrete choice model for probability that a vessel participate in a particular species fishery during a specific month. This approach allows us to further understand how a closure or abrupt weather/abundance changes restructure fisher's portfolios. 

In the participation model, our outcome variable is a categorical variable that indicate whether a vessel participate in a specific fishery. It ranges from 0 to 4 where: 0 = "No fishing during the month", 1 = "Pacific sardine", 2 = "Market Squid", 3 = "Northern Anchovy", and 4 = "Other". **<<Can I combine Anchovy + sardine in category 5? What if in the same month a vessel harvest two different species. Should we maybe assume 1 for the principal species, zero to the second one?>>** **<< We can use the approach of metier, where a choice is created from data (see Andersen, 2012, ICES). Here would be a combination of target species>>** **<<Other option is to estimate separately a binary model>>** To select vessels in or database, they should met the following criteria:

  1. Vessel active at least **XX%** of the sample. 
  2. Total revenue at least **XX%** of CPS fishery.
  3. Total annual revenue average for two or more species listed of at least **XXX**.
  
We expect that using monthly **<<Should I use Yearly data???>>** data allows us to observe seasonality in fishers´ behavior and to reduce the risk to not loosing general behavior when we dissagregate data in a finer scale.

According @richerson2017, fishers participation decision should depend, in general terms, on profitability, species distribution and regulations. Specifically, based on different studies [@richerson2017] (MORE REF), variables that can explain fishery participation on a particular fishery in a month are:

<!-- see if these are relevant:  -->
<!-- Holland D. S.. A bioeconomic model of marine sanctuaries on Georges Bank, Canadian Journal of Fisheries and Aquatic Sciences, 2000, vol. 57 (pg. 1307-1319) -->

<!-- Holland D. S.,  Herrera G. E.. Flexible catch-balancing policies for multispecies individual fishery quotas, Canadian Journal of Fisheries and Aquatic Sciences, 2006, vol. 63 (pg. 1669-1685)10.1139/f06-066 -->

<!-- Toft J. E.,  Punt A. E.,  Little L. R.. Modelling the economic and ecological impacts of the transition to individual transferable quotas in the multispecies US west coast groundfish trawl fleet, ICES Journal of Marine Science, 2011, vol. 68 (pg. 1566-1579)10.1093/icesjms/fsr095 -->

* Previous revenues
* Expected catch: 
    + We calculate expected revenue as a function of average outputs of the SDMs. Using SDM outputs instead of catch to compute expected revenues allow us to project fishers decision on time using SDM's projections. Moreover, using catch to compute expected revenue as a regress in a discrete choice model could incorporate endogeneity as it can be correlated with unobservables not captured by the choice constant. 
* Closure: Whether or not the Pacific sardine fishery was closed.
* Diversification using HHI (measurement of diversification, from @richerson2017)
* Dependence on the species in consideration (historical % of the revenue from the species considered)
* Typical landings location: Latitudinal center of gravity (LCG) index from [@richerson2017]
* Dispersion around centre of gravity: Latitude inertia (LI) index from [@richerson2017]
* Years in the sample that the vessel have participate in the fishery.

We model the probability $p_{ijm}$ that vessel $i$ fishes species $j$ in month $y$ as:
\begin{align*}
\text{logit}(p_{ijy}) = & \beta_1 + \beta_2  Closure + \beta_3 Mean.revenue_j + \beta_4 ExpectedCatch_j \\
& + \beta_5 HHI_i + \beta_6 Percent.revenue_j + \beta_7 LCG_i + \beta_8 LI_i + \beta_9 Year.fished. 
\end{align*}
Note that we are not able to observe if a vessel leave the CPS fishery for another resource or actually exit fishing entirely. Therefore, the outside option include is interpreted as "No fishing in any of the CPS fishery".

Should we study also the desicion to leave or stay the CPS fishery? I think in implicit in the participation model. Can we test this using the prediction from that model?

<!-- We can extend our analysis and infer cases in which a vessel do not longer participate in the fish industry after a the closure. For this, we can use Global Fishing Watch and observe whether a vessel that stop harvesting CPS species still actively fishing other species.  -->

<!-- Soould I include expected catch???  (Peña et al have some ideas how to use expected catch and cost. It could be the month average...) -->

## Effort susbsitution ## 

* Time series of number of trips (as a proxy for effort) for all the species
* @richerson2017 use a method identify the nature of the outliers in an ARMA time series model (read more if interested) 
    + I propose to estimate a system of simultaneous equations (VECM model) to study equilibrium of effort and short-run and long-run effects of the closure (structural breaks)
    + Have a long-run equation for each species (simultaneously estimated) and test for structural break in this long-run relationship.
    
    
## Seasonality changes ##

* Seasonality can be studied calculating monthly share of total trips by species, regress it using month dummiues and see any is there any structural change after the closure [@richerson2017]. 



<!-- Shall we study also effort as number of trips, and seasonality using time series -->


# Results

## Landing model

<!-- # print summary -->
<!-- texreg(list(f2, f3, r2, r3), caption = 'Panel data models for Pacific Sardine landings.\\label{table:sardine_est}', caption.above = TRUE, float.pos = "h", custom.model.names = c("FE: Model 1", "FE: Model 2", "RE: Model 1", "RE: Model 2")) -->


<!-- # ##  Extract Grouo-Level estimates ## -->
<!-- # ranef(fit_qPSDN_gamma) -->
<!-- #  -->
<!-- # ## Check divergence and other model check ## -->
<!-- # shinystan::launch_shinystan(fit_qPSDN_gamma) -->

<!-- # Investigate chain and posterior distributions.  -->
<!-- # https://cran.r-project.org/web/packages/bayesplot/vignettes/graphical-ppcs.html -->
<!-- # plot(fit_qPSDN_t2nc, pars = c("PSDN_SDM")) -->

<!-- # ### Predictions ### -->
<!-- # pred_data <- data.frame(PSDN_SDM = c(0.5, 0.25), MSQD_SDM = c(0.5), Port_ID = 1) -->
<!-- # predict(fit_qPSDN, newdata = pred_data, re_formula = NA) -->

<!-- # ## Compare models ## -->
<!-- # loo(fit1, fit2) -->

<!-- ## Check https://www.pcouncil.org/stock-assessments-and-fishery-evaluation-safe-documents/ for ACL and closures. -->

### Graphical posterior predictive
Before presenting the results for the three species in consideration, we check graphically whether the posterior distribution is able to predict the actual distribution. We exclude zero in our graph to avoid plotting different data generation processes. In Figure \ref{fig:posteriors} we show a posterior sample compare with the true sample distribution for the three species in analysis. Some deviation from the true sample distribution is observed in the three models, but still the posterior sample follow a similar shape than the actual curve. Moreover, our pacific sardine sample do well in predicting probabilities at lower landing levels. 

```{r y_rep, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
g1 <- pp_check(fit_qPSDN_price) + ggtitle('(a) Pacific sardine') + 
  scale_color_manual(name = "", values = c("y" = "royalblue4", "yrep" = "azure3"),
                       labels = c("y" = "Observed", "yrep" = "Replicated")) +  
  theme(legend.position = "none", plot.title = element_text(size=9, face="bold.italic")) +  
  xlim(0.1, 15000) + ylab("Density")

g2 <- pp_check(fit_qMSQD_price) + ggtitle('(b) Market Squid') +
  scale_color_manual(name = "", values = c("y" = "royalblue4", "yrep" = "azure3"),
                       labels = c("y" = "Observed", "yrep" = "Replicated")) + 
  theme(legend.position = "none", plot.title = element_text(size=9, face="bold.italic"))  + 
  xlim(0.1, 15000) + xlab("Landing (tons)")

g3 <- pp_check(fit_qNANC_price) + ggtitle('(c) Northern Anchovy') + 
  scale_color_manual(name = "", values = c("y" = "royalblue4", "yrep" = "azure3"),
                       labels = c("y" = "Observed", "yrep" = "Replicated")) +
  theme(legend.position = "right", plot.title = element_text(size=9, face="bold.italic"))  +  
  xlim(0.1, 15000) 



g1 + g2 + g3
```

In addition to a posterior predictive check, we also check divergence and treedepth.^[Explain what are these concepts...] In all three models, we did not have any divergent step in our estimation. The maximum treedepth was 11 for the Pacific sardine model, while in the others it was 10.   

```{r shinystan, eval=FALSE, include=FALSE}
shinystan::launch_shinystan(fit_qPSDN_price) 
shinystan::launch_shinystan(fit_qMSQD_price) 
shinystan::launch_shinystan(fit_qNANC_price) 
```

```{r y_rep_zero, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
g1 <- pp_check(fit_qPSDN_price) + ggtitle('(a) Pacific sardine')  + theme(legend.position = "none") + xlim(0, 0.1) 
g2 <- pp_check(fit_qMSQD_price) + ggtitle('(b) Market Squid')     + theme(legend.position = "none") + xlim(0, 0.1) 
g3 <- pp_check(fit_qNANC_price) + ggtitle('(c) Northern anchovy') + theme(legend.position = "right", 
                                             plot.title = element_text(size=9, face="bold.italic")) + xlim(0, 0.1) 



g1 + g2 + g3
```


```{r model-comparision, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
fit_qMSQD <- add_criterion(fit_qMSQD, "loo")
fit_qMSQD_90 <- add_criterion(fit_qMSQD_90, "loo")

comp <- loo_compare(loo(fit_qMSQD), loo(fit_qMSQD_90)) %>%
  as.data.frame() %>%
  select(elpd_loo, elpd_diff, se_diff, p_loo, looic) %>%
  dplyr::rename(
    "ELPD-Diff" = elpd_diff, "SE-Diff" = se_diff, 
    "ELPD-LOO" = elpd_loo, "P-LOO" = p_loo, "LOOIC" = looic
  )

mw1 <- model_weights(fit_qMSQD, fit_qMSQD_90, weights = "loo")[rownames(comp)]

comp %>%
  cbind("Akaike-Weight" = mw1) %>%
  apa_table(
    format = "latex", booktabs = TRUE, digits = 2,
    caption = "Comparison of models fit1 to fit3 based on approximate leave-one-out cross-validation. Market squid landigns model.",
    note =  "ELPD-LOO = expected log posterior predictive density (higher is better); ELPD-DIFF = difference in ELPD values compared to the best model. SE-DIFF = standard error of the ELPD difference. P-LOO = effective number of model parameters (lower is better); LOOIC: leave-one-out information criterion (lower is better); Akaike-Weight = Model weight based on the LOOIC values (higher is better).",
    align = c("l", rep("r", 6))
  )
```


### Own species distribution effect

The inclusion of hierarchical effects by port allows us to analyze the effects of the probability of presence on landings disaggregated by ports. We only focus our analysis in owns probability of presence effects, as other probability are analyzed as interaction (see next subsection). We can observe in Figure \ref{fig:sdmeffects} that the effects of the own probability of presence on landings are not strong (maybe I should use logs...). However, it is clear that it have a positive effect on landings, specially on port areas such as Columbia River at Oregon for Pacific sardine, and Monterrey for Northern anchovy, while a more moderate effect is observed at Santa Barbara Area for Northern anchovy.


```{r by_port_sdm, eval=FALSE, fig.cap=, include=FALSE}
# PSDN plots
conditions <- data.frame(port_ID = unique(est_data_psdn$port_ID))
  rownames(conditions) <- unique(est_data_psdn$Port)
conditions_psdn <- conditions %>% 
  rownames_to_column('port_name') %>%
  filter(port_ID == 1 | port_ID == 2 | port_ID == 3) %>%
  column_to_rownames('port_name')

c_eff_psdn <- (conditional_effects
               (fit_qPSDN_price, "PSDN_SDM_60", surface=TRUE, conditions = conditions_psdn, re_formula = NULL))
               #, transform = log, method = "posterior_predict"))
g1 <- plot(c_eff_psdn, plot = FALSE, nrow = 3, ncol = 1)[[1]] + ggtitle('(a) Pacific sardine')+ 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_continuous(name = element_blank()) +
  scale_y_continuous(name = "Landings (tons)")

# MSQD plots
conditions2 <- data.frame(port_ID = unique(est_data_msqd$port_ID))
  rownames(conditions2) <- unique(est_data_msqd$Port)
conditions_msqd <- conditions2 %>% 
  rownames_to_column('port_name') %>%
  filter(port_ID == 4  | port_ID == 5  | port_ID == 8) %>%
  column_to_rownames('port_name')
c_eff_msqd <- (conditional_effects
               (fit_qMSQD_price, "MSQD_SDM_90", surface=TRUE, conditions = conditions_msqd, re_formula = NULL))
               #, transform = log, method = "posterior_predict"))
g2 <- plot(c_eff_msqd, plot = FALSE, nrow = 3, ncol = 1)[[1]] + ggtitle('(b) Market squid') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_continuous(name = "Prob(Presence)") +
  scale_y_continuous(name = element_blank()) 

# NANC plots
conditions3 <- data.frame(port_ID = unique(est_data_nanc$port_ID))
  rownames(conditions3) <- unique(est_data_nanc$Port)
conditions_nanc <- conditions3 %>% 
  rownames_to_column('port_name') %>%
  filter(port_ID == 3  | port_ID == 4  | port_ID == 5) %>%
  column_to_rownames('port_name')
c_eff_nanc <- (conditional_effects
               (fit_qNANC_price, "NANC_SDM_20", surface=TRUE, conditions = conditions_nanc, re_formula = NULL))
               #, transform = log, method = "posterior_predict"))
g3 <- plot(c_eff_nanc, plot = FALSE, nrow = 3, ncol = 1)[[1]] + ggtitle('(c) Northern anchovy') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_continuous(name = element_blank()) +
  scale_y_continuous(name = element_blank()) 

# Merge plots
g1 + g2 + g3
```

<!-- @smith2021potential estimate with GAM framework (allows for non-linear relationships) -->


### Interaction effects

To study the effect of other species distribution on landings, we compute the conditional effects of the interaction between probabilities of presence. Let denote species A the species which we are analysing its landings, and species B and C the other species included in the model for species A landings. For each species, we compute the effect on landing of the interaction between the probability of presences of: 
  + Species A and species B, 
  + Species A versus species C,
  + Species B versus species C.
For example, for the Pacific sardine equation, we compute these results for the probability of presence effect between Pacific sardine and market squid, Pacific sardine and Northern anchovy, and market squid and Northern anchovy. 

```{r int_effect_PSDN_by_port, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
c_eff_int_psdn_msqd <- (conditional_effects(fit_qPSDN_price, "PSDN_SDM_60:MSQD_SDM_90", surface=TRUE, 
                                            conditions = conditions_psdn, re_formula = NULL))
c_eff_int_psdn_nanc <- (conditional_effects(fit_qPSDN_price, "PSDN_SDM_60:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_psdn, re_formula = NULL))
c_eff_int_msqd_nanc <- (conditional_effects(fit_qPSDN_price, "MSQD_SDM_90:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_psdn, re_formula = NULL))

g1_PSDN <-  plot(c_eff_int_psdn_msqd, plot = FALSE)[[1]] + ggtitle('(a) Pacific sardine x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) +
  scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): MSQD") 

g2_PSDN <-  plot(c_eff_int_psdn_nanc, plot = FALSE)[[1]] + ggtitle('(b) Pacific sardine x Northern anchovy') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): NANC") 

g3_PSDN <-  plot(c_eff_int_msqd_nanc, plot = FALSE)[[1]] + ggtitle('(c) Northern anchovy x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): MSQD") + scale_y_continuous(name = "P(Pres): NANC") 
save.image (file = "stan_fit.RData")
```

Let first analyze the interaction effect of the probability of presences on Pacific sardine landings, presented in Figure \ref{fig:sdm_int_psdn}. We only shows results for the main three port where Pacific sardine is landed (Columbia River at Oregon, Los Angeles Area  and Monterrey Area). As we already commented in Figure \ref{fig:sdmeffects}, the effects the Pacific sardine's own probability of presence is positive, changing color from left to right in panels (a) and (b). Market squid seems to be an stronger substitute for Pacific sardine than Northern anchovy. This is suggested by the different slopes between panel (a) and panel (b). For instane, in Columbia River, an increase in the probability of presence for anchovy does decrease Pacific sardine landings as much as an increase in the probability of presece of market squid. 

```{r int_effect_PSDN_by_port_PLOT, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
g1_PSDN / g2_PSDN
```

```{r int_effect_MSQD_by_port, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
c_eff_int_msqd_psdn <- (conditional_effects(fit_qMSQD_price, "MSQD_SDM_90:PSDN_SDM_60_dOpen", surface=TRUE, 
                                            conditions = conditions_msqd, re_formula = NULL))
c_eff_int_msqd_nanc <- (conditional_effects(fit_qMSQD_price, "MSQD_SDM_90:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_msqd, re_formula = NULL))
c_eff_int_psdn_nanc <- (conditional_effects(fit_qMSQD_price, "PSDN_SDM_60_dOpen:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_msqd, re_formula = NULL))

g1_MSQD <-  plot(c_eff_int_msqd_psdn, plot = FALSE)[[1]] + ggtitle('(a) Market squid x Pacific sardine') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: MSQD")) +
  scale_x_continuous(name = "P(Pres): MSQD") + scale_y_continuous(name = "P(Pres): PSDN") 

g2_MSQD <-  plot(c_eff_int_msqd_nanc, plot = FALSE)[[1]] + ggtitle('(b) Market squid x Northern anchovy') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: MSQD")) + 
        scale_x_continuous(name = "P(Pres): MSQD") + scale_y_continuous(name = "P(Pres): NANC") 

g3_MSQD <-  plot(c_eff_int_psdn_nanc, plot = FALSE)[[1]] + ggtitle('(c) Pacific sardine x Northern anchovy') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: MSQD")) + 
        scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): NANC") 
save.image (file = "stan_fit.RData")
```

We found some similar findings for market squid in Figure \ref{fig:sdm_int_msqd}. Pacific sardine it is a strong substitute of market squid. In regard to Norther anchovy, there is some complementarity with market squid. We observe that when Northern anchovy presence increase, there is also an increase in market squid landings. 

```{r int_effect_MSQD_by_port_PLOT, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
g1_MSQD / g2_MSQD 
```


```{r int_effect_NANC_by_port, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
conditions_nanc <- conditions_nanc %>% filter(port_ID == 3  | port_ID == 5)

c_eff_int_nanc_psdn <- (conditional_effects(fit_qNANC_price, "NANC_SDM_20:PSDN_SDM_60_dOpen", surface=TRUE, 
                                            conditions = conditions_nanc, re_formula = NULL))
c_eff_int_nanc_msqd <- (conditional_effects(fit_qNANC_price, "NANC_SDM_20:MSQD_SDM_90", surface=TRUE, 
                                            conditions = conditions_nanc, re_formula = NULL))
c_eff_int_psdn_msqd <- (conditional_effects(fit_qNANC_price, "PSDN_SDM_60_dOpen:MSQD_SDM_90", surface=TRUE, 
                                            conditions = conditions_nanc, re_formula = NULL))

g1_NANC <-  plot(c_eff_int_nanc_psdn, plot = FALSE)[[1]] + ggtitle('(a) Northern anchovy x Pacific sardine') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) +
  scale_x_continuous(name = "P(Pres): NANC") + scale_y_continuous(name = "P(Pres): PSDN") 

g2_NANC <-  plot(c_eff_int_nanc_msqd, plot = FALSE)[[1]] + ggtitle('(b) Northern anchovy x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): NANC") + scale_y_continuous(name = "P(Pres): MSQD") 

g3_NANC <-  plot(c_eff_int_psdn_msqd, plot = FALSE)[[1]] + ggtitle('(c) Pacific sardine x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): MSQD") 
save.image (file = "stan_fit.RData")
```

<!-- ISAAC COMMENTS: There are some notes from two stakeholder workshops (Desiree et al.). It would be good to use these to understand and motivate the discussion of complementarity and substition.  -->

However, this complementary is not observed for Northern anchovy landings. When market squid presence increase, we observe a decrease in Northern anchovy landings. An interesting case is observed for Pacific sardine and Northern anchovy, in particular at Monterrey area. For small levels of Pacific sardine presence, Pacific sardine is a complement with Northern anchovy. However, after certain threshold, Pacific sardine is no longer complement and Pacific sardine become a substitute, reducing Northern anchovy landings when the probability of presence for Pacific sardine increase.

```{r int_effect_NANC_by_port_PLOT, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
g1_NANC / g2_NANC 
```


### Pacific sardine closure
Finally, lets analyze the effect of the Pacific sardine closure on market squid and Northern anchovy landings. We do not find significant results in the case of Northern anchovy. In the case of market squid, we found a decrease in the level of landing after the closure was implemented. It seems that some fisher exit the CPS fishery after the closure of Pacific sardine, reducing their participation in the market squid fishery. Our participation model results give us more details about what happen after the Pacific sardine closure.

```{r by_port_msqd_dclose, eval=FALSE, fig.cap=, include=FALSE}
# conditions_dClose <- data.frame(port_ID = unique(est_data_msqd$dClose))
# rownames(conditions_dClose) <- unique(est_data_msqd$dClose)
c_eff_close_msqd <- (conditional_effects(fit_qMSQD_price, "dClose", conditions = conditions_msqd, re_formula = NULL))
g1 <-  plot(c_eff_close_msqd, plot = FALSE)[[1]] + ggtitle('(a) Market squid') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "Landings (tons)") 

c_eff_close_nanc <- (conditional_effects(fit_qNANC_price, "dClose", conditions = conditions_nanc, re_formula = NULL))
g2 <- plot(c_eff_close_nanc, plot = FALSE)[[1]] + ggtitle('(b) Northern anchovy') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  scale_x_discrete(name = "Closure? (1 = True; 0 = False)") +
  scale_y_continuous(name = "Landings (tons)") 

g1 / g2
```

## Multispecies participation model



# Predictions
...

# Conclusions
A possible extension of our research is to consider spatial autocorrelations between ports.^[See \cite{morris2019bayesian} for an application of a spatial model in a Bayesian framework.] Ports landing maybe correlated as vessel have the incentives to choose the port of landing, conditional on whether the port have the infrastructure for this. It is likely that they just land wherever is closer to the area they are fishing. Nevertheless, differential in prices could encourage them to travel a little further for higher prices. 




<!-- ```{r int_effect_sep, eval=FALSE, include=FALSE} -->

<!-- hu <- plot(conditional_effects(fit_qPSDN, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="hu"), -->
<!--            plot = FALSE, ask = FALSE) -->
<!-- mu <- plot(conditional_effects(fit_qPSDN, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="mu"), -->
<!--            plot = FALSE, ask = FALSE) -->

<!-- mu[[1]] + hu[[1]] + plot_layout(nrow = 2) -->

<!-- ``` -->

<!-- ```{r int_effect_sep_msqd, eval=FALSE, fig.cap=, include=FALSE} -->

<!-- hu <- plot(conditional_effects(fit_qMSQD_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="hu"), -->
<!--            plot = FALSE, ask = FALSE) -->
<!-- mu <- plot(conditional_effects(fit_qMSQD_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="mu"), -->
<!--            plot = FALSE, ask = FALSE) -->

<!-- mu[[1]] + hu[[1]] + plot_layout(nrow = 2) -->

<!-- ``` -->




