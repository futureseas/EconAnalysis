---
title: "Catch subtitution between Coastal Pelagic Species under climate change scenarios"
author: "Felipe J. Quezada + ....... add authors "
date: "`r format(Sys.time(), '%B %e, %Y')`"
abstract: "Fisher do not only catch one species. They have a set of possible choices, called 'fishing portfolio'. Some species are easier to shift as gear and method used are similar between them. Therefore, the cost of shifting between species is low and fishers could adapt quickly to a shift in fish species spatial distributions in response to climate change. Nevertheless, it is not clear whether actually this substitution happen as other constraint may be in play. Port constraints, as well as market characteristics could reduce substitution between species. In this study we analyze how changing in spatial distribution affects landing subtitution between three coastal pelagic species: Pacific sardine, market squid and Northern anchovy. We primary focus on the substitution that ocur between these species, and we project change on catch composition due to future climate change."
header-includes:
  \usepackage{mathtools}
  \usepackage{tcolorbox}
  \usepackage{float}
  \floatplacement{figure}{H}
  \usepackage{times}
  \usepackage{setspace}
  \setstretch{1.5} 
output:
  pdf_document: 
    number_sections: yes
    citation_package: natbib
bibliography: references.bib
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
rm(list = ls(all.names = TRUE)) 
load("stan_fit.RData")
# gc()
library(bookdown)
library(brms)
library(cmdstanr)
library(doBy)
library(dplyr)
library(fastDummies)
library(ggplot2)
library(here)
library(hrbrthemes)
library(kableExtra)
library(lmtest)
library(lubridate)
library(magrittr)
library(patchwork)
library(plm)
library(papaja)
library(reshape)
library(reshape2)
library(rstan)
library(scales)
library(sjlabelled)
library(summarytools)
library(texreg)
library(tidyr)
library(tidyverse)
library(tinytex)
library(viridis)
library(xtable)
library(zoo)
```

```{r read_data, include=FALSE} 
PacFIN_dat <- read.csv(file = here("Data", "PacFin.csv"))
sapply(PacFIN_dat, class) 
```

```{r functions, include=FALSE}

meanfun <- function(x, ...){
  c(mean=mean(x, na.rm=TRUE, ...)) #, v=var(x, na.rm=TRUE, ...), l=length(x))
}

sumfun <- function(x, ...){
  c(sum=sum(x, na.rm=TRUE, ...)) #, v=var(x, na.rm=TRUE, ...), l=length(x))
}

sum_mean_fun <- function(x, ...){
  c(mean=mean(x, na.rm=TRUE, ...), sum=sum(x, na.rm=TRUE, ...)) #, l=length(x))
}

port_by_state <- function(state_name) {
  if (state_name == "SOME") {
    collapse <- PacFIN_dat %>%
    filter(Port == "CLO" | Port == "LAA" | Port == "MNA" | Port == "SBA" | Port == "SFA") %>%
    filter(Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING") %>%
    mutate(Port = fct_relevel(Port, "LAA", "SBA", "MNA", "SFA", "CLO"))
  }
  if (state_name == "ALL") {
    collapse <- PacFIN_dat %>%
    filter(Port == "BDA" | Port == "CBA" | Port == "CCA" | Port == "CLO" | Port == "ERA" | Port == "LAA" | Port == "MNA" | Port == "MRA" | Port == "NPA" | Port == "NPS" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
    filter(Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING") %>%
    mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "MRA", "SFA", "BDA", "ERA", "CCA", "CBA", "NPA", "CLO", "NPS"))
  }
  else {
    collapse <- PacFIN_dat %>%
    filter(Port == "BDA" | Port == "CBA" | Port == "CCA" | Port == "CLO" | Port == "ERA" | Port == "LAA" | Port == "MNA" | Port == "MRA" | Port == "NPA" | Port == "NPS" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
    filter(State == state_name & (Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING")) %>%
    mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "MRA", "SFA", "BDA", "ERA", "CCA", "CBA", "NPA", "CLO", "NPS"))
  }
  
  ggplot(collapse, aes(y=Landings, x=Landing_year, color=Species_code, group=Species_code)) +
  geom_line(size=1) + 
  facet_wrap(~ Port) +
  theme(legend.position="bottom") + 
  theme(axis.text.x = element_text(angle=90))
}

```

# Introduction
Fishing portfolios are an important mechanism to safeguard fishers livelihood. Diversification strategy have been principally associated to reducing income variability. For instance, when a species abundance is reduced due to environmental conditions, fisher can change the targeted species. However, there is no always room for diversification. Switching between species can be costly if gears are quite different between species, or a new permit is required for legal fishing. Moreover, even though fisher may have flexibility switching between species, port infrastructure and markets may impose some restrictions on this flexibility. Therefore, it is not clear how change in species distribution would be reflected in landings.

In this study we analyze how changing in spatial distribution affects landing substitutins between three coastal pelagic species (CPS): Pacific sardine (PSDN), market squid (MSQD) and Northern anchovy (NANC). Moreover, using climate projections we can predict how catch composition is affected under climate change. Our analysis is focused on the US west coast CPS fishery. 

Our papers builds on the model developed by @smith2021potential for sardine landings.  We expand their research Fisheries historically have been analyzed as single species. We expand their model including a landing equation for all of the three species analyzed. Moreover, we use the probability of presence obtained from Species Distribution Models (SDM) as explanatory variable instead of landing by species. This allows us to project landing over time using SDM predictions for different climate scenarios. Additionally, we analyze how species distribution interact between each others. We expect that this additions allows us to characterize better how fishers portfolio is composed, and also to understand better species interactions on catch rates. 

The remainder of the paper is organized as follows: Section \ref{sec:coastal-pelagic-species-fishery} provides background on the CPS fishery in the US west coast. In Section \ref{methods} we discusses our data set and empirical strategy. Section \ref{results} presents the results of the estimations, and we conclude in Section \ref{conclusions}.


# Coastal Pelagic Species fishery 

Before Pacific sardine closure in 2015, the CPS fishery have been mainly dominated by Pacific sardine and market squid in landings (see Figure \ref{fig:avg_lan_rev}). In terms of revenue, due to the low prices received for sardine, the revenues in the CPS fishery are the highest for market squid. 

```{r avg_landings, echo=FALSE, fig.cap="Average annual landing and revenues for the CPS fishery by species.\\label{fig:avg_lan_rev}", message=FALSE, warning=FALSE}
landings <- summaryBy(Landings ~ Species_code + Landing_year + Management_group, FUN=sumfun, data=PacFIN_dat) %>%
  filter(Management_group == "CPEL") %>%
  filter(Species_code != "PBNT" & Species_code != "CMCK" & 
           Species_code != "JMCK" & Species_code != "RHRG" & Species_code != "UMCK")

landings <- summaryBy(Landings.sum ~ Species_code, FUN=meanfun, data=landings)

g1 <- ggplot(landings, aes(Species_code, Landings.sum.mean)) +
  geom_col(width=0.4) + theme(aspect.ratio = 1/1) + 
  ggtitle("(a) Landings") + theme(plot.title = element_text(size=9, face="bold.italic"))


revenue <- summaryBy(Revenue ~ Species_code + Landing_year + Management_group, FUN=sumfun, data=PacFIN_dat) %>%
  filter(Management_group == "CPEL") %>%
  filter(Species_code != "PBNT" & Species_code != "CMCK" & 
           Species_code != "JMCK" & Species_code != "RHRG" & Species_code != "UMCK")

revenue <- summaryBy(Revenue.sum ~ Species_code, FUN=meanfun, data=revenue)


g2 <- ggplot(revenue, aes(Species_code, Revenue.sum.mean)) +
  geom_col(width=0.4) + theme(aspect.ratio = 1/1) + 
  ggtitle("(b) Revenue") + theme(plot.title = element_text(size=9, face="bold.italic"))


g1 + g2
```
```{r ts_landings, eval=FALSE, fig.cap="Total annual landing by CPS species.\\label{fig:ts_landings}", message=FALSE, warning=FALSE, include=FALSE}
collapse <- PacFIN_dat %>%
  filter(Management_group == "CPEL") %>%
  filter(Species_code != "PBNT" & Species_code != "CMCK" & Species_code != "JMCK" & Species_code != "RHRG" & Species_code != "UMCK")

collapse <- summaryBy(Landings + Price ~ Species_name  + Landing_year, FUN=sumfun, data=collapse) %>%
  dplyr::select(Landing_year, Price.sum, Landings.sum, Species_name) 

ggplot(collapse, aes(x = Landing_year, y = Landings.sum, group= Species_name, colour =  Species_name)) + 
  geom_line(size=1.5) +
  scale_y_continuous(name = "Landings (M Tons)")
```

```{r ts_landings_vessels, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
collapse <- PacFIN_dat %>%
  filter(Management_group == "CPEL") %>%
  filter(Species_code != "PBNT" & Species_code != "RHRG" & Species_code != "UMCK")

collapse <- summaryBy(Landings + Price + N_vessels ~ Species_name  + Landing_year, FUN=sum_mean_fun, data=collapse) %>%
  dplyr::select(Landing_year, Landings.sum, N_vessels.mean, Species_name) 
coeff <- 1000
collapse$N_vessels.mean <- collapse$N_vessels.mean * coeff 
df <- gather(collapse, key = Variable, value = value,
             c("Landings.sum", "N_vessels.mean"))

# Plot
ggplot(df, aes(x=Landing_year, y = value, group = Variable, colour = Variable)) + 
geom_line(size=1) +
scale_y_continuous(name = "Landings (M Tons)", 
                   sec.axis = sec_axis(~./coeff, name = "Number of Vessels")) +
  facet_wrap(~Species_name)
```

Landings composition varies geographically. We show in Figure \ref{fig:avg_landings_by_ports} average annual landings by ports areas. We can observe that market squid is mostly landed in the southern ports located in Los Angeles, Santa Barbara and Monterrey areas, while Pacific sardine is mainly landed in Los Angeles and Monterrey areas in California, and also in the Columbia river area in Oregon. Substitution between species seems to be more likely in Los Angeles, Monterrey and Santa Barbara area ports (and in some lower scale at San Francisco area) as positive values for market squid, Pacific sardine and Northern anchovy landings are observed. 

```{r avg_landings_by_port,  fig.cap = "Annual average Landing by Port.\\label{fig:avg_landings_by_ports}", echo=FALSE, message=FALSE, warning=FALSE}
collapse <- summaryBy(Landings ~ Species_name + Species_code + Port + State, FUN=meanfun, data=PacFIN_dat) %>%
  filter(Port == "BDA" | Port == "CBA" | Port == "CCA" | Port == "CLO" | Port == "ERA" | Port == "LAA" | Port == "MNA" | Port == "MRA" | Port == "NPA" | Port == "NPS" | Port == "SBA" | Port == "SDA" | Port == "SFA") %>%
  filter(Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING") %>%
  mutate(Port = fct_relevel(Port, "SDA", "LAA", "SBA", "MNA", "MRA", "SFA", "BDA", "ERA", "CCA", "CBA", "NPA", "CLO", "NPS"))

ggplot(collapse, aes(fill=Species_code, y=Landings.mean, x=Port)) +
  geom_bar(position="dodge", stat="identity") + 
  facet_grid(~ State, scale="free", space="free_x") +
  theme(legend.position="bottom") + 
  scale_fill_viridis(discrete = T) + 
  theme(axis.text.x = element_text(angle=90))

```
To analyze substitution more in detail, we compute total annual landing by port during 1980-2020 period (Figure \ref{fig:ts_landings_by_ports}). Landings could be reflecting the abundance levels that fishers face in the surroundings areas near to a port.

```{r ts_by_port,  fig.cap = "Total annual landing by port area. 1980 - 2020. \\textit{Notes:} CLO = Columbia River (OR); LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara; SFA = San Francisco.\\label{fig:ts_landings_by_ports}" , echo=FALSE, message=FALSE, warning=FALSE}

collapse <- PacFIN_dat %>%
    filter(Port == "CLO" | Port == "LAA" | Port == "MNA" | Port == "SBA" | Port == "SFA") %>%
    filter(Species_name == "PACIFIC SARDINE" | Species_name == "NORTHERN ANCHOVY" | 
             Species_name == "MARKET SQUID" | Species_name == "PACIFIC HERRING") %>%
    mutate(Port = fct_relevel(Port, "LAA", "SBA", "MNA", "SFA", "CLO"))

ggplot(collapse, aes(y=Landings, x=Landing_year, color=Species_code, group=Species_code)) +
  geom_line(size=1) + 
  facet_wrap(~ Port) +
  theme(legend.position="bottom") + 
  theme(axis.text.x = element_text(angle=90))
```

# Methods

## Data 
Our data set contain a number of variables measured at the port and *vessel levels* for CPS the fishery located in the U.S. West Coast. Our outcome variables are landings by port areas in a year and landing by vessel in a month. These two different outcome variables would allows us to study the degree of flexibility that vessel have in comparison to ports in regard to species substitution and catch composition. If vessels have strong contracts with processor associated with a port, then we should observe that substitution of vessels and port is similar. Yearly panel data data on landing by port areas during the the period 1980 - 2020 is publicly available from [PacFIN](http://pacfin.psmfc.org/). **Vessel level data was obtained upon request from...** We only include ports areas where substitution could happen. In practical terms, we drop port that have never landed either Pacific sardine, market squid or Northern anchovy during our period of analysis.\\footnote{N/A were converted to zero.} We assume that this criteria would allows to identify ports that have the infrastructure to land all of the species in consideration.

Our main treatment variables are species probability of presence. This variables were obtained from Species Distribution Models (SDM), and future forecast of these variables allows us to simulate the CPS fishery in the future. Prior landings models have shown that the probability of presence have a large contribution on explaining landings. For instance, @smith2021potential use mean monthly probability of presence of sardine within 60 km of the port as explanatory variable. They found a positive effect of probability of presence on Pacific sardine landings. Moreover, landings where mostly explained by this variable. We follow their same procedure to associate SDM's outputs with ports. For Pacific sardine, we compute the average probability of presence within the same radius of 60 kilometers around the port. This radious also coincide with the average distance with two standard deviation traveled by vessels based on logbook availables for this fisheries. For market squid and Northern anchovy, we set this radius to 90 km. We also use logbook in the case or market squid, while for the Northern anchovy, the optimal distance for Northern anchovy was chosen empirically\\footnote{To see an animation of how far vessel travel please visit [this link](https://drive.google.com/file/d/1-PE_lcZNcXNcyILA_6xhkHyEhV3mV2TA/view?usp=sharing).}.   

Figure \ref{fig:sdm_land_by_port} show the relationship between the probability of presence and landings by species in three main port areas: Los Angeles, Monterrey and Santa Barbara areas. The graph suggest that Pacific sardine landings are positive correlated with the probability of presence of this species, similar to @smith2021potential. This is also true in Monterrey area for the Northern anchovy, In the case of market squid, we cannot distinguish correlation between landings and probability of presence. Note, however, that the evidence shown in this figure may not capturing the actual effect of the probability of presence as other effect may be in play. Our empirical strategy is designed to isolate the effect of the probability on landing in a multivariate model framework.

```{r SDM_land_by_port,  fig.cap = "Landings v/s probability of presence by port area. \\textit{Notes:} LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara.\\label{fig:sdm_land_by_port}", echo=FALSE, message=FALSE, warning=FALSE}

collapse <- PacFIN_dat %>%
  filter(Species_code == "PSDN" | Species_code == "MSQD"  | Species_code == "NANC") %>%
  select(Landing_year, Port, PSDN_SDM_60, MSQD_SDM_90, NANC_SDM_90, Landings, Species_code) %>% 
  filter(Port == "LAA" | Port == "MNA" | Port == "SBA") %>%
      mutate(Port = fct_relevel(Port, "LAA", "SBA", "MNA")) %>% 
  spread(Species_code, Landings) %>% 
  dplyr::rename(Landings_PSDN = PSDN) %>% dplyr::rename(Landings_MSQD = MSQD) %>% dplyr::rename(Landings_NANC = NANC) %>%
  filter(Landing_year >= 1998 & Landing_year <= 2018)
  
# Plot

coeff <- 50000
g1 <- ggplot(collapse) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_PSDN),
            size = 0.5, color = "grey") +
  geom_line(mapping = aes(x = Landing_year, y = PSDN_SDM_60*coeff), 
            size = 0.5, color = "blue", linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = "Year", labels = NULL) +
  scale_y_continuous(name = "Landings", sec.axis = sec_axis(~./coeff, name = "Pr(presence)")) +
  theme(plot.title = element_text(size=9, face="bold.italic")) + 
  ggtitle("(a) Pacific sardine")

g2 <- ggplot(collapse) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_MSQD),
            size = 0.5, color = "grey") +
  geom_line(mapping = aes(x = Landing_year, y = MSQD_SDM_90*coeff), 
            size = 0.5, color = "blue", linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = "Year", labels = NULL) +
  scale_y_continuous(name = "Landings", sec.axis = sec_axis(~./coeff, name = "Pr(presence)")) +
  theme(plot.title = element_text(size=9, face="bold.italic")) + 
  ggtitle("(b) Market squid")

g3 <- ggplot(collapse) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_NANC, color = "Landings"),
            size = 0.5) +
  geom_line(mapping = aes(x = Landing_year, y = NANC_SDM_90*coeff, color = "Probability of presence"), 
            size = 0.5, linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = "Year", labels = NULL) +
  scale_y_continuous(name = "Landings", sec.axis = sec_axis(~./coeff, name = "Pr(presence)")) +
  theme(legend.position="bottom", plot.title = element_text(size=9, face="bold.italic")) + 
  ggtitle("(c) Northern anchovy") +  scale_color_manual(name = "Variable", 
                     values = c("Landings" = "grey", "Probability of presence" = "blue"))

g1 / g2 / g3

```

Beside the biological stock, landings are affected by socio-economics conditions. Some of them are harvest cost, prices received by species and their substitutes, and regulations imposed by the authorities. In our data we include as a proxy of harvest cost average distances traveled by vessel from the port of origin *(TO BE INCLUDED USING GLOBAL FISHING WATCH...)* and fuel cost (TO BE INCLUDED...). Own price and substitute were included in the data and were obtained from PacFIN landings dataset. As regulatory variables, we construct a binary variable called **dClose** that takes the value 1 when the Pacific sardine fishery is close, and the value "0" when its close. We also include the Annual Catch Limit (ACL) for the Pacific sardine model. The ACL for Pacifin sardine were obtained from the [CPS Fisheries Management Plan](pcouncil.org)???. 
A summary statistics of our data set is shown in Table @ref(tab:sum_stats).
```{r desc_table, echo=FALSE, results='asis'}
# Clean dataset
PacFIN_dat = PacFIN_dat[,!grepl("*_LE_",names(PacFIN_dat))]

est_data <- PacFIN_dat %>%
  filter(Species_name == "PACIFIC SARDINE"  |
           Species_name == "MARKET SQUID") %>% 
  melt(id.vars=c("Species_name", "State", "Species_code", "Landing_year", "Port", "Complex", "Management_group")) %>% 
  dcast(Landing_year + Port ~ Species_code + variable) %>%
  mutate(port_num = as.numeric(as.factor(Port))) %>%
  dplyr::rename(PSDN_SDM_60 = PSDN_PSDN_SDM_60) %>%
  dplyr::rename(MSQD_SDM_60 = MSQD_MSQD_SDM_60) %>%
  dplyr::rename(MSQD_SDM_90 = MSQD_MSQD_SDM_90) %>%
  dplyr::rename(MSQD_SDM_120 = MSQD_MSQD_SDM_120) %>%
  dplyr::rename(NANC_SDM_60 = MSQD_NANC_SDM_60) %>%
  dplyr::rename(NANC_SDM_90 = MSQD_NANC_SDM_90) %>%
  dplyr::rename(ACL_PSDN = PSDN_ACL_PSDN.sum) %>%
  dplyr::rename(ACL_MSQD = MSQD_ACL_MSQD.mean)

  # Change chr to numeric #
  est_data$PSDN_SDM_60   <- as.numeric(est_data$PSDN_SDM_60)
  est_data$MSQD_SDM_60   <- as.numeric(est_data$MSQD_SDM_60)
  est_data$MSQD_SDM_90   <- as.numeric(est_data$MSQD_SDM_90)
  est_data$MSQD_SDM_120  <- as.numeric(est_data$MSQD_SDM_120)
  est_data$NANC_SDM_60   <- as.numeric(est_data$NANC_SDM_60)
  est_data$NANC_SDM_90   <- as.numeric(est_data$NANC_SDM_90)
  est_data$PSDN_Landings <- as.numeric(est_data$PSDN_Landings)
  est_data$MSQD_Landings <- as.numeric(est_data$MSQD_Landings)
  est_data$ACL_PSDN <- as.numeric(est_data$ACL_PSDN)
  est_data$ACL_MSQD <- as.numeric(est_data$ACL_MSQD)
  
print(xtable(descr(PacFIN_dat, stats = c("mean", "sd", "min", "max"), transpose = TRUE, headings = TRUE), caption = 'Descriptive statistics.'), label="tab:sum_stats", comment = FALSE, caption.placement = 'top')
```

## Empirical model
We use a Hierarchial Bayesian Hurdle model to estimate the effect of species distribution on fish landings. We estimate a separate model for the three species in consideration. We use a bayesian framework for several reasons. First, it allows us to consider uncertainty from modeling the process as well as from the imperfect observation of the process, assuming that all parameters are random variables. Second, it allows us to incorporate multilevel effects (i.e. hierarchical effects). Finally, it allow us to incorporate previous knowledge as a prior. For instance, we can include a prior the results obtained in @smith2021potential for the Pacific sardine landing equation. 

Specifically, we fit a hierarchical bayesian hurdle model to model the zeros included in our landing data. We observe a zero when no landings ocurr in a specific time period. This zero could mean that there was no incentives for the fleet/vessel to harvest the species in consideration.  In general, our Bayesian models have the following structure:
\begin{align*}
[\theta_i | q_{i,t}] &  \varpropto f\left(q_{i,t} | \theta_i\right) \times [\theta_i] 
\end{align*} 
where $q_{i,t}$ is the observed landings of the corresponding species in port $i \in (1,\ldots,L)$ at year $t$, $L$ is the total number of port, and $\theta_i$ are the parameters (i.e. random-coefficients) to be estimated at the port level. The latter give the name of heriarchical to our model.\\footnote{For more details about Heriachichal models, see \cite{hobbs2015}.} 
The distribution $f\left(q_{i,t} | \theta_j\right)$ can be rewritten as:
\begin{equation}
f\left(q_{i,t} | \theta_j \right) = \begin{cases}
p_i & \text{if} \quad q_{it} = 0  \\ 
\left[1-p_i\right] \text{gamma}| \left(q_{i,t} | \frac{\mu^2}{\sigma^2}, \frac{\mu}{\sigma^2} \right) & \text{if} \quad q_{it} > 0. 
\end{cases}
\end{equation}
where $\text{logit}(p_i) = \bf{X}\gamma$ and $\mu = \bf{X}\beta$.

<!-- @smith2021potential estimate with GAM framework (allows for non-linear relationships) -->

# Results

## Pacific Sardine model

<!-- # print summary -->
<!-- texreg(list(f2, f3, r2, r3), caption = 'Panel data models for Pacific Sardine landings.\\label{table:sardine_est}', caption.above = TRUE, float.pos = "h", custom.model.names = c("FE: Model 1", "FE: Model 2", "RE: Model 1", "RE: Model 2")) -->


```{r psdn_data, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
# Select data for estimation, replace N/A landings to zero #
est_data_psnd <- est_data %>%
  dplyr::select(port_num, Port, PSDN_SDM_60, MSQD_SDM_90, NANC_SDM_60, NANC_SDM_90, PSDN_Landings, Landing_year, ACL_PSDN) %>%
  dplyr::mutate(PSDN_Landings = coalesce(PSDN_Landings, 0)) %>% 
  filter(Landing_year >= 2000 & Landing_year < 2015)


# Select ports that at least they have landing PSDN once, and drop N/A #
Tot.landings.ports <- as.data.frame(cbind(rowsum(est_data_psnd$PSDN_Landings, est_data_psnd$Port, na.rm = TRUE)))

Tot.landings.ports <- Tot.landings.ports %>%
  mutate(dTotalPSDN = ifelse(V1>0, 1, 0)) %>%
  mutate(Port = rownames(Tot.landings.ports)) %>%
  dplyr::select(Port, dTotalPSDN)

### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###
est_data_psnd <- est_data_psnd %>%
  merge(Tot.landings.ports, by.x = "Port", by.y = "Port", all.x = TRUE, all.y = FALSE) %>%
  filter(dTotalPSDN==1) %>%
  drop_na()
  # mutate(dSDA = ifelse(Port == "SDA", 1, 0)) %>%
  # filter(dSDA == 0) %>%  

# Create matrices and vectors to run STAN model #
year_id <- as.vector(cbind(as.numeric(factor(est_data_psnd$Landing_year))));
est_data_psnd$port_ID <- udpipe::unique_identifier(est_data_psnd, fields = "port_num", start_from = 1) 

portID_names <- est_data_psnd %>%
  dplyr::select(Port, port_ID) %>%
  unique()

est_data_psnd$port_ID <- as.factor(est_data_psnd$port_ID)
class(est_data_psnd$port_ID)
```

```{r psdn_est, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qPSDN_90 <- brm(
  bf(PSDN_Landings ~ PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_90 + s(ACL_PSDN) + (1 + PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_90 | port_ID),
                hu ~ PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_90 + s(ACL_PSDN) + (1 + PSDN_SDM_60 + MSQD_SDM_90 + NANC_SDM_90 | port_ID)),
                          data = est_data_psnd,
                          family = hurdle_gamma(), 
                          control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)
save.image (file = "stan_fit.RData")

# ##  Extract Grouo-Level estimates ##
# ranef(fit_qPSDN_gamma)
# 
# ## Check divergence and other model check ##
# launch_shinystan(fit_qPSDN_gamma)

# Investigate chain and posterior distributions. 
# https://cran.r-project.org/web/packages/bayesplot/vignettes/graphical-ppcs.html
# plot(fit_qPSDN_t2nc, pars = c("PSDN_SDM"))

# ### Predictions ###
# pred_data <- data.frame(PSDN_SDM = c(0.5, 0.25), MSQD_SDM = c(0.5), Port_ID = 1)
# predict(fit_qPSDN, newdata = pred_data, re_formula = NA)

# ## Compare models ##
# loo(fit1, fit2)

## Check https://www.pcouncil.org/stock-assessments-and-fishery-evaluation-safe-documents/ for ACL and closures.
```


```{r y_rep, message=FALSE, warning=FALSE, fig.cap = "Graphical posterior predictive checks. (Gamma distribution)"}
pp_check(fit_qPSDN_90) + ggtitle('Pacific Sardine model') + theme(legend.position = "bottom") +  xlim(0, 20000) 
```

### Effect of SDM's on Sardine landings

```{r int_effect_smooth, eval=FALSE, include=FALSE}
pseq_gamma <- plot(conditional_smooths(fit_qPSDN_90), plot = FALSE, ask = FALSE)
pseq_gamma[[1]] + pseq_gamma[[2]] + plot_layout(nrow = 2)
```

```{r PSDN_effect_total, echo=FALSE, message=FALSE, warning=FALSE}
# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qPSDN_90, "PSDN_SDM_60", surface=TRUE), ask = FALSE)
```  

```{r MSQD_effect_total, echo=FALSE, message=FALSE, warning=FALSE}
# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qPSDN_90, "MSQD_SDM_90", surface=TRUE), ask = FALSE)
```  

```{r NANC_effect_total, echo=FALSE, message=FALSE, warning=FALSE}
# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qPSDN_90, "NANC_SDM_90", surface=TRUE), ask = FALSE)
```  

```{r ACL_effect, echo=FALSE, message=FALSE, warning=FALSE}
# summary(fit_qPSDN_gamma) 
plot(conditional_effects(fit_qPSDN_90, "ACL_PSDN", surface=TRUE), ask = FALSE)
```  


### Results by port

```{r by_port_sdm_psdn}
conditions <- data.frame(port_ID = unique(est_data_psnd$port_ID))
rownames(conditions) <- unique(est_data_psnd$Port)
plot(conditional_effects(
  fit_qPSDN_90, "PSDN_SDM_60", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points =FALSE)
```

```{r by_port_msqd_sdm}
plot(conditional_effects(
  fit_qPSDN, "MSQD_SDM_90", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```

```{r by_port_nanc_sdm}
plot(conditional_effects(
  fit_qPSDN_90, "NANC_SDM_90", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```

```{r by_port_acl_psdn}
plot(conditional_effects(
  fit_qPSDN, "ACL_PSDN", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)

```


### Interactive effects between Pacific Sardine and Market Squid SDMs

```{r int_effect_MSQD_total, echo=FALSE, message=FALSE, warning=FALSE}
plot(conditional_effects(
  fit_qPSDN_90, "PSDN_SDM_60:MSQD_SDM_90", surface=TRUE), ask = FALSE)
```   

```{r int_effect_NANC_total, echo=FALSE, message=FALSE, warning=FALSE}
plot(conditional_effects(
  fit_qPSDN_90, "PSDN_SDM_60:NANC_SDM_90", surface=TRUE), ask = FALSE)
```   



```{r int_effect_MSQD_by_port, echo=FALSE, message=FALSE, warning=FALSE}
plot(conditional_effects(
  fit_qPSDN_90, "PSDN_SDM_60:MSQD_SDM_90", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```

```{r int_effect_NANC_by_port, echo=FALSE, message=FALSE, warning=FALSE}
plot(conditional_effects(
  fit_qPSDN_90, "PSDN_SDM_60:NANC_SDM_90", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```


## Market Squid model

```{r msqd_data_all, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
# Select data for estimation, replace N/A landings to zero #
est_data_msqd_all <- est_data %>%
  dplyr::select(port_num, Port, PSDN_SDM_60, MSQD_SDM_90, NANC_SDM_60, NANC_SDM_90, MSQD_Landings, Landing_year, ACL_MSQD) %>%
  dplyr::mutate(MSQD_Landings = coalesce(MSQD_Landings, 0)) %>% 
  dplyr::mutate(dACL_MSQD= ifelse(Landing_year>=2004, 1, 0)) %>%
  dplyr::mutate(dClose = ifelse(Landing_year >= 2015,1,0)) %>%
  dplyr::mutate(dOpen = ifelse(Landing_year < 2015,1,0)) %>%
  dplyr::mutate(PSDN_SDM_60_dOpen = PSDN_SDM_60 * dOpen) %>%
  filter(Landing_year >= 2000)

# Select ports that at least they have landing PSDN once, and drop N/A #
Tot.landings.ports <- as.data.frame(cbind(rowsum(est_data_msqd_all$MSQD_Landings, est_data_msqd_all$Port, na.rm = TRUE)))

Tot.landings.ports <- Tot.landings.ports %>%
  mutate(dTotalMSQD = ifelse(V1>0, 1, 0)) %>%
  mutate(Port = rownames(Tot.landings.ports)) %>%
  dplyr::select(Port, dTotalMSQD)

### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###
est_data_msqd_all <- est_data_msqd_all %>%
  merge(Tot.landings.ports, by.x = "Port", by.y = "Port", all.x = TRUE, all.y = FALSE) %>%
  filter(dTotalMSQD==1) %>%
  drop_na() 
  
# Create matrices and vectors to run STAN model #
year_id <- as.vector(cbind(as.numeric(factor(est_data_msqd_all$Landing_year))));
est_data_msqd_all$port_ID <- udpipe::unique_identifier(est_data_msqd_all, fields = "port_num", start_from = 1) 
portID_names_all <- est_data_msqd_all %>%
  dplyr::select(Port, port_ID) %>%
  unique()

### Estimate using BRMS package ###
est_data_msqd_all$dACL_MSQD <- factor(est_data_msqd_all$dACL_MSQD)
est_data_msqd_all$dClose    <- factor(est_data_msqd_all$dClose)
est_data_msqd_all$port_ID   <- factor(est_data_msqd_all$port_ID)
class(est_data_msqd_all$dACL_MSQD)
class(est_data_msqd_all$dClose)
class(est_data_msqd_all$port_ID)
class(est_data_msqd_all$dOpen)
```

```{r msqd_est_90, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qMSQD_90 <- brm(
 bf(MSQD_Landings ~ MSQD_SDM_90 + PSDN_SDM_60_dOpen + NANC_SDM_90 + dClose + (1 + MSQD_SDM_90 + PSDN_SDM_60_dOpen + NANC_SDM_90 + dClose | port_ID),
               hu ~ MSQD_SDM_90 + PSDN_SDM_60_dOpen + NANC_SDM_90 + dClose + (1 + MSQD_SDM_90 + PSDN_SDM_60_dOpen + NANC_SDM_90 + dClose | port_ID)),
                       data = est_data_msqd_all,
                       family = hurdle_gamma(),
                       control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)
save.image (file = "stan_fit.RData")
```


```{r model-comp-msqd, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
fit_qMSQD <- add_criterion(fit_qMSQD, "loo")
fit_qMSQD_90 <- add_criterion(fit_qMSQD_90, "loo")

comp <- loo_compare(loo(fit_qMSQD), loo(fit_qMSQD_90)) %>%
  as.data.frame() %>%
  select(elpd_loo, elpd_diff, se_diff, p_loo, looic) %>%
  dplyr::rename(
    "ELPD-Diff" = elpd_diff, "SE-Diff" = se_diff, 
    "ELPD-LOO" = elpd_loo, "P-LOO" = p_loo, "LOOIC" = looic
  )

mw1 <- model_weights(fit_qMSQD, fit_qMSQD_90, weights = "loo")[rownames(comp)]

comp %>%
  cbind("Akaike-Weight" = mw1) %>%
  apa_table(
    format = "latex", booktabs = TRUE, digits = 2,
    caption = "Comparison of models fit1 to fit3 based on approximate leave-one-out cross-validation. Market squid landigns model.",
    note =  "ELPD-LOO = expected log posterior predictive density (higher is better); ELPD-DIFF = difference in ELPD values compared to the best model. SE-DIFF = standard error of the ELPD difference. P-LOO = effective number of model parameters (lower is better); LOOIC: leave-one-out information criterion (lower is better); Akaike-Weight = Model weight based on the LOOIC values (higher is better).",
    align = c("l", rep("r", 6))
  )
```

### Compare models 
```{r y_rep_logn_msqd, message=FALSE, warning=FALSE, fig.cap = "Graphical posterior predictive checks for Market Squid landings model."}
pp_check(fit_qMSQD_90) + ggtitle('Market Squid landing model') + theme(legend.position = "bottom")  +  xlim(0, 10) 
```

### Effect of SDM's on Market SquidSardine landings

```{r PSDN_effect_total_msqd, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Conditional effect of probability of occurrence of Pacific Sardine on Squid landings."}
plot(conditional_effects(fit_qMSQD_s, "PSDN_SDM_60_dOpen", surface=TRUE), ask = FALSE)
```  

```{r MSQD_effect_total_msqd, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Conditional effect of probability of occurrence of Market Squid on Squid landings."}
plot(conditional_effects(fit_qMSQD, "MSQD_SDM_90", surface=TRUE), ask = FALSE)
```  

```{r MSQD_effect_total_nanc, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Conditional effect of probability of occurrence of Northern Anchovy on Squid landings."}
plot(conditional_effects(fit_qMSQD, "NANC_SDM_60", surface=TRUE), ask = FALSE)
```  

```{r ACL_effect_msqd, echo=FALSE, fig.cap="Conditional effect of Pacific Sardin Closure on Market Squid Landings", message=TRUE, warning=TRUE}
plot(conditional_effects(fit_qMSQD, "dClose", dpar="mu"), ask = FALSE)
```  


### Results by port

```{r by_port_sdm_msdq}
conditions <- data.frame(port_ID = unique(est_data_msqd_all$port_ID))
rownames(conditions) <- unique(est_data_msqd_all$Port)
plot(conditional_effects(
  fit_qMSQD_90, "PSDN_SDM_60_dOpen", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```

```{r by_port_msqd_sdm_msqd}
plot(conditional_effects(
  fit_qMSQD_90, "MSQD_SDM_90", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```

```{r by_port_msqd_sdm_nanc}
plot(conditional_effects(
  fit_qMSQD_90, "NANC_SDM_90", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```

```{r by_port_msqd_dclose}
plot(conditional_effects(
  fit_qMSQD_90, "dClose", conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```

```{r by_port_msqd_dclose_hu}
plot(conditional_effects(
  fit_qMSQD_90, "dClose", conditions = conditions, 
  re_formula = NULL, dpar="hu"), ncol = 4, points = FALSE)
```
```{r by_port_msqd_dclose_mu}
plot(conditional_effects(
  fit_qMSQD_90, "dClose", conditions = conditions, 
  re_formula = NULL, dpar="mu"), ncol = 4, points = FALSE)
```

### Interactive effects between Pacific Sardine and Market Squid SDMs

```{r both_sdm_msqd, echo=FALSE, message=FALSE, warning=FALSE}
conditions_dClose <- data.frame(port_ID = unique(est_data_msqd_all$dClose))
rownames(conditions_dClose) <- unique(est_data_msqd_all$dClose)

plot(conditional_effects(
  fit_qMSQD_90, "PSDN_SDM_60_dOpen:MSQD_SDM_90", surface=TRUE, re_formula = NULL), ncol = 4, points = FALSE)
```

```{r both_sdm_nanc, echo=FALSE, message=FALSE, warning=FALSE}
conditions_dClose <- data.frame(port_ID = unique(est_data_msqd_all$dClose))
rownames(conditions_dClose) <- unique(est_data_msqd_all$dClose)

plot(conditional_effects(
  fit_qMSQD_90, "NANC_SDM_90:MSQD_SDM_90", surface=TRUE, re_formula = NULL), ncol = 4, points = FALSE)
```

```{r by_port_both_sdm_msqd, echo=FALSE, message=FALSE, warning=FALSE}
conditions_dClose <- data.frame(port_ID = unique(est_data_msqd_all$dClose))
rownames(conditions_dClose) <- unique(est_data_msqd_all$dClose)

plot(conditional_effects(
  fit_qMSQD_90, "PSDN_SDM_60_dOpen:MSQD_SDM_90", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```

```{r by_port_both_sdm_nanc, echo=FALSE, message=FALSE, warning=FALSE}
conditions_dClose <- data.frame(port_ID = unique(est_data_msqd_all$dClose))
rownames(conditions_dClose) <- unique(est_data_msqd_all$dClose)

plot(conditional_effects(
  fit_qMSQD_90, "NANC_SDM_90:MSQD_SDM_90", surface=TRUE, conditions = conditions, 
  re_formula = NULL), ncol = 4, points = FALSE)
```

# Conclusions
A possible extension of our research is to consider spatial autocorrelations between ports.\\footnote{See \cite{morris2019bayesian} for an application of a spatial model in a bayesian framework.} Ports landing maybe correlated as vessel have the incentives to choose the port of landing, conditional on whether the port have the infrastructure for this. It is likely that they just land wherever is closer to the area they are fishing. Nevertheless, differntial in prices could encourage them to travel a little further for higher prices. 




 



```{r int_effect_sep, eval=FALSE, include=FALSE}

hu <- plot(conditional_effects(fit_qPSDN, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="hu"),
           plot = FALSE, ask = FALSE)
mu <- plot(conditional_effects(fit_qPSDN, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="mu"),
           plot = FALSE, ask = FALSE)

mu[[1]] + hu[[1]] + plot_layout(nrow = 2)

```

```{r int_effect_sep_msqd, eval=FALSE, fig.cap=, include=FALSE}

hu <- plot(conditional_effects(fit_qMSQD_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="hu"),
           plot = FALSE, ask = FALSE)
mu <- plot(conditional_effects(fit_qMSQD_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="mu"),
           plot = FALSE, ask = FALSE)

mu[[1]] + hu[[1]] + plot_layout(nrow = 2)

```




