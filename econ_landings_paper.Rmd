---
title: "Portfolio Substitution between Coastal Pelagic Species under Shifting Target Species Distributions and Policy Constraints"
author:
  - name: Felipe Quezada
    email: felipe.quezada@noaa.gov
    institute: [ucsc, noaa1]
    correspondence: true
  - name: Desiree Tommasi
    institute: [ucsc, noaa1]
  - name: Stephen Stohs
    institute: noaa1
  - name: Isaac Kaplan
    institute: noaa2
  - name: Jonathan Sweeney 
    institute: noaa3
  - name: Barbara Muhling
    institute: [ucsc, noaa1]  

institute:
  - ucsc: Institute of Marine Sciences, University of California Santa Cruz
  - noaa1: NOAA Southwest Fisheries Science Center
  - noaa2: NOAA Northwest Fisheries Science Center
  - noaa3: NOAA Pacific Islands Fisheries Science Center
  
date: "`r format(Sys.time(), '%B %e, %Y')`"
abstract: "Fishers for forage species typically face a set of possible choices, called fishing portfolios, that allow them to diversify target species and reduce income risk. Switching among species is more feasible for vessels that share similar gear and methods for fishing. More diverse portfolios may increase fisher resilience to climate-driven changes in target species’ spatial distributions and availability. However, regulations and other constraints (e.g., port constraints on where landings of a particular species may occur, or permit requirements) may reduce the degree of substitution we observe. In this study, we analyze how historical changes in forage species distribution and the closure of the  Pacific sardine fishery affected landing substitution between three coastal pelagic species: Pacific sardine, market squid, and Northern anchovy. Using a discrete choice modeling approach, we also study how spatial distribution and closure affected the coastal pelagic species fisheries' participation decisions over the 2000-2019 period. Our preliminary results show strong substitution between market squid and Pacific sardine when both were available, while the Pacific sardine closure in 2015 was associated with reduced market squid landings suggesting lower fishers’ participation in this fishery. We plan to use species distribution model projections to study how landings and participation change under different future climate change scenarios."
header-includes:
  \usepackage{mathtools}
  \usepackage{tcolorbox}
  \usepackage{float}
  \floatplacement{figure}{H}
  \usepackage{times}
  \usepackage{setspace}
  \usepackage{rotating}
  \clearpage
  \setstretch{1.5}
output:
  pdf_document:
    number_sections: yes
    citation_package: natbib
    pandoc_args:
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
bibliography: references.bib
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# rm(list = ls(all.names = TRUE)) 
gc()
# load("PacFIN.RData")

library(bookdown)
library(brms)
library(cmdstanr)
library(doBy)
library(dplyr)
library(fastDummies)
library(ggplot2)
library(here)
library(hrbrthemes)
library(kableExtra)
library(lmtest)
library(lubridate)
library(magrittr)
library(Rcpp)
library(patchwork)
library(plm)
library(papaja)
library(reshape)
library(reshape2)
library(rstan)
library(scales)
library(sjlabelled)
library(texreg)
library(tidyr)
library(tidyverse)
library(tinytex)
library(viridis)
library(xtable)
library(zoo)
```

```{r read_data, include=FALSE}
port_area <- read.csv(file = here::here("Data", "Ports", "ports_area_codes.csv"))
  PacFIN.month <- read.csv(file ="C:\\Data\\PacFIN data\\PacFIN_month.csv")
  PacFIN.month <- PacFIN.month %>% merge(port_area, by = c("PACFIN_PORT_CODE"), all.x = TRUE)
  PacFIN.month.CPS <- PacFIN.month %>% 
    dplyr::filter(PACFIN_SPECIES_CODE %in% 
    c("CMCK", "JMCK", "MSQD", "NANC", "PBNT", "PSDN", "UMCK", "BTNA"))
    
  rm(port_area)
  
```

```{r functions, include=FALSE}
meanfun <- function(x, ...){
  c(mean=mean(x, na.rm=TRUE, ...)) #, v=var(x, na.rm=TRUE, ...), l=length(x))
}
sumfun <- function(x, ...){
  c(sum=sum(x, na.rm=TRUE, ...)) #, v=var(x, na.rm=TRUE, ...), l=length(x))
}
sum_mean_fun <- function(x, ...){
  c(mean=mean(x, na.rm=TRUE, ...), sum=sum(x, na.rm=TRUE, ...)) #, l=length(x))
}

```

# Introduction
Fishing portfolios are an essential mechanism to safeguard fishers' livelihood. Diversification strategies have been principally associated with reducing income variability [@kasperski2013]. For instance, when a species abundance is reduced due to environmental conditions, fishers can change targeted species to a species that requires similar gears. However, there is not always room for diversification. Switching between species can be costly if gears are pretty different between species, or a new permit is required for legal fishing. Moreover, even though fishers may have flexibility switching between species, port infrastructure and markets may impose some restrictions on this flexibility, as well as regulations that limit access to fisheries to avoid collapse of fish stocks from overfishing [@kasperski2013]. Therefore, it is unclear how species distribution and regulation changes would be reflected in landings compositions and participation.

In this study, we analyze how changes in spatial distribution and the implementation of fisheries closures affect landing and fisher participation of the two more important coastal pelagic species (CPS) harvested in the U.S. West Coast: Pacific sardine and market squid. Fisheries closures are an interesting policy instrument when fishers target more than one species because they allow us to study how fishers change behavior by excluding one alternative. However, fewer studies have studied one fishery closure's effect on other fishery outcomes. An example is @vermard2008 that studies the effect of an anchovy closure in trip choices conducted by the Bay of Biscay pelagic fleet, <!-- They use their estimate pre-closure to simulate the anchovy closure and compare with actual data. -->. Another example is  @richerson2017, who studies the effect of salmon closures in vessel participation on salmon fishery and other fisheries. In this paper, we study the effect of the 2015 Pacific sardine closure implemented after the over-exploitation of the fishery and the effect of seasonal closures after reaching a catch limit target. 

Studying the effect of closures and changes in species distribution is not straightforward as the different responses can be observed to the same conditions as fishers and vessels are heterogeneous [@zhang2011]. Moreover, vessel heterogeneity and port constraint will dictate the possible set of species that a fisher can choose.
Species are also interconnected, at least economically, if not ecologically. Thus, any regulation or ecological disruption that affects one species would affect fishers' target decision in other species. Therefore, a multiple species targeting framework that considers interrelation between species is necessary to understand the CPS fishery further. Our research gives a step further and analyzes the CPS fishery as one where fisher can target multiple species in line with recent literature that consider this setting in their analysis [@richerson2017]. Our goal is to understand how changes in species distribution, seasonal and total closures affect vessel responses in landing amount and participation, the substitution between species, and to what extent future projected climate will affect landings, catch composition, and fishers' participation.

Our papers build on the model developed by @smith2021potential for sardine landings. We expand their model, including a landing equation for the four species analyzed in this study and estimating a multilevel Bayesian model to incorporate heterogeneity between fleets and ports areas. Moreover, we use the probability of presence obtained from Species Distribution Models (SDM) as an explanatory variable instead of landing by species. The inclusion of SDMs allows us to project landing over time using SDM predictions for different climate scenarios incorporating projected substitution between species. We analyze how species distribution interacts with each other. We expect these additions to characterize better how the fishers portfolio is composed and better understand species interactions on catch rates. 

<!-- Additionally, we also estimate participation models for each species based on @richerson2017, expanding their analysis to the CPS fishery  -->
<!-- <!-- in monthly basis, allowing to understand seasonality within fishing season -->
<!-- . For this, we develop a Random Utility Model (RUM) to model monthly vessel participation in targeting a specific species in the CPS fishery as a function of... **fisher characteristics including revenue level, diversification, dependence on the species and spatial variables of area and range..**  -->

The remainder of the paper is organized as follows: Section \ref{coastal-pelagic-species-fishery} provides background on the CPS fishery in the US west coast. In Section \ref{methods} we discusses our data set and empirical strategy. Section \ref{results} presents the results of the estimations, and we conclude in Section \ref{conclusions}.



# Coastal Pelagic Species fishery 

Before 2000, the only fishery under a Fisheries Management Plan (FMP) was the Northern anchovy. The Northern anchovy FMP started to be developed in 1977, and the final draft was approved and implemented in 1978 [@CPSFMP2021]. During these times, and for many years, the Northern anchovy was harvested for reduction. This fleet was called *wetfish*. They also fisher for other CPS species such as Pacific sardine,  market squid, Pacific mackerel, Jack mackerel, Pacific bonito, and Pacific bluefin tuna [@SAFE2020]. In March 1995, the Pacific Fishery Management Council (PFMC) decided to expand the FMP through Amendment 8 to include the entire CPS species (Pacific sardine, northern anchovy, Pacific (chub) mackerel, jack mackerel, and market squid) along the U.S. west coast. . The PFMC partially approved this amendment on June 1999, and they published the final regulations on December 1999. Finally, the PFMC implemented the FMP on January 1st, 2000. 

Nowadays, there is no reduction capacity for the Northern anchovy fishery in California, and it is principally harvested in the Monterrey area as a substitute for sardine and squid when both are not available [@SAFE2020].  The Northern anchovy fishery has lost importance within the CPS species without the reduction market. However, in some particular ports like Monterrey, it is the only species that fishers can harvest when market squid is unavailable, and the Pacific sardine has been closed [@SAFE2020]. In Oregon, the Northern anchovy fishery was developmental between 1995 and 2009. Only 4 of the 15 developmental permits were issued for this fishery. The developmental program was suspended in 2009. The reason was there were no fundings to support it [@SAFE2020]. The Oregon Northern anchovy fishery is currently under an open-access regime but limited by gear [@SAFE2020]. A significant fishery started to grow in 2015 and 2016, but there were no landings in Oregon in 2018. In Washington, Northern anchovy fishery is restricted from developing to a high-volume fishery to protect the traditional bait fishery. Some of these regulations limit catch and limit the catch percentage allocated to reduction.

In the 60s, the Pacific sardine fishery in California closed due to the fishery's collapse. The fishery reopened in 1986 with a precautionary quota of 906 metric tons. The Pacific sardine fishery was considered as fully recovered in 1998, and biomass of over a million metric tons was estimated [@SAFE2020]. Since 2000, after implementing the CPS FMP, the Pacific sardine has been managed under a limited entry (LE) permit and quota management system, with a Harvest Guideline (HG) controlling commercial catch of sardine biomass. The CPS LE fleet is composed of 65 permits and 55 vessels. The LE permits program is federal. In Oregon and Washington, the fishery development did not happen until the years 2000s. In 1999, a fishery for the Pacific sardine started to operate in both states targeting larger sardines to be sold as bait to Asian longline tuna fisheries [@SAFE2020]. Then, in 2006 the fishery expanded on both states to human consumption. In Oregon, the Pacific sardine fishery was categorized as "developmental fishery" until 2005, and the first Limited Entry (LE) permits were issued in this state in 2006, capped at 26 (currently, there are 24 LE permits for this fishery in Oregon). In Washington, the Pacific sardine fishery was a "trial fishery" from 2000-2002 with a state HG of 15,000 metric tons (i.e., no limits on the number of participants). Later, from 2003 to 2009, the fishery was under an "experimental fishery" category, with experimental permits capped at 25. Finally, in 2009, Washington's Pacific sardine fishery was designated as a "commercial fishery" with a Limited Entry (LE) program that allocated 16 permanent permits and ten temporary ones. In Washington, fishing for sardine is prohibited from January 1st to March 31st, and directed commercial harvest is prohibited within state waters (0 to 3 miles). The HG for the Pacific sardine follows an allocation framework. A geographical boundary at the 39° N latitude divides the coast into two areas. In 2005, the quota allocation for Pacific sardine was modified from area-based, where 50\% of the HG goes to each area, to coast-wide seasonal release that follows an allocation formula: 
Moreover, the allocation formula for the Pacific sardine HG was defined as follow: 
1. 35\% of the HG to be allocated coastwide on January 1st.
2. 40|% of the HG, plus any portion not harvested from the initial allocation, will be reallocated coastwide on July 1st.
3. 25\% of the HG, plus any portion not harvested from earlier allocations, will be reallocated coastwide on September 15th.
The commercial fishery has been closed for the whole U.S. west coast since 2015 as the spawning stock biomass (SSB) is estimated to be below the cutoff point of 150,000 metric tons. This total closure came after many years of seasonal closures.

Concerning market squid, the fishery was unregulated under open access until permits became required in 1998. However, there were no limits to the number of permits issued by the authorities. In 2001, a Harvest Guideline (HG) was implemented to 125,000 U.S. tons for this fishery. Later, in 2005, the California Fish and Game Commission (CFGC) implemented the Market Squid Fisheries Management Plan (MSFMP), which reduced the fleet to a maximum of 73 vessels, limits the number of light boats to 34, reduced the HG to 118,000 U.S. tons and incorporate a weekend closure to allow for a period of uninterrupted spawning [@SAFE2020].^[Vessel permits allow vessels to attract squid with light and use purse seine for harvest, Brail permits allow to attract squid with light and use brail gear, and light boat permits only allows to attract squid with lights] Oregon's market squid fishery just started in 2014 with few vessels targeting squid (15 in 2016 and 11 in 2018), while in Washington, there are no directed landings of market squid. In 2019 two permits were issued to allow the possibility to deliver Oregon's market squid catch to Washington ports. 

The Pacific sardine's fishing season in California has a peak in landings during the early summer to fall in Monterrey area, specifically in Moss Landing, while in Southern California, specifically in San Pedro and Terminal Island, occurs during the winter. Fishing seasons for Pacific sardine are shown in Panel (a) of Figure \ref{{fig:fish_season}}. In Oregon and Washington state, at Astoria and Ilwaco/Chinook ports, the fishing season mostly happens in summer and early fall. Panel (b) shows that market squid fishing season in Southern California, specifically in San Pedro, Terminal Island, and Ventura, goes from fall to winter, while in Northern California, specifically in Moss Landing and Monterrey, the season goes from late spring to summer.  

```{r psdn_msqd_month_by_port, echo=FALSE, fig.cap="Fishing season for Pacific sardine and Market squid (average monthly total harvest for the period 2000-2014).", message=FALSE, warning=FALSE}

port_names <- as_labeller(c("SP" = "San Pedro", "HNM" = "Hueneme", "MNT" = "Monterrey", "MOS" = "Moss Landing", 
                               "LWC" = "Ilwaco / Chinook", "AST" = "Astoria", 
                               "PRN" = "Princeton/ Half Moon\nBay", "SF" = "San Francisco", 
                               "SLT" = "Sausalito", "TRM" = "Terminal Island",
                               "VEN" = "Ventura"))

q.psdn.by.month <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%
  filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>%  
  group_by(LANDING_YEAR, LANDING_MONTH, PACFIN_PORT_CODE) %>% 
  summarise(Landings_PSDN = sum(LANDED_WEIGHT_MTONS.sum)) %>%  
  group_by(LANDING_MONTH, PACFIN_PORT_CODE) %>% 
  summarise(Landings_PSDN = mean(Landings_PSDN)) %>%
    filter(PACFIN_PORT_CODE == "AST" | PACFIN_PORT_CODE == "SP" |
             PACFIN_PORT_CODE == "TRM" | PACFIN_PORT_CODE == "MOS" | 
             PACFIN_PORT_CODE == "LWC") %>%
    mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, "SP", "TRM", "MOS", "AST", "LWC"))
  
g1 <- ggplot(data=q.psdn.by.month, aes(x=LANDING_MONTH, y=Landings_PSDN)) +
    geom_bar(stat="identity", fill=rgb(0.1,0.4,0.5,0.7), width=0.4) + 
  scale_x_continuous(name = "Month", breaks=1:12) +
  scale_y_continuous(name = "Landings (M tons)" ) + 
  facet_grid(~ PACFIN_PORT_CODE, labeller = port_names) + ggtitle("(a) Pacific sardine") + 
  theme(plot.title = element_text(size=9, face="bold.italic"), axis.text = element_text(size = 6))

q.msqd.by.month <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%
  filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>%  
  group_by(LANDING_YEAR, LANDING_MONTH, PACFIN_PORT_CODE) %>% 
  summarise(Landings_PSDN = sum(LANDED_WEIGHT_MTONS.sum)) %>%  
  group_by(LANDING_MONTH, PACFIN_PORT_CODE) %>% 
  summarise(Landings_PSDN = mean(Landings_PSDN)) %>%
    filter( PACFIN_PORT_CODE == "SP" | PACFIN_PORT_CODE == "VEN" | PACFIN_PORT_CODE == "TRM" | 
              PACFIN_PORT_CODE == "MOS" | PACFIN_PORT_CODE == "MNT") %>%
    mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, "SP", "TRM", "VEN", "MNT", "MOS"))

# PACFIN_PORT_CODE == "HNM"

g2 <- ggplot(data=q.msqd.by.month, aes(x=LANDING_MONTH, y=Landings_PSDN)) +
    geom_bar(stat="identity", fill=rgb(0.1,0.4,0.5,0.7), width=0.4) + 
  scale_x_continuous(name = "Month", breaks=1:12) +
  scale_y_continuous(name = "Landings (M tons)" ) + 
  facet_grid(~ PACFIN_PORT_CODE, labeller = port_names) + ggtitle("(b) Market squid") + 
  theme(plot.title = element_text(size=9, face="bold.italic"), axis.text = element_text(size = 6))

g1 / g2

rm(g1, g2, q.psdn.by.month, q.msqd.by.month)
```


# Data analysis

## Landing, prices and revenue

Pacific sardine and market squid mainly dominated landings in the CPS fishery during the period 1981-2014, as is shown in Panel (a) in Figure \ref{fig:avg_lan_rev}. Panel (b) shows average annual prices. Average prices are low for all CPS species in comparison to bluefin tuna. Pacific bonito is the only one between CPS species whose average price is above 1.5 USD. This lower average price means that ladings levels mainly determine revenue. Therefore, similar to what we observe in Panel (a), we can observe in Panel (c) that market squid and Pacific sardine are the principal species in terms of revenue.

```{r avg_land_rev_price, echo=FALSE, fig.cap="Average annual landings, message=FALSE, warning=FALSE, prices and revenues by species (1981-2020).\\label{fig:avg_lan_rev}"}
## Landings chart
landings.year <- summaryBy(LANDED_WEIGHT_MTONS.sum ~ PACFIN_SPECIES_CODE + LANDING_YEAR, FUN=sumfun, data=PacFIN.month.CPS)
  landings.year <- landings.year %>% filter(LANDING_YEAR <2015)
  landings.avg.year <- summaryBy(LANDED_WEIGHT_MTONS.sum.sum ~ PACFIN_SPECIES_CODE, FUN=meanfun, da=landings.year)

g1 <- ggplot(landings.avg.year, aes(PACFIN_SPECIES_CODE, LANDED_WEIGHT_MTONS.sum.sum.mean)) +
  geom_col(width=0.4) + ggtitle("(a) Annual landings") + 
  theme(plot.title = element_text(size=9, face="bold.italic"), axis.text = element_text(size = 6), 
        axis.title = element_text(size = 8)) +
  xlab("Species") + ylab("Landings (tons)") + 
  scale_x_discrete(labels=c("BTNA" = "Bluefin\nTuna", "CMCK" = "Chub\nMackerel", "JMCK" = "Jack\nMackerel",
                            "MSQD" = "Market\nSquid", "NANC" = "Northern\nAnchovy", "PBNT" = "Pacific\nBonito",
                            "PSDN" = "Pacific\nSardine", "UMCK" = "Unknown\nMackerel"))

## Landings chart
price.year <- summaryBy(AFI_PRICE_PER_KG.mean ~ PACFIN_SPECIES_CODE + LANDING_YEAR, FUN=meanfun, da=PacFIN.month.CPS)
  price.year <- price.year %>% filter(LANDING_YEAR <2015)
  price.avg.year <- summaryBy(AFI_PRICE_PER_KG.mean.mean ~ PACFIN_SPECIES_CODE, FUN=meanfun, da=price.year)

g2 <- ggplot(price.avg.year, aes(PACFIN_SPECIES_CODE, AFI_PRICE_PER_KG.mean.mean.mean)) +
  geom_col(width=0.4) + ggtitle("(b) Average annual price") + 
  theme(plot.title = element_text(size=9, face="bold.italic"), axis.text = element_text(size = 6), 
        axis.title = element_text(size = 8)) +
  xlab("Species") + ylab("Price (kg)") + 
  scale_x_discrete(labels=c("BTNA" = "Bluefin\nTuna", "CMCK" = "Chub\nMackerel", "JMCK" = "Jack\nMackerel",
                            "MSQD" = "Market\nSquid", "NANC" = "Northern\nAnchovy", "PBNT" = "Pacific\nBonito",
                            "PSDN" = "Pacific\nSardine", "UMCK" = "Unknown\nMackerel"))

## Revenue chart

revenue.year <- summaryBy(AFI_EXVESSEL_REVENUE.sum ~ PACFIN_SPECIES_CODE + LANDING_YEAR, FUN=sumfun, data=PacFIN.month.CPS)
  revenue.year <- revenue.year %>% filter(LANDING_YEAR <2015)
  revenue.avg.year <- summaryBy(AFI_EXVESSEL_REVENUE.sum.sum ~ PACFIN_SPECIES_CODE, FUN=meanfun, data=revenue.year)

g3 <- ggplot(revenue.avg.year, aes(PACFIN_SPECIES_CODE, AFI_EXVESSEL_REVENUE.sum.sum.mean)) +
  geom_col(width=0.4) + ggtitle("(c) Annual revenue") + 
  theme(plot.title = element_text(size=9, face="bold.italic"), axis.text = element_text(size = 8), 
        axis.title = element_text(size = 8)) +
  xlab("Species") + ylab("Annual revenues (Millions of USD)") +  scale_y_continuous(labels = label_number(scale = 1e-6)) +
  scale_x_discrete(labels=c("BTNA" = "Bluefin\nTuna", "CMCK" = "Chub\nMackerel", "JMCK" = "Jack\nMackerel",
                            "MSQD" = "Market\nSquid", "NANC" = "Northern\nAnchovy", "PBNT" = "Pacific\nBonito",
                            "PSDN" = "Pacific\nSardine", "UMCK" = "Unspecific\nMackerel"))

(g1 + g2) / g3

rm(g1, g2, g3, landings.year, landings.avg.year, revenue.year, revenue.avg.year, price.year, price.avg.year)

```

```{r datasets_year, include=FALSE}
# Calculate number of vessels by species per month # 
nvessel.year <- PacFIN.month.CPS %>% 
  dplyr::select(PACFIN_SPECIES_CODE, LANDING_YEAR, VESSEL_NUM) %>% unique() %>% 
  mutate(n_vessel = 1) %>% group_by(PACFIN_SPECIES_CODE, LANDING_YEAR) %>%
  summarise(n_vessel = sum(n_vessel))

# Calculate average price and total landings by species per month #
landing.price.year <- summaryBy(LANDED_WEIGHT_MTONS.sum + AFI_PRICE_PER_KG.mean ~ 
                                  PACFIN_SPECIES_CODE + LANDING_YEAR, 
                      FUN=sum_mean_fun, data=PacFIN.month.CPS) 

```

The composition of the catch varies geographically. We show in Figure \ref{fig:avg_landings_by_ports} the average annual landings by ports. We can observe that market squid is mostly landed in the southern ports of California located around Los Angeles, Santa Barbara, and Monterrey areas. In contrast, Pacific sardine is mainly landed in California in Los Angeles and Monterrey areas and Oregon in the Columbia River area. As we mentioned before, a fishery in Oregon started developing for market squid recently. Within California boundaries, landing constraints comes from infrastructure capacity. For instance, between Coos Bay and San Francisco, there are ports with little opportunity to handle large volumes of market squid landings due to a lack of infrastructure. It is possible to truck landings to processors from these ports, but this is unlikely to be profitable due to transport costs. 

```{r avg_landings_by_port, echo=FALSE, fig.cap="Annual average landings by port area.\\label{fig:avg_landings_by_ports}", message=FALSE, warning=FALSE}
landings.by.port.year <- summaryBy(LANDED_WEIGHT_MTONS.sum ~ 
  PACFIN_SPECIES_CODE + PACFIN_PORT_CODE + LANDING_YEAR + AGENCY_CODE, FUN=sumfun, data=PacFIN.month.CPS)
  landings.by.port.avg.year <- summaryBy(LANDED_WEIGHT_MTONS.sum.sum ~ PACFIN_SPECIES_CODE + PACFIN_PORT_CODE 
    + AGENCY_CODE, FUN=meanfun, data=landings.by.port.year) %>% 
    filter(PACFIN_SPECIES_CODE == "PSDN" | PACFIN_SPECIES_CODE == "CMCK" | 
           PACFIN_SPECIES_CODE == "MSQD" |  PACFIN_SPECIES_CODE == "NANC") %>%
    filter(PACFIN_PORT_CODE == "AST" | PACFIN_PORT_CODE == "HNM" | PACFIN_PORT_CODE == "SP" |
           PACFIN_PORT_CODE == "VEN" | PACFIN_PORT_CODE == "TRM" | PACFIN_PORT_CODE == "MOS" |
           PACFIN_PORT_CODE == "WPT" | PACFIN_PORT_CODE == "MNT" | PACFIN_PORT_CODE == "LWC") %>%
    mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, 
      "SP", "WLM", "TRM", "HNM", "VEN", "MNT", "MOS", "PRN", "SF", "SLT", "WIN", "AST", "LWC", "WPT"))

 # PACFIN_PORT_CODE == "PRN" | PACFIN_PORT_CODE == "WLM" | PACFIN_PORT_CODE == "WIN"
 
states_names <- as_labeller(c(`C` = "California", `O` = "Oregon",`W` = "Washington"))
  ggplot(landings.by.port.avg.year, aes(fill=PACFIN_SPECIES_CODE, 
                                      y=LANDED_WEIGHT_MTONS.sum.sum.mean, x=PACFIN_PORT_CODE)) +
  geom_bar(position="dodge", stat="identity") + 
  facet_grid(~ AGENCY_CODE, scale="free", space="free_x", labeller = states_names) + 
  theme(strip.text.x = element_text(size = 7)) +
  theme(legend.position="bottom") + 
  scale_fill_viridis(discrete = T, labels=c("MSQD" = "Market Squid", "NANC" = "Northern Anchovy", 
                               "PHRG" = "Pacific Herring", "PSDN" = "Pacific Sardine", 
                               "BTNA" = "Bluefin tuna", "JMCK" = "Jack mackerel", 
                               "CMCK" = "Pacific mackerel", "UMCK" = "Unspecified mackerel",
                               "PBNT" = "Pacific bonito")) +
  theme(axis.text.x = element_text(angle=90, hjust=0.95, vjust=0.45)) + xlab("Ports") + 
  ylab("Landings (tons)") + guides(fill=guide_legend(title="Species: "))  + 
    scale_x_discrete(labels=c("SP" = "San\nPedro", "HNM" = "Hueneme", 
                              "MNT" = "Monterrey", "MOS" = "Moss\nLanding", 
                              "LWC" = "Ilwaco /\nChinook", "AST" = "Astoria", 
                              "PRN" = "Princeton/\nHalf Moon\nBay", "TRM" = "Terminal\nIsland",
                              "VEN" = "Ventura", "WIN" = "Winchester\nBay",
                              "WLM" = "Willmington", "WPT" = "Westport")) +
    scale_color_brewer(palette="Set2")

  
  
rm(states_names, landings.by.port.avg.year)
```

Let us now analyze our data ver time. In Figure \ref{fig:ts_landings_by_ports} we show the total annual landing by selected ports during the 2000-2020 period for market squid and Pacific sardine. The ports selected are the ones with the highest average annual landings identified in Figure \ref{fig:avg_landings_by_ports}. There is a general conception that vessels that harvest Pacific sardine switch to market squid when the other is unavailable. However, we can notice from Figure \ref{fig:ts_landings_by_ports} that landings of market squid have been decreasing in the last five years. We would expect that the Pacific sardine fishery's closure would have increased the level of market squid landing, but the graphs show some complementary instead of substitution. Complementary does not coincide with stakeholders' perceptions about switching behavior. They claim that many vessels in California switched to market squid after the Pacific sardine closure.^[Stalkholders state this during their participation in a workshop that reunited U.S. West Coast fishery.] 

```{r ts_by_port,  fig.cap = "Total annual landing by port area. 2000 - 2020. \\textit{Notes:} CLO = Columbia River (OR); LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara; SFA = San Francisco.\\label{fig:ts_landings_by_ports}" , echo=FALSE, message=FALSE, warning=FALSE}

landings.by.sel.ports <- landings.by.port.year %>% 
  filter(PACFIN_PORT_CODE == "SP" | PACFIN_PORT_CODE == "TRM" | 
         PACFIN_PORT_CODE == "MOS") %>%
  filter(PACFIN_SPECIES_CODE == "PSDN" |  PACFIN_SPECIES_CODE == "MSQD") %>%
  mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, "SP", "TRM", "HNM", "MNT", "MOS")) %>%
  filter(LANDING_YEAR >= 2000)

port_names <- as_labeller(c(`SP` = "San Pedro", `TRM` = "Terminal Island", 
                            `MOS` = "Moss Landing", `MNT` = "Monterrey", `HNM` = "Hueneme"))
     

ggplot(landings.by.sel.ports, aes(y=LANDED_WEIGHT_MTONS.sum.sum, 
                                  x=LANDING_YEAR, color=PACFIN_SPECIES_CODE, group=PACFIN_SPECIES_CODE)) +
  geom_line(size=1) + xlab("Year") + ylab("Landings (tons)") + 
  facet_wrap(~ PACFIN_PORT_CODE, labeller = port_names, nrow = 3, ncol = 1) +
  theme(legend.position="right") + 
  theme(axis.text.x = element_text(angle=90)) +
  guides(color=guide_legend(title="Species: ")) +
  scale_color_brewer(palette="Set2", labels=c("MSQD" = "Market Squid", "NANC" = "Northern Anchovy", 
             "PHRG" = "Pacific Herring", "PSDN" = "Pacific Sardine"))

rm(port_names, landings.by.sel.ports, landings.by.port.year)

```

A potential hypothesis is that unfavorable market conditions (e.g., low prices) affected market squid landings in recent years, independently of the condition of the Pacific sardine fishery. Figure \ref{fig:ts_landings_price} shows the evolution of landings and prices by species during the period 1981-2020. In Panel (a), we can observe that real prices for market squid have been increasing during the last two decades. Incentives should be high for landing market squid. However, we observe a sharp decline in market squid landings in the last decade.^[Prices for forage species are likely to be determined in the world market, as the California current landings for forage species correspond to a small share of the total landings in the world].

<!-- Regarding Pacific sardine, we observe that the price has been stable after 1990, while landing peaked in 2008, and there is a posterior decline in landing until the fishery closed in 2015. This trend suggests that abundance primarily determines Pacific sardine landings. -->

```{r ts_landing_price, echo=FALSE, fig.cap="Yearly total landing v/s, warning=FALSE, average price by CPS species (1981 - 2020).\\label{fig:ts_landings_price}", message=FALSE}
landing.price.year.sel <- landing.price.year %>% 
  select("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean", "PACFIN_SPECIES_CODE", "LANDING_YEAR")

# Graph landing v/s number of  vessels
coeff <- 100000
  df <- landing.price.year.sel %>% filter(PACFIN_SPECIES_CODE == "MSQD")
  df$AFI_PRICE_PER_KG.mean.mean <- df$AFI_PRICE_PER_KG.mean.mean * coeff 
  df <- gather(df, key = Variable, value = value,
               c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"))
  g1 <- ggplot(df, aes(x=LANDING_YEAR, y = value, colour = Variable)) + geom_line(size=1) +
    scale_y_continuous(name = "Landings (M Tons)", sec.axis = sec_axis(~./coeff, name = "Price per kg")) +
    theme(legend.position="none") + scale_x_continuous(name = element_blank()) + 
    theme(plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
      ggtitle("(b) Market Squid")  +  
    scale_color_brewer(palette="Set2",
                       limits = c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"))

coeff <- 100000
  df <- landing.price.year.sel %>% filter(PACFIN_SPECIES_CODE == "PSDN")
  df$AFI_PRICE_PER_KG.mean.mean <- df$AFI_PRICE_PER_KG.mean.mean * coeff 
  df <- gather(df, key = Variable, value = value,
               c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"))
  g2 <- ggplot(df, aes(x=LANDING_YEAR, y = value, colour = Variable)) + geom_line(size=1) +
    scale_y_continuous(name = "Landings (M Tons)", sec.axis = sec_axis(~./coeff, name = "Price per kg")) + 
    theme(legend.position="right") + scale_x_continuous(name = "Year") +
    theme(plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
      ggtitle("(a) Pacific Sardine")  + guides(colour=guide_legend(title="Variables: ")) + 
  scale_color_brewer(palette="Set2",
                     limits = c("LANDED_WEIGHT_MTONS.sum.sum", "AFI_PRICE_PER_KG.mean.mean"),
                     labels=c("AFI_PRICE_PER_KG.mean.mean" = "Price", "LANDED_WEIGHT_MTONS.sum.sum" = "Landings"))  

  (g2 / g1)
  rm(df, g1, g2, landing.price.year.sel)
  
  
```

```{r ts_Q_P_n, eval=FALSE, fig.cap="Yearly total landing, warning=FALSE, average price and total number of vessel by CPS species (1981 - 2020).\\label{fig:ts_landings}", message=FALSE, include=FALSE}

g1 <- ggplot(landing.price.year,
             aes(x = LANDING_YEAR, y = LANDED_WEIGHT_MTONS.sum.sum, group = PACFIN_SPECIES_CODE, colour = PACFIN_SPECIES_CODE)) +
  geom_line(size=1) + scale_x_continuous(name = "Year") +
  scale_y_continuous(name = "Landings (MTons)") +
  theme(legend.position = "right", plot.title = element_text(size=9, face="bold.italic"),
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  ggtitle("(a) Landings") +   guides(colour=guide_legend(title="Species: ")) +
  scale_color_brewer(palette="Set2", labels=c("MSQD" = "Market Squid",
                                              "NANC" = "Northern Anchovy",
                                              "PSDN" = "Pacific Herring",
                                              "PSDN" = "Pacific Sardine"))

g2 <- ggplot(landing.price.year,
             aes(x = LANDING_YEAR, y = AFI_PRICE_PER_KG.mean.mean, group = PACFIN_SPECIES_CODE, colour = PACFIN_SPECIES_CODE)) +
  geom_line(size=1) + scale_x_continuous(name = "Year") +
  scale_y_continuous(name = "Price ($/Kg)")  +
   scale_color_brewer(palette="Set2") +  theme(legend.position = "none", plot.title = element_text(size=9, face="bold.italic"),
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  ggtitle("(b) Prices")


g3 <- ggplot(nvessel.year, aes(x = LANDING_YEAR, y = n_vessel, group = PACFIN_SPECIES_CODE, colour = PACFIN_SPECIES_CODE)) +
  geom_line(size=1) + scale_x_continuous(name = "Year") +
  scale_y_continuous(name = "# of vessels") +   theme(legend.position="none")  +
   scale_color_brewer(palette="Set2") +  theme(plot.title = element_text(size=9, face="bold.italic"),
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  ggtitle("(c) Number of vessels")

(g2 + g1) / g3

rm(g1, g2, g3)

```

Another hypothesis that could explain the lower landings levels observed for market squid in the last decade could be the reduction in market squid's species availability and, therefore, the substitution to another species more profitable than market squid. According to the stakeholders, Pacific sardine's substitution may occur with other species such as mackerel, tuna, or anchovy. Figure \ref{fig:sdm_land_by_port} shows the relationship between the probability of presence (obtained from Species Distribution Models) and landings by species in three main port areas: Los Angeles, Monterrey, and Santa Barbara areas. The graph suggests that Pacific sardine landings positively correlate with the probability of presence of this species, similar to @smith2021potential. However, in the case of market squid, we cannot distinguish the correlation between landings and probability of presence. Note, however, that the evidence shown in this figure may not be capturing the actual effect of the probability of presence as other effects may be in play.

```{r SDM_land, eval=FALSE, fig.cap="Landings v/s probability of presence by port area. \\textit{Notes:} LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara.\\label{fig:sdm_land_by_port}", message=FALSE, warning=FALSE, include=FALSE}

sdm.by.species <- PacFIN.month.CPS %>%
  dplyr::select(LANDING_YEAR, PSDN_SDM_60, MSQD_SDM_90, NANC_SDM_20, LANDED_WEIGHT_MTONS.sum, PACFIN_SPECIES_CODE) %>% 
  filter(LANDING_YEAR >= 1998 & LANDING_YEAR <= 2019) %>%
  group_by(LANDING_YEAR, PACFIN_SPECIES_CODE) %>% 
  summarize(PSDN_SDM_60 = mean(PSDN_SDM_60, na.rm = TRUE), 
            NANC_SDM_20 = mean(NANC_SDM_20, na.rm = TRUE), 
            MSQD_SDM_90 = mean(MSQD_SDM_90, na.rm = TRUE),
            LANDED_WEIGHT_MTONS = sum(LANDED_WEIGHT_MTONS.sum, na.rm = TRUE)) %>%
  spread(PACFIN_SPECIES_CODE, LANDED_WEIGHT_MTONS) %>% 
  dplyr::rename(Landings_PSDN = PSDN) %>% dplyr::rename(Landings_MSQD = MSQD) %>% 
  dplyr::rename(Landings_NANC = NANC) %>%
  group_by(LANDING_YEAR) %>% 
  summarize(PSDN_SDM_60 = mean(PSDN_SDM_60, na.rm = TRUE), 
            NANC_SDM_20 = mean(NANC_SDM_20, na.rm = TRUE), 
            MSQD_SDM_90 = mean(MSQD_SDM_90, na.rm = TRUE),
            Landings_PSDN = sum(Landings_PSDN, na.rm = TRUE), Landings_MSQD = sum(Landings_MSQD, na.rm = TRUE),
            Landings_NANC = sum(Landings_NANC, na.rm = TRUE)) 
  # sdm.by.species$Date <- zoo::as.yearmon(paste(sdm.by.species$LANDING_YEAR, sdm.by.species$LANDING_MONTH, sep='-'))

# Plot
coeff <- 200000
g1 <-  ggplot(sdm.by.species) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = Landings_PSDN, color = "Landings"), size = 0.5) +
  geom_line(mapping = aes(x = LANDING_YEAR, y = PSDN_SDM_60*coeff, color = "Probability of presence"), 
            size = 0.5, linetype = "dashed") + 
  scale_x_continuous(name = element_blank(), labels = NULL) +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff, name = "")) +
  theme(legend.position="right", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(a) Pacific sardine") +  scale_color_manual(name = "Variable: ", 
                     values = c("Landings" = "grey", "Probability of presence" = "blue"))

coeff2 <- 300000
g2 <- ggplot(sdm.by.species) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = Landings_MSQD), size = 0.5, color = "grey") +
  geom_line(mapping = aes(x = LANDING_YEAR, y = MSQD_SDM_90*coeff2), 
            size = 0.5, color = "blue", linetype = "dashed") + 
  scale_x_continuous(name = element_blank(), labels = NULL) +
  scale_y_continuous(name = "Landings", sec.axis = sec_axis(~./coeff2, name = "P(presence)")) +
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(b) Market squid")

g1 / g2

rm(g1, g2, sdm.by.species, coeff, coeff2, coeff3)

```


```{r SDM_land_by_port, echo=FALSE, fig.cap="Landings v/s probability of presence by port area. \\textit{Notes:} LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara.\\label{fig:sdm_land_by_port}", message=FALSE, warning=FALSE}

sdm.by.species <- PacFIN.month.CPS %>%
  dplyr::select(LANDING_YEAR, PORT_NAME, PSDN_SDM_60, MSQD_SDM_90, NANC_SDM_20, 
                LANDED_WEIGHT_MTONS.sum, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE) %>% 
  filter(LANDING_YEAR >= 1998 & LANDING_YEAR <= 2019) %>%
  group_by(LANDING_YEAR, PORT_NAME, PACFIN_PORT_CODE, PACFIN_SPECIES_CODE) %>% 
  summarize(PSDN_SDM_60 = mean(PSDN_SDM_60, na.rm = TRUE), 
            NANC_SDM_20 = mean(NANC_SDM_20, na.rm = TRUE), 
            MSQD_SDM_90 = mean(MSQD_SDM_90, na.rm = TRUE),
            LANDED_WEIGHT_MTONS = sum(LANDED_WEIGHT_MTONS.sum, na.rm = TRUE)) %>%
  spread(PACFIN_SPECIES_CODE, LANDED_WEIGHT_MTONS) %>% 
  dplyr::rename(Landings_PSDN = PSDN) %>% dplyr::rename(Landings_MSQD = MSQD) %>% 
  dplyr::rename(Landings_NANC = NANC) %>%
  filter(PACFIN_PORT_CODE == "SP" | PACFIN_PORT_CODE == "TRM" | PACFIN_PORT_CODE == "MOS") %>% 
  mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, "SP", "TRM", "MOS")) %>%
  group_by(LANDING_YEAR, PORT_NAME, PACFIN_PORT_CODE) %>% 
  summarize(PSDN_SDM_60 = mean(PSDN_SDM_60, na.rm = TRUE), 
            NANC_SDM_20 = mean(NANC_SDM_20, na.rm = TRUE), 
            MSQD_SDM_90 = mean(MSQD_SDM_90, na.rm = TRUE),
            Landings_PSDN = sum(Landings_PSDN, na.rm = TRUE), Landings_MSQD = sum(Landings_MSQD, na.rm = TRUE),
            Landings_NANC = sum(Landings_NANC, na.rm = TRUE))
  # sdm.by.species$Date <- zoo::as.yearmon(paste(sdm.by.species$LANDING_YEAR, sdm.by.species$LANDING_MONTH, sep='-'))

# Plot
coeff <- 60000
g1 <-  ggplot(sdm.by.species) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = Landings_PSDN), size = 0.5, color = "grey") +
  geom_line(mapping = aes(x = LANDING_YEAR, y = PSDN_SDM_60*coeff), 
            size = 0.5, color = "blue", linetype = "dashed") + 
  facet_wrap(~ PORT_NAME) + 
  scale_x_continuous(name = element_blank(), labels = NULL) +
  scale_y_continuous(name = "Landings", sec.axis = sec_axis(~./coeff2, name = "P(presence)")) +
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("(a) Pacific sardine")

coeff2 <- 90000
g2 <- ggplot(sdm.by.species) + 
  geom_line(mapping = aes(x = LANDING_YEAR, y = Landings_MSQD, color = "Landings"), size = 0.5) +
  geom_line(mapping = aes(x = LANDING_YEAR, y = MSQD_SDM_90*coeff2, color = "Probability of presence"), 
            size = 0.5, linetype = "dashed") + 
  facet_wrap(~ PORT_NAME) + scale_x_continuous(name = "Year") +
  scale_y_continuous(name = "Landings", sec.axis = sec_axis(~./coeff2, name = "P(presence)")) +
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8),
        legend.position="bottom") + 
  ggtitle("(b) Market squid") +  scale_color_manual(name = "Variable: ", 
                     values = c("Landings" = "grey", "Probability of presence" = "blue"))

g1 / g2 

rm(g1, g2, g3, sdm.by.species, coeff, coeff2, coeff3)
```

```{r SDM_land_NANC_in_MNA, eval=FALSE, fig.cap="Landings v/s probability of presence by port area. \\textit{Notes:} LAA = Los Angeles; MNA = Monterey; SBA = Santa Barbara.\\label{fig:sdm_land_by_port}", message=FALSE, warning=FALSE, include=FALSE}

collapse <- PacFIN_yearly %>%
  filter(Species_code == "NANC") %>%
  dplyr::select(Landing_year, Port, NANC_SDM_20_sep_dec, Landings, Species_code) %>% 
  filter(Port == "MNA") %>% mutate(Port = fct_relevel(Port, "MNA")) %>% 
  spread(Species_code, Landings) %>% dplyr::rename(Landings_NANC = NANC) %>%
  filter(Landing_year >= 2000 & Landing_year <= 2018)
  
# Plot
coeff <- 50000
g3 <- ggplot(collapse) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_NANC, color = "Landings"),
            size = 0.5) +
  geom_line(mapping = aes(x = Landing_year, y = NANC_SDM_20_sep_dec*coeff, color = "Probability of presence"), 
            size = 0.5, linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = "Year") +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff, name = element_blank())) +
  theme(legend.position="bottom", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("Northern anchovy") +  scale_color_manual(name = "Variable: ", 
                     values = c("Landings" = "grey", "Probability of presence" = "blue"))

g3


collapse2 <- as.data.frame(diff(collapse$NANC_SDM_20_sep_dec))
  names(collapse2)[1] <- 'NANC_SDM_20_sep_dec'
  collapse2 <- collapse2 %>% mutate(Landings_NANC = diff(collapse$Landings_NANC)) %>% mutate(Port = "MNA") %>%
    mutate(Landing_year = seq(2001,2018))

dg3 <- ggplot(collapse2) + 
  geom_line(mapping = aes(x = Landing_year, y = Landings_NANC, color = "diff(Landings)"),
            size = 0.5) +
  geom_line(mapping = aes(x = Landing_year, y = NANC_SDM_20_sep_dec*coeff, color = "diff(Probability of presence)"), 
            size = 0.5, linetype = "dashed") + 
  facet_wrap(~ Port) + 
  scale_x_continuous(name = "Year") +
  scale_y_continuous(name = element_blank(), sec.axis = sec_axis(~./coeff, name = element_blank())) +
  theme(legend.position="bottom", plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  ggtitle("Northern anchovy (first differences)") +  scale_color_manual(name = "Variable: ", 
                     values = c("diff(Landings)" = "grey", "diff(Probability of presence)" = "blue"))

dg3


library("writexl")
write_xlsx(collapse,"Data\\monterrey_NANC_sdm_landings.xlsx")

```


It could also be that the lower abundance and the consequent closure of the Pacific sardine fishery also affect vessels' decision to participate in the market squid fishery. Maybe fishers stop fishing at all as the exclusion of Pacific sardine from their portfolio reduces fisher's ability to overcome income risk through diversification [@kasperski2013]. This hypothesis suggests an unintended consequence from a policy that aims only to affect Pacific sardine, but its effect indirectly affects other fisheries [@richerson2017]. We have some suggestive evidence from this in Figure \ref{fig:ts_landings}, which shows the evolution of Pacific sardine landings and the number of vessels landing market squid during the period 1981-2020. In the first year of the Pacific sardine closure, we observe that the number of vessels that lands Market squid decreased from 99 vessels in 2014 to 74 vessels in 2015. After this abrupt decline, we observe a slight recovery, reaching 109 vessels in 2020. Nevertheless, the level observed in 2020 is below the levels observed in 2012 with 139 vessels landings market squid during that year. 


```{r ts_landings_vessels, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Landing of Pacific sardine v/s Number of vessel landing market squid.\\label{fig:ts_landings}"}
landing.nvessels.year.sel <- landing.price.year %>%
  inner_join(nvessel.year, by = c("PACFIN_SPECIES_CODE", "LANDING_YEAR")) %>%
  select("LANDED_WEIGHT_MTONS.sum.sum", "n_vessel", "PACFIN_SPECIES_CODE", "LANDING_YEAR")

# Graph landing v/s number of  vessels
coeff <- 1000
  df <- landing.nvessels.year.sel %>% filter(PACFIN_SPECIES_CODE == "MSQD" | PACFIN_SPECIES_CODE == "PSDN") %>%
    mutate(n_vessel = ifelse(PACFIN_SPECIES_CODE == "MSQD", n_vessel, 0)) %>%
    mutate(LANDED_WEIGHT_MTONS.sum.sum = ifelse(PACFIN_SPECIES_CODE == "PSDN",
                                                LANDED_WEIGHT_MTONS.sum.sum, 0)) %>%
    group_by(LANDING_YEAR) %>%
    summarise(n_vessel = sum(n_vessel), LANDED_WEIGHT_MTONS.sum.sum = sum(LANDED_WEIGHT_MTONS.sum.sum))

  df$n_vessel <- df$n_vessel * coeff
  df <- gather(df, key = Variable, value = value,
               c("n_vessel", "LANDED_WEIGHT_MTONS.sum.sum"))
  ggplot(df, aes(x=LANDING_YEAR, y = value, colour = Variable)) + geom_line(size=1) +
    scale_y_continuous(name = "Landings of Pacific sardine (M Tons)", sec.axis = sec_axis(~./coeff, name = "Number of vessels landing market squid")) +
    theme(legend.position="bottom") + scale_x_continuous(name = element_blank()) +
    theme(plot.title = element_text(size=9, face="bold.italic"),
          axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
    guides(colour=guide_legend(title="Variables: ")) + scale_color_brewer(palette="Set2",
                     limits = c("LANDED_WEIGHT_MTONS.sum.sum", "n_vessel"),
                     labels=c("LANDED_WEIGHT_MTONS.sum.sum" = "Landing of Pacific sardine", 
                              "n_vessel" = "Number of vessel landing market squid")) 

rm(g1, g2, g3, g4, df, landing.nvessels.year.sel, coeff)
rm(landing.price.year, nvessel.year)

```

A clear story about why market squid landings have decreased would require a more rigorous statistical analysis. We design our empirical strategy to address various concerns about omitted variables to obtain clean causal effects of a set of explanatory variables on both Pacific sardine and market squid landings.



## Cluster analysis

Before continuing our analysis, we have to verify whether there is switching behavior between CPS species. We conduct a cluster analysis to categorize the different portfolios fishers manage during a year. For this, we conduct our cluster analysis using a hierarchical clustering method. This method has been used before in fisheries to define *metiers* in discrete choice models [@vermard2008]. This approach does not require defining the number of clusters chosen within the algorithm. There are different methods to compute the distance between two clusters and conduct the algorithm. We use Ward's method in our study, similar to [@vermard2008]. The goal of this method is to reduce the within-cluster variance. The algorithm starts with all observation in a cluster and then merge in each step the two cluster with the minimum distance between cluster. The analysis includes commercial vessels that have harvested CPS species or used gear that the CPS generally uses at least one during 2000-2015. 

We start our analysis including Pacific sardine, market squid, Pacific mackerel, Jack mackerel, Pacific bonito, and Bluefin tuna as species where substitution is likely [@SAFE2020].  Table \ref{Table:cluster_all} present the results for the clustering analysis. Many vessels belong to a cluster that describes a portfolio considered as single-species. For instance, a vessel belonging to Cluster 1 in average 99.48% of the total landings correspond to market squid. Thus, this vessel only focused on this species. An exciting cluster is Cluster 8. On average, 61.42\% of the total landing registered for vessels associated with this cluster comes from market squid, 26.07\% from Pacific sardine, 5.92\% from Pacific mackerel, 3.5\% from Northern anchovy, and the remaining 3\% comes from Jack mackerel, Pacific bonito, Bluefin tuna, and Unspecified mackerel.

```{r cluster_analysis, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
## Calculate share of revenue of species by vessel during a month ##
PacFIN.spread <- PacFIN.month.CPS %>% filter(LANDING_YEAR >=2000) %>%  filter(LANDING_YEAR < 2015) %>%
  select(LANDING_YEAR, LANDING_MONTH, VESSEL_NUM, PACFIN_SPECIES_CODE, LANDED_WEIGHT_MTONS.sum) %>% 
  group_by(VESSEL_NUM, PACFIN_SPECIES_CODE) %>% 
  summarise(Landings = sum(LANDED_WEIGHT_MTONS.sum)) %>%
  spread(PACFIN_SPECIES_CODE, Landings)
  PacFIN.spread[is.na(PacFIN.spread)] <- 0
   
  PacFIN.spread.perc <- PacFIN.spread %>% select("CMCK", "MSQD", "NANC", "PBNT", 
                                                 "PSDN", "BTNA", "JMCK", "UMCK") %>%
    mutate(Total = CMCK + MSQD + NANC + PBNT + PSDN + BTNA + JMCK + UMCK) %>%
    filter(Total > 0) %>%
    mutate(CMCK = CMCK / Total * 100) %>% mutate(MSQD = MSQD / Total * 100) %>% 
    mutate(NANC = NANC / Total * 100) %>% mutate(PBNT = PBNT / Total * 100) %>% 
    mutate(PSDN = PSDN / Total * 100) %>% mutate(BTNA = BTNA / Total * 100) %>% 
    mutate(JMCK = JMCK / Total * 100) %>% mutate(UMCK = UMCK / Total * 100)  

# set.seed(21)
# speciesCluster <- kmeans(PacFIN.spread[, 2:5], 30)
# speciesCluster

## Hierarchical clustering analysis ##
col <- (ncol(PacFIN.spread.perc)-1)  
  PacFIN.spread.perc[is.na(PacFIN.spread.perc)] <- 0
  clusters <- hclust(dist(PacFIN.spread.perc[, 2:col]), method = "ward.D")
  # plot(clusters, cex = 0.1, hang = -1)

## Construct table ##  
clusterCut <- as.data.frame(cutree(clusters, 10))
  PacFIN.spread.perc$cluster <- clusterCut$`cutree(clusters, 10)`
    PacFIN.clusters <- PacFIN.spread.perc %>% group_by(cluster) %>%
      summarise(mean.CMCK = mean(CMCK), mean.MSQD = mean(MSQD), mean.NANC = mean(NANC), mean.JMCK = mean(JMCK), 
                mean.PBNT = mean(PBNT), mean.PSDN = mean(PSDN), mean.BTNA = mean(BTNA), mean.UMCK = mean(UMCK),
                count = n())
    
PacFIN.clusters <- PacFIN.clusters[,-1]
colnames(PacFIN.clusters) = c("Pacific\nmackerel", "Market squid", "Northern anchovy", 
                              "Jack\nmakerel", "Pacific bonito", "Pacific sardine", 
                              "Bluefin tuna", "Unspecified mackerel", "Obs.") 
    
print(xtable(PacFIN.clusters, caption = 'Cluster by percentage of landings by species.\\label{Table:cluster_all}',
             type = "latex"), floating = TRUE, floating.environment = "sidewaystable", comment=FALSE,  caption.placement = "top")
  
##-------------------------------
# Compute Agglomerative coefficient
  
# # Compute with agnes (make sure you have the package cluster)
# library(cluster)
# hc2 <- agnes(PacFIN.spread.perc[, 2:col], method = "ward")
# hc2$ac
# ## 0.9995197

# # Make graph
# library(factoextra)
# fviz_cluster(list(data = cbind.data.frame(PacFIN.spread.perc$MSQD, PacFIN.spread.perc$PSDN), 
#                   cluster = cutree(clusters, 8)))  ## from ‘factoextra’ package 
# 
# pltree(hc2, hang=-1, cex = 0.6)
# rect.hclust(hc2, k = 8, border = 2:9)

```

Let us focus on a subgroup of species identified in Cluster 8: Pacific mackerel, market squid, Northern anchovy, and Pacific sardine. Table \ref{Table:clust_sel} present the result from the clustering analysis using this subgroup of species. The first four clusters correspond to vessels that focus on single species. In contrast, Cluster 5 depicts vessel' portfolios where substitution happens between CPS species, mostly between market squid and Pacific sardine. Specifically, on average, 55.41\% of the total landings come from market squid, 30.57\% comes from Pacific sardine, 9.89\% comes from Pacific mackerel, and 4.12\% comes from Northern anchovy. Clustering our data allow us to identify the characteristic of the vessels that are likely to switch between species. In the following subsections, we study gear used and port landed by vessel depending on the species landed and the vessel's cluster. 

```{r cluster_analysis_selec, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
## Calculate share of revenue of species by vessel during a month ##
PacFIN.spread <- PacFIN.month.CPS %>% filter(LANDING_YEAR >=2000) %>%  filter(LANDING_YEAR < 2015) %>%
  select(LANDING_YEAR, LANDING_MONTH, VESSEL_NUM, PACFIN_SPECIES_CODE, LANDED_WEIGHT_MTONS.sum) %>% 
  group_by(VESSEL_NUM, PACFIN_SPECIES_CODE) %>% 
  summarise(Landings = sum(LANDED_WEIGHT_MTONS.sum)) %>%
  spread(PACFIN_SPECIES_CODE, Landings)
  PacFIN.spread[is.na(PacFIN.spread)] <- 0
   
  PacFIN.spread.perc <- PacFIN.spread %>% select("CMCK", "MSQD", "NANC", "PSDN") %>%
    mutate(Total = CMCK + MSQD + NANC + PSDN) %>%
    filter(Total > 0) %>%
    mutate(CMCK = CMCK / Total * 100) %>% mutate(MSQD = MSQD / Total * 100) %>% 
    mutate(NANC = NANC / Total * 100) %>% mutate(PSDN = PSDN / Total * 100) 
  
# set.seed(21)
# speciesCluster <- kmeans(PacFIN.spread[, 2:5], 30)
# speciesCluster

## Hierarchical clustering analysis ##
col <- (ncol(PacFIN.spread.perc)-1)  
  PacFIN.spread.perc[is.na(PacFIN.spread.perc)] <- 0
  clusters <- hclust(dist(PacFIN.spread.perc[, 2:col]), method = "ward.D")
  # plot(clusters, cex = 0.1, hang = -1)

## Construct table ##  
clusterCut <- as.data.frame(cutree(clusters, 5))
  PacFIN.spread.perc$cluster <- clusterCut$`cutree(clusters, 5)`
    PacFIN.clusters <- PacFIN.spread.perc %>% group_by(cluster) %>%
      summarise(mean.CMCK = mean(CMCK), mean.MSQD = mean(MSQD), mean.NANC = mean(NANC), mean.PSDN = mean(PSDN),
                count = n())
 
    
PacFIN.clusters <- PacFIN.clusters[,-1]
colnames(PacFIN.clusters) = c("Pacific mackerel", "Market squid", "Northern anchovy", 
                              "Pacific sardine", "Obs.") 

print(xtable(PacFIN.clusters, caption = 'Cluster by percentage of landings by species (main species).\\label{Table:clust_sel}', type = "latex"), comment=FALSE,  caption.placement = "top")

rm(PacFIN.spread, col, clusters, clusterCut, PacFIN.clusters)

```

```{r dataframe_cluster, include=FALSE}

PacFIN.month.cluster <- PacFIN.spread.perc %>% select('VESSEL_NUM', 'cluster') %>% unique() %>%
  merge(PacFIN.month, by = ("VESSEL_NUM"), all.y = TRUE, all.x = FALSE)

rm(PacFIN.spread.perc)

```

## Switching behavior

Substitution between species is likely related to the gear that a vessel or fisher have invested in for their fishing activities and the port they commonly land. These two characteristics will dictate the potential species choices that a vessel has to choose. @richerson2017 call species choices and other spatial patterns of ocean use as spatial constraints. Vessels with the same spatial constraints share local ecological knowledge and vessel mobility [@richerson2017]. Nevertheless, vessels are not restricted to a specific gear and port. In theory, they can switch between different gear alternatives and choose different ports to land. Therefore, they can modify the spatial constraints that they face. Nevertheless, switching between gears that are entirely different could be costly, and landing in a port without the infrastructure to land the targeted is unlikely. 

Substitution between Pacific sardine and market squid is more likely in the south of the California Current System (CCS) as both species have a fishery running around this area. Specifically, substitution between market squid and Pacific sardine seems more likely in Los Angeles, Monterrey, and Santa Barbara area ports as positive values for market squid and Pacific sardine are observed. Meanwhile, there is less target switching in the north of the CCS (CPS Workshop). 

Vessel traveling considerable distances to catch CPS species is unlikely. Because CPS spoils quickly, fishers stay close to ports and usually come back to port on the same day. Therefore, ports constraints could have consequences if species distribution shifts north due to climate conditions. Probably, fishers will not target market squid, independently of its biomass levels, if fishing grounds move north,  as there is no close infrastructure for its landing (CPS workshop). Nevertheless, there is uncertainty about this assumption as it would depend on the speed that ports can anticipate and adjust their landings capacity and infrastructure in the future. In this section, we analyze our dataset to understand better how gears and ports are related to switching between species and whether individual vessels switch gears and ports during the historical data.


### Switching by gear used

```{r n_species, eval=FALSE, include=FALSE}
PacFIN.species <- PacFIN.month %>% select('PACFIN_SPECIES_CODE') %>% unique()
nrow(PacFIN.species)

```

On average, in our sample data, a vessel uses 1.4 gears for its fishing activities, with a standard deviation of 0.72. If we only focus on the CPS fleet, a vessel switches between 1.42 gears on average to harvest market squid, 1.16 gears on average to harvest Northern anchovy, and 1.24 gears on average to harvest Pacific herring, and 1.28 on average to harvest Pacific sardine. In terms of gears, midwater trawl and seine allow for the highest substitution level between all CPS species (including also Bluefin tuna). On average, a vessel using midwater trawl harvests 2.36 CPS species, while a vessel using seine harvest in average 1.91 CPS species.

```{r n_gears_used_vessels, eval=FALSE, include=FALSE}
# How many gears a vessel use in the dataset
PacFIN.CPS.unique.gear <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_GEAR_CODE) %>% unique()

PacFIN.CPS.n_gears <- PacFIN.CPS.unique.gear %>% mutate(n_gears = 1) %>% group_by(VESSEL_NUM) %>% 
  summarise(n_gears= sum(n_gears)) 
  summary(PacFIN.CPS.n_gears$n_gears)
  sd(PacFIN.CPS.n_gears$n_gears)

# ### If I have used SEINE, how many other gear I use?
# PacFIN.Base <- PacFIN_month %>% filter( LANDING_YEAR >= 2010) %>%  select(VESSEL_NUM, PACFIN_GEAR_CODE) %>% unique()
#   PacFIN.only.seine <- PacFIN_month %>% filter( LANDING_YEAR >= 2010) %>% select(VESSEL_NUM, PACFIN_GEAR_CODE) %>%
#     filter(PACFIN_GEAR_CODE == "SEN") %>% mutate(D_Seine = 1) %>% select(VESSEL_NUM, D_Seine) %>% unique() 
#   PacFIN.CPS.n_gear <- PacFIN.Base %>% inner_join(PacFIN.only.seine, by = c("VESSEL_NUM")) %>% filter(D_Seine == 1) %>% 
#     unique() %>% group_by(VESSEL_NUM) %>% summarise(N_gear= sum(D_Seine)) 
#   summary(PacFIN.CPS.n_gear$N_gear)
#   sd(PacFIN.CPS.n_gear$N_gear)
  
rm(PacFIN.CPS.unique.gear, PacFIN.CPS.n_gears)

```

```{r n_gear_by_species, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
PacFIN.Gear.PSDN <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% unique() %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>% mutate(n_gears = 1) %>%  
  group_by(VESSEL_NUM) %>% summarise(n_gears = sum(n_gears)) %>% mutate(Species = "PSDN")

PacFIN.Gear.MSQD <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% unique() %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>% mutate(n_gears = 1) %>%  
  group_by(VESSEL_NUM) %>% summarise(n_gears = sum(n_gears)) %>% mutate(Species = "MSQD")

PacFIN.Gear.NANC <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% unique() %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("NANC")) %>% mutate(n_gears = 1) %>%  
  group_by(VESSEL_NUM) %>% summarise(n_gears = sum(n_gears)) %>% mutate(Species = "NANC")

PacFIN.Gear.CMCK <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% unique() %>% 
  filter(PACFIN_SPECIES_CODE  %in% c("CMCK")) %>% mutate(n_gears = 1) %>%  
  group_by(VESSEL_NUM) %>% summarise(n_gears = sum(n_gears)) %>% mutate(Species = "CMCK")

PacFIN.Gear <- rbind.data.frame(PacFIN.Gear.PSDN, PacFIN.Gear.NANC, 
                                PacFIN.Gear.MSQD, PacFIN.Gear.CMCK)

table <- xtabs(n_gears ~ Species, aggregate(n_gears ~ Species, PacFIN.Gear, mean))
rownames(table) = c("Market squid", "Northern Anchovy", "Pacific sardine") 
print(xtable(table, caption = 'Average number of gear used to catch a CPS species.', type = "latex"), comment=FALSE,  caption.placement = "top")

rm(PacFIN.Gear, PacFIN.Gear.PSDN, PacFIN.Gear.NANC, PacFIN.Gear.MSQD, PacFIN.Gear.PHRG)

```

```{r n_species_species_gear, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

# Create dummy of whether a vessel harvest MSQD, NANC OR PSDN 
PacFIN.CPS <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% 
  unique() %>%  
  filter(PACFIN_GEAR_CODE %in% c("DPN", "ONT", "SEN", "GLN", "MDT", "POL")) %>% mutate(CPS_species = 1) %>%
  group_by(VESSEL_NUM, PACFIN_GEAR_CODE) %>% 
  summarise(n_CPS_landed = sum(CPS_species)) 

table <- xtabs(n_CPS_landed ~ PACFIN_GEAR_CODE, aggregate(n_CPS_landed ~ PACFIN_GEAR_CODE, PacFIN.CPS, mean))
#table
rownames(table) = c("Dip Net", "Gill Net", "Midwater Trawl", "Other Net Gear", "Pole", "Seine") 

print(xtable(table, caption = 'Average number of CPS species landed by a vessel by gear used.\\label{Table:n_CPS_gear}', type = "latex"), comment=FALSE,  caption.placement = "top")

rm(PacFIN.CPS, table)

```

However, seine is the most used gear to harvest Pacific sardine, Northern anchovy, and market squid. 29\% of vessels have used seine to harvest market squid since 2000, 45\% to harvest Pacific sardine, and 51\% to harvest Northern anchovy. In the case of Pacific mackerel, 29\% of the vessel observed during the period 2000-2020 use pole for their harvest, while 18\% of vessels use seine. Regarding total landings, seine is the most important gear by far. The percentage of the total landing that comes from using seine is 97\% for market squid, 96\%  for Northern anchovy and 93\%  for Pacific mackerel, and 67\% for the Pacific sardine. The other 33\% of the total landings of Pacific sardine come from other net gears (e.g., round-haul nets).

```{r n_vessels_using_gear, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
PacFIN.Gear.PSDN <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>% 
  mutate(n_vessels = 1) %>% mutate(n_total = n()) %>% group_by(PACFIN_GEAR_CODE) %>%
  summarise(n_vessels = sum(n_vessels), n_total = mean(n_total)) %>% mutate(Species = "PSDN") %>% 
  filter(PACFIN_GEAR_CODE %in% c("DPN", "MDT", "ONT", "POL", "SEN", "TRL"))

PacFIN.Gear.MSQD <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>% 
  mutate(n_vessels = 1) %>% mutate(n_total = n()) %>% group_by(PACFIN_GEAR_CODE) %>%
  summarise(n_vessels = sum(n_vessels), n_total = mean(n_total)) %>% mutate(Species = "MSQD") %>% 
  filter(PACFIN_GEAR_CODE %in% c("DPN", "MDT", "ONT", "POL", "SEN", "TRL"))

PacFIN.Gear.NANC <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE %in% c("NANC")) %>% 
  mutate(n_vessels = 1) %>% mutate(n_total = n()) %>% group_by(PACFIN_GEAR_CODE) %>%
  summarise(n_vessels = sum(n_vessels), n_total = mean(n_total)) %>% mutate(Species = "NANC") %>% 
  filter(PACFIN_GEAR_CODE %in% c("DPN", "MDT", "ONT", "POL", "SEN", "TRL"))

PacFIN.Gear.CMCK <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE %in% c("CMCK")) %>% 
  mutate(n_vessels = 1) %>% mutate(n_total = n()) %>% group_by(PACFIN_GEAR_CODE) %>%
  summarise(n_vessels = sum(n_vessels), n_total = mean(n_total)) %>% mutate(Species = "CMCK") %>% 
  filter(PACFIN_GEAR_CODE %in% c("DPN", "MDT", "ONT", "POL", "SEN", "TRL"))

PacFIN.Gear.PSDN$n_vessels <- PacFIN.Gear.PSDN$n_vessels/PacFIN.Gear.PSDN$n_total
PacFIN.Gear.MSQD$n_vessels <- PacFIN.Gear.MSQD$n_vessels/PacFIN.Gear.MSQD$n_total
PacFIN.Gear.NANC$n_vessels <- PacFIN.Gear.NANC$n_vessels/PacFIN.Gear.NANC$n_total
PacFIN.Gear.CMCK$n_vessels <- PacFIN.Gear.CMCK$n_vessels/PacFIN.Gear.CMCK$n_total
  PacFIN.Gear <- rbind.data.frame(PacFIN.Gear.PSDN, PacFIN.Gear.NANC, PacFIN.Gear.MSQD, PacFIN.Gear.CMCK)
  table <- xtabs(n_vessels ~ PACFIN_GEAR_CODE + Species, PacFIN.Gear)

colnames(table) = c("Pacific mackerel", "Market squid", "Northern anchovy", "Pacific sardine") 
  rownames(table) = c("Dip Net", "Midwater Trawl", "Other Net Gear", "Pole", "Seine", "Troll") 

print(xtable(table, 
             caption = 'Percentage of vessels using a gear to harvest CPS species.\\label{table:perc_n_vessel}', 
             type = "latex"), comment=FALSE,  caption.placement = "top")

rm(PacFIN.Gear, PacFIN.Gear.PSDN, PacFIN.Gear.NANC, PacFIN.Gear.MSQD, table)

```

```{r landing_using_gear, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
PacFIN.Gear.PSDN <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE, LANDED_WEIGHT_MTONS.sum) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE %in% c("PSDN")) %>% 
  mutate(tot_landings = sum(LANDED_WEIGHT_MTONS.sum)) %>% group_by(PACFIN_GEAR_CODE) %>%
  summarise(landings = sum(LANDED_WEIGHT_MTONS.sum), tot_landings = mean(tot_landings)) %>% 
  mutate(Species = "PSDN") %>% filter(PACFIN_GEAR_CODE %in% c("DPN", "MDT", "ONT", "SEN"))

PacFIN.Gear.MSQD <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE, LANDED_WEIGHT_MTONS.sum) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE %in% c("MSQD")) %>% 
  mutate(tot_landings = sum(LANDED_WEIGHT_MTONS.sum)) %>% group_by(PACFIN_GEAR_CODE) %>%
  summarise(landings = sum(LANDED_WEIGHT_MTONS.sum), tot_landings = mean(tot_landings)) %>% 
  mutate(Species = "MSQD") %>% filter(PACFIN_GEAR_CODE %in% c("DPN", "MDT", "ONT", "SEN"))

PacFIN.Gear.NANC <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE, LANDED_WEIGHT_MTONS.sum) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE %in% c("NANC")) %>% 
  mutate(tot_landings = sum(LANDED_WEIGHT_MTONS.sum)) %>% group_by(PACFIN_GEAR_CODE) %>%
  summarise(landings = sum(LANDED_WEIGHT_MTONS.sum), tot_landings = mean(tot_landings)) %>% 
  mutate(Species = "NANC") %>% filter(PACFIN_GEAR_CODE %in% c("DPN", "MDT", "ONT", "SEN"))

PacFIN.Gear.CMCK <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(PACFIN_SPECIES_CODE, PACFIN_GEAR_CODE, LANDED_WEIGHT_MTONS.sum) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE %in% c("CMCK")) %>% 
  mutate(tot_landings = sum(LANDED_WEIGHT_MTONS.sum)) %>% group_by(PACFIN_GEAR_CODE) %>%
  summarise(landings = sum(LANDED_WEIGHT_MTONS.sum), tot_landings = mean(tot_landings)) %>% 
  mutate(Species = "CMCK") %>% filter(PACFIN_GEAR_CODE %in% c("DPN", "MDT", "ONT", "SEN"))

PacFIN.Gear.PSDN$n_vessels <- PacFIN.Gear.PSDN$landings/PacFIN.Gear.PSDN$tot_landings
PacFIN.Gear.MSQD$n_vessels <- PacFIN.Gear.MSQD$landings/PacFIN.Gear.MSQD$tot_landings
PacFIN.Gear.NANC$n_vessels <- PacFIN.Gear.NANC$landings/PacFIN.Gear.NANC$tot_landings
PacFIN.Gear.CMCK$n_vessels <- PacFIN.Gear.CMCK$landings/PacFIN.Gear.CMCK$tot_landings
  PacFIN.Gear <- rbind.data.frame(PacFIN.Gear.PSDN, PacFIN.Gear.NANC, PacFIN.Gear.MSQD, PacFIN.Gear.CMCK)
  table <- xtabs(n_vessels ~ PACFIN_GEAR_CODE + Species, PacFIN.Gear)

colnames(table) = c("Pacific mackerel", "Market squid", "Northern anchovy", "Pacific sardine") 
  rownames(table) = c("Dip Net", "Midwater Trawl", "Other Net Gear", "Seine") 

print(xtable(table, 
    caption = 'Percentage of landing by gear used and CPS species harvested.\\label{table:perc_landings}', 
    type = "latex"), comment=FALSE,  caption.placement = "top")

rm(PacFIN.Gear, PacFIN.Gear.PSDN, PacFIN.Gear.NANC, PacFIN.Gear.MSQD, table)

```

The ability to switch using seine as gear is confirmed when we analyze the most common gears used by different clusters (see Table \ref{Table:cluster_gear}). In Cluster 5, the cluster where we observe substitution, 88\% of the cluster's total landings correspond to catches using seine as a gear. Only 7\% and 3\% of the cluster's total landings correspond to catches using other net gear and midwater trawl, respectively.

```{r gear_by_cluster, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

# Create dummy of whether a vessel harvest MSQD, NANC OR PSDN 
PacFIN.cluster <- PacFIN.month.cluster %>% filter(LANDING_YEAR >= 2000) %>% 
  group_by(cluster, PACFIN_GEAR_CODE) %>% summarise(landings = sum(LANDED_WEIGHT_MTONS.sum)) %>% 
  group_by(cluster) %>% mutate(perc = landings / sum(landings)) %>% 
  unique() %>% filter(cluster != is.na(cluster)) %>% 
  filter(PACFIN_GEAR_CODE %in% 
           c("MDT", "SEN", "TRL", "ONT", "RLT"))
    
table <- xtabs(perc ~  PACFIN_GEAR_CODE + cluster, PacFIN.cluster)
#table
rownames(table) = c("Midwater Trawl", "Other Net Gear", "Roller Trawl", "Seine", "Troll")
colnames(table) = c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4", "Cluster 5")

print(xtable(table, caption = 'Percentage of cluster total langings by gear used.\\label{Table:cluster_gear}', type = "latex"), comment=FALSE,  caption.placement = "top")

rm(table)

```

### Switching by port landed


```{r n_ports_vessels, eval=FALSE, include=FALSE}
# How many gears a vessel use in the dataset
PacFIN.CPS.unique.port <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_PORT_CODE) %>% unique() 
  PacFIN.CPS.n_ports <- PacFIN.CPS.unique.port %>% mutate(n_ports = 1) %>% 
    group_by(VESSEL_NUM) %>% summarise(n_ports= sum(n_ports)) 
    summary(PacFIN.CPS.n_ports$n_ports)
    sd(PacFIN.CPS.n_ports$n_ports)

rm(PacFIN.CPS.unique.port, PacFIN.CPS.n_ports)

```

```{r n_ports_vessels_CPS, eval=FALSE, include=FALSE}
# How many gears a vessel use in the dataset
PacFIN.CPS.unique.port <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_PORT_CODE) %>% unique() 
  PacFIN.CPS.n_ports <- PacFIN.CPS.unique.port %>% mutate(n_ports = 1) %>% 
    group_by(VESSEL_NUM) %>% summarise(n_ports= sum(n_ports)) 
    summary(PacFIN.CPS.n_ports$n_ports)
    sd(PacFIN.CPS.n_ports$n_ports)

rm(PacFIN.CPS.unique.port, PacFIN.CPS.n_ports)

```

```{r n_ports_CPS, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
PacFIN.Gear.PSDN <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>% 
  mutate(N_port = 1) %>% group_by(VESSEL_NUM) %>% 
  summarise(N_port = sum(N_port)) %>% mutate(Species = "PSDN")

PacFIN.Gear.MSQD <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>% 
  mutate(N_port = 1) %>% group_by(VESSEL_NUM) %>% 
  summarise(N_port = sum(N_port)) %>% mutate(Species = "MSQD")

PacFIN.Gear.NANC <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("NANC")) %>% 
  mutate(N_port = 1) %>% group_by(VESSEL_NUM) %>% 
  summarise(N_port = sum(N_port)) %>% mutate(Species = "NANC")

PacFIN.Gear.CMCK <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% 
  select(VESSEL_NUM, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE) %>% 
  unique() %>% filter(PACFIN_SPECIES_CODE  %in% c("CMCK")) %>% 
  mutate(N_port = 1) %>% group_by(VESSEL_NUM) %>% 
  summarise(N_port = sum(N_port)) %>% mutate(Species = "CMCK")

PacFIN.Port <- rbind.data.frame(PacFIN.Gear.PSDN, PacFIN.Gear.NANC,
                                PacFIN.Gear.MSQD, PacFIN.Gear.CMCK)

table <- xtabs(N_port ~ Species, aggregate(N_port ~ Species, PacFIN.Port, mean))
rownames(table) = c("Pacific mackerel", "Market squid", "Northern Anchovy", "Pacific sardine") 
print(xtable(table, caption = 'Average number of ports where a vessel landed their CPS species catch.', 
             type = "latex"), comment=FALSE,  caption.placement = "top")

rm(PacFIN.Gear.PSDN, PacFIN.Gear.MSQD, PacFIN.Gear.NANC, PacFIN.Port)

```

On average, vessels land their catch in 4.8 ports, with a standard deviation of 3.94. If we only consider CPS landings, vessels land in 2.1 ports on average, with a standard deviation of 2.17. When we disaggregate this information by species, vessels land on average market squid in 2.25 ports, Pacific sardine in 2.25 ports, Northern anchovy in 1.61 ports, and Pacific mackerel in 1.51 ports. 

Using the results from the cluster analysis, we can identify how many ports, on average, a vessel that belongs to a cluster lands. On average, vessels belonging to Cluster 1 land in 2.23 ports, Cluster 2 land in 1.35 ports, Cluster 3 land in 2.35 ports, Cluster 4 land in 1.46 ports, and Cluster 5 land in 6.32 ports. Thus, vessels with a multiple species portfolio (Cluster 5) on average land in more ports than vessels that only focus on one species. 

```{r n_ports_CPS_cluster, eval=FALSE, include=FALSE}
# How many gears a vessel use in the dataset
PacFIN.CPS.unique.port <- PacFIN.month.cluster %>% filter(LANDING_YEAR >= 2000) %>% 
  filter(PACFIN_SPECIES_CODE %in% c("CMCK", "MSQD", "NANC", "PSDN")) %>%
  select(VESSEL_NUM, PACFIN_PORT_CODE, cluster) %>% unique() 
  PacFIN.CPS.n_ports <- PacFIN.CPS.unique.port %>% mutate(n_ports = 1) %>% 
    group_by(VESSEL_NUM, cluster) %>% summarise(n_ports= sum(n_ports)) %>% 
    group_by(cluster) %>% summarise(n_ports = mean(n_ports))
  
rm(PacFIN.CPS.unique.port, PacFIN.CPS.n_ports)

```

California concentrates the most significant percentage of landings from Cluster 5, adding up to 86\% of the total catch, mainly in the south (see Table \ref{Table:cluster_port}). The percentage of the total catch made by Cluster 5 in San Pedro is 22\%, 19\% in Terminal Island, 19\% in Moss Landing, 13\% in Hueneme, 8\% in Ventura, 7\% in Astoria, 5\% in Monterrey, and 1\% in Ilwaco/Chinook. If we aggregate by areas, 41\% is landed in Los Angeles area port, 21\% in Santa Barbara area ports, and 24\% in Monterrey area.

```{r port_by_cluster, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

# Create dummy of whether a vessel harvest MSQD, NANC OR PSDN 
PacFIN.cluster <- PacFIN.month.cluster %>% filter(LANDING_YEAR >= 2000) %>% 
  group_by(cluster, PACFIN_PORT_CODE) %>% summarise(landings = sum(LANDED_WEIGHT_MTONS.sum)) %>% 
  group_by(cluster) %>% mutate(perc = landings / sum(landings)) %>% 
  unique() %>% filter(cluster != is.na(cluster)) %>% 
  filter(PACFIN_PORT_CODE %in% 
      c("SP", "TRM", "HNM", "VEN", "MNT", "MOS", "AST", "LWC", "WPT")) %>%
  mutate(PACFIN_PORT_CODE = fct_relevel(PACFIN_PORT_CODE, 
      "SP", "TRM", "HNM", "VEN", "MNT", "MOS", "AST", "LWC", "WPT"))
    
table <- xtabs(perc ~  PACFIN_PORT_CODE + cluster, PacFIN.cluster)
rownames(table) = c("San Pedro", "Terminal Island", "Hueneme", "Ventura", "Monterrey", "Moss Landing", 
                    "Astoria", "Ilwaco / Chinook", "Westport")
  
colnames(table) = c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4", "Cluster 5")

print(xtable(table, caption = 'Percentage of cluster total landings by port.\\label{Table:cluster_port}', type = "latex"), comment=FALSE,  caption.placement = "top")

rm(table)

```

<!-- ### Vessel lenght  -->
<!-- <!-- 1) What are the characteristics of a vessel depending on gear, and also on Species -->
<!-- There is heterogeneity on vessel characteristics depending on the gear and target species. In general, vessel harvesting Pacific herring tends to be smaller in length (see Table \ref{Table:length}), except for vessels using pole. Vessels using seine and harvesting Market squid, Pacific sardine and Northern anchovy have similar length, suggesting easier substitution between these species. About fishing days... -->

<!-- ```{r lenght_by_species_gear, echo=FALSE, results='asis'} -->

<!-- PacFIN.CPS <- PacFIN.month %>%  -->
<!--   filter(PACFIN_SPECIES_CODE  %in% c("MSQD", "PSDN", "NANC", "PHRG"))  %>%  -->
<!--   filter(PACFIN_GEAR_CODE  %in% c("DPN", "ONT", "SEN", "GLN", "MDT", "POL")) %>% -->
<!--   filter(LANDING_YEAR >= 2010 ) -->

<!-- table <- xtabs(VESSEL_LENGTH.mean ~ PACFIN_GEAR_CODE + PACFIN_SPECIES_CODE, -->
<!--                aggregate(VESSEL_LENGTH.mean ~ PACFIN_GEAR_CODE + PACFIN_SPECIES_CODE, PacFIN.CPS, mean)) -->
<!-- # table -->
<!-- colnames(table) = c("Market squid", "Northern Anchovy", "Pacific Herring", "Pacific Sardine")  -->
<!-- rownames(table) = c("Dip Net", "Gill Net", "Midwater Trawl", "Other Net Gear", "Pole", "Seine")  -->
<!-- print(xtable(table, caption = 'Vessel lenght used in the CPS fishery by gear used.\\label{Table:lenght}', type = "latex"), comment=FALSE,  caption.placement = "top") -->

<!-- rm(table, PacFIN.CPS) -->

<!-- ``` -->


<!-- ### Fishing days -->

<!-- ```{r fishing_days, echo=FALSE, results='asis'} -->

<!-- PacFIN.CPS <- PacFIN.month %>%  -->
<!--   filter(PACFIN_SPECIES_CODE  %in% c("MSQD", "PSDN", "NANC", "PHRG"))  %>%  -->
<!--   filter(PACFIN_GEAR_CODE  %in% c("DPN", "ONT", "SEN", "GLN", "MDT", "POL")) %>% -->
<!--   filter(LANDING_YEAR >= 2000 ) -->

<!-- table <- xtabs(NUM_OF_DAYS_FISHED.mean ~ PACFIN_GEAR_CODE + PACFIN_SPECIES_CODE, -->
<!--                aggregate(NUM_OF_DAYS_FISHED.mean ~ PACFIN_GEAR_CODE + PACFIN_SPECIES_CODE, PacFIN.CPS, mean)) -->
<!--  # table -->
<!-- colnames(table) = c("Northern Anchovy", "Pacific Herring", "Pacific Sardine")  -->
<!-- rownames(table) = c("Dip Net", "Midwater Trawl", "Other Net Gear", "Seine") -->
<!-- print(xtable(table, caption = 'Number of days fishing by species and gear used', type = "latex"), comment=FALSE,  caption.placement = "top") -->

<!-- rm(table, PacFIN.CPS) -->

<!-- ``` -->




### Other determinants switching of behavior

Switching behavior might depend on whether a vessel is owner-operated or company-owned (CPS Workshop). Owner-operated vessels can freely choose what to harvest (and when and where), while company-owned vessels are restricted by what the company dictates.  However, regardless of vessel ownership, most fishing behavior would be determined by market order (CPS workshop). Vessels will already have contracts with processors before fishing (CPS workshop), having already decided on the target species. Prices will affect target decisions, which in general varies by port. 

<!-- Another determinant of behavior that vessels face is the perishability of the catch. CPS vessels are limited to staying at sea for one day because CPS species can perish if stored for longer. It does not mean that vessels cannot target different species in one day. Some vessels harvest market squid and Pacific sardine during the same day.  -->

```{r switching_day_landings, eval=FALSE, include=FALSE}
# PacFIN_2010_2020 <- read.csv(file = "C:/Data/PacFIN data/FutureSeasIII_2010_2020.csv")
#   PacFIN_2000_2009 <- read.csv(file = "C:/Data/PacFIN data/FutureSeasIII_2000_2009.csv")
#
#   # Merge different decades of data #
# PacFIN <- rbind.data.frame(PacFIN_2000_2009, PacFIN_2010_2020)
#   rm(PacFIN_2000_2009, PacFIN_2010_2020)
#   gc()
#
# psdn.landings.by.day.vessel <- PacFIN %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%
#   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR, LANDING_MONTH, LANDING_DAY, LANDED_WEIGHT_MTONS) %>%
#   filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>%
#   group_by(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR, LANDING_MONTH, LANDING_DAY) %>%
#   summarise(Landed_PSDN = sum(LANDED_WEIGHT_MTONS)) %>% mutate(harv.psdn = 1)
#
# # If a vessel harvest Pacific sardine in a year, how many also harvest squid.
# squid.cond.psdn <- PacFIN %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%
#   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR, LANDING_MONTH, LANDING_DAY, LANDED_WEIGHT_MTONS) %>%
#   merge(psdn.landings.by.day.vessel, by = c("VESSEL_NUM", "LANDING_YEAR", "LANDING_MONTH", "LANDING_DAY"), all.x = TRUE) %>%
#   filter(harv.psdn == 1) %>% filter(PACFIN_SPECIES_CODE.x == "MSQD") %>%
#   mutate(perc_land_squid = LANDED_WEIGHT_MTONS / (LANDED_WEIGHT_MTONS + Landed_PSDN))
#
# write.csv(squid.cond.psdn,"C:\\Data\\day_switch_land.csv", row.names = FALSE)
df <- read.csv(file = "C:\\Data\\day_switch_land.csv")
hist(df$perc_land_squid, col = 'skyblue3', breaks = 10)
plot.ecdf(df$perc_land_squid)

```

```{r switching_day, eval=FALSE, include=FALSE}
# PacFIN_2010_2020 <- read.csv(file = "C:/Data/PacFIN data/FutureSeasIII_2010_2020.csv")
#   PacFIN_2000_2009 <- read.csv(file = "C:/Data/PacFIN data/FutureSeasIII_2000_2009.csv")
#
#   # Merge different decades of data #
# PacFIN <- rbind.data.frame(PacFIN_2000_2009, PacFIN_2010_2020)
#   rm(PacFIN_2000_2009, PacFIN_2010_2020)
#   gc()
#
# psdn.by.day <- PacFIN %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%
#   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR, LANDING_MONTH, LANDING_DAY) %>%
#   filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>%
#   unique() %>% mutate(harv.psdn = 1)
#
# # If a vessel harvest Pacific sardine in a year, how many also harvest squid.
# squid.cond.psdn <- PacFIN %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%
#   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR, LANDING_MONTH, LANDING_DAY) %>%
#   merge(psdn.by.day, by = c("VESSEL_NUM", "LANDING_YEAR", "LANDING_MONTH", "LANDING_DAY"), all.x = TRUE) %>%
#   filter(harv.psdn == 1) %>% filter(PACFIN_SPECIES_CODE.x == "MSQD") %>% unique()
#
# # Calculate number of vessels harvesting sardine and squid and percentage per year
# n_vessel_psdn <- psdn.by.day %>% group_by(LANDING_YEAR, LANDING_MONTH, LANDING_DAY) %>%
#   summarize(n_vessel_psdn = sum(harv.psdn, na.rm = TRUE))
# # %>% group_by(LANDING_MONTH, LANDING_DAY) %>%
# #   summarize(n_vessel_psdn = mean(n_vessel_psdn, na.rm = TRUE))
#
# n_vessel_msqd_c_psdn <- squid.cond.psdn %>% group_by(LANDING_YEAR, LANDING_MONTH, LANDING_DAY) %>%
#   summarize(n_vessel_msqd = sum(harv.psdn, na.rm = TRUE))
# # %>% group_by(LANDING_MONTH, LANDING_DAY) %>%
# #   summarize(n_vessel_msqd = mean(n_vessel_msqd, na.rm = TRUE))
#
# df <- merge(n_vessel_psdn, n_vessel_msqd_c_psdn, by=c("LANDING_YEAR", "LANDING_MONTH", "LANDING_DAY"), all.x = TRUE) %>%
#     mutate(n_vessel_msqd = if_else(is.na(n_vessel_msqd), 0, n_vessel_msqd)) %>% group_by(LANDING_MONTH, LANDING_DAY) %>%
#     summarize(n_vessel_msqd = sum(n_vessel_msqd, na.rm = TRUE), n_vessel_psdn = sum(n_vessel_psdn, na.rm = TRUE)) %>%
#     mutate(perc = (n_vessel_msqd / n_vessel_psdn)) %>% select(LANDING_MONTH, LANDING_DAY, perc)
#
# df$MonthDay <- paste( month.abb[df$LANDING_MONTH], df$LANDING_DAY, sep="-" )
#
# write.csv(df,"C:\\Data\\day_switch.csv", row.names = FALSE)
df <- read.csv(file = "C:\\Data\\day_switch.csv")
ggplot(data=df, aes(x=MonthDay, y=perc)) +
    geom_bar(stat="identity", fill=rgb(0.1,0.4,0.5,0.7), width=0.4) +
  scale_x_discrete(name = "Day", breaks=1:366) +
  scale_y_percent(name = "Percentage of vessels harvesting squid" )
rm(df)
```



# Methods

## Multispecies Landing Model

Our data set contains variables measured at the port and vessel levels for the CPS fishery in the U.S. West Coast. In our landing model, our outcome variable is the vessel's landings in a month of a specific species. <!-- These two different outcome variables would allow us to study the degree of flexibility that vessel has compared to ports regarding species substitution and catch composition. If vessels have firm contracts with processors associated with a port, we should observe that the substitution of vessels and port is similar.  --> We obtained daily vessel level panel data on landing by port areas from 1981 to 2020 upon request from [PacFIN](http://pacfin.psmfc.org/). We only include ports areas where substitution could happen. In practical terms, we drop ports that have never landed either Pacific sardine or market squid during our analysis period.^[We converted missing values to zero.] We assume that this criterion would allow us to identify ports with the infrastructure to land the two species.

```{r dataset, include=FALSE}
# Clean dataset
PacFIN.month.dataset = PacFIN.month[,!grepl("*_LE_",names(PacFIN.month))]
PacFIN.month.dataset <- PacFIN.month.dataset %>%   filter(LANDING_YEAR >= 2000) %>%
  filter(PACFIN_SPECIES_CODE == "PSDN" | PACFIN_SPECIES_CODE == "MSQD") %>%
  dplyr::select(LANDING_YEAR, LANDING_MONTH, PORT_NAME, VESSEL_NUM, PSDN_SDM_60, MSQD_SDM_90, ACL_PSDN,
         LANDED_WEIGHT_MTONS.sum, AFI_PRICE_PER_KG.mean, PACFIN_SPECIES_CODE, PACFIN_PORT_CODE, AGENCY_CODE) %>% 
  mutate(AFI_PRICE_PER_KG.mean = na_if(AFI_PRICE_PER_KG.mean, 0)) %>% 
  melt(id.vars=c("LANDING_YEAR", "LANDING_MONTH", "VESSEL_NUM",  "PORT_NAME", 
                 "PACFIN_PORT_CODE", "PACFIN_SPECIES_CODE", "AGENCY_CODE")) %>% 
  dcast(LANDING_YEAR + LANDING_MONTH + VESSEL_NUM + PORT_NAME + PACFIN_PORT_CODE + AGENCY_CODE ~
          PACFIN_SPECIES_CODE + variable, fun.aggregate=mean) 
  PacFIN.month.dataset[PacFIN.month.dataset == "NaN"] <- NA
  PacFIN.month.dataset <- PacFIN.month.dataset %>%
    mutate(PORT_ID = as.numeric(as.factor(PORT_NAME))) %>% ### Here is the port ID
    mutate(PSDN_SDM_60 = rowMeans(cbind(PSDN_PSDN_SDM_60, MSQD_PSDN_SDM_60), na.rm = T)) %>%
    mutate(MSQD_SDM_90 = rowMeans(cbind(PSDN_MSQD_SDM_90, MSQD_MSQD_SDM_90), na.rm = T)) %>%
    mutate(ACL_PSDN = rowMeans(cbind(PSDN_ACL_PSDN, MSQD_ACL_PSDN), na.rm = T))
    PacFIN.month.dataset[PacFIN.month.dataset == "NaN"] <- NA

# Create dataset for estimations
dataset = subset(PacFIN.month.dataset, select = -c(PSDN_PSDN_SDM_60, MSQD_PSDN_SDM_60, 
                  PSDN_MSQD_SDM_90, MSQD_MSQD_SDM_90, PSDN_ACL_PSDN, MSQD_ACL_PSDN))

# Include port area codes
port_area <- read.csv(file = here::here("Data", "Ports", "ports_area_codes.csv"))
  dataset <- dataset %>% merge(port_area, by = c("PACFIN_PORT_CODE"), all.x = TRUE)
  rm(PacFIN.month.dataset, port_area)
 
```

Our main treatment variables are the probability of presence and closures by species. We obtained the probability of presence from Species Distribution Models (SDM). The future forecast of these variables allows us to simulate the CPS fishery in the future. The species distribution has changed relative to ports in the last decades [@selden2020], which could explain the variability observed in fish landings [@selden2020, @smith2021potential]. For instance,  @smith2021potential found a positive effect of the probability of Pacific sardine presence on Pacific sardine landings. We follow the same procedure as @smith2021potential to associate SDM's outputs with ports. We compute the average probability of presence within the same radius of 60 kilometers around the port for Pacific sardine. This radius also coincides with the average distance with two standard deviations traveled by vessels based on logbooks available for these fisheries.^[@selden2020 use the 75th quantile of the travel distances made by vessels to define the availability of a species associated to a port for multiple species and weight these distances by the catch of those species.] We set this radius to 90 and 20 kilometers for market squid and Northern anchovy, respectively, based on logbooks' average distance to the fishing ground.^[To see an animation of how far vessels travel, please visit [this link](https://drive.google.com/file/d/1-PE_lcZNcXNcyILA_6xhkHyEhV3mV2TA/view?usp=sharing).] We use the monthly average probability of presence first within a port code defined by PacFIN and second within a port area excluding ports with no information to fill the missing values.  

```{r calculate-sdm, include=FALSE}
# Calculate year SDM for N/A's using PacFIN port code and port area code.

## Pacific sardine

### (a) Using PacFIN port code
SDM.port.code.PSDN <- aggregate(x=dataset$PSDN_SDM_60, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PACFIN_PORT_CODE), FUN = mean, na.rm=T)
  SDM.port.code.PSDN <- SDM.port.code.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PACFIN_PORT_CODE = Group.3) %>%
    dplyr::rename(PSDN.SDM.port.code = x)
    SDM.port.code.PSDN[SDM.port.code.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(SDM.port.code.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "PACFIN_PORT_CODE"), all.x = TRUE) %>% 
      mutate(PSDN_SDM_60 = ifelse(is.na(PSDN_SDM_60), PSDN.SDM.port.code, PSDN_SDM_60))
        rm(SDM.port.code.PSDN)
    
### (b) Using port area code
SDM.port.area.PSDN <- aggregate(x=dataset$PSDN_SDM_60, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_AREA_CODE), FUN = mean, na.rm=T)
  SDM.port.area.PSDN <- SDM.port.area.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_AREA_CODE = Group.3) %>%
    dplyr::rename(PSDN.SDM.port.area = x)
    SDM.port.area.PSDN[SDM.port.area.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(SDM.port.area.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_AREA_CODE"), all.x = TRUE) %>% 
      mutate(PSDN_SDM_60 = ifelse(is.na(PSDN_SDM_60), PSDN.SDM.port.area, PSDN_SDM_60))
        rm(SDM.port.area.PSDN)

dataset = subset(dataset, select = -c(PSDN.SDM.port.code, PSDN.SDM.port.area))

## Market squid 

### (a) Using PacFIN port code
SDM.port.code.MSQD <- aggregate(x=dataset$MSQD_SDM_90, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PACFIN_PORT_CODE), FUN = mean, na.rm=T)
  SDM.port.code.MSQD <- SDM.port.code.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PACFIN_PORT_CODE = Group.3) %>%
    dplyr::rename(MSQD.SDM.port.code = x)
    SDM.port.code.MSQD[SDM.port.code.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(SDM.port.code.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "PACFIN_PORT_CODE"), all.x = TRUE) %>% 
      mutate(MSQD_SDM_90 = ifelse(is.na(MSQD_SDM_90), MSQD.SDM.port.code, MSQD_SDM_90))
        rm(SDM.port.code.MSQD)
    
### (b) Using port area code
SDM.port.area.MSQD <- aggregate(x=dataset$MSQD_SDM_90, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_AREA_CODE), FUN = mean, na.rm=T)
  SDM.port.area.MSQD <- SDM.port.area.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_AREA_CODE = Group.3) %>%
    dplyr::rename(MSQD.SDM.port.area = x)
    SDM.port.area.MSQD[SDM.port.area.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(SDM.port.area.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_AREA_CODE"), all.x = TRUE) %>% 
      mutate(MSQD_SDM_90 = ifelse(is.na(MSQD_SDM_90), MSQD.SDM.port.area, MSQD_SDM_90))
        rm(SDM.port.area.MSQD)

dataset = subset(dataset, select = -c(MSQD.SDM.port.code, MSQD.SDM.port.area))
     
```


We use a Hierarchical Bayesian Hurdle model to estimate the effect of species distribution on fish landings. We estimate a separate model for the two species in consideration. We use a Bayesian framework for several reasons. First, it allows us to consider uncertainty from modeling the process and its imperfect observation, assuming that all parameters are random variables. Second, Bayesian modeling allows the incorporation of multilevel effects (i.e., hierarchical effects). Finally, we can incorporate previous knowledge as a prior. For instance, we can include a prior for the effect of SDM's on Pacific sardine landings using the results obtained in @smith2021potential. Our Bayesian framework incorporates a hurdle model to model the zeros included in our landing data. We observe a zero when no landings occur in a specific period (we transformed landings observations with "N/A" to zero). We assume that these zeros mean no incentives for the fleet/vessel to harvest the related species during a month.  In general, our Bayesian hurdle models have the following structure:
$$
[\theta_i | q_{it}] \varpropto f\left(q_{it} | \theta_i\right) \times [\theta_i]
$$
where $q_{it}$ is the observed landings of the corresponding species in port $i \in (1,\ldots,L)$ at year $t$, $L$ is the total number of port, and $\theta_i$ are the parameters (i.e., random-coefficients) to be estimated at the port level. The latter gives the name of hierarchical to our model.^[For more details about Hierarchical models, see \cite{hobbs2015}.] 
The distribution $f\left(q_{it} | \theta_i\right)$ can be rewritten as:
$$ f\left(q_{it} | \theta_i \right) = 
\begin{cases} p_{it} & \text{if} \quad q_{it} = 0  \\
\left[1-p_{it}\right] \text{gamma} \left(q_{it} | \frac{\mu_{it}^2}{\sigma^2}, \frac{\mu_{it}}{\sigma^2} \right) & \text{if} \quad q_{it} > 0. \end{cases} $$
where $\text{logit}(p_{it}) = \bf{X}\gamma_i$ and $\mu_{it} = \bf{X}\beta_i$. Specifically $\mu_{it}$ is defined as the following: 
\begin{equation}
\mu_{it} = \beta_{0,i} + \beta_{1,i} P(Precense.PSDN)_{it} + \beta_{2,i} + P(Precense.MSQD)_{it}.
\end{equation}
$\text{logit}(p_{it})$ follows the same structure, but coefficient $\beta_i$ are replaced by $\gamma_i$. 


```{r calculate-price, include=FALSE}

# Calculate year price for N/A's using PacFIN port code, port area code, state and year/month.

## Pacific sardine
  
### (a) Using port name
price.port.name.PSDN <- aggregate(x=dataset$PSDN_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_NAME), FUN = mean, na.rm=T)
  price.port.name.PSDN <- price.port.name.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_NAME = Group.3) %>%
    dplyr::rename(PSDN.price.port.name = x)
    price.port.name.PSDN[price.port.name.PSDN == "NaN"] <- NA
    dataset <- dataset %>% 
      merge(price.port.name.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_NAME"), all.x = TRUE) %>%
      mutate(PSDN_AFI_PRICE_PER_KG.mean = ifelse(is.na(PSDN_AFI_PRICE_PER_KG.mean), 
        PSDN.price.port.name, PSDN_AFI_PRICE_PER_KG.mean))
        rm(price.port.name.PSDN)
    
### (b) Using PacFIN port code
price.port.code.PSDN <- aggregate(x=dataset$PSDN_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PACFIN_PORT_CODE), FUN = mean, na.rm=T)
  price.port.code.PSDN <- price.port.code.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PACFIN_PORT_CODE = Group.3) %>%
    dplyr::rename(PSDN.price.port.code = x)
    price.port.code.PSDN[price.port.code.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.port.code.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "PACFIN_PORT_CODE"), all.x = TRUE) %>% 
      mutate(PSDN_AFI_PRICE_PER_KG.mean = ifelse(is.na(PSDN_AFI_PRICE_PER_KG.mean), 
        PSDN.price.port.code, PSDN_AFI_PRICE_PER_KG.mean))
        rm(price.port.code.PSDN)
    
### (c) Using port area code
price.port.area.PSDN <- aggregate(x=dataset$PSDN_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_AREA_CODE), FUN = mean, na.rm=T)
  price.port.area.PSDN <- price.port.area.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_AREA_CODE = Group.3) %>%
    dplyr::rename(PSDN.price.port.area = x)
    price.port.area.PSDN[price.port.area.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.port.area.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_AREA_CODE"), all.x = TRUE) %>% 
      mutate(PSDN_AFI_PRICE_PER_KG.mean = ifelse(is.na(PSDN_AFI_PRICE_PER_KG.mean), 
        PSDN.price.port.area, PSDN_AFI_PRICE_PER_KG.mean))
        rm(price.port.area.PSDN)
        
### (d) Using state
price.state.PSDN <- aggregate(x=dataset$PSDN_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$AGENCY_CODE), FUN = mean, na.rm=T)
  price.state.PSDN <- price.state.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(AGENCY_CODE = Group.3) %>%
    dplyr::rename(PSDN.price.state = x)
    price.state.PSDN[price.state.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.state.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH", "AGENCY_CODE"), all.x = TRUE) %>% 
      mutate(PSDN_AFI_PRICE_PER_KG.mean = ifelse(is.na(PSDN_AFI_PRICE_PER_KG.mean), 
        PSDN.price.state, PSDN_AFI_PRICE_PER_KG.mean))
        rm(price.state.PSDN)
        
### (e) Using year/month
price.year.PSDN <- aggregate(x=dataset$PSDN_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH), FUN = mean, na.rm=T)
  price.year.PSDN <- price.year.PSDN %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PSDN.price.year.month = x)
    price.year.PSDN[price.year.PSDN == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.year.PSDN, by = c("LANDING_YEAR", "LANDING_MONTH"), all.x = TRUE) %>% 
      mutate(PSDN_AFI_PRICE_PER_KG.mean = ifelse(is.na(PSDN_AFI_PRICE_PER_KG.mean), 
        PSDN.price.year.month, PSDN_AFI_PRICE_PER_KG.mean))
        rm(price.year.PSDN)
    
dataset = subset(dataset, select = 
                   -c(PSDN.price.port.name, PSDN.price.port.code, 
                      PSDN.price.port.area, PSDN.price.state, PSDN.price.year.month))


## Market squid
  
### (a) Using port name
price.port.name.MSQD <- aggregate(x=dataset$MSQD_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_NAME), FUN = mean, na.rm=T)
  price.port.name.MSQD <- price.port.name.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_NAME = Group.3) %>%
    dplyr::rename(MSQD.price.port.name = x)
    price.port.name.MSQD[price.port.name.MSQD == "NaN"] <- NA
    dataset <- dataset %>% 
      merge(price.port.name.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_NAME"), all.x = TRUE) %>%
      mutate(MSQD_AFI_PRICE_PER_KG.mean = ifelse(is.na(MSQD_AFI_PRICE_PER_KG.mean), 
        MSQD.price.port.name, MSQD_AFI_PRICE_PER_KG.mean))
        rm(price.port.name.MSQD)
    
### (b) Using PacFIN port code
price.port.code.MSQD <- aggregate(x=dataset$MSQD_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PACFIN_PORT_CODE), FUN = mean, na.rm=T)
  price.port.code.MSQD <- price.port.code.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PACFIN_PORT_CODE = Group.3) %>%
    dplyr::rename(MSQD.price.port.code = x)
    price.port.code.MSQD[price.port.code.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.port.code.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "PACFIN_PORT_CODE"), all.x = TRUE) %>% 
      mutate(MSQD_AFI_PRICE_PER_KG.mean = ifelse(is.na(MSQD_AFI_PRICE_PER_KG.mean), 
        MSQD.price.port.code, MSQD_AFI_PRICE_PER_KG.mean))
        rm(price.port.code.MSQD)
    
### (c) Using port area code
price.port.area.MSQD <- aggregate(x=dataset$MSQD_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$PORT_AREA_CODE), FUN = mean, na.rm=T)
  price.port.area.MSQD <- price.port.area.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(PORT_AREA_CODE = Group.3) %>%
    dplyr::rename(MSQD.price.port.area = x)
    price.port.area.MSQD[price.port.area.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.port.area.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "PORT_AREA_CODE"), all.x = TRUE) %>% 
      mutate(MSQD_AFI_PRICE_PER_KG.mean = ifelse(is.na(MSQD_AFI_PRICE_PER_KG.mean), 
        MSQD.price.port.area, MSQD_AFI_PRICE_PER_KG.mean))
        rm(price.port.area.MSQD)
        
### (d) Using state
price.state.MSQD <- aggregate(x=dataset$MSQD_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH, dataset$AGENCY_CODE), FUN = mean, na.rm=T)
  price.state.MSQD <- price.state.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(AGENCY_CODE = Group.3) %>%
    dplyr::rename(MSQD.price.state = x)
    price.state.MSQD[price.state.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.state.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH", "AGENCY_CODE"), all.x = TRUE) %>% 
      mutate(MSQD_AFI_PRICE_PER_KG.mean = ifelse(is.na(MSQD_AFI_PRICE_PER_KG.mean), 
        MSQD.price.state, MSQD_AFI_PRICE_PER_KG.mean))
        rm(price.state.MSQD)
        
### (e) Using year/month
price.year.MSQD <- aggregate(x=dataset$MSQD_AFI_PRICE_PER_KG.mean, by = list(dataset$LANDING_YEAR, 
  dataset$LANDING_MONTH), FUN = mean, na.rm=T)
  price.year.MSQD <- price.year.MSQD %>% dplyr::rename(LANDING_YEAR = Group.1) %>%
    dplyr::rename(LANDING_MONTH = Group.2) %>% dplyr::rename(MSQD.price.year.month = x)
    price.year.MSQD[price.year.MSQD == "NaN"] <- NA
    dataset <- dataset %>%
      merge(price.year.MSQD, by = c("LANDING_YEAR", "LANDING_MONTH"), all.x = TRUE) %>% 
      mutate(MSQD_AFI_PRICE_PER_KG.mean = ifelse(is.na(MSQD_AFI_PRICE_PER_KG.mean), 
        MSQD.price.year.month, MSQD_AFI_PRICE_PER_KG.mean))
        rm(price.year.MSQD)
    
dataset = subset(dataset, select = 
                   -c(MSQD.price.port.name, MSQD.price.port.code, 
                      MSQD.price.port.area, MSQD.price.state, MSQD.price.year.month))

```

Besides the biological stock, landings are affected by economic conditions. Some of them are harvest cost, prices received by species and their substitutes, and regulations imposed by the authorities. Our dataset includes <!-- average distances traveled by vessel from the port of origin *(TO BE INCLUDED USING GLOBAL FISHING WATCH)* and fuel cost *(TO BE INCLUDED...)* as proxies of harvest cost. We also include  --> the average species' price that a vessel receives in a port during a month, obtained from the PacFIN landings dataset. When prices were missing, we replaced this value with the average species' price in the port for all vessels in the corresponding year. If we still have missing values, we use the average price during the month at the port code, then at the port area, then at the state, and then considering the whole U.S. west coast (excluding Alaska). <!-- We should also include weather variables. Bad weather should reduce fishers' decision to go to sea. Ir becomes risky, but also this is compared to revenue and how risk-averse is a fisher (see Lisa's work): "Weather and tides are major factors in fishing operations and timing of vessels transiting in and out of the Columbia River." SAFE --> We include the Annual Catch Limit (ACL) for the Pacific sardine model as an additional explanatory variable in both $\mu_i$ and $\text{logit}(p_i)$ equations. ACL variable is the total quota allocated each year for this fishery. We obtained this information from the CPS Fisheries Management Plan [@CPSFMP2021] and the Stock Assessment and Fishery Evaluation for 2019 document [@SAFE2020].  We restrict our data set to the period when the fishery was open (2000-2015) for this species. <!-- ISAAC's comments: Is this the ACL or the remaining part of the ACL (accounting for the previous catch). R: In the annual case does not matter, but in a monthly model, I should consider this. --> In the case of market squid, our database comprises the period between 2000 and 2018. We do not include ACL as an explanatory variable as this variable has no variation between years. To capture any change in fishers' behavior when the Pacific sardine fishery is closed, we include a binary variable called **dClose** that takes the value "1" when the Pacific sardine fishery is closed and takes the value "0" when the Pacific sardine fishery is open. Concerning the Pacific sardine probability of presence, this variable takes the value of zero when the fishery is closed. Thus, the effect of this variable is only relevant to capture potential substitution between targets when the Pacific sardine fishery is open. We show a summary statistics of our data set in Table \ref{tab:sum_stats}.

```{r desc, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

# Rename Price and landing variables #
dataset <- dataset %>% 
  dplyr::rename(PSDN_Price = PSDN_AFI_PRICE_PER_KG.mean) %>%
  dplyr::rename(MSQD_Price = MSQD_AFI_PRICE_PER_KG.mean) %>%
  dplyr::rename(PSDN_Landings = PSDN_LANDED_WEIGHT_MTONS.sum) %>%
  dplyr::rename(MSQD_Landings = MSQD_LANDED_WEIGHT_MTONS.sum)

# Label dataset
sjlabelled::set_label(dataset$MSQD_SDM_90)   <- "Prob(presence): MSQD"
sjlabelled::set_label(dataset$PSDN_SDM_60)   <- "Prob(presence): PSDN"
sjlabelled::set_label(dataset$LANDING_YEAR)  <- "Year"
sjlabelled::set_label(dataset$LANDING_MONTH)    <- "Month"
sjlabelled::set_label(dataset$PACFIN_PORT_CODE) <- "Port code"
sjlabelled::set_label(dataset$PORT_AREA_CODE)   <- "Port area code"
sjlabelled::set_label(dataset$PORT_NAME)        <- "Port name"
sjlabelled::set_label(dataset$AGENCY_CODE)      <- "State"
sjlabelled::set_label(dataset$VESSEL_NUM)       <- "Vessel ID"
sjlabelled::set_label(dataset$MSQD_Landings) <- "Landings: MSQD"
sjlabelled::set_label(dataset$MSQD_Price)    <- "Price: MSQD"
sjlabelled::set_label(dataset$PSDN_Landings) <- "Landings: PSDN"
sjlabelled::set_label(dataset$PSDN_Price)    <- "Price: PSDN"
sjlabelled::set_label(dataset$ACL_PSDN)      <- "Annual Catch Limit: PSDN"
sjlabelled::set_label(dataset$PORT_ID)       <- "Port ID"

desc_data <- dataset %>%
  subset(select = -c(PORT_ID, LANDING_YEAR, LANDING_MONTH, VESSEL_NUM, 
                     AGENCY_CODE, PACFIN_PORT_CODE, PORT_AREA_CODE, PORT_NAME))

sjlabelled::set_label(desc_data$MSQD_SDM_90)   <- "Prob(presence): MSQD"
sjlabelled::set_label(desc_data$PSDN_SDM_60)   <- "Prob(presence): PSDN"
sjlabelled::set_label(desc_data$MSQD_Landings) <- "Landings: MSQD"
sjlabelled::set_label(desc_data$MSQD_Price)    <- "Price: MSQD"
sjlabelled::set_label(desc_data$PSDN_Landings) <- "Landings: PSDN"
sjlabelled::set_label(desc_data$PSDN_Price)    <- "Price: PSDN"
sjlabelled::set_label(desc_data$ACL_PSDN)      <- "Annual Catch Limit: PSDN"


# Exclude port without MSQD and PSDN landings (they have to have both)
Tot.landings.ports.PSDN <- as.data.frame(cbind(
  rowsum(dataset$PSDN_Landings, dataset$PORT_NAME, na.rm = TRUE)))
  Tot.landings.ports.PSDN <- Tot.landings.ports.PSDN %>% mutate(dTotalPSDN = ifelse(V1>0, 1, 0)) %>% 
    mutate(PORT_NAME = rownames(Tot.landings.ports.PSDN)) %>%  dplyr::select(PORT_NAME, dTotalPSDN)

Tot.landings.ports.MSQD <- as.data.frame(cbind(
  rowsum(dataset$MSQD_Landings, dataset$PORT_NAME, na.rm = TRUE)))
  Tot.landings.ports.MSQD <- Tot.landings.ports.MSQD %>% mutate(dTotalMSQD = ifelse(V1>0, 1, 0)) %>% 
    mutate(PORT_NAME = rownames(Tot.landings.ports.MSQD)) %>%  dplyr::select(PORT_NAME, dTotalMSQD)

Tot.landings.ports <- Tot.landings.ports.PSDN %>% 
  merge(Tot.landings.ports.MSQD, by = c("PORT_NAME")) %>% 
   mutate(nSpecies = dTotalPSDN + dTotalMSQD)

rm(Tot.landings.ports.PSDN, Tot.landings.ports.MSQD)
  

# Select ports that at least they have landing PSDN once, and drop N/A #
## Select data for estimation, replace N/A landings to zero #
### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###

dataset <- dataset %>% 
  merge(Tot.landings.ports, by = "PORT_NAME", all.x = TRUE, all.y = FALSE) %>% 
  filter(nSpecies==2) 

# Compute descriptive statistics #

desc_data <- desc_data[c("PSDN_SDM_60", "MSQD_SDM_90", "PSDN_Landings", "MSQD_Landings",
                         "PSDN_Price", "MSQD_Price", "ACL_PSDN")]
                                 
vtable::st(desc_data, labels = TRUE, title='Summary Statistics \\label{tab:sum_stats}', out='latex')
rm(desc_data)

```

<!-- #################################### -->
<!-- ### CREATE DATASET AND RUN MODEL ### -->
<!-- #################################### -->

```{r dataset_psdn, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

## Select data for estimation, replace N/A landings to zero #
### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###

dataset_psdn <- dataset %>% 
  dplyr::select(PSDN_SDM_60, PSDN_Landings, PSDN_Price, ACL_PSDN, MSQD_SDM_90,
                PORT_ID, PACFIN_PORT_CODE, PORT_AREA_CODE, LANDING_YEAR, LANDING_MONTH) %>% 
  filter(LANDING_YEAR >= 2000 & LANDING_YEAR < 2015) %>% 
  dplyr::mutate(PSDN_Landings = coalesce(PSDN_Landings, 0)) %>% 
  drop_na() ## Just 2 observations are dropped

# Create matrices and vectors to run STAN model #
# year_id <- as.vector(cbind(as.numeric(factor(dataset_psdn$LANDING_YEAR))))
dataset_psdn$port_ID <- as.factor(
  udpipe::unique_identifier(dataset_psdn, fields = "PORT_ID", start_from = 1))
  dataset_psdn_port_names <- dataset_psdn %>% dplyr::select(PORT_AREA_CODE, port_ID) %>% unique()
  rm(year_id, dataset_psdn_port_names)
```

```{r psdn_estimation, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qPSDN <- brm(
  bf(PSDN_Landings ~ PSDN_SDM_60 + MSQD_SDM_90 + PSDN_Price + s(ACL_PSDN) 
                      + (1 + PSDN_SDM_60 + MSQD_SDM_90 + PSDN_Price | port_ID),
                hu ~ PSDN_SDM_60 + MSQD_SDM_90 + PSDN_Price + s(ACL_PSDN) 
                      + (1 + PSDN_SDM_60 + MSQD_SDM_90 + PSDN_Price | port_ID)),
                          data = dataset_psdn,
                          family = hurdle_gamma(), 
                          control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)

save.image (file = "stan_fit.RData")

```


```{r msqd_data, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
# Select data for estimation, replace N/A landings to zero #
est_data_msqd <- est_data %>%
  dplyr::select(port_num, Port, MSQD_SDM_90, MSQD_Landings, MSQD_Price, 
                  PSDN_SDM_60, NANC_SDM_20, Landing_year) %>%
  dplyr::mutate(MSQD_Landings = coalesce(MSQD_Landings, 0)) %>% 
  dplyr::mutate(dClose = ifelse(Landing_year >= 2015,1,0)) %>%
  dplyr::mutate(dOpen = ifelse(Landing_year < 2015,1,0)) %>%
  dplyr::mutate(PSDN_SDM_60_dOpen = PSDN_SDM_60 * dOpen) %>%
  filter(Landing_year >= 2000)

# Select ports that at least they have landing PSDN once, and drop N/A #
Tot.landings.ports <- as.data.frame(cbind(rowsum(est_data_msqd$MSQD_Landings, est_data_msqd$Port, na.rm = TRUE)))

Tot.landings.ports <- Tot.landings.ports %>%
  mutate(dTotalMSQD = ifelse(V1>0, 1, 0)) %>%
  mutate(Port = rownames(Tot.landings.ports)) %>%
  dplyr::select(Port, dTotalMSQD)

### NOTE: If I use drop_na, some ports without MSQD landings are excluded. ###
est_data_msqd <- est_data_msqd %>%
  merge(Tot.landings.ports, by.x = "Port", by.y = "Port", all.x = TRUE, all.y = FALSE) %>%
  filter(dTotalMSQD==1) %>%
  drop_na() 
  
# Create matrices and vectors to run STAN model #
year_id <- as.vector(cbind(as.numeric(factor(est_data_msqd$Landing_year))));
est_data_msqd$port_ID <- udpipe::unique_identifier(est_data_msqd, fields = "port_num", start_from = 1) 
portID_names_MSQD <- est_data_msqd %>%
  dplyr::select(Port, port_ID) %>%
  unique()

### Estimate using BRMS package ###
est_data_msqd$dClose    <- factor(est_data_msqd$dClose)
est_data_msqd$port_ID   <- factor(est_data_msqd$port_ID)
class(est_data_msqd$dClose)
class(est_data_msqd$port_ID)
class(est_data_msqd$dOpen)
```


```{r msqd_est_price, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
fit_qMSQD_price <- brm(bf(MSQD_Landings ~ MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose 
                      + (1 + MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose | port_ID),
                               hu ~ MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose 
                      + (1 + MSQD_SDM_90 + MSQD_Price + PSDN_SDM_60_dOpen + NANC_SDM_20 + dClose | port_ID)),
                       data = est_data_msqd,
                       family = hurdle_gamma(),
                       control = list(adapt_delta = 0.999, max_treedepth = 20),
                       chains = 4, cores = 4)
save.image (file = "stan_fit.RData")
```


<!-- ##  Multispecies participation model -->
<!-- For the multispecies participation model, we follow a similar methodology than @richerson2017. We estimate a discrete choice model for probability that a vessel participate in a particular species fishery during a specific month. This approach allows us to further understand how a closure or abrupt weather/abundance changes restructure fisher's portfolios.  -->

<!-- In the participation model, our outcome variable is a categorical variable that indicate whether a vessel participate in a specific fishery. It ranges from 0 to 4 where: 0 = "No fishing during the month", 1 = "Pacific sardine", 2 = "Market Squid", 3 = "Northern Anchovy", and 4 = "Other". **<<Can I combine Anchovy + sardine in category 5? What if in the same month a vessel harvest two different species. Should we maybe assume 1 for the principal species, zero to the second one?>>** **<< We can use the approach of metier, where a choice is created from data (see Andersen, 2012, ICES). Here would be a combination of target species>>** **<<Other option is to estimate separately a binary model>>** To select vessels in or database, they should met the following criteria: -->

<!--   1. Vessel active at least **XX%** of the sample.  -->
<!--   2. Total revenue at least **XX%** of CPS fishery. -->
<!--   3. Total annual revenue average for two or more species listed of at least **XXX**. -->

<!-- We expect that using monthly **<<Should I use Yearly data???>>** data allows us to observe seasonality in fishers´ behavior and to reduce the risk to not loosing general behavior when we dissagregate data in a finer scale. -->

<!-- According @richerson2017, fishers participation decision should depend, in general terms, on profitability, species distribution and regulations. Specifically, based on different studies [@richerson2017] (MORE REF), variables that can explain fishery participation on a particular fishery in a month are: -->

<!-- <!-- see if these are relevant:  --> 
<!-- <!-- Holland D. S.. A bioeconomic model of marine sanctuaries on Georges Bank, Canadian Journal of Fisheries and Aquatic Sciences, 2000, vol. 57 (pg. 1307-1319) --> 

<!-- <!-- Holland D. S.,  Herrera G. E.. Flexible catch-balancing policies for multispecies individual fishery quotas, Canadian Journal of Fisheries and Aquatic Sciences, 2006, vol. 63 (pg. 1669-1685)10.1139/f06-066 --> 

<!-- <!-- Toft J. E.,  Punt A. E.,  Little L. R.. Modelling the economic and ecological impacts of the transition to individual transferable quotas in the multispecies US west coast groundfish trawl fleet, ICES Journal of Marine Science, 2011, vol. 68 (pg. 1566-1579)10.1093/icesjms/fsr095 -->

<!-- * Previous revenues -->
<!-- * Expected catch:  -->
<!--     + We calculate expected revenue as a function of average outputs of the SDMs. Using SDM outputs instead of catch to compute expected revenues allow us to project fishers decision on time using SDM's projections. Moreover, using catch to compute expected revenue as a regress in a discrete choice model could incorporate endogeneity as it can be correlated with unobservables not captured by the choice constant.  -->
<!-- * Closure: Whether or not the Pacific sardine fishery was closed. -->
<!-- * Diversification using HHI (measurement of diversification, from @richerson2017) -->
<!-- * Dependence on the species in consideration (historical % of the revenue from the species considered) -->
<!-- * Typical landings location: Latitudinal center of gravity (LCG) index from [@richerson2017] -->
<!-- * Dispersion around centre of gravity: Latitude inertia (LI) index from [@richerson2017] -->
<!-- * Years in the sample that the vessel have participate in the fishery. -->

<!-- We model the probability $p_{ijm}$ that vessel $i$ fishes species $j$ in month $y$ as: -->
<!-- \begin{align*} -->
<!-- \text{logit}(p_{ijy}) = & \beta_1 + \beta_2  Closure + \beta_3 Mean.revenue_j + \beta_4 ExpectedCatch_j \\ -->
<!-- & + \beta_5 HHI_i + \beta_6 Percent.revenue_j + \beta_7 LCG_i + \beta_8 LI_i + \beta_9 Year.fished.  -->
<!-- \end{align*} -->
<!-- Note that we are not able to observe if a vessel leave the CPS fishery for another resource or actually exit fishing entirely. Therefore, the outside option include is interpreted as "No fishing in any of the CPS fishery". -->

<!-- Should we study also the desicion to leave or stay the CPS fishery? I think in implicit in the participation model. Can we test this using the prediction from that model? -->

<!-- <!-- We can extend our analysis and infer cases in which a vessel do not longer participate in the fish industry after a the closure. For this, we can use Global Fishing Watch and observe whether a vessel that stop harvesting CPS species still actively fishing other species.  --> 

<!-- <!-- Soould I include expected catch???  (Peña et al have some ideas how to use expected catch and cost. It could be the month average...) --> 





<!-- First, we observe how many vessel participate in both the Pacific sardine and market squid fishery. To do this, we first have to define what we understand as participation. Following @richerson2017, we consider a vessel participate in a specific fishery if they met the following criteria: -->

<!-- 1. Harvest the species during the period 2000-2014 (before the Pacific sardine closure)  -->
<!-- 2. Total annual revenue from the species averaged at least 1000 USD per year over 2000–2014. This calculation exclude years where the vessel did not fish. -->
<!-- 3. Revenue from the species at least 5% of total vessel revenue per year over 2000–2014. -->
<!-- 4. The vessel fished at least 3 of 15 years in 2000–2014. -->


<!-- ```{r only_psdn, include=FALSE} -->
<!-- ### Vessel that participate in Pacific sardine ### -->
<!-- total.revenue <- PacFIN.month %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%  -->
<!--   group_by(VESSEL_NUM, LANDING_YEAR) %>% summarise(year_revenue = sum(AFI_EXVESSEL_REVENUE.sum))  -->

<!-- psdn.fleet <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%  -->
<!--   filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>%  -->
<!--   group_by(VESSEL_NUM, LANDING_YEAR) %>% summarise(revenue_psdn = sum(AFI_EXVESSEL_REVENUE.sum)) %>% -->
<!--     merge(total.revenue, by = c("VESSEL_NUM", "LANDING_YEAR"), all.x = TRUE) %>%  -->
<!--   filter(revenue_psdn > 0) %>% group_by(VESSEL_NUM) %>%  -->
<!--   summarise(anual_revenue_psdn = mean(revenue_psdn), anual_revenue_all = mean(year_revenue), n_year_fishing = n()) %>%   -->
<!--   mutate(perc_psdn_rev = anual_revenue_psdn/anual_revenue_all) %>%  -->
<!--   filter(anual_revenue_psdn >= 1000) %>%  -->
<!--   filter(perc_psdn_rev >= 0.05) %>%  -->
<!--   filter(n_year_fishing >= 3) %>% -->
<!--   select(VESSEL_NUM) %>% unique() %>% mutate(d_PSDN_fleet = 1) -->


<!-- ### Vessel that participate in Pacific sardine ### -->
<!-- msqd.fleet <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%  -->
<!--   filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>%  -->
<!--   group_by(VESSEL_NUM, LANDING_YEAR) %>% summarise(revenue_specie = sum(AFI_EXVESSEL_REVENUE.sum)) %>% -->
<!--     merge(total.revenue, by = c("VESSEL_NUM", "LANDING_YEAR"), all.x = TRUE) %>%  -->
<!--   filter(revenue_specie > 0) %>% group_by(VESSEL_NUM) %>%  -->
<!--   summarise(anual_revenue_specie = mean(revenue_specie), anual_revenue_all = mean(year_revenue), n_year_fishing = n()) %>%   -->
<!--   mutate(perc_specie_rev = anual_revenue_specie/anual_revenue_all) %>%  -->
<!--   filter(anual_revenue_specie >= 1000) %>%  -->
<!--   filter(perc_specie_rev >= 0.05) %>%  -->
<!--   filter(n_year_fishing >= 3) %>% -->
<!--   select(VESSEL_NUM) %>% unique() %>% mutate(d_MSQD_fleet = 1) -->


<!-- # Which are the vessel that harvest both PSDN and MSQD? -->
<!-- squid.and.psdn <- merge(psdn.fleet, msqd.fleet, by = c("VESSEL_NUM"), all.y = FALSE, all.x = FALSE) %>% -->
<!--   select(VESSEL_NUM) %>% unique() %>%  mutate(d_PSDN_and_MSQD = 1) -->

<!-- # Which are the vessel that harvest only MSQD? -->
<!-- only.msqd <- msqd.fleet %>% merge(squid.and.psdn, by = c("VESSEL_NUM"), all.x = TRUE) %>%  -->
<!--   filter(is.na(d_PSDN_and_MSQD)) %>% select(VESSEL_NUM) %>% unique() %>% mutate(d_onlyMSQD = 1) -->

<!-- # Which are the vessel that harvest only PSDN? -->
<!-- only.psdn <- psdn.fleet %>% merge(squid.and.psdn, by = c("VESSEL_NUM"), all.x = TRUE) %>%  -->
<!--   filter(is.na(d_PSDN_and_MSQD)) %>% select(VESSEL_NUM) %>% unique() %>% mutate(d_onlyPSDN = 1) -->

<!-- rm(total.revenue) -->

<!-- ``` -->

<!-- From 2000 to 2014, there are 74 vessels that participate in both Pacific sardine and market squid fisheries, while 26 vessel participate in the Pacific sardine but not in the market squid fishery, and  82 vessels participate in the market squid fishery but not in the Pacific sardine fishery. From this calculation, we can infer that it is more likely that a vessel that harvest Pacific sardine will also harvest market squid, instead of the opposite. This is also reflected in Figure \ref{fig:switching}, which shows the number of vessel that harvest squid in a year conditional they also harvest sardine, and the number of vessel that harvest sardine in a year conditional that they also harvest squid.  -->

<!-- ```{r switching_graph, eval=FALSE, fig.cap="Switching", message=FALSE, warning=FALSE, include=FALSE} -->
<!-- psdn.by.year <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%  -->
<!--   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR) %>% filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>%  -->
<!--   unique() %>% mutate(harv.psdn = 1) -->
<!-- msqd.by.year <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%  -->
<!--   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR) %>% filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>%  -->
<!--   unique() %>% mutate(harv.msqd = 1) -->

<!-- # If a vessel harvest Pacific sardine in a year, how many also harvest squid. -->
<!-- squid.cond.psdn <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%  -->
<!--   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR) %>% merge(psdn.by.year,  -->
<!--                         by = c("VESSEL_NUM", "LANDING_YEAR"), all.y = TRUE) %>%  -->
<!--   filter(harv.psdn == 1) %>% filter(PACFIN_SPECIES_CODE.x == "MSQD") %>% unique() -->

<!-- # Calculate number of vessels harvesting sardine and squid and percentage per year -->
<!-- n_vessel_psdn <- psdn.by.year %>% group_by(LANDING_YEAR) %>% summarize(n_vessel_psdn = sum(harv.psdn)) -->
<!-- n_vessel_msqd_c_psdn <- squid.cond.psdn %>% group_by(LANDING_YEAR) %>% summarize(n_vessel_msqd = sum(harv.psdn)) -->
<!--   df <- n_vessel_msqd_c_psdn %>% mutate(perc = n_vessel_psdn$n_vessel_psdn) %>% -->
<!--     mutate(n_vessel_only_psdn = perc) %>%  # - n_vessel_msqd -->
<!--     mutate(perc = (n_vessel_msqd / perc))  -->

<!-- coeff = 115 -->
<!-- g1 <- ggplot(df) +  -->
<!--   geom_line(mapping = aes(x = LANDING_YEAR, y = n_vessel_only_psdn, -->
<!--                           color = "# of vessels landing sardine"), size = 1) + -->
<!--   geom_line(mapping = aes(x = LANDING_YEAR, y = n_vessel_msqd, -->
<!--                           color = "# of vessels landing squid (c/ landing sardine)"), size = 1) + -->
<!--   geom_line(mapping = aes(x = LANDING_YEAR, y = perc*coeff,  -->
<!--                           color = "% of vessels landing squid (c/ landings sardine)"), -->
<!--             size = 1, linetype = "dashed") + scale_x_continuous(name = "Year") + -->
<!--   scale_y_continuous(name = "Number of vessels",  -->
<!--                      sec.axis = sec_axis(~./coeff, name = "% vessels harvesting squid" )) + -->
<!--   theme(axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +  scale_color_manual(name = "Variables: ",  -->
<!--                      values = c("# of vessels landing sardine" = "green",  -->
<!--                                 "# of vessels landing squid (c/ landing sardine)" = "blue", -->
<!--                                "% of vessels landing squid (c/ landings sardine)" = "grey")) +  -->
<!--   theme(legend.position="right") -->

<!--   rm(psdn.by.year, squid.cond.psdn, n_vessel_psdn, n_vessel_msqd_c_psdn, df, coeff) -->

<!-- msqd.by.year <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2020) %>%  -->
<!--   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR) %>% filter(PACFIN_SPECIES_CODE  %in% c("MSQD")) %>%  -->
<!--   unique() %>% mutate(harv.msqd = 1) -->

<!-- # If a vessel harvest Pacific sardine in a year, how many also harvest squid. -->
<!-- psdn.cond.msqd <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2020) %>%  -->
<!--   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR) %>% merge(msqd.by.year,  -->
<!--                         by = c("VESSEL_NUM", "LANDING_YEAR"), all.y = TRUE) %>%  -->
<!--   filter(harv.msqd == 1) %>% filter(PACFIN_SPECIES_CODE.x == "PSDN") %>% unique() -->

<!-- # Calculate number of vessels harvesting sardine and squid and percentage per year -->
<!-- n_vessel_msqd <- msqd.by.year %>% group_by(LANDING_YEAR) %>% summarize(n_vessel_msqd = sum(harv.msqd)) -->
<!-- n_vessel_psdn_c_msqd <- psdn.cond.msqd %>% group_by(LANDING_YEAR) %>% summarize(n_vessel_psdn = sum(harv.msqd)) -->
<!--   df <- n_vessel_psdn_c_msqd %>%  mutate(n_vessel_msqd = n_vessel_msqd$n_vessel_msqd) %>% -->
<!--     mutate(perc = n_vessel_psdn / n_vessel_msqd)  -->

<!-- coeff = 200 -->
<!-- g2 <- ggplot(df) +  -->
<!--   geom_line(mapping = aes(x = LANDING_YEAR, y = n_vessel_msqd, -->
<!--                           color = "# of vessels landing squid"), size = 1) + -->
<!--   geom_line(mapping = aes(x = LANDING_YEAR, y = n_vessel_psdn, -->
<!--                           color = "# of vessels landing sardine (c/ landing squid)"), size = 1) + -->
<!--   geom_line(mapping = aes(x = LANDING_YEAR, y = perc*coeff,  -->
<!--                           color = "% of vessels landing sardine (c/ landings squid)"), -->
<!--             size = 1, linetype = "dashed") + scale_x_continuous(name = "Year") + -->
<!--   scale_y_continuous(name = "Number of vessels",  -->
<!--                      sec.axis = sec_axis(~./coeff, name = "% vessels harvesting squid" )) + -->
<!--   theme(axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +  scale_color_manual(name = "Variables: ",  -->
<!--                      values = c("# of vessels landing squid" = "green",  -->
<!--                                 "# of vessels landing sardine (c/ landing squid)" = "blue", -->
<!--                                "% of vessels landing sardine (c/ landings squid)" = "grey")) +  -->
<!--   theme(legend.position="right") -->

<!-- g1 / g2 -->

<!-- rm(msqd.by.year, psdn.cond.msqd, n_vessel_msqd, n_vessel_psdn_c_msqd, df, coeff, g1, g2) -->

<!-- ``` -->

<!-- ```{r switching_month, eval=FALSE, include=FALSE} -->
<!-- psdn.by.month <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%  -->
<!--   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR, LANDING_MONTH) %>% filter(PACFIN_SPECIES_CODE  %in% c("PSDN")) %>%  -->
<!--   unique() %>% mutate(harv.psdn = 1)  -->

<!-- # If a vessel harvest Pacific sardine in a year, how many also harvest squid. -->
<!-- squid.cond.psdn <- PacFIN.month.CPS %>% filter(LANDING_YEAR >= 2000) %>% filter(LANDING_YEAR <= 2014) %>%  -->
<!--   select(VESSEL_NUM, PACFIN_SPECIES_CODE, LANDING_YEAR, LANDING_MONTH) %>% merge(psdn.by.month,  -->
<!--                         by = c("VESSEL_NUM", "LANDING_YEAR", "LANDING_MONTH"), all.y = TRUE) %>%  -->
<!--   filter(harv.psdn == 1) %>% filter(PACFIN_SPECIES_CODE.x == "MSQD") %>% unique() -->

<!-- # Calculate number of vessels harvesting sardine and squid and percentage per year -->
<!-- n_vessel_psdn <- psdn.by.month %>% group_by(LANDING_YEAR, LANDING_MONTH) %>%  -->
<!--   summarize(n_vessel_psdn = sum(harv.psdn, na.rm = TRUE))  -->

<!-- n_vessel_msqd_c_psdn <- squid.cond.psdn %>% group_by(LANDING_YEAR, LANDING_MONTH) %>%  -->
<!--   summarize(n_vessel_msqd = sum(harv.psdn, na.rm = TRUE)) -->

<!-- df <- merge(n_vessel_psdn, n_vessel_msqd_c_psdn, by=c("LANDING_YEAR", "LANDING_MONTH"), all.x = TRUE) %>% -->
<!--     mutate(n_vessel_msqd = if_else(is.na(n_vessel_msqd), 0, n_vessel_msqd)) %>% group_by(LANDING_MONTH) %>%  -->
<!--     summarize(n_vessel_msqd = sum(n_vessel_msqd, na.rm = TRUE), n_vessel_psdn = sum(n_vessel_psdn, na.rm = TRUE)) %>% -->
<!--     mutate(perc = (n_vessel_msqd / n_vessel_psdn)) %>% select(LANDING_MONTH, perc) -->

<!-- ggplot(data=df, aes(x=LANDING_MONTH, y=perc)) + -->
<!--     geom_bar(stat="identity", fill=rgb(0.1,0.4,0.5,0.7), width=0.4) +  -->
<!--   scale_x_continuous(name = "Month", breaks=1:12) + -->
<!--   scale_y_percent(name = "Percentage of vessels harvesting squid" ) -->

<!-- rm(psdn.by.month, squid.cond.psdn, n_vessel_psdn, n_vessel_msqd_c_psdn, df) -->


<!-- ``` -->

<!-- ## Effort susbsitution ##  -->

<!-- * Time series of number of trips (as a proxy for effort) for all the species -->
<!-- * @richerson2017 use a method identify the nature of the outliers in an ARMA time series model (read more if interested)  -->
<!--     + I propose to estimate a system of simultaneous equations (VECM model) to study equilibrium of effort and short-run and long-run effects of the closure (structural breaks) -->
<!--     + Have a long-run equation for each species (simultaneously estimated) and test for structural break in this long-run relationship. -->


<!-- ## Seasonality changes ## -->

<!-- * Seasonality can be studied calculating monthly share of total trips by species, regress it using month dummiues and see any is there any structural change after the closure [@richerson2017].  -->



<!-- <!-- Shall we study also effort as number of trips, and seasonality using time series --> 


# Results




## Landing model

<!-- # print summary -->
<!-- texreg(list(f2, f3, r2, r3), caption = 'Panel data models for Pacific Sardine landings.\\label{table:sardine_est}', caption.above = TRUE, float.pos = "h", custom.model.names = c("FE: Model 1", "FE: Model 2", "RE: Model 1", "RE: Model 2")) -->


<!-- # ##  Extract Grouo-Level estimates ## -->
<!-- # ranef(fit_qPSDN_gamma) -->
<!-- #  -->
<!-- # ## Check divergence and other model check ## -->
<!-- # shinystan::launch_shinystan(fit_qPSDN_gamma) -->

<!-- # Investigate chain and posterior distributions.  -->
<!-- # https://cran.r-project.org/web/packages/bayesplot/vignettes/graphical-ppcs.html -->
<!-- # plot(fit_qPSDN_t2nc, pars = c("PSDN_SDM")) -->

<!-- # ### Predictions ### -->
<!-- # pred_data <- data.frame(PSDN_SDM = c(0.5, 0.25), MSQD_SDM = c(0.5), Port_ID = 1) -->
<!-- # predict(fit_qPSDN, newdata = pred_data, re_formula = NA) -->

<!-- # ## Compare models ## -->
<!-- # loo(fit1, fit2) -->

<!-- ## Check https://www.pcouncil.org/stock-assessments-and-fishery-evaluation-safe-documents/ for ACL and closures. -->

### Graphical posterior predictive
Before presenting the results for the three species in consideration, we check graphically whether the posterior distribution is able to predict the actual distribution. We exclude zero in our graph to avoid plotting different data generation processes. In Figure \ref{fig:posteriors} we show a posterior sample compare with the true sample distribution for the three species in analysis. Some deviation from the true sample distribution is observed in the three models, but still the posterior sample follow a similar shape than the actual curve. Moreover, our pacific sardine sample do well in predicting probabilities at lower landing levels. 

```{r y_rep, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
g1 <- pp_check(fit_qPSDN_price) + ggtitle('(a) Pacific sardine') + 
  scale_color_manual(name = "", values = c("y" = "royalblue4", "yrep" = "azure3"),
                       labels = c("y" = "Observed", "yrep" = "Replicated")) +  
  theme(legend.position = "none", plot.title = element_text(size=9, face="bold.italic")) +  
  xlim(0.1, 15000) + ylab("Density")

g2 <- pp_check(fit_qMSQD_price) + ggtitle('(b) Market Squid') +
  scale_color_manual(name = "", values = c("y" = "royalblue4", "yrep" = "azure3"),
                       labels = c("y" = "Observed", "yrep" = "Replicated")) + 
  theme(legend.position = "none", plot.title = element_text(size=9, face="bold.italic"))  + 
  xlim(0.1, 15000) + xlab("Landing (tons)")

g3 <- pp_check(fit_qNANC_price) + ggtitle('(c) Northern Anchovy') + 
  scale_color_manual(name = "", values = c("y" = "royalblue4", "yrep" = "azure3"),
                       labels = c("y" = "Observed", "yrep" = "Replicated")) +
  theme(legend.position = "right", plot.title = element_text(size=9, face="bold.italic"))  +  
  xlim(0.1, 15000) 



g1 + g2 + g3
```

In addition to a posterior predictive check, we also check divergence and treedepth.^[Explain what are these concepts...] In all three models, we did not have any divergent step in our estimation. The maximum treedepth was 11 for the Pacific sardine model, while in the others it was 10.   

```{r shinystan, eval=FALSE, include=FALSE}
shinystan::launch_shinystan(fit_qPSDN_price) 
shinystan::launch_shinystan(fit_qMSQD_price) 
shinystan::launch_shinystan(fit_qNANC_price) 
```

```{r y_rep_zero, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
g1 <- pp_check(fit_qPSDN_price) + ggtitle('(a) Pacific sardine')  + theme(legend.position = "none") + xlim(0, 0.1) 
g2 <- pp_check(fit_qMSQD_price) + ggtitle('(b) Market Squid')     + theme(legend.position = "none") + xlim(0, 0.1) 
g3 <- pp_check(fit_qNANC_price) + ggtitle('(c) Northern anchovy') + theme(legend.position = "right", 
                                             plot.title = element_text(size=9, face="bold.italic")) + xlim(0, 0.1) 



g1 + g2 + g3
```


```{r model-comparision, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='asis'}
fit_qMSQD <- add_criterion(fit_qMSQD, "loo")
fit_qMSQD_90 <- add_criterion(fit_qMSQD_90, "loo")

comp <- loo_compare(loo(fit_qMSQD), loo(fit_qMSQD_90)) %>%
  as.data.frame() %>%
  select(elpd_loo, elpd_diff, se_diff, p_loo, looic) %>%
  dplyr::rename(
    "ELPD-Diff" = elpd_diff, "SE-Diff" = se_diff, 
    "ELPD-LOO" = elpd_loo, "P-LOO" = p_loo, "LOOIC" = looic
  )

mw1 <- model_weights(fit_qMSQD, fit_qMSQD_90, weights = "loo")[rownames(comp)]

comp %>%
  cbind("Akaike-Weight" = mw1) %>%
  apa_table(
    format = "latex", booktabs = TRUE, digits = 2,
    caption = "Comparison of models fit1 to fit3 based on approximate leave-one-out cross-validation. Market squid landigns model.",
    note =  "ELPD-LOO = expected log posterior predictive density (higher is better); ELPD-DIFF = difference in ELPD values compared to the best model. SE-DIFF = standard error of the ELPD difference. P-LOO = effective number of model parameters (lower is better); LOOIC: leave-one-out information criterion (lower is better); Akaike-Weight = Model weight based on the LOOIC values (higher is better).",
    align = c("l", rep("r", 6))
  )
```


### Own species distribution effect

The inclusion of hierarchical effects by port allows us to analyze the effects of the probability of presence on landings disaggregated by ports. We only focus our analysis in owns probability of presence effects, as other probability are analyzed as interaction (see next subsection). We can observe in Figure \ref{fig:sdmeffects} that the effects of the own probability of presence on landings are not strong (maybe I should use logs...). However, it is clear that it have a positive effect on landings, specially on port areas such as Columbia River at Oregon for Pacific sardine, and Monterrey for Northern anchovy, while a more moderate effect is observed at Santa Barbara Area for Northern anchovy.


```{r by_port_sdm, eval=FALSE, fig.cap=, include=FALSE}
# PSDN plots
conditions <- data.frame(port_ID = unique(est_data_psdn$port_ID))
  rownames(conditions) <- unique(est_data_psdn$Port)
conditions_psdn <- conditions %>% 
  rownames_to_column('port_name') %>%
  filter(port_ID == 1 | port_ID == 2 | port_ID == 3) %>%
  column_to_rownames('port_name')

c_eff_psdn <- (conditional_effects
               (fit_qPSDN_price, "PSDN_SDM_60", surface=TRUE, conditions = conditions_psdn, re_formula = NULL))
               #, transform = log, method = "posterior_predict"))
g1 <- plot(c_eff_psdn, plot = FALSE, nrow = 3, ncol = 1)[[1]] + ggtitle('(a) Pacific sardine')+ 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_continuous(name = element_blank()) +
  scale_y_continuous(name = "Landings (tons)")

# MSQD plots
conditions2 <- data.frame(port_ID = unique(est_data_msqd$port_ID))
  rownames(conditions2) <- unique(est_data_msqd$Port)
conditions_msqd <- conditions2 %>% 
  rownames_to_column('port_name') %>%
  filter(port_ID == 4  | port_ID == 5  | port_ID == 8) %>%
  column_to_rownames('port_name')
c_eff_msqd <- (conditional_effects
               (fit_qMSQD_price, "MSQD_SDM_90", surface=TRUE, conditions = conditions_msqd, re_formula = NULL))
               #, transform = log, method = "posterior_predict"))
g2 <- plot(c_eff_msqd, plot = FALSE, nrow = 3, ncol = 1)[[1]] + ggtitle('(b) Market squid') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_continuous(name = "Prob(Presence)") +
  scale_y_continuous(name = element_blank()) 

# NANC plots
conditions3 <- data.frame(port_ID = unique(est_data_nanc$port_ID))
  rownames(conditions3) <- unique(est_data_nanc$Port)
conditions_nanc <- conditions3 %>% 
  rownames_to_column('port_name') %>%
  filter(port_ID == 3  | port_ID == 4  | port_ID == 5) %>%
  column_to_rownames('port_name')
c_eff_nanc <- (conditional_effects
               (fit_qNANC_price, "NANC_SDM_20", surface=TRUE, conditions = conditions_nanc, re_formula = NULL))
               #, transform = log, method = "posterior_predict"))
g3 <- plot(c_eff_nanc, plot = FALSE, nrow = 3, ncol = 1)[[1]] + ggtitle('(c) Northern anchovy') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_continuous(name = element_blank()) +
  scale_y_continuous(name = element_blank()) 

# Merge plots
g1 + g2 + g3
```

<!-- @smith2021potential estimate with GAM framework (allows for non-linear relationships) -->


### Interaction effects

To study the effect of other species distribution on landings, we compute the conditional effects of the interaction between probabilities of presence. Let denote species A the species which we are analysing its landings, and species B and C the other species included in the model for species A landings. For each species, we compute the effect on landing of the interaction between the probability of presences of: 
  + Species A and species B, 
  + Species A versus species C,
  + Species B versus species C.
For example, for the Pacific sardine equation, we compute these results for the probability of presence effect between Pacific sardine and market squid, Pacific sardine and Northern anchovy, and market squid and Northern anchovy. 

```{r int_effect_PSDN_by_port, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
c_eff_int_psdn_msqd <- (conditional_effects(fit_qPSDN_price, "PSDN_SDM_60:MSQD_SDM_90", surface=TRUE, 
                                            conditions = conditions_psdn, re_formula = NULL))
c_eff_int_psdn_nanc <- (conditional_effects(fit_qPSDN_price, "PSDN_SDM_60:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_psdn, re_formula = NULL))
c_eff_int_msqd_nanc <- (conditional_effects(fit_qPSDN_price, "MSQD_SDM_90:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_psdn, re_formula = NULL))

g1_PSDN <-  plot(c_eff_int_psdn_msqd, plot = FALSE)[[1]] + ggtitle('(a) Pacific sardine x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) +
  scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): MSQD") 

g2_PSDN <-  plot(c_eff_int_psdn_nanc, plot = FALSE)[[1]] + ggtitle('(b) Pacific sardine x Northern anchovy') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): NANC") 

g3_PSDN <-  plot(c_eff_int_msqd_nanc, plot = FALSE)[[1]] + ggtitle('(c) Northern anchovy x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): MSQD") + scale_y_continuous(name = "P(Pres): NANC") 
save.image (file = "stan_fit.RData")
```

Let first analyze the interaction effect of the probability of presences on Pacific sardine landings, presented in Figure \ref{fig:sdm_int_psdn}. We only shows results for the main three port where Pacific sardine is landed (Columbia River at Oregon, Los Angeles Area  and Monterrey Area). As we already commented in Figure \ref{fig:sdmeffects}, the effects the Pacific sardine's own probability of presence is positive, changing color from left to right in panels (a) and (b). Market squid seems to be an stronger substitute for Pacific sardine than Northern anchovy. This is suggested by the different slopes between panel (a) and panel (b). For instane, in Columbia River, an increase in the probability of presence for anchovy does decrease Pacific sardine landings as much as an increase in the probability of presece of market squid. 

```{r int_effect_PSDN_by_port_PLOT, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
g1_PSDN / g2_PSDN
```

```{r int_effect_MSQD_by_port, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
c_eff_int_msqd_psdn <- (conditional_effects(fit_qMSQD_price, "MSQD_SDM_90:PSDN_SDM_60_dOpen", surface=TRUE, 
                                            conditions = conditions_msqd, re_formula = NULL))
c_eff_int_msqd_nanc <- (conditional_effects(fit_qMSQD_price, "MSQD_SDM_90:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_msqd, re_formula = NULL))
c_eff_int_psdn_nanc <- (conditional_effects(fit_qMSQD_price, "PSDN_SDM_60_dOpen:NANC_SDM_20", surface=TRUE, 
                                            conditions = conditions_msqd, re_formula = NULL))

g1_MSQD <-  plot(c_eff_int_msqd_psdn, plot = FALSE)[[1]] + ggtitle('(a) Market squid x Pacific sardine') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: MSQD")) +
  scale_x_continuous(name = "P(Pres): MSQD") + scale_y_continuous(name = "P(Pres): PSDN") 

g2_MSQD <-  plot(c_eff_int_msqd_nanc, plot = FALSE)[[1]] + ggtitle('(b) Market squid x Northern anchovy') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: MSQD")) + 
        scale_x_continuous(name = "P(Pres): MSQD") + scale_y_continuous(name = "P(Pres): NANC") 

g3_MSQD <-  plot(c_eff_int_psdn_nanc, plot = FALSE)[[1]] + ggtitle('(c) Pacific sardine x Northern anchovy') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: MSQD")) + 
        scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): NANC") 
save.image (file = "stan_fit.RData")
```

We found some similar findings for market squid in Figure \ref{fig:sdm_int_msqd}. Pacific sardine it is a strong substitute of market squid. In regard to Norther anchovy, there is some complementarity with market squid. We observe that when Northern anchovy presence increase, there is also an increase in market squid landings. 

```{r int_effect_MSQD_by_port_PLOT, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
g1_MSQD / g2_MSQD 
```


```{r int_effect_NANC_by_port, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
conditions_nanc <- conditions_nanc %>% filter(port_ID == 3  | port_ID == 5)

c_eff_int_nanc_psdn <- (conditional_effects(fit_qNANC_price, "NANC_SDM_20:PSDN_SDM_60_dOpen", surface=TRUE, 
                                            conditions = conditions_nanc, re_formula = NULL))
c_eff_int_nanc_msqd <- (conditional_effects(fit_qNANC_price, "NANC_SDM_20:MSQD_SDM_90", surface=TRUE, 
                                            conditions = conditions_nanc, re_formula = NULL))
c_eff_int_psdn_msqd <- (conditional_effects(fit_qNANC_price, "PSDN_SDM_60_dOpen:MSQD_SDM_90", surface=TRUE, 
                                            conditions = conditions_nanc, re_formula = NULL))

g1_NANC <-  plot(c_eff_int_nanc_psdn, plot = FALSE)[[1]] + ggtitle('(a) Northern anchovy x Pacific sardine') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) +
  scale_x_continuous(name = "P(Pres): NANC") + scale_y_continuous(name = "P(Pres): PSDN") 

g2_NANC <-  plot(c_eff_int_nanc_msqd, plot = FALSE)[[1]] + ggtitle('(b) Northern anchovy x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): NANC") + scale_y_continuous(name = "P(Pres): MSQD") 

g3_NANC <-  plot(c_eff_int_psdn_msqd, plot = FALSE)[[1]] + ggtitle('(c) Pacific sardine x Market squid') + 
         theme(
          plot.title = element_text(size=9, face="bold.italic"), 
          axis.text = element_text(size = 7), 
          axis.title = element_text(size = 8),
          legend.title = element_text(size = 9), 
          legend.text = element_text(size=8)
        ) + guides(colour=guide_legend(title="Landings: PSDN")) + 
        scale_x_continuous(name = "P(Pres): PSDN") + scale_y_continuous(name = "P(Pres): MSQD") 
save.image (file = "stan_fit.RData")
```

<!-- ISAAC COMMENTS: There are some notes from two stakeholder workshops (Desiree et al.). It would be good to use these to understand and motivate the discussion of complementarity and substition.  -->

However, this complementary is not observed for Northern anchovy landings. When market squid presence increase, we observe a decrease in Northern anchovy landings. An interesting case is observed for Pacific sardine and Northern anchovy, in particular at Monterrey area. For small levels of Pacific sardine presence, Pacific sardine is a complement with Northern anchovy. However, after certain threshold, Pacific sardine is no longer complement and Pacific sardine become a substitute, reducing Northern anchovy landings when the probability of presence for Pacific sardine increase.

```{r int_effect_NANC_by_port_PLOT, eval=FALSE, fig.cap=, message=FALSE, warning=FALSE, include=FALSE}
g1_NANC / g2_NANC 
```


### Pacific sardine closure
Finally, lets analyze the effect of the Pacific sardine closure on market squid and Northern anchovy landings. We do not find significant results in the case of Northern anchovy. In the case of market squid, we found a decrease in the level of landing after the closure was implemented. It seems that some fisher exit the CPS fishery after the closure of Pacific sardine, reducing their participation in the market squid fishery. Our participation model results give us more details about what happen after the Pacific sardine closure.

```{r by_port_msqd_dclose, eval=FALSE, fig.cap=, include=FALSE}
# conditions_dClose <- data.frame(port_ID = unique(est_data_msqd$dClose))
# rownames(conditions_dClose) <- unique(est_data_msqd$dClose)
c_eff_close_msqd <- (conditional_effects(fit_qMSQD_price, "dClose", conditions = conditions_msqd, re_formula = NULL))
g1 <-  plot(c_eff_close_msqd, plot = FALSE)[[1]] + ggtitle('(a) Market squid') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "Landings (tons)") 

c_eff_close_nanc <- (conditional_effects(fit_qNANC_price, "dClose", conditions = conditions_nanc, re_formula = NULL))
g2 <- plot(c_eff_close_nanc, plot = FALSE)[[1]] + ggtitle('(b) Northern anchovy') + 
  theme(plot.title = element_text(size=9, face="bold.italic"), 
        axis.text = element_text(size = 7), axis.title = element_text(size = 8)) + 
  scale_x_discrete(name = "Closure? (1 = True; 0 = False)") +
  scale_y_continuous(name = "Landings (tons)") 

g1 / g2
```

## Multispecies participation model



# Predictions
...

# Conclusions
A possible extension of our research is to consider spatial autocorrelations between ports.^[See \cite{morris2019bayesian} for an application of a spatial model in a Bayesian framework.] Ports landing maybe correlated as vessel have the incentives to choose the port of landing, conditional on whether the port have the infrastructure for this. It is likely that they just land wherever is closer to the area they are fishing. Nevertheless, differential in prices could encourage them to travel a little further for higher prices. 




<!-- ```{r int_effect_sep, eval=FALSE, include=FALSE} -->

<!-- hu <- plot(conditional_effects(fit_qPSDN, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="hu"), -->
<!--            plot = FALSE, ask = FALSE) -->
<!-- mu <- plot(conditional_effects(fit_qPSDN, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="mu"), -->
<!--            plot = FALSE, ask = FALSE) -->

<!-- mu[[1]] + hu[[1]] + plot_layout(nrow = 2) -->

<!-- ``` -->

<!-- ```{r int_effect_sep_msqd, eval=FALSE, fig.cap=, include=FALSE} -->

<!-- hu <- plot(conditional_effects(fit_qMSQD_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="hu"), -->
<!--            plot = FALSE, ask = FALSE) -->
<!-- mu <- plot(conditional_effects(fit_qMSQD_gamma, "PSDN_SDM:MSQD_SDM", surface=TRUE, dpar="mu"), -->
<!--            plot = FALSE, ask = FALSE) -->

<!-- mu[[1]] + hu[[1]] + plot_layout(nrow = 2) -->

<!-- ``` -->




